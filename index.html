<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>长沙飞狐智能数据平台</title>
    <script id="chartjs-cdn" src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" onerror="this.onerror=null; this.src='https://cdn.staticfile.org/Chart.js/4.4.1/chart.umd.min.js'; this.onerror=function(){ this.onerror=null; this.src='https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'; };"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 LeanCloud SDK（含多CDN回退） -->
    <script id="leancloud-cdn" src="https://unpkg.com/leancloud-storage@4.13.2/dist/av-min.js" onerror="this.onerror=null; this.src='https://cdn.staticfile.org/leancloud-storage/4.13.2/av-min.js'; this.onerror=function(){ this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js'; };"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary: #1a73e8;
            --secondary: #0d47a1;
            --accent: #00c853;
            --dark: #0a1929;
            --light: #f5f9ff;
            --gray: #e0e0e0;
            --card-bg: rgba(255, 255, 255, 0.85);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        body {
            background: #ffffff;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* 星空背景样式 - 只在登录页面显示 */
        #nebula {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at center, #1B2735 0%, #090A0F 100%);
        }
        
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        /* 确保主页面有白色背景 */
        #main-container {
            background: #ffffff;
        }
        
        /* 添加头部标题样式 */
        .header-title {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        .header-logo {
            height: 35px; /* 调整图片大小与文字一致 */
            vertical-align: middle;
             margin-top: 40px; /* 添加与文字相同的上边距 */
        }
        
       .header-text {
    color: white;
    font-size: 35px; /* 增大字体 */
    font-weight: bold; /* 这里修改字体粗细 */
    font-family: "SimSun", serif; /* 宋体 */
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    margin: 0;
    vertical-align: middle;
    letter-spacing: 2px; /* 添加字符间距 */
    margin-top: 40px;   /* 或者: margin-bottom: 10px; 会使文字向上移动 */
}
        
        /* 修改底部版权信息样式 */
        .footer-copyright {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 15px 0;
            color: white;
            font-size: 14px;
            z-index: 1001;
            background: transparent; /* 移除背景 */
        }
        
        /* 调整登录容器的z-index以确保它在标题上方 */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            z-index: 1000;
        }
        
        .login-container {
            width: 100%;
            max-width: 330px;  /* 调整登录窗体宽度 */
            background: transparent;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
            margin-right: 160px; /* 调整这个值来控制向左移动的距离 */
            margin-bottom:180px;  /* 这里控制垂直位置 */
        }
        
        .form-container {
            padding: 8px;
            transition: transform 0.6s ease-in-out;
        }
        
        #login-container .logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        #login-container .logo i {
            font-size: 42px;
            color: #764ba2;
            margin-bottom: 10px;
        }
        
        #login-container .logo h2 {
            color: white;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 7px;
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #764ba2;
            z-index: 2;
            font-size: 16px;
            width: 20px;
            text-align: center;
            display: block;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px 12px 45px; /* 保持左侧内边距 */
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
            outline: none;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd5;
        }
        
        .links {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .links a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
            cursor: pointer;
        }
        
        .links a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }
        
        .divider:before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: #ddd;
        }
        
        .divider span {
            background: rgba(255, 255, 255, 0.9);
            padding: 0 15px;
            color: #777;
            position: relative;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 7px;
            text-align: center;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        #registerForm, #resetForm {
            display: none;
        }
        
        .back-to-login {
            text-align: center;
            margin-top: 20px;
            color: white;
        }
        
        .back-to-login a {
            color: white !important;
            text-decoration: none;
        }
        
        .back-to-login a:hover {
            color: white !important;
            text-decoration: underline;
        }
        
        .info-text {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 15px;
        }
        
        @media (max-width: 480px) {
            .login-container {
                border-radius: 12px;
            }
            
            .form-container {
                padding: 20px;
            }
        }
        
        /* 主页面布局 */
        #main-container {
            display: none;
            min-height: 100vh;
            flex: 1;
            flex-direction: column;
            padding-top: 70px; /* 添加这行，为固定的header腾出空间 */
        }
        
        /* 移动端菜单按钮 */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            margin-right: 15px;
        }
        
        header {
            position: fixed; /* 修改为fixed */
            top: 0; 
            left: 0;
            width: 100%; /* 确保宽度为100% */
            z-index: 1000;
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            height: 70px;
            box-sizing: border-box;
        }
        
        header .logo {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logo img {
            height: 40px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .time-display {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            background: var(--glass-bg);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        /* 用户信息区域 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--glass-bg);
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .username {
            font-size: 14px;
            font-weight: 500;
        }
        
        .layout {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 70px);
            margin-left: 250px; /* 添加这行，为固定的sidebar腾出空间 */
        }
        
        /* 左侧菜单 */
        .sidebar {
            position: fixed; /* 修改为fixed */
            top: 70px; /* 与header高度一致 */
            left: 0;
            height: calc(100vh - 70px); /* 减去header高度 */
            background: linear-gradient(180deg, var(--dark), #0c1e32);
            padding: 25px 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto; /* 确保菜单内容可滚动 */
            width: 250px;
            z-index: 999; /* 确保在内容之上，但在header之下 */
        }
        
        .menu-item {
            padding: 15px 30px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            font-size: 16px;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background: rgba(26, 115, 232, 0.2);
            color: white;
            border-left: 4px solid var(--primary);
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
        }
        
        /* 子菜单样式 */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .submenu.expanded {
            max-height: 500px;
        }
        
        .submenu-item {
            padding: 12px 20px 12px 60px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 14px;
            text-decoration: none; /* 添加这行移除下划线 */
        }
        
        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            text-decoration: none; /* 添加这行确保hover时也没有下划线 */
        }
        
        .submenu-item i {
            font-size: 12px;
        }
        
        .submenu .submenu {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .submenu .submenu .submenu-item {
            padding-left: 80px;
        }
        .menu-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
        }
        
        .menu-item.expanded .menu-toggle {
            transform: translateY(-50%) rotate(90deg);
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 20px;
            background: transparent;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 22px;
            margin-top: 7px;
            margin-bottom: 5px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        
        /* 第一个section-title不需要上边距 */
        .main-content > .section-title:first-child {
            margin-top: 0;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* 数据查询区域 - 修改部分 */
        .query-section {
            background: transparent;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 7px;
            box-shadow: none;
            border: none;
            width: 100%;
            height: auto;
        }
        
        .query-form {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            align-items: center;
        }

        #data-query-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .form-group {
    width: 100%; /* 确保宽度100% */
    margin-bottom: 20px;
    position: relative;
}
        .form-group label {
            font-weight: 500;
            color: #555;
            font-size: 14px; /* 减小字体 */
        }
        
        #data-query-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        #data-query-container .form-group {
            flex: 0 0 22%; /* 固定宽度约为原来的1/3 */
            margin: 0;
        }

        #data-query-container .form-group input,
        #data-query-container .form-group select {
            width: 100%;
            padding: 8px 10px;
            height: 36px;
            box-sizing: border-box;
        }

        #data-query-container .btn-group {
            flex: 0 0 auto;
            display: flex;
            gap: 8px;
            align-items: center;
            height: 36px;
        }

        .form-group input, .form-group select {
            padding: 8px 10px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s;
            height: 36px;
            width: 100%;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            outline: none;
        }
        
        #data-query-container .btn-group {
            display: flex;
            gap: 8px;
            margin-left: 0;
            padding-bottom: 0;
        }
        
        .query-btn, .export-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px; /* 减小内边距 */
            border-radius: 8px;
            font-size: 14px; /* 减小字体 */
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px; /* 减小间距 */
            height: 36px; /* 固定高度 */
            white-space: nowrap; /* 防止文本换行 */
        }
        
        .export-btn {
            background: var(--success);
        }
        
        .query-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .query-btn:disabled, .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .query-btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .query-btn.loading .spinner {
            display: inline-block;
        }
        
        .query-btn.loading span {
            vertical-align: middle;
        }
        
        .query-info {
            margin-top: 10px; /* 减小上边距 */
            color: #666;
            font-size: 13px; /* 减小字体 */
            padding: 6px; /* 减小内边距 */
            border-radius: 8px;
            background-color: transparent;
            border-left: none;
        }
        
        .query-info.error {
            background-color: transparent;
            border-left-color: none;
            color: var(--danger);
        }
        
        .query-info.error i {
            color: var(--danger);
        }
        
        .query-info.success {
            background-color: transparent;
            border-left-color: none;
            color: var(--success);
        }
        
        .query-info.success i {
            color: var(--success);
        }
        
        /* Excel 表格区域 */
        .excel-section {
            background: transparent;
            border-radius: 12px;
            padding: 8px;
            box-shadow: none;
            border: none;
            margin-bottom: 7px;
        }
        
        .excel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 7px;
        }
        
        .table-container {
            /* 报表在桌面和移动端均支持双向滚动 */
            overflow: auto;
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px; /* 确保表格不会过窄 */
            /* 移除固定布局，让列宽自适应 */
            table-layout: auto; 
        }
        
        .table-container th {
            background-color: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            padding: 12px 15px;
        }
        
        .table-container th, .table-container td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
            /* 移除最小宽度限制 */
            min-width: 0;
            /* 确保内容完整显示 */
            white-space: normal;
            word-break: break-word;
            line-height: 1.5;
            vertical-align: middle;
            /* 添加最大宽度限制防止内容过长 */
            max-width: 300px;
        }
        
        /* 确保数字列也居中对齐 */
        .table-container .num-cell,
        .table-container .num-col {
            text-align: center !important;
        }
        
        /* 综合数据报表数字列居中对齐 */
        #comprehensive-table-container .num-cell,
        #comprehensive-table-container .num-col {
            text-align: center !important;
        }
        
        /* 综合数据报表表格样式 */
        #comprehensive-table-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: auto;
            max-height: 600px;
            position: relative;
        }
        
        #comprehensive-table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            table-layout: auto;
        }
        
        #comprehensive-table-container th, #comprehensive-table-container td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 0;
            white-space: normal;
            word-break: break-word;
            line-height: 1.5;
            vertical-align: middle;
            max-width: 300px;
        }
        
        #comprehensive-table-container th {
            background-color: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        
        /* 单位信息左对齐 */
        .unit-info-cell {
            text-align: left !important;
        }
        
        /* 充电数据看板表格数字列居中对齐 */
        #charging-board-table-container .num-cell,
        #charging-board-table-container .num-col {
            text-align: center !important;
        }
        
        /* 实时数据表格数字列居中对齐 */
        #realtime-table .num-cell,
        #realtime-table .num-col {
            text-align: center !important;
        }
        
        /* 站点数据统计板块样式 */
        .site-stats-section {
            margin-bottom: 7px;
            background: transparent;
            border-radius: 12px;
            box-shadow: none;
            border: none;
            padding: 8px;
        }
        
        .site-stats-container {
            width: 100%;
        }
        
        .stats-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: transparent;
            border-radius: 8px;
        }
        
        .data-mode-buttons {
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: #fff;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .mode-btn:hover {
            border-color: #007bff;
            color: #007bff;
        }
        
        .mode-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: #fff;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .page-btn {
            width: 35px;
            height: 35px;
            border: 2px solid #e9ecef;
            background: #fff;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-btn:hover:not(:disabled) {
            border-color: #007bff;
            color: #007bff;
        }
        
        .page-btn:disabled {
            background: #f8f9fa;
            border-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }
        
        .page-info {
            font-weight: 600;
            color: #495057;
            min-width: 80px;
            text-align: center;
        }
        
        .stats-data-container {
            display: flex;
            flex-direction: column;
            gap: 0px;
        }
        
        .site-data-section {
            background: transparent;
            border-radius: 0;
            padding: 8px;
            border: none;
            margin-bottom: 0;
        }
        
        .site-name-header {
            font-size: 18px;
            font-weight: 700;
            color: #495057;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #007bff;
            text-align: center;
        }
        
        .data-item {
            margin-bottom: 4px;
            padding: 5px;
            background: transparent;
            border-radius: 0;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .site-name {
            font-size: 14px;
            color: #007bff;
            font-weight: 700;
            min-width: 80px;
            flex-shrink: 0;
            text-align: center;
            background: transparent;
            padding: 2px 6px;
            border-radius: 4px;
            border: none;
        }
        
        .site-name-spacer {
            min-width: 80px;
            flex-shrink: 0;
        }
        .data-label {
            font-size: 14px;
            color: #495057;
            font-weight: 600;
            min-width: 120px;
            flex-shrink: 0;
        }
        .data-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .progress-bar {
            flex: 1;
            height: 12px;
            background: #e9ecef;
            border-radius: 0px;  /* 改为方形：从6px改为0px */
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: #4b6bc4;  /* 改为纯绿色：删除渐变效果 */
            border-radius: 0px;  /* 改为方形：从6px改为0px */
            transition: width 0.8s ease;
            position: relative;
        }
        
        /* 移除渐变效果 */
        .progress-fill::after {
            display: none;
        }
        
        /* 删除shimmer动画，因为不再需要渐变效果 */
        
        .progress-value {
            min-width: 60px;
            text-align: right;
            font-weight: bold;
            color: #495057;
            font-size: 12px;
        }
        
        /* 百分比颜色样式 */
        .percentage-increase {
            color: #28a745;
            font-weight: bold;
        }
        
        .percentage-decrease {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .stats-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .stats-data-container {
                flex-direction: column;
            }
            
            .site-data-section {
                width: 100%;
            }
            
            .data-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .progress-bar {
                width: 100%;
            }
        }
        
        /* 未充电时长统计表格数字列居中对齐 */
        #uncharged-table .num-cell,
        #uncharged-table .num-col {
            text-align: center !important;
        }
        
        .table-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .table-container tr:hover {
            background-color: #f1f7ff;
        }
        
        .table-container td:first-child {
            font-weight: bold;
            background-color: #f0f5ff;
        }
        
        .data-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* 综合数据报表样式 */
        .comprehensive-section {
            background: transparent;
            border-radius: 12px;
            padding: 8px;
            box-shadow: none;
            border: none;
            margin-bottom: 7px;
        }
        
        .comprehensive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 7px;
        }
        
        /* 页脚 */
        footer {
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            margin-top: auto;
            width: 100%;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .income-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 900px) {
            .layout {
                margin-left: 0;
                flex-direction: column;
            }
            
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                top: 0;
                order: 2;
                display: none; /* 默认隐藏 */
            }
            
            .sidebar.mobile-open {
                display: block;
            }
            
            /* 移动端空白页调整 */
            #page-cd-data, #page-zh-data {
                left: 0 !important;
                top: 60px !important;
            }
            
            .main-content {
                order: 1;
                width: 100%;
            }
            
            #main-container {
                padding-top: 60px;
            }
            
            header {
                height: 60px;
                padding: 10px 15px;
                position: relative;
            }
            
            .logo h1 {
                font-size: 18px;
            }
            
            .mobile-menu-toggle {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 5px;
            }
            
            .query-form {
                flex-direction: column;
                gap: 5px;
            }
            
            #data-query-container {
                flex-direction: column;
                gap: 5px;
            }
            
            #data-query-container .form-group {
                flex: 1;
                width: 100%;
            }
            
            #data-query-container .btn-group {
                flex: none;
                width: 100%;
                justify-content: center;
            }
            
            .form-group {
                width: 100% !important;
                min-width: unset !important;
            }
            
            .btn-group {
                width: 100% !important;
                justify-content: center !important;
                flex-wrap: wrap;
            }
            
            .query-btn, .export-btn {
                min-width: 120px;
                flex: 1;
            }
        }
        
        @media (max-width: 768px) {
            .metric-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .income-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .metric-card {
                min-width: unset;
                width: 100%;
            }
            
            .user-info .username {
                display: none;
            }
            
            .time-display {
                font-size: 12px;
                padding: 5px 8px;
            }
            
            .logo h1 {
                font-size: 16px;
            }
            
            .chart-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .chart-title > div {
                display: flex;
                gap: 10px;
                align-items: center;
                width: 100%;
                justify-content: flex-start;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            .table-container th, .table-container td {
                padding: 8px 5px;
                min-width: 80px;
            }
            
            .metric-value {
                font-size: 18px;
            }
            
            .metric-label {
                font-size: 12px;
            }
        }
        @media (max-width: 480px) {
            .login-container {
                width: 95%;
                margin: 10px;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            header {
                padding: 8px 10px;
                height: 50px;
            }
            
            #main-container {
                padding-top: 50px;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .query-section {
                padding: 10px;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .logo h1 {
                font-size: 14px;
            }
            
            .time-display {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .metric-value {
                font-size: 16px;
            }
            
            .metric-label {
                font-size: 11px;
            }
            
            .query-btn, .export-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .table-container th, .table-container td {
                padding: 6px 4px;
                font-size: 11px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
        /* 移动端日期选择器优化 */
        @media (max-width: 768px) {
            .custom-picker {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 300px;
                z-index: 2000;
            }
            
            .date-picker-container {
                position: relative;
            }
            
            .table-container {
                border-radius: 4px;
            }
            
            .realtime-table-container {
                height: 300px;
            }
            
            .uncharged-table-container {
                max-height: 300px;
            }
            
            /* 表格左右滚动提示 */
            .table-container::before {
                content: "← 左右滚动查看更多";
                position: absolute;
                top: 5px;
                right: 10px;
                font-size: 10px;
                color: #999;
                z-index: 5;
                background: rgba(255, 255, 255, 0.9);
                padding: 2px 5px;
                border-radius: 3px;
            }
        }

        /* 登录表单图标显示样式 */
#login-container .form-group i {
    display: block;
}
#login-container .form-control {
    padding: 12px 15px 12px 45px !important; /* 保持左侧内边距 */
}

/* 其他表单隐藏图标样式 */
.main-content .form-group i {
    display: none;
}
.main-content .form-control {
    padding: 12px 15px !important; /* 移除左侧内边距 */
}

/* 短信验证码登录样式 */
#smsLoginForm {
    display: none;
}

#smsLoginForm .form-group {
    position: relative;
}

#smsLoginForm .form-group:has(#smsCode) {
    display: flex;
    gap: 10px;
    align-items: center;
}

#smsLoginForm #smsCode {
    flex: 1;
    padding: 12px 15px 12px 45px !important;
}

.btn-sms {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
    min-width: 100px;
}

.btn-sms:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-sms:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-sms.countdown {
    background: #999;
    cursor: not-allowed;
}

/* 手机号输入框样式 */
#smsPhone {
    padding: 12px 15px 12px 45px !important;
}

/* 验证码输入框样式 */
#smsCode {
    padding: 12px 15px 12px 45px !important;
}
        /* 图表加载指示器 */
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        .chart-loading i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.5; transform: scale(0.9); }
        }
        
        /* 数据加载指示器 */
        .data-loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary);
            font-size: 16px;
        }
        
        .data-loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .data-type-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* 日期选择器改进 */
        .form-group input[type="month"] {
            cursor: pointer;
            position: relative;
        }
        
        .form-group input[type="month"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
        }
        
        /* 自定义日期选择器容器 */
        .custom-date-picker {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .year-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .year-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px; /* 提升可见度 */
            padding: 0 8px;
            color: #555;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
        }
        
        .year-btn:hover {
            color: var(--primary);
        }
        
        .year-display {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .month-btn {
            padding: 8px 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .month-btn:hover {
            background: #f0f5ff;
            border-color: var(--primary);
        }
        
        .month-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 日期选择器容器 */
        .date-picker-container {
            position: relative;
        }
        
        .custom-picker {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            min-width: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }
        
        /* 功能提示弹窗 */
        .feature-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            text-align: center;
            max-width: 90%;
            width: 400px;
            display: none;
        }
        
        .feature-popup h3 {
            margin-bottom: 7px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .feature-popup .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #777;
            background: none;
            border: none;
        }
        
        .feature-popup .popup-content {
            margin-bottom: 7px;
            font-size: 18px;
            color: #555;
        }
        
        .feature-popup .confirm-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .feature-popup .confirm-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }

        #metrics-container {
            padding: 20px;
            background: #f0f5ff;
        }

        .metrics-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .metrics-section {
            margin-bottom: 25px;
        }
        
        .metrics-section > .metrics-row {
            width: 100%;
            margin-bottom: 10px;
        }

/* 调整指标卡片宽度 */
.metrics-section > .metrics-row:nth-child(1) .metric-item {
    background: linear-gradient(135deg, rgba(26, 115, 232, 0.15), rgba(26, 115, 232, 0.05));
    border-left: 4px solid var(--primary);
}

.metrics-section > .metrics-row:nth-child(2) .metric-item {
    background: linear-gradient(135deg, rgba(0, 200, 83, 0.15), rgba(0, 200, 83, 0.05));
    border-left: 4px solid var(--accent);
}

.metrics-section > .metrics-row:nth-child(3) .metric-item {
    background: linear-gradient(135deg, rgba(156, 39, 176, 0.15), rgba(156, 39, 176, 0.05));
    border-left: 4px solid #9c27b0;
}

.metrics-section > .metrics-row:nth-child(4) .metric-item {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.05));
    border-left: 4px solid #ffc107;
}
/* 悬停效果增强 */
.metric-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

/* 调整指标值的颜色与卡片主题匹配 */
.metrics-section > .metrics-row:nth-child(1) .metric-value {
    color: var(--primary) !important;
}

.metrics-section > .metrics-row:nth-child(2) .metric-value {
    color: var(--accent) !important;
}

.metrics-section > .metrics-row:nth-child(3) .metric-value {
    color: #9c27b0 !important;
}

.metrics-section > .metrics-row:nth-child(4) .metric-value {
    color: #ff9800 !important;
}
        .metrics-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .metric-card {
            background: transparent;
            border-radius: 12px;
            padding: 12px;
            box-shadow: none;
            border: none;
            flex: 1;
            min-width: 300px;
        }

        .metric-card-title {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 5px;
            /* 移除了下面的横线 */
    /* border-bottom: 2px solid var(--primary); */
        }

        .metric-card-title i {
            color: var(--primary);
        }

       /* 修改网格布局为一行的四个项目 */
.metric-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 改为4列 */
    gap: 8px; /* 可以根据需要调整间距 */
}

/* 修改指标项背景为透明 */
.metric-item {
    padding: 8px;
    border-radius: 8px;
    background: transparent; /* 改为透明背景 */
    text-align: center;
    transition: all 0.3s;
}

        
        /* 综合收入数据显示在一行 */
        .income-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .metric-item {
            padding: 8px;
            border-radius: 8px;
            background: transparent;
            text-align: center;
            transition: all 0.3s;
        }

        .metric-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin: 5px 0;
            white-space: nowrap;
        }
/* 在这里添加您的自定义颜色代码 */
/* 本月充电数据数字颜色 */
#month-charge, #month-electricity, #month-service, #month-orders {
    color: #000000; /* 红色系 */
}

/* 本年度充电数据数字颜色 */
#year-charge, #year-electricity, #year-service, #year-orders {
    color: #0c0c0c; /* 青色系 */
}

/* 累计充电数据数字颜色 */
#total-charge, #total-electricity, #total-service, #total-orders {
    color: #0c0c0c; /* 蓝色系 */
}
/* 累计综合业务收入数字颜色 */
#month-income, #year-income, #total-income {
    color: #0c0c0c; /* 蓝色系 */
}
        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            background: transparent;
            border-radius: 12px;
            padding: 20px;
            box-shadow: none;
            border: none;
            margin-bottom: 7px;
        }

        .chart-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--primary);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        .chart-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .chart-action-btn {
            padding: 8px 15px;
            background: #f0f5ff;
            border: 1px solid var(--primary);
            border-radius: 6px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        /* 综合收入看板特定样式 */
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 7px;
            gap: 5px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
        }

        .form-select {
            padding: 8px 12px;
            border: 1px solid var(--gray);
            border-radius: 6px;
            background: white;
            min-width: 100px;
        }

        .table-wrapper {
            margin-bottom: 7px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .chart-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        #report-section {
            padding-top: 50px;
        }
        
        /* 数据加载动画 */
        .data-loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: var(--primary);
        }
        
        .data-loading-indicator i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

/* 实时数据表格样式 */
.realtime-table-container {
    height: 400px; /* 将max-height改为固定高度 */
    overflow: auto; /* 改为auto以便内容超出时可以滚动 */
    position: relative;
    border: 1px solid #ddd;
    border-radius: 8px;
}

#realtime-loading {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    padding: 20px;
    color: var(--primary);
    font-size: 16px;
    width: 100%;
    z-index: 5;
}

#realtime-loading i {
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

#realtime-table {
    width: 100%;
    border-collapse: collapse;
}

#realtime-table th {
    background-color: var(--primary);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 12px 15px;
    text-align: center;
}

#realtime-table td {
    padding: 10px 15px;
    text-align: center;
    border-bottom: 1px solid #eee;
}

#realtime-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

#realtime-table tr.highlight {
    background-color:   #e0d0ff!important;
    transition: background-color 0.5s ease;
}

#realtime-table tr:hover {
    background-color: #f1f7ff;
    cursor: pointer;
}
 /* 未充电时长统计表格表头样式 */
        #uncharged-table th {
            background-color: #1a73e8 !important; /* 深蓝色背景 */
            color: #ffffff !important; /* 白色文字 */
            border: 1px solid #0d47a1 !important; /* 深蓝色边框 */
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* 表格行样式 */
        #uncharged-table tr:nth-child(even) {
            background-color: #f8fbff;
        }
        
        #uncharged-table tr:hover {
            background-color: #e8f0fe;
        }

        /* 桌面端：报表容器显示底部横向滚动条并禁止单元格换行 */
        @media (min-width: 901px) {
            #table-container,
            #comprehensive-table-container,
            .table-wrapper {
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            #table-container th, #table-container td,
            #comprehensive-table-container th, #comprehensive-table-container td {
                white-space: nowrap;
                word-break: keep-all;
                max-width: none;
            }

            /* 让表格在内容较多时能触发横向滚动 */
            #table-container table,
            #comprehensive-table-container table {
                table-layout: auto;
                min-width: 1000px;
            }
        }

        /* 整体情况概要 */
        .overview-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        
        .overview-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .overview-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .overview-value-large {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .overview-name-large {
            font-size: 16px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .overview-subtext {
            font-size: 14px;
            color: #888;
            line-height: 1.4;
        }

        /* 响应式调整 */
        @media (max-width: 1200px) {
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .overview-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 按钮禁用状态样式 */
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        button:disabled:hover {
            background-color: #ccc !important;
            cursor: not-allowed !important;
        }

    </style>
</head>
<body>
    <!-- 星空背景 -->
    <div id="nebula"></div>
    <canvas id="starfield" width="1379" height="932"></canvas>
    
    <!-- 在body开始处添加头部标题区域 -->
    <div class="header-title" id="login-header-title">
        <img src="https://jiangnanwaw.github.io/my-page/photo/fhlogo.png" alt="Logo" class="header-logo">
        <h1 class="header-text">长沙飞狐数据管理平台</h1>
    </div>
    
    <!-- LeanCloud 登录系统 -->
    <div id="login-container">
        <div class="login-container">
            <div class="form-container">
                <div class="logo">
                    <i class="fas fa-user-lock"></i>
                    <h2 id="form-title">用户登录</h2>
                </div>
                
                <div id="loginMessage" class="message"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="loginUsername" class="form-control" placeholder="用户名" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" class="form-control" placeholder="密码" required>
                    </div>
                    
                    <button type="submit" class="btn">登录</button>
                    
                    <div class="links">
                        <a href="#" id="showReset">忘记密码?</a>
                        <a href="#" id="showRegister">注册新账号</a>
                        <a href="#" id="showSmsLogin">短信验证码登录</a>
                    </div>
                </form>
                
                <form id="registerForm">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="registerUsername" class="form-control" placeholder="设置用户名" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="registerPassword" class="form-control" placeholder="设置密码" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="registerEmail" class="form-control" placeholder="电子邮箱" required>
                    </div>
                    

                    
                    <button type="submit" class="btn">注册</button>
                    
                                    
                                      
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromRegister">返回登录</a>
                    </div>
                </form>
                
                <form id="resetForm">
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="resetEmail" class="form-control" placeholder="输入注册邮箱" required>
                    </div>
                    
                    <button type="submit" class="btn">发送重置邮件</button>
                    
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromReset">返回登录</a>
                    </div>
                </form>
                
                <form id="smsLoginForm">
                    <div class="form-group">
                        <i class="fas fa-mobile-alt"></i>
                        <input type="tel" id="smsPhone" class="form-control" placeholder="请输入手机号码" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-key"></i>
                        <input type="text" id="smsCode" class="form-control" placeholder="请输入验证码" required>
                        <button type="button" id="sendSmsCode" class="btn-sms">发送验证码</button>
                    </div>
                    
                    <button type="submit" class="btn">验证码登录</button>
                    
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromSms">返回登录</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    
    <!-- 功能提示弹窗 -->
    <div class="feature-popup" id="feature-popup">
        <button class="close-btn" id="close-popup"><i class="fas fa-times"></i></button>
        <h3><i class="fas fa-exclamation-triangle"></i> 功能提示</h3>
        <div class="popup-content" id="popup-content">
            此功能暂未开放
        </div>
        <button class="confirm-btn" id="confirm-popup">确定</button>
    </div>

    <!-- 主页面容器 -->
    <div id="main-container">
        <header>
            <button class="mobile-menu-toggle" id="mobile-menu-toggle" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-bolt"></i>
                <h1>长沙飞狐智能数据平台</h1>
            </div>
            <div class="user-info">
                <img src="https://jiangnanwaw.github.io/my-page/photo/fhlogo.png" alt="用户头像" class="user-avatar">
                <span class="username" id="user-display">admin</span>
            </div>
            <div class="time-display" id="time-display">
                2025年08月05日 星期二 10:30:45
            </div>
        </header>
        
        <div class="layout">
            <!-- 左侧菜单 -->
            <div class="sidebar">
                <div class="menu-item active" id="menu-home">
                    <i class="fas fa-home"></i>
                    <span>平台首页</span>
                </div>
                
                <!-- BI数据分析（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>BI数据分析</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://www.csfhcdz.cn/bi/cdbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-bolt"></i>
                        <span>充电数据可视化</span>
                    </a>
                    <a href="https://www.csfhcdz.cn/bi/zhbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>综合数据可视化</span>
                    </a>
                </div>
                
                <!-- 场站基本情况（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>场站基本情况</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <!-- 四方坪站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>四方坪站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <!-- 监控（带子菜单） -->
                        <div class="menu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                            <i class="fas fa-chevron-right menu-toggle"></i>
                        </div>
                        <div class="submenu">
                            <a href="http://wawtf.eicp.net:50000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>东区</span>
                            </a>
                            <a href="http://wawtf.eicp.net:7000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>南区</span>
                            </a>
                            <a href="http://wawtf.eicp.net:9000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>西区</span>
                            </a>
                        </div>
                        <a href="https://cloud.wlyk.com/" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                    
                    <!-- 高岭站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>高岭站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <a href="http://wawwt.eicp.net:1428" target="_blank" class="submenu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                        </a>
                        <a href="https://psp.hikparking.com/#/login" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                </div>
                
                <!-- 充电桩管理（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-car-battery"></i>
                    <span>充电桩管理</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://cloud.teld.cn/web/login?locale=zh-CN" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>特来电</span>
                    </a>
                    <a href="https://auth.digipowercloud.huawei.com/dpcloud/index.html#/login" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>华为</span>
                    </a>
                </div>
                
                <!--  资料文件（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-building"></i>
                    <span>资料文件</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="ftp://wawtf.eicp.net/" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>相关合同</span>
                    </a>
                   <a href="https://www.csfhcdz.cn/bi/qt.html" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>其它资料</span>
                    </a>
                </div>

                <!-- 数据查询（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-search"></i>
                    <span>数据查询</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="#" class="submenu-item" id="menu-cd-data">
                        <i class="fas fa-bolt"></i>
                        <span>充电数据</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-zh-data">
                        <i class="fas fa-chart-bar"></i>
                        <span>综合数据</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-bill-data">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>电费账单</span>
                    </a>
                </div>

                <!-- 其他菜单项 -->
                
                <div class="menu-item" id="finance-management">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>财务管理</span>
                </div>

                <div class="menu-item" id="system-settings">
                    <i class="fas fa-cogs"></i>
                    <span>系统设置</span>
                </div>
                <div class="menu-item" id="history-menu">
                    <i class="fas fa-history"></i>
                    <span>历史记录</span>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="main-content" style="position: relative;">
                <!-- 覆盖式空白页面：充电数据（正式查询页） -->
                <div id="page-cd-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf" style="color:#333;">充电数据</strong>
                    </div>

                        
                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 充电设备选择 -->
                        <select id="device-select" onchange="onDeviceChange()" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px; color:#999;">
                            <option value="" disabled selected hidden>充电设备</option>
                            <option value="特来电">特来电</option>
                            <option value="能科">能科</option>
                        </select>
                        <!-- 电站选择（1.jpg风格简化） -->
                        <div id="station-box" style="width:220px; border:1px solid #e5e5e5; border-radius:8px; padding:8px; position:relative; height:36px; display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:170px; font-size:14px;" id="station-display">电站</div>
                            <button id="station-menu-btn" onclick="toggleStationMenu()" title="选择电站" style="background:transparent; border:none; cursor:pointer; font-size:18px; line-height:1; color:#666;">⋯</button>
                            <div id="station-menu" style="position:absolute; top:44px; right:10px; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:10px; width:200px; z-index:1100; display:none;">
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" id="station-all" checked onchange="onToggleAllStations()"> 全选
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="east" checked> 长沙飞狐东区站
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="west" checked> 长沙飞狐西区站
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="south" checked> 长沙飞狐南区站
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="gaoling" checked> 长沙飞狐高岭充电站
                                </label>
                                <div style="text-align:right; margin-top:8px;">
                                    <button onclick="applyStationSelection()" style="background:#007bff; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">确定</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 时间字段选择 -->
                        <select id="time-field-select" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                            <option value="充电结束时间" selected>充电结束时间</option>
                            <option value="充电开始时间">充电开始时间</option>
                        </select>

                        <!-- 开始时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="start-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="start-date-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 结束时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="end-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="end-date-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runStationQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                            <button id="export-btn" onclick="exportQueryToExcel()" disabled style="background:#adb5bd; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:not-allowed;">导出 Excel</button>
                        </div>
                            </div>
                            
                    <!-- 查询结果 -->
                    <div id="query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="current-conditions-text" style="color: #6c757d;">请选择查询条件后点击查询</span>
                        </div>
                        <div id="query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                     </div>
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：电费账单 -->
                <div id="page-bill-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section-bill">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf-bill" style="color:#333;">电费账单</strong>
                    </div>

                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 客户号选择 -->
                        <div id="customer-box" style="width:220px; border:1px solid #e5e5e5; border-radius:8px; padding:8px; position:relative; height:36px; display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:170px; font-size:14px;" id="customer-display">客户号</div>
                            <button id="customer-menu-btn" onclick="toggleCustomerMenu()" title="选择客户号" style="background:transparent; border:none; cursor:pointer; font-size:18px; line-height:1; color:#666;">⋯</button>
                            <div id="customer-menu" style="position:absolute; top:44px; right:10px; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:10px; width:200px; z-index:1100; display:none;">
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" id="customer-all" checked onchange="onToggleAllCustomers()"> 全选
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="customer-group" data-customer="3111439077" checked> 3111439077
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="customer-group" data-customer="3118481453" checked> 3118481453
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
                                    <input type="checkbox" class="customer-group" data-customer="4350001671599" checked> 4350001671599
                                </label>
                                <div style="text-align:right; margin-top:8px;">
                                    <button onclick="applyCustomerSelection()" style="background:#007bff; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">确定</button>
                                </div>
                            </div>
                        </div>

                        <!-- 开始时间（年月格式） -->
                        <div style="position:relative; width:220px;">
                            <input id="bill-start-month" type="text" placeholder="开始年月" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="bill-start-month-btn" title="选择年月" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 结束时间（年月格式） -->
                        <div style="position:relative; width:220px;">
                            <input id="bill-end-month" type="text" placeholder="结束年月" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="bill-end-month-btn" title="选择年月" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runBillQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                            <button id="bill-export-btn" onclick="exportBillToExcel()" disabled style="background:#adb5bd; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:not-allowed;">导出 Excel</button>
                        </div>
                    </div>
                    
                    <!-- 查询结果 -->
                    <div id="bill-query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="bill-current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="bill-current-conditions-text" style="color: #6c757d;">请选择查询条件后点击查询</span>
                        </div>
                        <div id="bill-query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：综合数据 -->
                <div id="page-zh-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section-zh">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf-zh" style="color:#333;">综合数据</strong>
                    </div>

                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 项目类别选择 -->
                        <select id="zh-project-select" onchange="onZhProjectChange()" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px; color:#333;">
                            <option value="" disabled selected hidden>项目类别</option>
                            <option value="红门缴费">红门缴费</option>
                            <option value="月租车充值">月租车充值</option>
                            <option value="兴元售货机">兴元售货机</option>
                            <option value="赛菲姆道闸">赛菲姆道闸</option>
                            <option value="快易洁洗车">快易洁洗车</option>
                            <option value="收钱吧">收钱吧</option>
                            <option value="车颜知己洗车">车颜知己洗车</option>
                            <option value="车海洋洗车">车海洋洗车</option>
                            <option value="微信">微信</option>
                            <option value="智小盟">智小盟</option>
                        </select>

                        <!-- 开始时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="zh-start-datetime" type="text" placeholder="开始时间" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="zh-start-date-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 结束时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="zh-end-datetime" type="text" placeholder="结束时间" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="zh-end-date-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runZhQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                            <button id="zh-export-btn" onclick="exportZhToExcel()" disabled style="background:#adb5bd; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:not-allowed;">导出 Excel</button>
                        </div>
                    </div>
                    
                    <!-- 查询结果 -->
                    <div id="zh-query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="zh-current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="zh-current-conditions-text" style="color: #6c757d;">请选择查询条件后点击查询</span>
                        </div>
                        <div id="zh-query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>
            
            <!-- 整体情况概要 -->
            <div class="overview-section">
                <h3 class="metric-section-title"><i class="fas fa-tachometer-alt"></i> 整体情况概要</h3>
                <div class="overview-grid" id="overview-grid">
                    <!-- 数据将由JavaScript动态填充 -->
                </div>
            </div>

                <h2 class="section-title"><i class="fas fa-charging-station"></i> 充电数据</h2>
                <!-- 充电数据指标板块 -->
                <div class="metrics-section" style="gap: 8px;">
    <!-- 本月充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-calendar-check"></i>
                本月充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="month-charge">205,673.95 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-electricity">¥177,408.03</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-service">¥64,784.97</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-orders">8,222</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                        
                       
                               <!-- 本年度充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-calendar-alt"></i>
                本年度充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="year-charge">3,395,628.58 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-electricity">¥2,878,714.66</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-service">¥963,642.56</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-orders">130,688</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                        
                                                      <!-- 累计充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-chart-line"></i>
                累计充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="total-charge">32,051,447.86 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-electricity">¥30,318,139.69</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-service">¥11,305,282.54</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-orders">1,235,906</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                    
               <!-- 站点数据统计板块 -->
<!-- 本月实时数据板块 -->
<h2 class="section-title"><i class="fas fa-chart-line"></i> 本月实时数据</h2>
<div class="metrics-section">
    <!-- 实时数据轮播表格 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-table"></i>
            本月日充电数据
        </div>
        <div class="realtime-table-container" id="realtime-table-container">
            <div class="data-loading" id="realtime-loading">
                <i class="fas fa-spinner fa-spin"></i> 正在加载实时数据，请稍候...
            </div>
            <table id="realtime-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>站点</th>
                        <th>充电量(kwh)</th>
                        <th>充电总收入(元)</th>   <!-- 新增这一列 -->
                        <th>充电服务费收入(元)</th>
                        <th>总订单数量</th>
                    </tr>
                </thead>
                <tbody id="realtime-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 实时数据图表 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            本月充电数据趋势
        </div>
        <div class="chart-wrapper">
            <canvas id="realtime-chart"></canvas>
        </div>
    </div>

    <!-- 未充电时长统计 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-clock"></i>
            未充电时长统计
            <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
                <select id="uncharged-duration-filter" style="padding: 5px;">
                    <option value="all">全部时长</option>
                    <option value="lt30">&lt;30小时</option>
                    <option value="ge30lt60">&gt;=30&lt;60小时</option>
                    <option value="ge60lt90">&gt;=60&lt;90小时</option>
                    <option value="ge90">&gt;=90小时</option>
                </select>
            </div>
        </div>
        <div class="uncharged-table-container" style="max-height: 400px; overflow-y: auto; border: none; border-radius: 8px;">
            <table id="uncharged-table" class="data-table" style="width: 100%; border-collapse: collapse; border: none;">
                <thead>
                    <tr>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">电站名称</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">终端名称</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">上一次充电结束时间</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">截止一直未充电时间</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">未充电时长(小时)</th>
                    </tr>
                </thead>
                <tbody id="uncharged-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
        <div class="data-info" style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 10px;">
            <div id="uncharged-data-info">共加载 0 条数据</div>
            <div id="uncharged-pagination">
                当前第 <span id="current-page">1</span> 页，共 <span id="total-pages">1</span> 页
                <select id="page-select" style="margin-left: 10px;">
                    <option value="1">1</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 数据可视化分析 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            数据可视化分析
        </div>
        
        <!-- 翻页控制 -->
        <div class="visualization-controls" style="margin-bottom: 20px; text-align: center;">
            <button id="prev-visualization-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px;">&lt;</button>
            <span id="visualization-date-display" style="padding: 8px 16px; background: transparent; color: #333; border: none; border-radius: 4px; font-size: 14px; min-width: 120px; text-align: center; display: inline-block;">加载中...</span>
            <button id="next-visualization-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;">&gt;</button>
        </div>
        
        <!-- 四个可视化图表 -->
        <div class="visualization-charts" style="display: flex; gap: 15px; flex-wrap: wrap;">
            <!-- 柱状图 - 站点充电数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">站点充电数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="station-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
            
            <!-- 折线图 - 电站终端数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">电站终端数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="terminal-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
            
            <!-- 饼图 - 车辆分类数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">车辆分类数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="vehicle-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
            
            <!-- 散点图 - 用户分类数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">用户分类数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="user-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户充电行为分析 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-users"></i>
            用户充电行为分析
        </div>
        <div class="user-behavior-controls" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <!-- 数据模式选择按钮 -->
                <button id="day-data-btn" class="data-mode-btn active" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px;">日数据</button>
                <button id="month-data-btn" class="data-mode-btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">月数据</button>
            </div>
        </div>
        
        
        <!-- 可视化图表 -->
        <div class="chart-wrapper" style="position: relative;">
            <div style="position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; align-items: center; gap: 10px;">
                <button id="prev-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&lt;</button>
                <span id="current-data-display" style="padding: 8px 12px; background: transparent; color: #333; border: none; border-radius: 4px; font-size: 12px; min-width: 80px; text-align: center;">加载中...</span>
                <button id="next-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&gt;</button>
            </div>
            <canvas id="behavior-chart"></canvas>
        </div>
        
        <!-- 尖峰平谷充电记录表格和饼图 -->
        <div class="electricity-analysis-container" style="margin-top: 20px; display: flex; gap: 20px;">
            <!-- 表格部分 - 缩小到一半 -->
            <div class="electricity-analysis-table" style="flex: 1;">
                <div style="margin-bottom: 10px; font-weight: bold; color: #333;">尖峰平谷充电记录</div>
                <table id="electricity-table" style="width: 100%; border-collapse: collapse; border: none;">
                    <thead>
                        <tr>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">站点</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">尖</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">峰</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">平</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">谷</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">小计</th>
                        </tr>
                    </thead>
                    <tbody id="electricity-table-body">
                        <!-- 数据将由JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 饼图部分 - 分为两个独立的饼图 -->
            <div class="electricity-pie-charts" style="flex: 1; display: flex; gap: 20px;">
                <!-- 四方坪站饼图 -->
                <div class="electricity-pie-chart-sfp" style="flex: 1;">
                    <div style="position: relative; height: 200px; width: 200px; margin: 0 auto;">
                        <canvas id="electricity-pie-chart-sfp"></canvas>
                    </div>
                    <!-- 四方坪站数字显示 -->
                    <div class="electricity-numbers-sfp" style="margin-top: 10px; text-align: center;">
                        <div style="display: flex; justify-content: space-around; flex-wrap: nowrap; gap: 5px; font-size: 12px;">
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #ff6b6b; font-weight: bold; font-size: 14px;">尖:</span>
                                <span id="sfp-jian-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-jian-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #ffa726; font-weight: bold; font-size: 14px;">峰:</span>
                                <span id="sfp-feng-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-feng-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #66bb6a; font-weight: bold; font-size: 14px;">平:</span>
                                <span id="sfp-ping-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-ping-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #42a5f5; font-weight: bold; font-size: 14px;">谷:</span>
                                <span id="sfp-gu-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-gu-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 高岭站饼图 -->
                <div class="electricity-pie-chart-gl" style="flex: 1;">
                    <div style="position: relative; height: 200px; width: 200px; margin: 0 auto;">
                        <canvas id="electricity-pie-chart-gl"></canvas>
                    </div>
                    <!-- 高岭站数字显示 -->
                    <div class="electricity-numbers-gl" style="margin-top: 10px; text-align: center;">
                        <div style="display: flex; justify-content: space-around; flex-wrap: nowrap; gap: 5px; font-size: 12px;">
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #e57373; font-weight: bold; font-size: 14px;">尖:</span>
                                <span id="gl-jian-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-jian-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #ffb74d; font-weight: bold; font-size: 14px;">峰:</span>
                                <span id="gl-feng-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-feng-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #81c784; font-weight: bold; font-size: 14px;">平:</span>
                                <span id="gl-ping-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-ping-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #64b5f6; font-weight: bold; font-size: 14px;">谷:</span>
                                <span id="gl-gu-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-gu-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 经营效率分析 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-bar"></i>
            经营效率分析
        </div>
        <div class="efficiency-controls" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <!-- 数据模式选择按钮 -->
                <button id="efficiency-day-data-btn" class="efficiency-data-mode-btn active" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px;">日数据</button>
                <button id="efficiency-month-data-btn" class="efficiency-data-mode-btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">月数据</button>
            </div>
        </div>
        
        <!-- 经营效率分析内容 -->
        <div style="display: flex; gap: 20px; margin-top: 0px;">
            <!-- 经营效率分析表格 -->
            <div class="efficiency-table-container" style="flex: 1; position: relative;">
                <!-- 翻页控件 -->
                <div style="position: absolute; top: -40px; right: 0; z-index: 10; display: flex; align-items: center; gap: 10px;">
                    <button id="efficiency-prev-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&lt;</button>
                    <span id="efficiency-current-data-display" style="padding: 8px 12px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; min-width: 80px; text-align: center;">加载中...</span>
                    <button id="efficiency-next-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&gt;</button>
                </div>
                <table id="efficiency-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead>
                        <tr>
                            <th style="text-align: center; padding: 12px 8px; background-color: #007bff; color: white; border: 1px solid #e0e0e0; width: 30%;">指标</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: #007bff; color: white; border: 1px solid #e0e0e0; width: 35%;">四方坪站</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: #007bff; color: white; border: 1px solid #e0e0e0; width: 35%;">高岭站</th>
                        </tr>
                    </thead>
                    <tbody id="efficiency-table-body">
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均充电时长(分钟)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-duration">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-duration">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均利用率</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-utilization">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-utilization">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均充电电量(kwh)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-energy">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-energy">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均充电收益(元)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-revenue">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-revenue">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">平均每小时充电功率(kw)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-power">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-power">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">单枪日均充电次数</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-times">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-times">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 雷达图容器 -->
            <div class="efficiency-chart-container" style="flex: 1;">
                <div style="height: 400px; position: relative; margin-top: -90px;">
                    <canvas id="efficiency-radar-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
 
               <!-- 站点数据统计板块 -->
<div class="site-stats-section">
    <h2 class="section-title"><i class="fas fa-chart-bar"></i> 站点数据统计</h2>
    <div class="site-stats-container">
        <!-- 控制按钮区域 -->
        <div class="stats-controls">
            <div class="data-mode-buttons">
                <button class="mode-btn active" data-mode="month">月份数据</button>
                <button class="mode-btn" data-mode="year">年份数据</button>
                <button class="mode-btn" data-mode="total">总数据</button>
            </div>
            <div class="pagination-controls">
                <button class="page-btn" id="prev-btn" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="page-info" id="page-info">2024-01</span>
                <button class="page-btn" id="next-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <!-- 数据展示区域 -->
        <div class="stats-data-container">
            <!-- 四方坪站数据 -->
            <div class="site-data-section">
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电电量(kwh)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="sifang-charge-progress">
                            <div class="progress-fill" id="sifang-charge-fill"></div>
                        </div>
                        <span class="progress-value" id="sifang-charge-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name">四方坪站</div>
                    <div class="data-label">充电服务费(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="sifang-service-progress">
                            <div class="progress-fill" id="sifang-service-fill"></div>
                        </div>
                        <span class="progress-value" id="sifang-service-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电总收入(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="sifang-total-progress">
                            <div class="progress-fill" id="sifang-total-fill"></div>
                        </div>
                        <span class="progress-value" id="sifang-total-value">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 高岭站数据 -->
            <div class="site-data-section">
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电电量(kwh)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="gaoling-charge-progress">
                            <div class="progress-fill" id="gaoling-charge-fill"></div>
                        </div>
                        <span class="progress-value" id="gaoling-charge-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name">高岭站</div>
                    <div class="data-label">充电服务费(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="gaoling-service-progress">
                            <div class="progress-fill" id="gaoling-service-fill"></div>
                        </div>
                        <span class="progress-value" id="gaoling-service-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电总收入(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="gaoling-total-progress">
                            <div class="progress-fill" id="gaoling-total-fill"></div>
                        </div>
                        <span class="progress-value" id="gaoling-total-value">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 两站共计数据 -->
            <div class="site-data-section">
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电电量(kwh)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="total-charge-progress">
                            <div class="progress-fill" id="total-charge-fill"></div>
                        </div>
                        <span class="progress-value" id="total-charge-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name">两站共计</div>
                    <div class="data-label">充电服务费(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="total-service-progress">
                            <div class="progress-fill" id="total-service-fill"></div>
                        </div>
                        <span class="progress-value" id="total-service-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电总收入(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="total-total-progress">
                            <div class="progress-fill" id="total-total-fill"></div>
                        </div>
                        <span class="progress-value" id="total-total-value">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

               <!-- 充电数据看板 -->
<h2 class="section-title"><i class="fas fa-charging-station"></i> 充电数据看板</h2>
<div class="metrics-section">
    <!-- 第一部分：数据表格 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-table"></i>
            充电数据表格
            <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
                <select id="year-select" style="padding: 5px;">
                    <!-- 年份选项将由JavaScript动态生成 -->
                </select>
                <button class="export-btn" id="export-board-btn">
                    <i class="fas fa-file-excel"></i>
                    <span>导出数据</span>
                </button>
            </div>
        </div>
        <div class="table-container" id="charging-board-table-container">
            <table id="charging-board-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>充电量(kwh)</th>
                        <th>充电电费(元)</th>
                        <th>充电服务费(元)</th>
                        <th>充电总收入(元)</th>
                        <th>总订单数量</th>
                    </tr>
                </thead>
                <tbody id="charging-board-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 第二部分：可视化图表 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            充电数据趋势
        </div>
        <div class="chart-wrapper">
            <canvas id="charging-board-chart"></canvas>
        </div>
    </div>
</div>
                    
                    <!-- 充电数据总趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            充电数据总趋势 (2018-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="charging-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <h2 class="section-title"><i class="fas fa-chart-line"></i> 综合业务数据</h2>
                <!-- 综合数据板块 -->
                <div class="metrics-section">
                    <div class="metrics-row">
                        <div class="metric-card">
                            <div class="metric-card-title">
                                <i class="fas fa-money-bill-wave"></i>
                                综合收入数据
                            </div>
                            <!-- 修改为三列布局 -->
                            <div class="income-grid">
                                <div class="metric-item">
                                    <div class="metric-value" id="month-income">¥43,435.85</div>
                                    <div class="metric-label">上期总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="year-income">¥375,153.84</div>
                                    <div class="metric-label">本年度总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="total-income">¥2,564,822.21</div>
                                    <div class="metric-label">累计总收入</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                  <!-- 综合收入看板 -->
<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-chart-bar"></i>
        综合收入看板
        <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
            <select id="income-year-select" class="form-select">
                <!-- 年份选项将由JavaScript动态生成 -->
            </select>
            <button id="income-export-btn" class="chart-action-btn">
                <i class="fas fa-download"></i> 导出数据
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table id="income-table" class="data-table">
            <thead>
                <tr>
                    <!-- 表头将由JavaScript动态生成 -->
                </tr>
            </thead>
            <tbody>
                <!-- 表格数据将通过JavaScript动态加载 -->
            </tbody>
        </table>
    </div>
    <div class="chart-wrapper" style="margin-top: 20px;">
        <canvas id="income-dashboard-chart"></canvas>
    </div>
</div>  
                                     
                    <!-- 各版块收入汇总图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            各版块收入汇总 (2023-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenue-by-sector-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                    
                    <!-- 年度总收入趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            年度总收入趋势 (2018-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="annual-revenue-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <!-- 查询板块 -->
                <div class="query-section">
                    <h2 class="section-title"><i class="fas fa-search"></i> 数据查询</h2>
                    <div class="query-form" id="data-query-form">
                        <div class="form-group date-picker-container" style="flex: 0 0 18%;">
                           <label for="start-date">开始日期</label>
        <input type="text" id="start-date" placeholder="选择开始日期" style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
        <div class="custom-picker" id="start-date-picker" style="width: 100%;">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button type="button" class="year-btn prev-year" aria-label="上一年">‹</button>
                                            <div class="year-display" id="start-year-display">2025</div>
                                            <button type="button" class="year-btn next-year" aria-label="下一年">›</button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="start-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group date-picker-container" style="flex: 0 0 18%;">
                             <label for="end-date">结束日期</label>
        <input type="text" id="end-date" placeholder="选择结束日期" style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
        <div class="custom-picker" id="end-date-picker" style="width: 100%;">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button type="button" class="year-btn prev-year" aria-label="上一年">‹</button>
                                            <div class="year-display" id="end-year-display">2025</div>
                                            <button type="button" class="year-btn next-year" aria-label="下一年">›</button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="end-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="flex: 0 0 18%;">
                            <label for="data-type">数据类型</label>
        <select id="data-type" style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
            <option value="charging">充电数据</option>
            <option value="comprehensive">综合数据</option>
        </select>
    </div>
                        
                        <div class="btn-group" style="flex: 0 0 auto; display: flex; gap: 8px; align-items: center;">
                           <button class="query-btn" id="query-btn" style="margin-bottom: 0;">
            <span class="spinner"></span>
            <i class="fas fa-search"></i>
            <span>查询数据</span>
        </button>
        <button class="export-btn" id="report-export-btn" disabled style="margin-bottom: 0;">
            <i class="fas fa-file-excel"></i>
            <span>导出Excel</span>
        </button>
    </div>
</div>
                    <div class="query-info" id="query-info" style="margin-top: 2px; padding: 4px;">
                        <i class="fas fa-info-circle"></i> 
                        请选择日期和数据类型来查询数据
                    </div>
                </div>
                
                <h2 class="section-title"><i class="fas fa-table"></i> 数据报表</h2>
                <!-- Excel 表格区域 -->
                <div class="excel-section" id="report-section">
                    <div class="excel-header">
                        <h3 class="metric-section-title"><i class="fas fa-table"></i> 充电数据报表</h3>
                        <div id="file-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="data-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="table-container">
                        <!-- Excel表格将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>场站名称</th>
                                    <th>充电量(kwh)</th>
                                    <th>服务车辆(辆)</th>
                                    <th>收入(元)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="row-count">共加载 0 行数据</div>
                        <div id="last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>
                
                <!-- 综合数据报表 -->
                <div class="comprehensive-section">
                    <div class="comprehensive-header">
                        <h3 class="metric-section-title"><i class="fas fa-chart-pie"></i> 综合数据报表</h3>
                        <div id="comprehensive-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="comprehensive-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载综合数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="comprehensive-table-container">
                        <!-- 综合数据报表将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th>四方坪站</th>
                                    <th>高岭站</th>
                                    <th>合计</th>
                                    <th>同比增长</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="comprehensive-row-count">共加载 0 行数据</div>
                        <div id="comprehensive-last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 页脚 -->
        <footer>
            © 2025 长沙飞狐电动汽车充电服务有限公司 | 新能源充电站数据管理平台
        </footer>
    </div>

    <!-- 在body结束前添加版权信息 -->
    <div class="footer-copyright" id="login-footer-copyright">
        <p>© 2018-2025 长沙飞狐电动汽车充电服务有限公司</p>
    </div>

    <script>
        // LeanCloud 配置
        const APP_ID = 'YTZnYJZLrOLM1iUgi3hyF3LX-gzGzoHsz';
        const APP_KEY = 'gd1zSY9FVQdpBwdmNhn91RUT';
        const SERVER_URL = 'https://api.leancloud.cn';
        
        // 删除旧的LEANCLOUD_APP_URL配置
        
        // 初始化 LeanCloud
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });
        
        console.log('LeanCloud 初始化完成:', {
            appId: APP_ID,
            serverURL: SERVER_URL
        });
        
        // 登录记录相关函数
        // 记录用户登录
        async function recordUserLogin(username, additionalData = {}) {
            try {
                console.log('开始记录登录:', username);
                
                // 获取真实IP地址
                console.log('正在获取IP地址...');
                const clientIP = await getClientIP();
                console.log('获取到IP地址:', clientIP);
                
                // 直接使用LeanCloud数据存储
                const LoginRecord = AV.Object.extend('LoginRecord');
                const loginRecord = new LoginRecord();
                
                // 设置ACL权限，允许公开读写
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                loginRecord.setACL(acl);
                
                loginRecord.set('user_name', username);  // 改用user_name避免与系统字段冲突
                loginRecord.set('username', username);  // 保留原字段作为备份
                loginRecord.set('loginTime', new Date());
                loginRecord.set('userAgent', navigator.userAgent);
                loginRecord.set('deviceInfo', getDeviceInfo());
                loginRecord.set('page', window.location.href);
                loginRecord.set('ipAddress', clientIP); // 使用真实IP地址
                loginRecord.set('sessionId', 'web_session_' + Date.now());
                
                // 添加额外数据
                Object.keys(additionalData).forEach(key => {
                    loginRecord.set(key, additionalData[key]);
                });
                
                console.log('准备保存登录记录到LeanCloud...');
                console.log('用户名参数:', username);
                console.log('登录记录对象详情:', {
                    username: loginRecord.get('username'),
                    loginTime: loginRecord.get('loginTime'),
                    ipAddress: loginRecord.get('ipAddress'),
                    userAgent: loginRecord.get('userAgent'),
                    deviceInfo: loginRecord.get('deviceInfo')
                });
				const savedRecord = await loginRecord.save();
                console.log('✅ 登录记录成功保存到LeanCloud！记录ID:', savedRecord.id);
				// 记录最近一次登录记录ID，便于快速更新logoutTime
				try {
					window.__lastLoginRecordId = savedRecord.id;
					localStorage.setItem('lastLoginRecordId', savedRecord.id);
				} catch (e) {
					console.warn('无法保存lastLoginRecordId到本地存储:', e);
				}
                
                // 验证数据是否真的保存了
                try {
                    const verifyQuery = new AV.Query('LoginRecord');
                    const verifyRecord = await verifyQuery.get(savedRecord.id);
                    console.log('📋 验证保存成功，记录详情:', {
                        id: verifyRecord.id,
                        username: verifyRecord.get('username'),
                        loginTime: verifyRecord.get('loginTime'),
                        ipAddress: verifyRecord.get('ipAddress')
                    });
                } catch (verifyError) {
                    console.error('❌ 验证保存失败:', verifyError);
                }
                
                return {
                    success: true,
                    recordId: savedRecord.id,
                    loginTime: savedRecord.get('loginTime'),
                    ipAddress: clientIP,
                    message: '登录记录已保存'
                };
                
            } catch (error) {
                console.error('❌ 记录登录失败:', error);
                console.error('错误详情:', error.message, error.code);
                // 不抛出错误，避免影响正常登录流程
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // 获取用户登录历史
        async function getUserLoginHistory(username, limit = 10) {
            try {
                console.log('获取登录历史:', username);
                
                const query = new AV.Query('LoginRecord');
                query.equalTo('username', username);
                query.descending('loginTime');
                query.limit(limit);
                
                const records = await query.find();
                
                const loginHistory = records.map(record => ({
                    id: record.id,
                    username: record.get('username'),
                    loginTime: record.get('loginTime'),
                    userAgent: record.get('userAgent'),
                    ipAddress: record.get('ipAddress'),
                    deviceInfo: record.get('deviceInfo'),
                    page: record.get('page')
                }));
                
                console.log('获取登录历史成功:', loginHistory.length, '条记录');
                
                return {
                    success: true,
                    records: loginHistory,
                    total: loginHistory.length
                };
                
            } catch (error) {
                console.error('获取登录历史失败:', error);
                return {
                    success: false,
                    error: error.message,
                    records: []
                };
            }
        }
        
        // 获取客户端IP地址
        async function getClientIP() {
            try {
                // 方法1: 使用免费的IP查询服务
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.warn('获取IP地址失败，使用备用方法:', error);
                try {
                    // 方法2: 使用备用服务
                    const response = await fetch('https://httpbin.org/ip');
                    const data = await response.json();
                    return data.origin.split(',')[0].trim();
                } catch (error2) {
                    console.warn('备用IP服务也失败:', error2);
                    // 方法3: 使用WebRTC获取本地IP（可能被阻止）
                    return await getLocalIP();
                }
            }
        }
		// 添加记录用户登出信息的函数
		async function recordUserLogout(username) {
            try {
                console.log('开始记录登出信息:', username);

				// 优先使用本地缓存的最近一次登录记录ID，避免查询耗时导致未能及时保存
				let cachedRecordId = null;
				try {
					cachedRecordId = window.__lastLoginRecordId || localStorage.getItem('lastLoginRecordId');
				} catch (e) {
					console.warn('读取本地lastLoginRecordId失败:', e);
				}

				if (cachedRecordId) {
					try {
						const loginRecord = AV.Object.createWithoutData('LoginRecord', cachedRecordId);
						loginRecord.set('logoutTime', new Date());
						await loginRecord.save();
						console.log('✅ 通过缓存ID快速更新登出时间成功，记录ID:', cachedRecordId);
						return {
							success: true,
							recordId: cachedRecordId,
							message: '登出信息已记录'
						};
					} catch (fastUpdateError) {
						console.warn('通过缓存ID更新登出时间失败，回退到查询方式:', fastUpdateError);
					}
				}
                
                // 查询当前用户的最新登录记录
                const query = new AV.Query('LoginRecord');
                query.equalTo('username', username);
                query.descending('loginTime');
                query.limit(1);
                
                const records = await query.find();
                
                if (records.length > 0) {
                    const loginRecord = records[0];
                    
					// 更新登出时间
					loginRecord.set('logoutTime', new Date());
                    
                    // 保存更新
                    await loginRecord.save();
                    console.log('✅ 登出信息记录成功，记录ID:', loginRecord.id);
					// 清除本地缓存的记录ID，避免重复更新
					try {
						if (window.__lastLoginRecordId === loginRecord.id) {
							window.__lastLoginRecordId = null;
						}
						localStorage.removeItem('lastLoginRecordId');
					} catch (e) {
						console.warn('清理lastLoginRecordId失败:', e);
					}
					// 清除登录状态
					clearLoginStatus();
                    
                    return {
                        success: true,
                        recordId: loginRecord.id,
                        message: '登出信息已记录'
                    };
                } else {
                    console.warn('未找到用户的登录记录');
                    return {
                        success: false,
                        error: '未找到登录记录'
                    };
                }
            } catch (error) {
                console.error('❌ 记录登出信息失败:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // 通过WebRTC获取本地IP地址
        async function getLocalIP() {
            return new Promise((resolve) => {
                try {
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);
                            if (ipMatch) {
                                pc.close();
                                resolve(ipMatch[1]);
                            }
                        }
                    };
                    
                    // 超时处理
                    setTimeout(() => {
                        pc.close();
                        resolve('未知IP');
                    }, 3000);
                } catch (error) {
                    console.warn('WebRTC获取IP失败:', error);
                    resolve('未知IP');
                }
            });
        }
        
        // 检查用户是否被授权的函数
        async function checkUserAuthorization(username) {
            try {
                // 使用HTTP请求查询leanengine-demo应用的AuthorizedUsers表
                const authUrl = 'https://api.leancloud.cn/1.1/classes/AuthorizedUsers';
                const authResponse = await fetch(authUrl, {
                    method: 'GET',
                    headers: {
                        'X-LC-Id': 'N4KUUvF2eY8wOG0sF5oddkdC-gzGzoHsz', // leanengine-demo应用ID
                        'X-LC-Key': 'xtsTJ4R0uMAJCjCJJvNcwsHt', // leanengine-demo应用Key
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!authResponse.ok) {
                    console.error('查询授权表失败:', authResponse.status, authResponse.statusText);
                    return false;
                }
                
                const authData = await authResponse.json();
                console.log('授权表查询结果:', authData);
                
                // 检查用户名是否在授权列表中
                const isAuthorized = authData.results && authData.results.some(user => user.username === username);
                return isAuthorized;
                
            } catch (error) {
                console.error('检查用户授权失败:', error);
                // 查询失败时拒绝授权，确保安全
                return false;
            }
        }
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            
            let device = 'Desktop';
            if (/Mobile|Android|iPhone|iPod|BlackBerry|IEMobile/.test(ua)) {
                device = 'Mobile';
            } else if (/Tablet|iPad/.test(ua)) {
                device = 'Tablet';
            }
        
            let browser = 'Unknown';
            if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
            else if (ua.includes('Edge')) browser = 'Edge';
        
            return `${device} - ${browser}`;
        }

        
        // 获取DOM元素
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const resetForm = document.getElementById('resetForm');
        const loginMessage = document.getElementById('loginMessage');
        
        const showReset = document.getElementById('showReset');
        const showRegister = document.getElementById('showRegister');
        const showSmsLogin = document.getElementById('showSmsLogin');
        const backToLoginFromRegister = document.getElementById('backToLoginFromRegister');
        const backToLoginFromReset = document.getElementById('backToLoginFromReset');
        const backToLoginFromSms = document.getElementById('backToLoginFromSms');
        
        // 表单切换
        showReset.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            resetForm.style.display = 'block';
            registerForm.style.display = 'none';
            hideMessage();
            // 修改标题为"密码重置"
            document.getElementById('form-title').textContent = '密码重置';
            // 修改图标为钥匙图标
            document.querySelector('#login-container .logo i').className = 'fas fa-key';
        });
        
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            resetForm.style.display = 'none';
            registerForm.style.display = 'block';
            document.getElementById('smsLoginForm').style.display = 'none';
            hideMessage();
            // 修改标题为"新用户注册"
            document.getElementById('form-title').textContent = '新用户注册';
            // 修改图标为用户添加图标
            document.querySelector('#login-container .logo i').className = 'fas fa-user-plus';
        });
        
        showSmsLogin.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            resetForm.style.display = 'none';
            registerForm.style.display = 'none';
            document.getElementById('smsLoginForm').style.display = 'block';
            hideMessage();
            // 修改标题为"短信验证码登录"
            document.getElementById('form-title').textContent = '短信验证码登录';
            // 修改图标为手机图标
            document.querySelector('#login-container .logo i').className = 'fas fa-mobile-alt';
        });
        
        backToLoginFromRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'block';
            resetForm.style.display = 'none';
            registerForm.style.display = 'none';
            document.getElementById('smsLoginForm').style.display = 'none';
            hideMessage();
            // 修改标题为"用户登录"
            document.getElementById('form-title').textContent = '用户登录';
            // 重置图标为登录图标
            document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
        });
        
        backToLoginFromReset.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'block';
            resetForm.style.display = 'none';
            registerForm.style.display = 'none';
            document.getElementById('smsLoginForm').style.display = 'none';
            hideMessage();
            // 修改标题为"用户登录"
            document.getElementById('form-title').textContent = '用户登录';
            // 重置图标为登录图标
            document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
        });
        
        backToLoginFromSms.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'block';
            resetForm.style.display = 'none';
            registerForm.style.display = 'none';
            document.getElementById('smsLoginForm').style.display = 'none';
            hideMessage();
            // 修改标题为"用户登录"
            document.getElementById('form-title').textContent = '用户登录';
            // 重置图标为登录图标
            document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
        });
        
        // 显示消息
        function showMessage(message, type) {
            loginMessage.textContent = message;
            loginMessage.className = 'message ' + type;
            loginMessage.style.display = 'block';
        }
        
        // 隐藏消息
        function hideMessage() {
            loginMessage.style.display = 'none';
        }
        
        // 登录处理
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // 首先检查用户是否被授权
                const isAuthorized = await checkUserAuthorization(username);
                if (!isAuthorized) {
                    showMessage('登录失败: 该用户未获得访问授权！', 'error');
                    return;
                }
                
                // 如果用户被授权，尝试登录
                const user = await AV.User.logIn(username, password);
                showMessage(`登录成功！欢迎回来，${user.getUsername()}`, 'success');
                
                console.log('登录成功，开始记录登录信息...');
                console.log('获取到的用户名:', user.getUsername());
                console.log('用户对象详情:', user.toJSON());
                
                // 保存登录状态
                saveLoginStatus(user.getUsername(), 'web_form');
                
                // 立即隐藏登录框并显示主页面
                showMainPage(user.getUsername());
                
                // 在后台记录登录信息，不影响用户界面响应
                try {
                    const loginResult = await recordUserLogin(user.getUsername(), {
                        loginMethod: 'web_form',
                        timestamp: new Date().toISOString()
                    });
                    if (loginResult && loginResult.success) {
                        console.log('✅ 登录记录成功！记录ID:', loginResult.recordId);
                    } else {
                        console.warn('⚠️ 登录记录失败:', loginResult ? loginResult.error : '未知错误');
                    }
                } catch (recordError) {
                    console.error('❌ 登录记录出错:', recordError);
                }
                
            } catch (error) {
                console.error('登录错误:', error);
                // 根据错误类型提供更友好的提示
                if (error.code === 211) {
                    showMessage('登录失败: 用户名或密码错误', 'error');
                } else if (error.code === 210) {
                    showMessage('登录失败: 用户名或密码错误', 'error');
                } else if (error.code === 219) {
                    showMessage('登录失败: 登录信息无效', 'error');
                } else {
                    showMessage(`登录失败: ${error.message}`, 'error');
                }
            }
        });
        
        // 注册处理
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value;
            
            try {
                // 首先检查用户是否被授权
                const isAuthorized = await checkUserAuthorization(username);
                if (!isAuthorized) {
                    showMessage('注册失败: 该用户未获得授权！', 'error');
                    return;
                }
                
                // 如果用户被授权，则尝试创建账户
                const user = new AV.User();
                user.setUsername(username);
                user.setPassword(password);
                user.setEmail(email);
                
                await user.signUp();
                showMessage('账户创建成功！请使用新账户登录。', 'success');
                
                // 自动切换回登录表单
                setTimeout(() => {
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = '';
                }, 2000);
                
            } catch (error) {
                console.error('注册错误:', error);
                if (error.code === 202) {
                    showMessage('注册失败: 该用户名已经存在，请直接使用登录功能', 'error');
                } else if (error.code === 203) {
                    showMessage('注册失败: 该邮箱已经被使用', 'error');
                } else if (error.code === 137) {
                    showMessage('注册失败: 用户名格式不正确', 'error');
                } else {
                    showMessage(`注册失败: ${error.message}`, 'error');
                }
            }
        });
        
        // 重置密码处理
        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            
            try {
                await AV.User.requestPasswordReset(email);
                showMessage('密码重置邮件已发送，请检查您的邮箱。', 'success');
                
                // 自动切换回登录表单
                setTimeout(() => {
                    loginForm.style.display = 'block';
                    resetForm.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('密码重置错误:', error);
                showMessage(`密码重置失败: ${error.message}`, 'error');
            }
        });
        
        // 短信验证码登录处理
        const smsLoginForm = document.getElementById('smsLoginForm');
        const sendSmsCodeBtn = document.getElementById('sendSmsCode');
        const smsPhoneInput = document.getElementById('smsPhone');
        const smsCodeInput = document.getElementById('smsCode');
        
        // 发送验证码
        sendSmsCodeBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const phone = smsPhoneInput.value.trim();
            
            // 验证手机号格式
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                showMessage('请输入正确的手机号码', 'error');
                return;
            }
            
            try {
                showMessage('正在发送验证码...', 'info');
                sendSmsCodeBtn.disabled = true;
                sendSmsCodeBtn.textContent = '发送中...';
                
                // 调用LeanCloud云函数发送短信
                const result = await AV.Cloud.run('sendSmsCode', {
                    phone: phone
                });
                
                if (result.success) {
                    showMessage('验证码已发送，请查收短信', 'success');
                    startCountdown();
                } else {
                    showMessage(result.message || '发送失败，请重试', 'error');
                    sendSmsCodeBtn.disabled = false;
                    sendSmsCodeBtn.textContent = '发送验证码';
                }
                
            } catch (error) {
                console.error('发送验证码错误:', error);
                showMessage('发送失败，请重试', 'error');
                sendSmsCodeBtn.disabled = false;
                sendSmsCodeBtn.textContent = '发送验证码';
            }
        });
        
        // 短信验证码登录提交
        smsLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const phone = smsPhoneInput.value.trim();
            const code = smsCodeInput.value.trim();
            
            if (!phone || !code) {
                showMessage('请填写手机号和验证码', 'error');
                return;
            }
            
            try {
                showMessage('正在验证...', 'info');
                
                // 调用LeanCloud云函数验证短信验证码
                const result = await AV.Cloud.run('verifySmsCode', {
                    phone: phone,
                    code: code
                });
                
                if (result.success) {
                    showMessage('登录成功！欢迎回来', 'success');
                    
                    // 创建用户对象并设置为当前用户，确保登出记录能正常工作
                    const user = new AV.User();
                    user.set('username', phone);
                    user.set('mobilePhoneNumber', phone);
                    user.set('loginMethod', 'sms');
                    // 设置用户为当前用户，这样登出时能正确获取用户信息
                    AV.User.current = () => user;
                    
                    // 保存登录状态
                    saveLoginStatus(phone, 'sms', phone);
                    
                    // 记录登录
                    await recordUserLogin(phone, {
                        loginMethod: 'sms',
                        phone: phone
                    });
                    
                    // 隐藏登录容器，显示主页面
                    setTimeout(() => {
                        showMainPage(phone);
                    }, 1000);
                    
                } else {
                    showMessage(result.message || '验证失败，请检查验证码', 'error');
                }
                
            } catch (error) {
                console.error('短信验证码登录错误:', error);
                showMessage('登录失败，请重试', 'error');
            }
        });
        // 倒计时功能
        function startCountdown() {
            let countdown = 60;
            sendSmsCodeBtn.textContent = `${countdown}秒后重发`;
            sendSmsCodeBtn.classList.add('countdown');
            
            const timer = setInterval(() => {
                countdown--;
                sendSmsCodeBtn.textContent = `${countdown}秒后重发`;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    sendSmsCodeBtn.disabled = false;
                    sendSmsCodeBtn.textContent = '发送验证码';
                    sendSmsCodeBtn.classList.remove('countdown');
                }
            }, 1000);
        }
        
        // 初始化主页面系统函数
        function initMainSystem() {
            // 初始化移动端菜单
            initMobileMenu();
            
            // 初始化菜单点击事件
            initMenuEvents();
            
            // 初始化日期选择器
            initDatePickers();
            
            // 初始化自定义日期选择器
            initCustomDatePickers();
            
            // 加载默认数据
            loadDefaultData();

            // 初始化图表
            initCharts();
            
            // 启动顶部时间刷新
            startClock();
            
            // 加载指标数据
            loadMetricsData();

            // 加载综合收入看板数据
            loadIncomeDashboardData();

            // 加载站点数据统计
            loadSiteStatsData();
            
            // 加载充电数据看板
            loadChargingBoardData();
            initChargingBoardExport();
            
            // 加载实时数据
            loadRealtimeData();
            
            // 加载未充电时长统计数据
            loadUnchargedData();
            
			// 添加页面关闭相关事件监听器，尽量在卸载前完成登出记录
			window.addEventListener('beforeunload', handlePageUnload);
			// 当页面变为隐藏状态时（切到后台或关闭前），优先尝试记录登出
			document.addEventListener('visibilitychange', async () => {
				try {
					const currentUser = AV.User.current();
					if (document.hidden && currentUser && !window.__logoutRecordingInProgress) {
						window.__logoutRecordingInProgress = true;
						await recordUserLogout(currentUser.getUsername());
					}
				} finally {
					window.__logoutRecordingInProgress = false;
				}
			});
			// Safari等浏览器更可靠的卸载事件
			window.addEventListener('pagehide', async () => {
				try {
					const currentUser = AV.User.current();
					if (currentUser && !window.__logoutRecordingInProgress) {
						window.__logoutRecordingInProgress = true;
						await recordUserLogout(currentUser.getUsername());
					}
				} finally {
					window.__logoutRecordingInProgress = false;
				}
			});
        }
        
        // 处理页面关闭事件
        async function handlePageUnload(event) {
            // 清理会话超时计时器
            if (sessionTimeoutTimer) {
                clearTimeout(sessionTimeoutTimer);
                sessionTimeoutTimer = null;
            }
            
            // 获取当前登录用户
            const currentUser = AV.User.current();
            if (currentUser) {
                console.log('页面即将关闭，记录用户登出信息...');
                
                // 记录登出信息
                try {
                    const logoutResult = await recordUserLogout(currentUser.getUsername());
                    if (logoutResult.success) {
                        console.log('✅ 用户登出信息记录成功');
                    } else {
                        console.warn('⚠️ 用户登出信息记录失败:', logoutResult.error);
                    }
                } catch (error) {
                    console.error('❌ 记录登出信息时出错:', error);
                }
            }
        }
        
        // 初始化菜单事件
        function initMenuEvents() {
            // 可以在这里添加其他菜单事件
            console.log('菜单事件已初始化');
        }


        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                });
                
                // 点击主内容区域时关闭菜单
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.addEventListener('click', function() {
                        sidebar.classList.remove('mobile-open');
                    });
                }
                
                // 监听窗口尺寸变化，自动显示/隐藏移动端菜单按钮
                function checkMobileView() {
                    if (window.innerWidth <= 900) {
                        mobileMenuToggle.style.display = 'block';
                    } else {
                        mobileMenuToggle.style.display = 'none';
                        sidebar.classList.remove('mobile-open');
                    }
                }
                
                // 初始检查
                checkMobileView();
                
                // 监听窗口尺寸变化
                window.addEventListener('resize', checkMobileView);
            }
        }
        
        // 主页面相关变量
        const mainContainer = document.getElementById('main-container');
        const userDisplay = document.getElementById('user-display');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dataTypeSelect = document.getElementById('data-type');
        const queryBtn = document.getElementById('query-btn');
        const exportBtn = document.getElementById('report-export-btn');
        const queryInfo = document.getElementById('query-info');
        const tableContainer = document.getElementById('table-container');
        const dataLoading = document.getElementById('data-loading');
        const fileInfo = document.getElementById('file-info');
        const rowCount = document.getElementById('row-count');
        const lastUpdate = document.getElementById('last-update');
        
        // 综合数据报表元素
        const comprehensiveTableContainer = document.getElementById('comprehensive-table-container');
        const comprehensiveLoading = document.getElementById('comprehensive-loading');
        const comprehensiveInfo = document.getElementById('comprehensive-info');
        const comprehensiveRowCount = document.getElementById('comprehensive-row-count');
        const comprehensiveLastUpdate = document.getElementById('comprehensive-last-update');
        
        // 功能提示弹窗元素
        const featurePopup = document.getElementById('feature-popup');
        const closePopup = document.getElementById('close-popup');
        const confirmPopup = document.getElementById('confirm-popup');
        const popupContent = document.getElementById('popup-content');
        
        // 当前加载的Excel数据
        let currentExcelData = null;
        let currentFileName = '';
        let currentDataType = 'charging';
        let defaultChargingData = null;
        let defaultComprehensiveData = null;
        let defaultChargingFileName = '';
        let defaultComprehensiveFileName = '';
        
        // 导出相关变量
        let currentExportData = null;
        let currentExportFileName = '';
        let currentExportDataType = '';
        
        // 自定义日期选择器变量
        let startYear = 2025;
        let startMonth = null;
        let endYear = 2025;
        let endMonth = null;

        
        // 图表实例
        let chargingChart = null;
        let incomeChart = null;
        let chargingTrendChart = null;
        let revenueBySectorChart = null;
        let annualRevenueTrendChart = null;
        let electricityPieChart = null; // 尖峰平谷饼图（已废弃）
        let electricityPieChartSFP = null; // 四方坪站尖峰平谷饼图
        let electricityPieChartGL = null; // 高岭站尖峰平谷饼图
        
        // GitHub数据文件URL
        const metricsDataUrl = 'https://www.csfhcdz.cn/data/homepage.xlsx';
        
        // 显示功能提示弹窗
        function showFeaturePopup(message) {
            popupContent.textContent = message;
            featurePopup.style.display = 'block';
        }
        
        // 关闭功能提示弹窗
        function closeFeaturePopup() {
            featurePopup.style.display = 'none';
        }
        
        // 调整工作表范围以仅包含有数据的部分
        function adjustSheetRange(worksheet) {
            if (!worksheet['!ref']) return;
            
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            let minRow = range.s.r;
            let maxRow = range.e.r;
            let minCol = range.s.c;
            let maxCol = range.e.c;
            
            let firstRow = maxRow;
            let lastRow = minRow;
            let firstCol = maxCol;
            let lastCol = minCol;
            
            // 遍历工作表中所有的单元格地址
            Object.keys(worksheet).forEach(address => {
                if (address[0] !== '!') { // 跳过特殊属性
                    const cellAddress = XLSX.utils.decode_cell(address);
                    // 更新实际有数据的行和列范围
                    if (cellAddress.r < firstRow) firstRow = cellAddress.r;
                    if (cellAddress.r > lastRow) lastRow = cellAddress.r;
                    if (cellAddress.c < firstCol) firstCol = cellAddress.c;
                    if (cellAddress.c > lastCol) lastCol = cellAddress.c;
                }
            });
            
            // 如果找到了有效的数据范围，则更新worksheet的!ref
            if (firstRow <= lastRow && firstCol <= lastCol) {
                const newRange = { s: { r: firstRow, c: firstCol }, e: { r: lastRow, c: lastCol } };
                worksheet['!ref'] = XLSX.utils.encode_range(newRange);
            }
        }
        
        // 初始化自定义日期选择器
        function initCustomDatePickers() {
            const now = new Date();
            startYear = now.getFullYear();
            endYear = now.getFullYear();
            
            // 生成月份网格
            const months = ['一月', '二月', '三月', '四月', '五月', '六月', 
                            '七月', '八月', '九月', '十月', '十一月', '十二月'];
            
            const startMonthGrid = document.getElementById('start-month-grid');
            const endMonthGrid = document.getElementById('end-month-grid');
            
            months.forEach((month, index) => {
                const startBtn = document.createElement('button');
                startBtn.className = 'month-btn';
                startBtn.textContent = month;
                startBtn.dataset.month = index + 1;
                startBtn.addEventListener('click', function() {
                    selectMonth('start', index + 1);
                });
                startMonthGrid.appendChild(startBtn);
                
                const endBtn = document.createElement('button');
                endBtn.className = 'month-btn';
                endBtn.textContent = month;
                endBtn.dataset.month = index + 1;
                endBtn.addEventListener('click', function() {
                    selectMonth('end', index + 1);
                });
                endMonthGrid.appendChild(endBtn);
            });
            
            // 设置年份显示
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            // 年份控制按钮事件
            document.querySelectorAll('#start-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear--;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#start-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear++;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear--;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear++;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            // 点击外部关闭日期选择器
            document.addEventListener('click', function(e) {
                const startPicker = document.getElementById('start-date-picker');
                const endPicker = document.getElementById('end-date-picker');
                
                if (!e.target.closest('.date-picker-container')) {
                    startPicker.style.display = 'none';
                    endPicker.style.display = 'none';
                }
            });
            
            // 日期输入框点击事件
            startDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('start-date-picker');
                picker.style.display = 'block';
                document.getElementById('end-date-picker').style.display = 'none';
            });
            
            endDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('end-date-picker');
                picker.style.display = 'block';
                document.getElementById('start-date-picker').style.display = 'none';
            });
        }
        
        // 选择月份
        function selectMonth(type, month) {
            const year = type === 'start' ? startYear : endYear;
            const formattedMonth = month.toString().padStart(2, '0');
            const dateString = `${year}-${formattedMonth}`;
            
            if (type === 'start') {
                startMonth = month;
                startDateInput.value = dateString;
                document.getElementById('start-date-picker').style.display = 'none';
                
                // 清除结束日期选择状态
                document.querySelectorAll('#end-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            } else {
                endMonth = month;
                endDateInput.value = dateString;
                document.getElementById('end-date-picker').style.display = 'none';
                
                // 清除开始日期选择状态
                document.querySelectorAll('#start-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }
            
            // 设置选中状态
            document.querySelectorAll(`#${type}-month-grid .month-btn`).forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.month) === month) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // 初始化日期选择器
        function initDatePickers() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            
            // 设置默认值为上个月
            if (month === 0) {
                year--;
                month = 11;
            } else {
                month--;
            }
            
            const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            
            startDateInput.value = defaultDate;
            endDateInput.value = defaultDate;
            
            // 设置自定义选择器状态
            startYear = year;
            endYear = year;
            startMonth = month + 1;
            endMonth = month + 1;
            
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            document.querySelectorAll(`#start-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === startMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            document.querySelectorAll(`#end-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === endMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            defaultChargingFileName = generateFileName(defaultDate, defaultDate);
            defaultComprehensiveFileName = generateFileName(defaultDate, defaultDate);
        }
        
        // 格式化月份显示
        function formatMonthDisplay(dateStr) {
            const [year, month] = dateStr.split('-');
            return `${year}年${parseInt(month)}月`;
        }
        
        // 生成文件名
        function generateFileName(startDate, endDate) {
            const start = startDate.replace('-', '');
            const end = endDate.replace('-', '');
            return `${start}-${end}.xlsx`;
        }
        
        // 生成文件路径
        function generateFilePath(fileName, dataType) {
            const basePath = dataType === 'charging' 
                ? 'https://www.csfhcdz.cn/chargingdata/' 
                : 'https://www.csfhcdz.cn/comprehensivedata/';
            return `${basePath}${fileName}`;
        }
        // 加载并显示Excel数据
        function loadExcelData(filePath, fileName, dataType, isUserQuery = false) {
            // 返回 Promise 以便调用者可以处理错误
            return new Promise((resolve, reject) => {
            const isCharging = dataType === 'charging';
            const loadingElement = isCharging ? dataLoading : comprehensiveLoading;
            const tableElement = isCharging ? tableContainer : comprehensiveTableContainer;
            const infoElement = isCharging ? fileInfo : comprehensiveInfo;
            const rowCountElement = isCharging ? rowCount : comprehensiveRowCount;
            const lastUpdateElement = isCharging ? lastUpdate : comprehensiveLastUpdate;
            
            loadingElement.style.display = 'block';
            
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: 文件未找到或无法访问`);
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 调整工作表范围以仅包含有数据的部分
                    adjustSheetRange(worksheet);
                    
                    const tableId = isCharging ? 'excel-table-charging' : 'excel-table-comprehensive';
                    const html = XLSX.utils.sheet_to_html(worksheet, {
                        id: tableId,
                        header: '',
                        footer: ''
                    });
                    
                    tableElement.innerHTML = html;
                    
                    // 添加表格样式
                    const tableEl = tableElement.querySelector('table');
                    if (tableEl) {
                        tableEl.classList.add('excel-table');
                        // 确保表格宽度适应内容
                        tableEl.style.width = 'auto';
                        // 修复列宽问题
                        tableEl.style.tableLayout = 'auto';
                        
                        // 确保单元格内容正确显示
                        const cells = tableEl.querySelectorAll('td, th');
                        cells.forEach(cell => {
                            cell.style.lineHeight = '1.5';
                            cell.style.verticalAlign = 'middle';
                        });
                        // 标记数字为不换行
                        markNumericCells(tableEl);
                        // 处理单位信息左对齐
                        handleUnitInfoAlignment(tableEl);
                    }
                    
                    // 如果是用户查询，设置导出数据
                    if (isUserQuery) {
                        currentExportData = data;
                        currentExportFileName = fileName;
                        currentExportDataType = dataType;
                        exportBtn.disabled = false;
                    }
                    
                    // 更新文件信息
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    infoElement.textContent = `当前显示: ${formatMonthDisplay(startDate)}至${formatMonthDisplay(endDate)}数据`;
                    
                    // 更新行数
                    const table = tableElement.querySelector('table');
                    const rowCountValue = table.rows.length - 1; // 减去表头
                    rowCountElement.textContent = `共加载 ${rowCountValue} 行数据`;
                    
                    // 更新最后更新时间
                    const now = new Date();
                    lastUpdateElement.textContent = `最后更新时间: ${now.toLocaleString()}`;
                    
                    // 显示成功信息
                    queryInfo.innerHTML = `<i class="fas fa-check-circle"></i> 成功加载 ${fileName} 数据(可查询半年度和全年数据)`;
                    queryInfo.className = 'query-info success';
                    
                    // 保存为默认数据
                    if (isCharging) {
                        defaultChargingData = data;
                    } else {
                        defaultComprehensiveData = data;
                    }

                    // 只有在用户查询时才滚动到报表区域
                    if (isUserQuery) {
                        document.getElementById('report-section').scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                    
                    resolve({ success: true, fileName, dataType });
                })
                .catch(error => {
                    console.error('加载Excel文件失败:', error);
                    console.error('文件路径:', filePath);
                    console.error('错误类型:', error.name);
                    console.error('错误信息:', error.message);
                    
                    loadingElement.style.display = 'none';
                    
                    // 显示友好的错误提示
                    const errorMessage = `无法加载文件: ${fileName}\n错误: ${error.message}\n这可能是由于文件不存在或网络连接问题引起的。`;
                    infoElement.textContent = errorMessage;
                    infoElement.style.color = '#dc3545';
                    
                    // 从文件名中提取年月信息
                    const fileNameWithoutExt = fileName.replace('.xlsx', '');
                    // 处理格式如 "202412-202412" 的文件名
                    const dateMatch = fileNameWithoutExt.match(/(\d{4})(\d{2})-\d{4}\d{2}/);
                    let year = '未知';
                    let month = '未知';
                    
                    if (dateMatch) {
                        year = dateMatch[1];
                        month = dateMatch[2];
                    }
                    
                    // 显示具体年月错误信息
                    if (isUserQuery) {
                        const startDate = startDateInput.value;
                        const endDate = endDateInput.value;
                        queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 没有找到${startDate}至${endDate}之间的数据`;
                        queryInfo.className = 'query-info error';
                        
                        // 更新"当前显示"信息
                        const errorMessage = `没有找到${year}年${month}月的数据`;
                        infoElement.textContent = errorMessage;
                        infoElement.style.color = '#e74c3c';
                        
                        // 更新行数和更新时间信息
                        rowCountElement.textContent = '共加载 0 行数据';
                        lastUpdateElement.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                        
                        // 15秒后恢复默认提示
                        setTimeout(() => {
                            queryInfo.innerHTML = '<i class="fas fa-info-circle"></i> 请选择日期和数据类型来查询数据';
                            queryInfo.className = 'query-info';
                        }, 15000);
                    } else {
                        // 默认加载失败时显示年月信息
                        const errorMessage = `没有找到${year}年${month}月的数据`;
                        if (isCharging) {
                            fileInfo.textContent = errorMessage;
                            fileInfo.style.color = '#e74c3c';
                            // 更新行数和更新时间信息
                            rowCount.textContent = '共加载 0 行数据';
                            lastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                        } else {
                            comprehensiveInfo.textContent = errorMessage;
                            comprehensiveInfo.style.color = '#e74c3c';
                            // 更新行数和更新时间信息
                            comprehensiveRowCount.textContent = '共加载 0 行数据';
                            comprehensiveLastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                        }
                    }
                    
                    // 清空表格内容
                    tableElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><i class="fas fa-exclamation-triangle"></i> 暂无数据</div>';
                    
                    // 如果是用户查询，重置导出数据
                    if (isUserQuery) {
                        currentExportData = null;
                        exportBtn.disabled = true;
                    }
                    
                    reject(error);
                })
                .finally(() => {
                    loadingElement.style.display = 'none';
                    queryBtn.classList.remove('loading');
                });
            });
        }
        
        // 从数据渲染Excel表格
        function renderExcelFromData(data, container) {
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 调整工作表范围以仅包含有数据的部分
            adjustSheetRange(worksheet);
            
            const containerId = container === tableContainer ? 'excel-table-charging' : 'excel-table-comprehensive';
            const html = XLSX.utils.sheet_to_html(worksheet, {
                id: containerId,
                header: '',
                footer: ''
            });
            
            container.innerHTML = html;
            
            const tableEl = container.querySelector('table');
            if (tableEl) {
                tableEl.classList.add('excel-table');
                tableEl.style.width = 'auto';
                tableEl.style.tableLayout = 'auto';
                
                // 确保单元格内容正确显示
                const cells = tableEl.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.lineHeight = '1.5';
                    cell.style.verticalAlign = 'middle';
                });
                // 标记数字为不换行
                markNumericCells(tableEl);
                // 处理单位信息左对齐
                handleUnitInfoAlignment(tableEl);
            }
        }
        
        // 加载默认数据
        function loadDefaultData() {
            try {
                const now = new Date();
                let year = now.getFullYear();
                let month = now.getMonth(); // 0-11
                
                // 设置默认值为上个月
                if (month === 0) {
                    year--;
                    month = 11;
                } else {
                    month--;
                }
                
                const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
                const chargingFileName = generateFileName(defaultDate, defaultDate);
                const chargingFilePath = generateFilePath(chargingFileName, 'charging');
                
                // 加载默认充电数据（捕获错误但不阻塞）
                loadExcelData(chargingFilePath, chargingFileName, 'charging').catch(err => {
                    console.warn('默认充电数据加载失败，但不影响页面功能:', err);
                });
                
                // 加载默认综合数据（捕获错误但不阻塞）
                const comprehensiveFileName = generateFileName(defaultDate, defaultDate);
                const comprehensiveFilePath = generateFilePath(comprehensiveFileName, 'comprehensive');
                loadExcelData(comprehensiveFilePath, comprehensiveFileName, 'comprehensive').catch(err => {
                    console.warn('默认综合数据加载失败，但不影响页面功能:', err);
                });
            } catch (err) {
                console.error('loadDefaultData 执行失败:', err);
                // 不抛出错误，避免阻塞页面初始化
            }
        }
        
        // 导出Excel文件
        function exportExcel() {
            if (!currentExportData) {
                alert('没有查询数据导出');
                return;
            }
            
            const blob = new Blob([currentExportData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = currentExportFileName;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        // 查询按钮点击事件
        queryBtn.addEventListener('click', function() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const dataType = dataTypeSelect.value;
            
            if (!startDate || !endDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 请选择开始日期和结束日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 检查结束日期是否小于开始日期
            if (endDate < startDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 结束日期不能早于开始日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 显示加载状态
            this.classList.add('loading');
            
            const fileName = generateFileName(startDate, endDate);
            const filePath = generateFilePath(fileName, dataType);
            
            // 设置当前数据类型
            currentDataType = dataType;
            
            // 加载Excel数据 (标记为用户查询)
            loadExcelData(filePath, fileName, dataType, true);
        });
        
        // 导出按钮点击事件
        exportBtn && exportBtn.addEventListener('click', exportExcel);
        
        // 菜单项点击事件
        document.querySelectorAll('.menu-item').forEach(item => {
            const submenu = item.nextElementSibling;
            if (!submenu || !submenu.classList.contains('submenu')) {
                item.addEventListener('click', function() {
                    if (this !== document.querySelector('.menu-item.active')) {
                        document.querySelector('.menu-item.active').classList.remove('active');
                        this.classList.add('active');
                    }
                });
            }
            
            const toggle = item.querySelector('.menu-toggle');
            if (toggle) {
                item.addEventListener('click', function(e) {
                    if (e.target !== toggle && !toggle.contains(e.target)) {
                        const submenu = this.nextElementSibling;
                        if (submenu && submenu.classList.contains('submenu')) {
                            this.classList.toggle('expanded');
                            submenu.classList.toggle('expanded');
                        }
                    }
                });
            }
        });
        
        // 为特定菜单项添加点击事件
       
        document.getElementById('finance-management').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('财务管理功能暂未开放');
        });
        
        document.getElementById('system-settings').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('系统设置功能暂未开放');
        });
        
        document.getElementById('history-menu').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('历史记录功能暂未开放');
        });
        
        // 关闭弹窗事件
        closePopup.addEventListener('click', closeFeaturePopup);
        confirmPopup.addEventListener('click', closeFeaturePopup);




        
        // 检查登录状态
        function checkLoginStatus() {
            try {
                // 检查localStorage中是否有登录信息
                const savedUserInfo = sessionStorage.getItem('userLoginInfo');
                if (savedUserInfo) {
                    const userInfo = JSON.parse(savedUserInfo);
                    const currentTime = new Date().getTime();
                    
                    // 检查登录是否过期（24小时）
                    if (currentTime - userInfo.loginTime < 24 * 60 * 60 * 1000) {
                        console.log('发现有效的登录状态，自动登录:', userInfo.username);
                        
                        // 恢复用户状态
                        const user = new AV.User();
                        user.set('username', userInfo.username);
                        user.set('mobilePhoneNumber', userInfo.mobilePhoneNumber);
                        user.set('loginMethod', userInfo.loginMethod);
                        AV.User.current = () => user;
                        
                        // 显示主页面
                        showMainPage(userInfo.username);
                        return true;
                    } else {
                        console.log('登录状态已过期，清除本地存储');
                        sessionStorage.removeItem('userLoginInfo');
                    }
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                sessionStorage.removeItem('userLoginInfo');
            }
            return false;
        }
        
        // 显示主页面
        function showMainPage(username) {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('login-header-title').style.display = 'none';
            document.getElementById('login-footer-copyright').style.display = 'none';
            // 隐藏星空背景
            document.getElementById('nebula').style.display = 'none';
            document.getElementById('starfield').style.display = 'none';
            document.getElementById('user-display').textContent = username;
            initMainSystem();
            
            // 启动用户活动跟踪
            initActivityTracking();
        }
        
        // 保存登录状态
        function saveLoginStatus(username, loginMethod, mobilePhoneNumber = null) {
            try {
                const userInfo = {
                    username: username,
                    loginMethod: loginMethod,
                    mobilePhoneNumber: mobilePhoneNumber,
                    loginTime: new Date().getTime()
                };
                sessionStorage.setItem('userLoginInfo', JSON.stringify(userInfo));
                console.log('登录状态已保存:', userInfo);
            } catch (error) {
                console.error('保存登录状态失败:', error);
            }
        }
        
        // 清除登录状态
        function clearLoginStatus() {
            try {
                sessionStorage.removeItem('userLoginInfo');
                localStorage.removeItem('lastLoginRecordId');
                console.log('登录状态已清除');
            } catch (error) {
                console.error('清除登录状态失败:', error);
            }
        }
        // 会话超时管理
        let sessionTimeoutTimer = null;
        let lastActivityTime = Date.now();
        const SESSION_TIMEOUT = 15 * 60 * 1000; // 15分钟
        // 重置会话超时计时器
        function resetSessionTimeout() {
            lastActivityTime = Date.now();
            if (sessionTimeoutTimer) {
                clearTimeout(sessionTimeoutTimer);
            }
            
            sessionTimeoutTimer = setTimeout(() => {
                handleSessionTimeout();
            }, SESSION_TIMEOUT);
            
            console.log('会话超时计时器已重置，将在15分钟后自动登出');
        }
        
        // 处理会话超时
        async function handleSessionTimeout() {
            console.log('会话超时，开始自动登出流程');
            
            // 记录登出信息
            try {
                const currentUser = AV.User.current();
                if (currentUser) {
                    await recordUserLogout(currentUser.getUsername());
                }
            } catch (error) {
                console.error('记录登出信息失败:', error);
            }
            
            // 清除登录状态
            clearLoginStatus();
            
            // 显示会话超时提示
            showSessionTimeoutMessage();
        }
        
        // 显示会话超时提示
        function showSessionTimeoutMessage() {
            // 清理会话超时计时器
            if (sessionTimeoutTimer) {
                clearTimeout(sessionTimeoutTimer);
                sessionTimeoutTimer = null;
            }
            
            // 重置活动跟踪状态
            activityTrackingInitialized = false;
            
            // 隐藏主页面，显示登录页面
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('login-header-title').style.display = 'block';
            document.getElementById('login-footer-copyright').style.display = 'block';
            // 显示星空背景
            document.getElementById('nebula').style.display = 'block';
            document.getElementById('starfield').style.display = 'block';
            
            // 显示会话超时消息
            showMessage('会话超时，请重新登录', 'error');
            
            // 清空登录表单
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('smsPhone').value = '';
            document.getElementById('smsCode').value = '';
            
            // 确保显示登录表单而不是其他表单
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('resetForm').style.display = 'none';
            document.getElementById('smsLoginForm').style.display = 'none';
            document.getElementById('form-title').textContent = '用户登录';
            document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
        }
        // 初始化用户活动监听
        let activityTrackingInitialized = false;
        function initActivityTracking() {
            if (activityTrackingInitialized) {
                // 如果已经初始化，只重置计时器
                resetSessionTimeout();
                return;
            }
            
            // 监听各种用户活动
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    resetSessionTimeout();
                }, true);
            });
            
            // 初始启动计时器
            resetSessionTimeout();
            activityTrackingInitialized = true;
            console.log('用户活动跟踪已初始化');
        }

        // 初始化系统
        window.addEventListener('DOMContentLoaded', function() {
            // 首先检查登录状态
            if (!checkLoginStatus()) {
                // 如果没有有效登录状态，显示登录界面
                document.getElementById('login-container').style.display = 'flex';
                document.getElementById('main-container').style.display = 'none';
                // 显示星空背景
                document.getElementById('nebula').style.display = 'block';
                document.getElementById('starfield').style.display = 'block';
            }
        });
        
        // 时间显示更新
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[now.getDay()];
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            document.getElementById('time-display').textContent = 
                `${year}年${month}月${day}日 ${weekday} ${hours}:${minutes}:${seconds}`;
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // 格式化数字显示（解决科学计数法问题）
        // 修改后的格式化函数
function formatNumber(value) {
    // 检查是否为整数（包括浮点数表示的整数）
    if (Number.isInteger(value) || Math.abs(value - Math.round(value)) < 1e-6) {
        // 整数：直接格式化为整数
        return Math.round(value).toLocaleString();
    } else {
        // 非整数：使用原来的处理方式
        if (typeof value === 'number' && (Math.abs(value) > 1e6 || Math.abs(value) < 1e-6)) {
            return value.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return value.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

        // 初始化图表
        function initCharts() {
           


            // 充电数据总趋势图表
            const chargingTrendCtx = document.getElementById('charging-trend-chart').getContext('2d');
           chargingTrendChart = new Chart(chargingTrendCtx, {
    type: 'line',
    data: {
        labels: [], // 改为空数组
        datasets: [
            {
                label: '充电量 (kwh)',
                data: [], // 改为空数组
                            borderColor: 'rgba(26, 115, 232, 1)',
                            backgroundColor: 'rgba(26, 115, 232, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: '充电服务费收入 (元)',
                data: [], // 改为空数组
                            borderColor: 'rgba(0, 200, 83, 1)',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '充电量 (kwh)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '服务费收入 (元)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            // 强制同步刻度范围
                            min: 0,
                            max: 7000000,
                            ticks: {
                                // 设置固定的刻度步长
                                stepSize: 1000000,
                                // 格式化刻度值
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // 各版块收入汇总图表
            const revenueBySectorCtx = document.getElementById('revenue-by-sector-chart').getContext('2d');
revenueBySectorChart = new Chart(revenueBySectorCtx, {
    type: 'bar',
    data: {
        labels: [], // 清空硬编码的标签
        datasets: [
            {
                label: '2023年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(26, 115, 232, 0.7)',
                borderColor: 'rgba(26, 115, 232, 1)',
                borderWidth: 1
            },
            {
                label: '2024年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(0, 200, 83, 0.7)',
                borderColor: 'rgba(0, 200, 83, 1)',
                borderWidth: 1
            },
            {
                label: '2025年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            }
        ]
    },
              options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: '收入 (元)'
                }
            }
        }
    }
});

            // 年度总收入趋势图表
            const annualRevenueTrendCtx = document.getElementById('annual-revenue-trend-chart').getContext('2d');
            annualRevenueTrendChart = new Chart(annualRevenueTrendCtx, {
    type: 'line',
    data: {
        labels: [], // 改为空数组
        datasets: [
            {
                label: '年度总收入 (元)',
                data: [], // 改为空数组
                            borderColor: 'rgba(156, 39, 176, 1)',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '总收入 (元)'
                            }
                        }
                    }
                }
            });

               
            // 图表按钮事件
            document.querySelectorAll('.chart-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.textContent.includes('导出')) {
                        const canvas = this.closest('.chart-container').querySelector('canvas');
                        const link = document.createElement('a');
                        link.download = '图表导出.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } else {
                        // 刷新数据
                        loadMetricsData();
                        alert('数据已刷新！');
                    }
                });
            });
        }

        // 站点数据统计相关函数
let siteStatsData = [];
let currentMode = 'month';
let currentPage = 0;
let availablePages = [];

// 加载站点统计数据
function loadSiteStatsData() {
    fetch('https://www.csfhcdz.cn/data/hzsj.xlsx')
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取Sheet1工作表
            const sheet = workbook.Sheets['Sheet1'];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // 处理数据
            siteStatsData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length >= 7) {
                    const record = {
                        '充电时间': row[0],
                        '站点': row[1],
                        '充电量(kwh)': row[2] || 0,
                        '充电电费(元)': row[3] || 0,
                        '充电服务费(元)': row[4] || 0,
                        '充电总收入(元)': row[5] || 0,
                        '总订单数量': row[6] || 0
                    };
                    siteStatsData.push(record);
                }
            }
            
            console.log('站点统计数据加载完成:', siteStatsData);
            
            // 初始化页面
            initSiteStatsPage();
            updateAvailablePages();
            loadCurrentPageData();
        })
        .catch(error => {
            console.error('加载站点统计数据失败:', error);
        });
}

// 初始化站点统计页面
function initSiteStatsPage() {
    // 绑定模式切换按钮事件
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // 移除所有active类
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            // 添加active类到当前按钮
            this.classList.add('active');
            
            currentMode = this.getAttribute('data-mode');
            currentPage = 0;
            
            updateAvailablePages();
            loadCurrentPageData();
        });
    });
    
    // 绑定翻页按钮事件
    document.getElementById('prev-btn').addEventListener('click', function() {
        if (currentPage > 0) {
            currentPage--;
            loadCurrentPageData();
        }
    });
    
    document.getElementById('next-btn').addEventListener('click', function() {
        if (currentPage < availablePages.length - 1) {
            currentPage++;
            loadCurrentPageData();
        }
    });
}

// 更新可用页面列表
function updateAvailablePages() {
    availablePages = [];
    
    if (currentMode === 'total') {
        availablePages = ['总数据'];
    } else {
        // 获取所有唯一的年月组合
        const dateMap = new Map();
        
        siteStatsData.forEach(item => {
            if (item['充电时间']) {
                let dateStr = item['充电时间'];
                if (typeof dateStr === 'string') {
                    // 处理yyyy-mm格式
                    const match = dateStr.match(/^(\d{4})-(\d{1,2})$/);
                    if (match) {
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]);
                        const key = `${year}-${month.toString().padStart(2, '0')}`;
                        
                        if (currentMode === 'year') {
                            const yearKey = year.toString();
                            if (!dateMap.has(yearKey)) {
                                dateMap.set(yearKey, []);
                            }
                            dateMap.get(yearKey).push(item);
                        } else if (currentMode === 'month') {
                            if (!dateMap.has(key)) {
                                dateMap.set(key, []);
                            }
                            dateMap.get(key).push(item);
                        }
                    }
                }
            }
        });
        
        // 排序并生成页面列表
        const sortedKeys = Array.from(dateMap.keys()).sort();
        availablePages = sortedKeys;
    }
    
    // 更新翻页按钮状态
    updatePaginationButtons();
}

// 更新翻页按钮状态
function updatePaginationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');
    
    prevBtn.disabled = currentPage <= 0;
    nextBtn.disabled = currentPage >= availablePages.length - 1;
    
    if (availablePages.length > 0) {
        pageInfo.textContent = availablePages[currentPage] || '无数据';
    } else {
        pageInfo.textContent = '无数据';
    }
}
// 加载当前页面数据
function loadCurrentPageData() {
    if (availablePages.length === 0) {
        // 显示空数据
        displayEmptyData();
        return;
    }
    
    const currentPageKey = availablePages[currentPage];
    let filteredData = [];
    
    if (currentMode === 'total') {
        filteredData = siteStatsData;
    } else {
        filteredData = siteStatsData.filter(item => {
            if (!item['充电时间']) return false;
            
            let dateStr = item['充电时间'];
            if (typeof dateStr === 'string') {
                const match = dateStr.match(/^(\d{4})-(\d{1,2})$/);
                if (match) {
                    const year = parseInt(match[1]);
                    const month = parseInt(match[2]);
                    
                    if (currentMode === 'year') {
                        return year.toString() === currentPageKey;
                    } else if (currentMode === 'month') {
                        return `${year}-${month.toString().padStart(2, '0')}` === currentPageKey;
                    }
                }
            }
            return false;
        });
    }
    
    // 计算统计数据
    const stats = calculateSiteStats(filteredData);
    
    // 显示数据
    displaySiteStats(stats);
    updatePaginationButtons();
}

// 计算站点统计数据
function calculateSiteStats(data) {
    const sifangData = data.filter(item => item['站点'] === '四方坪站');
    const gaolingData = data.filter(item => item['站点'] === '高岭站');
    
    const sifangStats = calculateSingleSiteStats(sifangData);
    const gaolingStats = calculateSingleSiteStats(gaolingData);
    
    const totalStats = {
        charge: sifangStats.charge + gaolingStats.charge,
        service: sifangStats.service + gaolingStats.service,
        total: sifangStats.total + gaolingStats.total
    };
    
    return {
        sifang: sifangStats,
        gaoling: gaolingStats,
        total: totalStats
    };
}

// 计算单个站点的统计数据
function calculateSingleSiteStats(data) {
    return {
        charge: data.reduce((sum, item) => sum + (parseFloat(item['充电量(kwh)']) || 0), 0),
        service: data.reduce((sum, item) => sum + (parseFloat(item['充电服务费(元)']) || 0), 0),
        total: data.reduce((sum, item) => sum + (parseFloat(item['充电总收入(元)']) || 0), 0)
    };
}

// 显示站点统计数据
function displaySiteStats(stats) {
    // 更新四方坪站数据
    updateSiteData('sifang', stats.sifang);
    
    // 更新高岭站数据
    updateSiteData('gaoling', stats.gaoling);
    
    // 更新两站共计数据
    updateSiteData('total', stats.total);
}
// 更新单个站点数据
function updateSiteData(site, stats) {
    const prefix = site === 'sifang' ? 'sifang' : site === 'gaoling' ? 'gaoling' : 'total';
    
    // 更新数值显示
    let chargeText = stats.charge.toFixed(2);
    let serviceText = stats.service.toFixed(2);
    let totalText = stats.total.toFixed(2);
    
    // 如果是年份数据模式，计算百分比
    if (currentMode === 'year') {
        const currentYear = parseInt(availablePages[currentPage]);
        const prevYear = currentYear - 1;
        
        // 获取上一年的数据
        const prevYearData = siteStatsData.filter(item => {
            if (!item['充电时间']) return false;
            const itemYear = parseInt(item['充电时间'].substring(0, 4));
            return itemYear === prevYear;
        });
        
        if (prevYearData && prevYearData.length > 0) {
            // 根据站点类型过滤数据
            let filteredPrevData;
            if (site === 'sifang') {
                filteredPrevData = prevYearData.filter(item => item['站点'] === '四方坪站');
            } else if (site === 'gaoling') {
                filteredPrevData = prevYearData.filter(item => item['站点'] === '高岭站');
            } else {
                filteredPrevData = prevYearData; // 总数据
            }
            
            const prevStats = calculateSingleSiteStats(filteredPrevData);
            
            // 计算百分比
            const chargePercent = prevStats.charge > 0 ? ((stats.charge - prevStats.charge) / prevStats.charge * 100) : 0;
            const servicePercent = prevStats.service > 0 ? ((stats.service - prevStats.service) / prevStats.service * 100) : 0;
            const totalPercent = prevStats.total > 0 ? ((stats.total - prevStats.total) / prevStats.total * 100) : 0;
            
            // 添加百分比显示（带颜色）
            const chargePercentClass = chargePercent >= 0 ? 'percentage-increase' : 'percentage-decrease';
            const servicePercentClass = servicePercent >= 0 ? 'percentage-increase' : 'percentage-decrease';
            const totalPercentClass = totalPercent >= 0 ? 'percentage-increase' : 'percentage-decrease';
            
            chargeText += ` (<span class="${chargePercentClass}">${chargePercent >= 0 ? '+' : ''}${chargePercent.toFixed(1)}%</span>)`;
            serviceText += ` (<span class="${servicePercentClass}">${servicePercent >= 0 ? '+' : ''}${servicePercent.toFixed(1)}%</span>)`;
            totalText += ` (<span class="${totalPercentClass}">${totalPercent >= 0 ? '+' : ''}${totalPercent.toFixed(1)}%</span>)`;
        }
    }
    
    document.getElementById(`${prefix}-charge-value`).innerHTML = chargeText;
    document.getElementById(`${prefix}-service-value`).innerHTML = serviceText;
    document.getElementById(`${prefix}-total-value`).innerHTML = totalText;
    
    // 根据当前数据模式设置不同的最大值
    let maxValues;
    if (currentMode === 'month') {
        // 月份数据：最大值800000
        maxValues = {
            charge: 600000,
            service: 600000,
            total: 600000
        };
    } else if (currentMode === 'year') {
        // 年份数据：最大值10000000
        maxValues = {
            charge: 7800000,
            service: 7800000,
            total: 7800000
        };
    } else if (currentMode === 'total') {
        // 总数据：最大值150000000
        maxValues = {
            charge: 50000000,
            service: 50000000,
            total: 50000000
        };
    } else {
        // 默认值
        maxValues = {
            charge: 35000000,
            service: 35000000,
            total: 35000000
        };
    }
    
    // 更新进度条
    updateProgressBar(`${prefix}-charge-fill`, stats.charge, maxValues.charge);
    updateProgressBar(`${prefix}-service-fill`, stats.service, maxValues.service);
    updateProgressBar(`${prefix}-total-fill`, stats.total, maxValues.total);
}

// 更新进度条
function updateProgressBar(elementId, value, maxValue) {
    const fillElement = document.getElementById(elementId);
    if (fillElement) {
        const percentage = Math.min((value / maxValue) * 100, 100);
        fillElement.style.width = `${percentage}%`;
    }
}

// 显示空数据
function displayEmptyData() {
    const sites = ['sifang', 'gaoling', 'total'];
    
    // 根据当前数据模式设置不同的最大值
    let maxValues;
    if (currentMode === 'month') {
        // 月份数据：最大值800000
        maxValues = {
            charge: 800000,
            service: 800000,
            total: 800000
        };
    } else if (currentMode === 'year') {
        // 年份数据：最大值10000000
        maxValues = {
            charge: 10000000,
            service: 10000000,
            total: 10000000
        };
    } else if (currentMode === 'total') {
        // 总数据：最大值150000000
        maxValues = {
            charge: 150000000,
            service: 150000000,
            total: 150000000
        };
    } else {
        // 默认值
        maxValues = {
            charge: 35000000,
            service: 35000000,
            total: 35000000
        };
    }
    
    sites.forEach(site => {
        document.getElementById(`${site}-charge-value`).textContent = '0.00';
        document.getElementById(`${site}-service-value`).textContent = '0.00';
        document.getElementById(`${site}-total-value`).textContent = '0.00';
        
        updateProgressBar(`${site}-charge-fill`, 0, maxValues.charge);
        updateProgressBar(`${site}-service-fill`, 0, maxValues.service);
        updateProgressBar(`${site}-total-fill`, 0, maxValues.total);
    });
}

// 刷新站点统计数据
function refreshSiteStatsData() {
    console.log('刷新站点统计数据...');
    loadSiteStatsData();
}

// 设置定时刷新（每5分钟刷新一次数据）
// setInterval(refreshSiteStatsData, 5 * 60 * 1000); // 已禁用自动刷新功能

        // 充电数据看板相关函数
let chargingBoardData = [];

// 加载充电数据看板数据
function loadChargingBoardData() {
    fetch('https://www.csfhcdz.cn/data/homepage.xlsx')
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取Chargingdata工作表
            const chargingSheet = workbook.Sheets['Chargingdata'];
            const jsonData = XLSX.utils.sheet_to_json(chargingSheet, { header: 1 });
            
            // 保存表头和数据
            const headers = jsonData[0];
            chargingBoardData = jsonData.slice(1).map(row => {
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index];
                });
                return obj;
            });
            
            // 初始化年份下拉框
            initYearSelect();
            
            // 默认显示当前年度的数据
            const currentYear = new Date().getFullYear();
            renderChargingBoardTable(currentYear);
        })
        .catch(error => {
            console.error('加载充电数据看板数据失败:', error);
        });
}

// 初始化年份下拉框
function initYearSelect() {
    const yearSelect = document.getElementById('year-select');
    // 获取数据中存在的年份
    const years = new Set();
    chargingBoardData.forEach(item => {
        if (item['时间']) {
            const dateStr = item['时间'];
            let year;
            if (dateStr instanceof Date) {
                year = dateStr.getFullYear();
            } else if (typeof dateStr === 'string') {
                const match = dateStr.match(/(\d{4})/);
                if (match) {
                    year = parseInt(match[1]);
                }
            }
            if (year) {
                years.add(year);
            }
        }
    });
    
    // 排序年份
    const sortedYears = Array.from(years).sort();
    
    // 清空下拉框
    yearSelect.innerHTML = '';
    
    // 添加年份选项
    sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        yearSelect.appendChild(option);
    });
    
    // 设置默认选中当前年份(2025年)
    const currentYear = 2025;
    if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
        yearSelect.value = currentYear;
    }
    
    // 添加事件监听
    yearSelect.addEventListener('change', function() {
        const selectedYear = parseInt(this.value);
        renderChargingBoardTable(selectedYear);
    });
}
// 渲染充电数据看板表格
function renderChargingBoardTable(year) {
    const tableBody = document.getElementById('charging-board-table-body');
    tableBody.innerHTML = '';
    
    // 过滤出指定年份的数据
    const yearData = chargingBoardData.filter(item => {
        if (item['时间']) {
            const dateStr = item['时间'];
            let itemYear;
            if (dateStr instanceof Date) {
                itemYear = dateStr.getFullYear();
            } else if (typeof dateStr === 'string') {
                const match = dateStr.match(/(\d{4})/);
                if (match) {
                    itemYear = parseInt(match[1]);
                }
            }
            return itemYear === year;
        }
        return false;
    });
    
    // 按时间排序
    yearData.sort((a, b) => {
        const dateA = new Date(a['时间']);
        const dateB = new Date(b['时间']);
        return dateA - dateB;
    });
    
    // 填充数据
    let totalCharge = 0;
    let totalElectricity = 0;
    let totalService = 0;
    let totalIncome = 0;
    let totalOrders = 0;
    
    yearData.forEach(item => {
        const row = document.createElement('tr');
        
        // 格式化时间显示为yyyy-mm
        let timeDisplay = '';
        if (item['时间'] instanceof Date) {
            const date = item['时间'];
            timeDisplay = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        } else if (typeof item['时间'] === 'string') {
            const date = new Date(item['时间']);
            if (!isNaN(date)) {
                timeDisplay = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            } else {
                timeDisplay = item['时间'];
            }
        }
        
        row.innerHTML = `
            <td>${timeDisplay}</td>
            <td>${formatNumber(item['充电量(kwh)'])}</td>
            <td>${formatNumber(item['充电电费(元)'])}</td>
            <td>${formatNumber(item['充电服务费(元)'])}</td>
            <td>${formatNumber(item['充电总收入(元)'])}</td>
            <td>${formatNumber(item['总订单数量'])}</td>
        `;
        
        tableBody.appendChild(row);
        
        // 计算合计
        totalCharge += Number(item['充电量(kwh)']) || 0;
        totalElectricity += Number(item['充电电费(元)']) || 0;
        totalService += Number(item['充电服务费(元)']) || 0;
        totalIncome += Number(item['充电总收入(元)']) || 0;
        totalOrders += Number(item['总订单数量']) || 0;
    });
    
    // 添加合计行
    const totalRow = document.createElement('tr');
    // 为合计行添加样式：背景色和加粗字体
    totalRow.style.backgroundColor = '#f0f8ff'; // 浅蓝色背景
    totalRow.style.fontWeight = 'bold'; // 加粗字体
    totalRow.style.color = '#0066cc'; // 蓝色文字
    
    totalRow.innerHTML = `
        <td>合计</td>
        <td>${formatNumber(totalCharge)}</td>
        <td>${formatNumber(totalElectricity)}</td>
        <td>${formatNumber(totalService)}</td>
        <td>${formatNumber(totalIncome)}</td>
        <td>${formatNumber(totalOrders)}</td>
    `;
    tableBody.appendChild(totalRow);
    
    // 渲染图表
    renderChargingBoardChart(yearData);
}

// 渲染充电数据看板图表
function renderChargingBoardChart(data) {
    const ctx = document.getElementById('charging-board-chart').getContext('2d');
    
    // 如果已存在图表实例，先销毁它
    if (window.chargingBoardChartInstance) {
        window.chargingBoardChartInstance.destroy();
    }
    
    // 按时间排序
    data.sort((a, b) => {
        const dateA = new Date(a['时间']);
        const dateB = new Date(b['时间']);
        return dateA - dateB;
    });
    
    // 准备图表数据
    const labels = data.map(item => {
        if (item['时间'] instanceof Date) {
            const date = item['时间'];
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        } else if (typeof item['时间'] === 'string') {
            const date = new Date(item['时间']);
            if (!isNaN(date)) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            } else {
                return item['时间'];
            }
        }
        return '';
    });
    
    const chargeData = data.map(item => Number(item['充电量(kwh)']) || 0);
    const serviceData = data.map(item => Number(item['充电服务费(元)']) || 0);
    
    // 创建图表
    window.chargingBoardChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '充电量 (kwh)',
                    data: chargeData,
                    backgroundColor: 'rgba(26, 115, 232, 0.7)',
                    borderColor: 'rgba(26, 115, 232, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: '充电服务费 (元)',
                    data: serviceData,
                    type: 'line',
                    borderColor: 'rgba(0, 200, 83, 1)',
                    backgroundColor: 'rgba(0, 200, 83, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '充电量 (kwh)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '充电服务费 (元)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// 导出充电数据看板数据
function exportChargingBoardData() {
    // 获取当前显示的年份
    const year = parseInt(document.getElementById('year-select').value);
    
    // 过滤出指定年份的数据
    const yearData = chargingBoardData.filter(item => {
        if (item['时间']) {
            const dateStr = item['时间'];
            let itemYear;
            if (dateStr instanceof Date) {
                itemYear = dateStr.getFullYear();
            } else if (typeof dateStr === 'string') {
                const match = dateStr.match(/(\d{4})/);
                if (match) {
                    itemYear = parseInt(match[1]);
                }
            }
            return itemYear === year;
        }
        return false;
    });
    
    // 创建一个新的工作簿
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(yearData);
    XLSX.utils.book_append_sheet(wb, ws, '充电数据');
    
    // 导出文件
    XLSX.writeFile(wb, `充电数据_${year}年.xlsx`);
}

// 初始化充电数据看板导出按钮事件
function initChargingBoardExport() {
    document.getElementById('export-board-btn').addEventListener('click', exportChargingBoardData);
}
        // 从GitHub加载指标数据
        function loadMetricsData() {
            // 显示加载状态
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'data-loading-indicator';
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载指标数据...';
            document.querySelector('.metrics-section').prepend(loadingIndicator);
            
            fetch(metricsDataUrl)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 处理指标数据（Metrics工作表）
                    const metricsSheet = workbook.Sheets['Metrics'];
                    const metricsJson = XLSX.utils.sheet_to_json(metricsSheet, { header: 1 });
                    
                    // 更新指标数据 - 修正索引位置
                    document.getElementById('month-charge').textContent = formatNumber(metricsJson[1][1]) + ' kwh';
                    document.getElementById('month-electricity').textContent = '¥' + formatNumber(metricsJson[2][1]);
                    document.getElementById('month-service').textContent = '¥' + formatNumber(metricsJson[3][1]);
                    document.getElementById('month-orders').textContent = formatNumber(metricsJson[4][1]);
                    
                    document.getElementById('year-charge').textContent = formatNumber(metricsJson[5][1]) + ' kwh';
                    document.getElementById('year-electricity').textContent = '¥' + formatNumber(metricsJson[6][1]);
                    document.getElementById('year-service').textContent = '¥' + formatNumber(metricsJson[7][1]);
                    document.getElementById('year-orders').textContent = formatNumber(metricsJson[8][1]);
                    
                    document.getElementById('total-charge').textContent = formatNumber(metricsJson[9][1]) + ' kwh';
                    document.getElementById('total-electricity').textContent = '¥' + formatNumber(metricsJson[10][1]);
                    document.getElementById('total-service').textContent = '¥' + formatNumber(metricsJson[11][1]);
                    document.getElementById('total-orders').textContent = formatNumber(metricsJson[12][1]);
                    
                    document.getElementById('month-income').textContent = '¥' + formatNumber(metricsJson[13][1]);
                    document.getElementById('year-income').textContent = '¥' + formatNumber(metricsJson[14][1]);
                    document.getElementById('total-income').textContent = '¥' + formatNumber(metricsJson[15][1]);
                    
                    // 处理充电图表数据（ChargingChart工作表）
                    const chargingChartSheet = workbook.Sheets['ChargingChart'];
                    const chargingChartJson = XLSX.utils.sheet_to_json(chargingChartSheet, { header: 1 });
                    
                    // 提取数据
                    const labels = [];
                    const chargingData = [];
                    const serviceIncomeData = [];
                    
                    for (let i = 1; i < chargingChartJson.length; i++) {
                        const row = chargingChartJson[i];
                        if (row && row.length >= 3) {
                            labels.push(row[0]);
                            chargingData.push(row[1]);
                            serviceIncomeData.push(row[2]);
                        }
                    }
                    
                    // 更新充电图表
                    if (chargingChart) {
                        chargingChart.data.labels = labels;
                        chargingChart.data.datasets[0].data = chargingData;
                        chargingChart.data.datasets[1].data = serviceIncomeData;
                        chargingChart.update();
                    }
                    
                    // 处理综合收入图表数据（IncomeChart工作表）
                    const incomeChartSheet = workbook.Sheets['IncomeChart'];
                    const incomeChartJson = XLSX.utils.sheet_to_json(incomeChartSheet, { header: 1 });
                    
                    // 提取数据
                    const incomeLabels = [];
                    const incomeDataArray = [];
                    
                    for (let i = 1; i < incomeChartJson.length; i++) {
                        const row = incomeChartJson[i];
                        if (row && row.length >= 2) {
                            incomeLabels.push(row[0]);
                            incomeDataArray.push(row[1]);
                        }
                    }
                    
                    // 更新收入图表
                    if (incomeChart) {
                        incomeChart.data.labels = incomeLabels;
                        incomeChart.data.datasets[0].data = incomeDataArray;
                        incomeChart.update();
                    }
                    
                    // 处理充电数据总趋势图表数据（csdjzqs工作表）
if (workbook.SheetNames.includes('csdjzqs')) {
    const csdjzqsSheet = workbook.Sheets['csdjzqs'];
    const csdjzqsJson = XLSX.utils.sheet_to_json(csdjzqsSheet, { header: 1 });
    
    // 提取数据
    const labels = [];
    const chargingData = [];
    const serviceIncomeData = [];
    
    for (let i = 1; i < csdjzqsJson.length; i++) {
        const row = csdjzqsJson[i];
        if (row && row.length >= 3) {
            labels.push(row[0]); // 年份
            chargingData.push(row[1]); // 充电量
            serviceIncomeData.push(row[2]); // 服务费收入
        }
    }
    
    // 更新充电数据总趋势图表
    if (chargingTrendChart) {
        chargingTrendChart.data.labels = labels;
        chargingTrendChart.data.datasets[0].data = chargingData;
        chargingTrendChart.data.datasets[1].data = serviceIncomeData;
        chargingTrendChart.update();
    }
}

                // 处理年度总收入趋势图表数据（ndzsrqs工作表）
if (workbook.SheetNames.includes('ndzsrqs')) {
    const ndzsrqsSheet = workbook.Sheets['ndzsrqs'];
    const ndzsrqsJson = XLSX.utils.sheet_to_json(ndzsrqsSheet, { header: 1 });
    
    // 提取数据
    const labels = [];
    const incomeData = [];
    
    for (let i = 1; i < ndzsrqsJson.length; i++) {
        const row = ndzsrqsJson[i];
        if (row && row.length >= 2) {
            labels.push(row[0]); // 年份
            incomeData.push(row[1]); // 收入
        }
    }
    
    // 更新年度总收入趋势图表
    if (annualRevenueTrendChart) {
        annualRevenueTrendChart.data.labels = labels;
        annualRevenueTrendChart.data.datasets[0].data = incomeData;
        annualRevenueTrendChart.update();
    }
}

// 处理各版块收入汇总数据（bksr工作表）
if (workbook.SheetNames.includes('bksr')) {
    const bksrSheet = workbook.Sheets['bksr'];
    const bksrJson = XLSX.utils.sheet_to_json(bksrSheet, { header: 1 });
    
    // 提取表头
    const headers = bksrJson[0];
    
    // 构建一个对象，按年份存储各版块收入
    const sectorDataByYear = {};
    
    // 遍历数据行（从第二行开始）
    for (let i = 1; i < bksrJson.length; i++) {
        const row = bksrJson[i];
        if (row && row.length >= 3) {
            const sectorName = row[0];
            const year = row[1];
            const income = row[2];
            
            if (!sectorDataByYear[year]) {
                sectorDataByYear[year] = {};
            }
            sectorDataByYear[year][sectorName] = income;
        }
    }

// 更新各版块收入汇总图表
    if (revenueBySectorChart) {
        // 获取所有唯一的版块名称
        const sectors = [...new Set(bksrJson.slice(1).map(row => row[0]))];
        
        // 为每个年份创建数据数组
        const year2023Data = sectors.map(sector => sectorDataByYear[2023]?.[sector] || 0);
        const year2024Data = sectors.map(sector => sectorDataByYear[2024]?.[sector] || 0);
        const year2025Data = sectors.map(sector => sectorDataByYear[2025]?.[sector] || 0);
        
        // 更新图表数据
        revenueBySectorChart.data.labels = sectors;
        revenueBySectorChart.data.datasets[0].data = year2023Data;
        revenueBySectorChart.data.datasets[1].data = year2024Data;
        revenueBySectorChart.data.datasets[2].data = year2025Data;
        revenueBySectorChart.update();
    }
}

                    // 移除加载状态
                    loadingIndicator.remove();
                })
                .catch(error => {
                    console.error('加载指标数据失败:', error);
                    loadingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 加载指标数据失败';
                    
                    // 5秒后移除提示
                    setTimeout(() => {
                        loadingIndicator.remove();
                    }, 5000);
                });
        }

        // 实时数据轮播变量
let realtimeData = [];
let currentRealtimeIndex = 0;
let realtimeInterval = null;
let isRealtimePaused = false;
let realtimeChart = null;

// 加载实时数据
function loadRealtimeData() {
    const loadingElement = document.getElementById('realtime-loading');
    loadingElement.style.display = 'block';
    
     fetch('https://www.csfhcdz.cn/data/daydata.xlsx?t=' + new Date().getTime())
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 转换为JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // 处理表头
            const headers = jsonData[0];

            // 处理数据行
            realtimeData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                // 只要有数据就显示，不检查特定列
if (row && row.some(cell => cell !== null && cell !== undefined && cell !== '')) {
                    // 处理日期格式
                    let dateStr = row[0];
                    let formattedDate = '';
                    // 更健壮的日期处理
if (dateStr instanceof Date) {
    const month = (dateStr.getMonth() + 1).toString().padStart(2, '0');
    const day = dateStr.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else if (typeof dateStr === 'string' && dateStr.includes('-')) {
    // 处理字符串日期格式
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length >= 3) {
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        formattedDate = `${month}-${day}`;
    } else {
        formattedDate = datePart;
    }
} else if (typeof dateStr === 'number') {
    // 处理Excel日期序列号
    const jsDate = excelDateToJSDate(dateStr);
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else {
    // 其他情况直接显示原始值
    formattedDate = String(dateStr || '');
}

                    // Excel日期序列号转换函数
                    function excelDateToJSDate(serial) {
                        const utc_days = Math.floor(serial - 25569);
                        const utc_value = utc_days * 86400;
                        const date_info = new Date(utc_value * 1000);
                        return date_info;
                    }

                    if (typeof dateStr === 'number') {
                        // 处理Excel日期序列号
                        const jsDate = excelDateToJSDate(dateStr);
                        const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                        const day = jsDate.getDate().toString().padStart(2, '0');
                        formattedDate = `${month}-${day}`;
                    } else if (typeof dateStr === 'string') {
                        // 提取日期部分（可能包含时间）
                        const datePart = dateStr.split(' ')[0];
                        const parts = datePart.split('-');
                        if (parts.length >= 3) {
                            // 直接从字符串中提取月份和日期
                            const month = parts[1].padStart(2, '0');
                            const day = parts[2].padStart(2, '0');
                            formattedDate = `${month}-${day}`;
                        } else {
                            formattedDate = datePart;
                        }
                    } else if (dateStr instanceof Date) {
                        // 如果是Date对象，直接格式化
                        formattedDate = `${(dateStr.getMonth() + 1).toString().padStart(2, '0')}-${dateStr.getDate().toString().padStart(2, '0')}`;
                    } else {
                        // 其他情况，转换为字符串
                        formattedDate = String(dateStr);
                    }
                    
// 获取当前年月
const currentDate = new Date();
const currentYear = currentDate.getFullYear();
const currentMonth = currentDate.getMonth() +1; // 月份从0开始，所以+1，+1是获取当前年月，不+1则是获取上个月

// 处理日期格式
if (dateStr instanceof Date) {
    jsDate = dateStr;
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else if (typeof dateStr === 'string' && dateStr.includes('-')) {
    // 处理字符串日期格式
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length >= 3) {
        // 直接从字符串中提取月份和日期
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        formattedDate = `${month}-${day}`;
        
        // 创建Date对象用于比较
        const year = parseInt(parts[0]);
        jsDate = new Date(year, parseInt(month) - 1, parseInt(day));
    } else {
        formattedDate = datePart;
    }
} else if (typeof dateStr === 'number') {
    // 处理Excel日期序列号
    jsDate = excelDateToJSDate(dateStr);
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else {
    // 其他情况，转换为字符串
    formattedDate = String(dateStr);
}

// 检查日期是否在当前年月
if (jsDate && jsDate.getFullYear() === currentYear && (jsDate.getMonth() + 1) === currentMonth) {
    // 确保所有字段都有值
    realtimeData.push({
        date: formattedDate,
        station: row[1] || '',
        charge: row[2] !== undefined && row[2] !== null && row[2] !== '' ? row[2] : 0,
        totalIncome: row[3] !== undefined && row[3] !== null && row[3] !== '' ? row[3] : 0,
        income: row[4] !== undefined && row[4] !== null && row[4] !== '' ? row[4] : 0,
        orders: row[5] !== undefined && row[5] !== null && row[5] !== '' ? row[5] : 0
    });
}
                }
            }
                    
            // 更新表格
            updateRealtimeTable();
            
            // 绘制图表
            drawRealtimeChart();

            // 只有当数据超过表格显示范围时才开始轮播
            if (realtimeData.length > 8) {
                startRealtimeCarousel();
            }
            
            // 添加容器级别的鼠标事件处理
            const tableContainer = document.getElementById('realtime-table-container');
            if (tableContainer) {
                tableContainer.addEventListener('mouseenter', () => {
                    isRealtimePaused = true;
                    clearInterval(realtimeInterval);
                });
                
                tableContainer.addEventListener('mouseleave', () => {
                    isRealtimePaused = false;
                    // 只有当数据超过表格显示范围时才重新开始轮播
                    if (realtimeData.length > 8) {
                        startRealtimeCarousel();
                    }
                });
            }
        })
        .catch(error => {
            console.error('加载实时数据失败:', error);
            loadingElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 加载实时数据失败';
        })
        .finally(() => {
            loadingElement.style.display = 'none';
        });
}

// 更新实时数据表格
function updateRealtimeTable() {
    const tableBody = document.getElementById('realtime-table-body');
    tableBody.innerHTML = '';
    
    // 显示当前页的数据
    const startIndex = currentRealtimeIndex;
    // 修改这里，确保能显示到最后一行
    const endIndex = Math.min(startIndex + 10, realtimeData.length);;
    
    for (let i = startIndex; i < endIndex; i++) {
        const item = realtimeData[i];
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${item.date}</td>
            <td>${item.station}</td>
            <td>${formatNumber(item.charge)}</td>
            <td>${formatNumber(item.totalIncome)}</td>   <!-- 新增列 -->
            <td>${formatNumber(item.income)}</td>
            <td>${formatNumber(item.orders)}</td>
        `;
        
        // 添加鼠标事件
        row.addEventListener('mouseenter', () => {
            isRealtimePaused = true;
            clearInterval(realtimeInterval);
        });
        
        row.addEventListener('mouseleave', () => {
            isRealtimePaused = false;
            // 只有当数据超过表格显示范围时才重新开始轮播
            if (realtimeData.length > 8) {
                startRealtimeCarousel();
            }
        });
        
        tableBody.appendChild(row);
    }

    // 高亮当前行
    if (tableBody.children.length > 0) {
        const firstRow = tableBody.children[0];
        firstRow.classList.add('highlight');
        
        // 移除之前的高亮
        setTimeout(() => {
            firstRow.classList.remove('highlight');
        }, 1000);
    }
}

// 开始实时数据轮播
function startRealtimeCarousel() {
    clearInterval(realtimeInterval);
    
    realtimeInterval = setInterval(() => {
        if (isRealtimePaused) return;
        
        currentRealtimeIndex++;
        // 修改重置条件
        if (currentRealtimeIndex >= realtimeData.length) {
            currentRealtimeIndex = 0;
        }
          
        updateRealtimeTable();
    }, 1000); // 每2秒轮播一次
}
// 绘制实时数据图表
function drawRealtimeChart() {
    const ctx = document.getElementById('realtime-chart').getContext('2d');
    
    // 如果已存在图表实例，先销毁它
    if (realtimeChart) {
        realtimeChart.destroy();
    }
    
    // 按站点和日期分组数据
    const stations = {};
    const dates = [...new Set(realtimeData.map(item => item.date))].sort();
    
    realtimeData.forEach(item => {
        if (!stations[item.station]) {
            stations[item.station] = {
                chargeData: new Array(dates.length).fill(0),
                incomeData: new Array(dates.length).fill(0)
            };
        }
        
        const dateIndex = dates.indexOf(item.date);
        if (dateIndex !== -1) {
            stations[item.station].chargeData[dateIndex] = item.charge;
            stations[item.station].incomeData[dateIndex] = item.income;
        }
    });

    // 创建数据集
    const datasets = [];
    const colors = [
        'rgba(26, 115, 232, 0.7)',      // 蓝色 - 充电量
        'rgba(26, 115, 232, 0.3)',      // 浅蓝色 - 充电量(辅助)
        'rgba(0, 200, 83, 0.7)',        // 绿色 - 服务费收入
        'rgba(0, 200, 83, 0.3)',        // 浅绿色 - 服务费收入(辅助)
        'rgba(220, 53, 69, 0.7)',       // 红色
        'rgba(156, 39, 176, 0.7)',      // 紫色
        'rgba(255, 152, 0, 0.7)'        // 橙色
    ];
    
    let colorIndex = 0;
    for (const station in stations) {
    
        // 为四方坪站特别设置样式
        const isSifangping = station.includes('四方坪');
        
        datasets.push({
            label: `${station} - 充电量`,
            data: stations[station].chargeData,
            borderColor: isSifangping ? colors[0] : colors[colorIndex % colors.length],
            backgroundColor: 'transparent',
            yAxisID: 'y',
            tension: 0.4,
            borderWidth: isSifangping ? 3 : 2,
            pointRadius: isSifangping ? 4 : 3,
            pointHoverRadius: isSifangping ? 6 : 4
        });
        
        datasets.push({
            label: `${station} - 服务费收入`,
            data: stations[station].incomeData,
            borderColor: isSifangping ? colors[2] : colors[(colorIndex + 2) % colors.length],
            backgroundColor: 'transparent',
            yAxisID: 'y1',
            tension: 0.4,
            borderWidth: isSifangping ? 3 : 2,
            borderDash: isSifangping ? [0] : [5, 5], // 四方坪站用实线，其他用虚线
            pointRadius: isSifangping ? 4 : 3,
            pointHoverRadius: isSifangping ? 6 : 4
        });

        colorIndex++;
    }
    
    // 创建图表
    realtimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '充电量 (kwh)'
                    },
                    // 移除任何固定的min/max设置，让图表自动调整
                    beginAtZero: true // 从0开始，但会自动扩展
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '服务费收入 (元)'
                    },
                    grid: {
                        drawOnChartArea: false
                    },
                    // 移除任何固定的min/max设置，让图表自动调整
                    beginAtZero: true // 从0开始，但会自动扩展
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                const value = context.parsed.y;
                                if (context.dataset.yAxisID === 'y1') {
                                    label += '¥' + formatNumber(value);
                                } else {
                                    label += formatNumber(value) + ' kwh';
                                }
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}
// setTimeout(loadRealtimeData, 5 * 60 * 1000); // 每5分钟刷新一次 - 已禁用自动刷新功能
// 在页面加载完成后调用
// 综合收入看板功能
let incomeDashboardData = [];
let incomeDashboardChart = null;
// 加载综合收入数据
async function loadIncomeDashboardData() {
    try {
        const response = await fetch('https://www.csfhcdz.cn/data/homepage.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        // 查找zgmysj工作表
        const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('zgmysj'));
        if (!sheetName) {
            throw new Error('未找到zgmysj工作表');
        }
        
        const worksheet = workbook.Sheets[sheetName];
        
        // 转换Excel数据为JSON
        const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (data.length < 2) {
            throw new Error('工作表数据为空');
        }
        
        // 处理表头和数据
        const headers = data[0];
        incomeDashboardData = data.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, index) => {
                if (header === '时间') {
                    // 处理日期字段
                    if (row[index] instanceof Date) {
                        obj[header] = row[index];
                    } else if (typeof row[index] === 'number') {
                        // Excel日期序列号转换为Date对象
                        const date = new Date((row[index] - 25569) * 86400 * 1000);
                        obj[header] = date;
                    } else if (typeof row[index] === 'string') {
                        // 尝试解析字符串日期
                        const date = new Date(row[index]);
                        if (!isNaN(date.getTime())) {
                            obj[header] = date;
                        } else {
                            obj[header] = row[index];
                        }
                    } else {
                        obj[header] = row[index];
                    }
                } else {
                    obj[header] = row[index];
                }
            });
            return obj;
        }).filter(item => item['时间'] && !isNaN(new Date(item['时间']).getTime())); // 过滤掉无效日期数据
        
        // 更新年份选择器
        updateYearSelector();
        
        // 加载当前年份数据
        const currentYear = new Date().getFullYear();
        loadYearData(currentYear.toString());
        
    } catch (error) {
        console.error('加载综合收入数据失败:', error);
        alert('加载综合收入数据失败，请检查网络连接或数据文件');
    }
}

// 更新年份选择器
function updateYearSelector() {
    const yearSelect = document.getElementById('income-year-select');
    const years = [...new Set(incomeDashboardData
        .filter(item => item['时间'])
        .map(item => {
            const date = new Date(item['时间']);
            return date.getFullYear();
        })
        .filter(year => !isNaN(year))
    )].sort((a, b) => b - a);
    
    yearSelect.innerHTML = '';
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === new Date().getFullYear()) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    });
    
    // 添加年份选择事件监听
    yearSelect.addEventListener('change', (e) => {
        loadYearData(e.target.value);
    });
    
    // 添加导出按钮事件监听
document.getElementById('income-export-btn').addEventListener('click', exportIncomeData);
}

// 加载指定年份数据
function loadYearData(year) {
    const yearData = incomeDashboardData.filter(item => {
        if (!item['时间']) return false;
        const date = new Date(item['时间']);
        return date.getFullYear() === parseInt(year);
    });
    
    // 更新表格
    updateIncomeTable(yearData, year);
    
    // 更新图表
    updateIncomeChart(yearData);
}

// 更新收入表格
function updateIncomeTable(data, year) {
    const tableBody = document.querySelector('#income-table tbody');
    const tableHead = document.querySelector('#income-table thead tr');
    
    // 清空表格
    tableBody.innerHTML = '';
    tableHead.innerHTML = '';
    
    // 如果没有数据，显示提示
    if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="12" style="text-align: center;">没有找到${year}年的数据</td>`;
        tableBody.appendChild(row);
        return;
    }
    
    // 获取所有表头（排除时间列）
    const allHeaders = Object.keys(data[0]).filter(key => key !== '时间');
    
    // 检查每个字段是否在所有数据中都为0
    const nonZeroHeaders = allHeaders.filter(header => {
        // 检查该字段是否至少有一个非零值
        return data.some(item => {
            const value = item[header];
            return typeof value === 'number' && value !== 0;
        });
    });
    
    // 使用非零字段作为表头
    const headers = nonZeroHeaders;
    
    // 添加表头
    const timeHeader = document.createElement('th');
    timeHeader.textContent = '时间';
    tableHead.appendChild(timeHeader);
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHead.appendChild(th);
    });
    
    // 添加小计列
    const totalHeader = document.createElement('th');
    totalHeader.textContent = '小计';
    tableHead.appendChild(totalHeader);
    
    // 初始化列总计数组
    const columnTotals = new Array(headers.length).fill(0);
    let grandTotal = 0;
    
    // 添加数据行
    data.forEach(item => {
        const row = document.createElement('tr');
        
        // 时间列
        const timeCell = document.createElement('td');
        const date = new Date(item['时间']);
        timeCell.textContent = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        row.appendChild(timeCell);
        
        // 数据列
        let rowTotal = 0;
        headers.forEach((header, index) => {
            const cell = document.createElement('td');
            const value = item[header] || 0;
            cell.textContent = typeof value === 'number' ? value.toFixed(2) : value;
            rowTotal += typeof value === 'number' ? value : 0;
            
            // 累加列总计
            if (typeof value === 'number') {
                columnTotals[index] += value;
            }
            
            row.appendChild(cell);
        });
        
        // 小计列
        const totalCell = document.createElement('td');
        totalCell.textContent = rowTotal.toFixed(2);
        totalCell.style.fontWeight = 'bold';
        row.appendChild(totalCell);
        
        // 累加总计
        grandTotal += rowTotal;
        
        tableBody.appendChild(row);
    });
    
    // 添加"共计"行
    if (data.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.style.fontWeight = 'bold';
        totalRow.style.backgroundColor = '#f5f5f5';
        
        // 时间列
        const timeCell = document.createElement('td');
        timeCell.textContent = '共计';
        totalRow.appendChild(timeCell);
        
        // 各列总计
        columnTotals.forEach(total => {
            const cell = document.createElement('td');
            cell.textContent = total.toFixed(2);
            totalRow.appendChild(cell);
        });
        
        // 总计列
        const grandTotalCell = document.createElement('td');
        grandTotalCell.textContent = grandTotal.toFixed(2);
        grandTotalCell.style.backgroundColor = '#e8f5e9';
        totalRow.appendChild(grandTotalCell);
        
        tableBody.appendChild(totalRow);
    }
}

// 更新收入图表
function updateIncomeChart(data) {
    const ctx = document.getElementById('income-dashboard-chart').getContext('2d');
    
    // 销毁现有图表
    if (incomeDashboardChart) {
        incomeDashboardChart.destroy();
    }
    
    // 获取所有非零字段（排除时间列）
    const allHeaders = Object.keys(data[0] || {}).filter(key => key !== '时间');
    const nonZeroHeaders = allHeaders.filter(header => {
        return data.some(item => {
            const value = item[header];
            return typeof value === 'number' && value !== 0;
        });
    });
    
    // 按月分组数据
    const monthlyData = {};
    data.forEach(item => {
        if (!item['时间']) return;
        const date = new Date(item['时间']);
        const month = date.getMonth() + 1;
        if (!monthlyData[month]) {
            monthlyData[month] = [];
        }
        monthlyData[month].push(item);
    });
    
    // 准备图表数据
    const labels = [];
    const monthlyTotals = [];
    
    // 计算每月小计
    for (let month = 1; month <= 12; month++) {
        if (monthlyData[month]) {
            labels.push(`${month}月`);
            
            let monthTotal = 0;
            monthlyData[month].forEach(item => {
                // 只计算非零字段的小计
                nonZeroHeaders.forEach(key => {
                    if (typeof item[key] === 'number') {
                        monthTotal += item[key];
                    }
                });
            });
            
            monthlyTotals.push(monthTotal);
        } else {
            labels.push(`${month}月`);
            monthlyTotals.push(0);
        }
    }
    
    // 创建图表
    incomeDashboardChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '月收入趋势',
                data: monthlyTotals,
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '收入 (元)'
                    }
                }
            }
        }
    });
}
// 导出数据功能
function exportIncomeData() {
    // 获取当前选择的年份
    const year = document.getElementById('income-year-select').value;
    
    // 获取当前显示的表格数据（已经过滤掉全为0的字段）
    const table = document.getElementById('income-table');
    const headers = [];
    const data = [];
    
    // 获取表头
    const headerRow = table.querySelector('thead tr');
    headerRow.querySelectorAll('th').forEach(th => {
        headers.push(th.textContent);
    });
    
    // 获取数据行（排除总计行）
    const dataRows = table.querySelectorAll('tbody tr:not(:last-child)');
    dataRows.forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(cell => {
            rowData.push(cell.textContent);
        });
        data.push(rowData);
    });
    
    // 创建工作簿
    const wb = XLSX.utils.book_new();
    
    // 准备Excel数据
    const excelData = [headers];
    data.forEach(row => excelData.push(row));
    
    // 创建工作表
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // 将工作表添加到工作簿
    XLSX.utils.book_append_sheet(wb, ws, `${year}年收入数据`);
    
    // 导出文件
    XLSX.writeFile(wb, `综合收入数据_${year}年.xlsx`);
}



// 未充电时长统计相关变量
let unchargedData = [];
let currentUnchargedPage = 1;
const rowsPerPage = 10;
let filteredUnchargedData = [];
let currentDurationFilter = 'all';
let unchargedUpdateInterval = null; // 动态更新定时器

// 加载未充电时长统计数据
function loadUnchargedData() {
    const loadingElement = document.createElement('div');
    loadingElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载未充电时长统计数据，请稍候...';
    loadingElement.style.textAlign = 'center';
    loadingElement.style.padding = '20px';
    
    const tableContainer = document.querySelector('.uncharged-table-container');
    tableContainer.prepend(loadingElement);
    
    fetch('https://www.csfhcdz.cn/data/wcdsc.xlsx?t=' + new Date().getTime())
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 转换为JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // 处理表头
            const headers = jsonData[0];
            
            // 处理数据行
            unchargedData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                // 检查是否有有效数据（A、B、C列至少有一个不为空）
                if (row && row.length >= 3 && (row[0] || row[1] || row[2])) {
                    // 确保日期格式正确
                    const lastEndTime = formatDateString(row[2]);
                    // 从Excel第四列加载截止一直未充电时间数据
                    const stillUnchargedTime = row[3] ? formatDateString(row[3]) : '';
                    
                    unchargedData.push({
                        stationName: row[0] || '',
                        terminalName: row[1] || '',
                        lastEndTime: lastEndTime,
                        stillUnchargedTime: stillUnchargedTime, // 从Excel D列加载数据
                        duration: 0 // E列将动态计算
                    });
                }
            }
            
            // 初始化筛选器
            initDurationFilter();
            
            // 启动动态时间更新
            startUnchargedDynamicUpdate();
            
            // 更新表格
            updateUnchargedTable();
        })
        .catch(error => {
            console.error('加载未充电时长统计数据失败:', error);
            const tableContainer = document.querySelector('.uncharged-table-container');
            tableContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-exclamation-triangle"></i> 加载未充电时长统计数据失败</div>';
        })
        .finally(() => {
            loadingElement.remove();
        });
}

// 格式化日期字符串，确保正确显示
function formatDateString(dateStr) {
    if (!dateStr) return '';
    
    // 如果已经是字符串格式，直接返回
    if (typeof dateStr === 'string') {
        return dateStr;
    }
    
    // 如果是日期对象
    if (dateStr instanceof Date) {
        const year = dateStr.getFullYear();
        const month = (dateStr.getMonth() + 1).toString().padStart(2, '0');
        const day = dateStr.getDate().toString().padStart(2, '0');
        const hours = dateStr.getHours().toString().padStart(2, '0');
        const minutes = dateStr.getMinutes().toString().padStart(2, '0');
        const seconds = dateStr.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    
    // 如果是Excel日期序列号
    if (typeof dateStr === 'number') {
        const jsDate = excelDateToJSDate(dateStr);
        const year = jsDate.getFullYear();
        const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
        const day = jsDate.getDate().toString().padStart(2, '0');
        const hours = jsDate.getHours().toString().padStart(2, '0');
        const minutes = jsDate.getMinutes().toString().padStart(2, '0');
        const seconds = jsDate.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    
    return '';
}

// Excel日期序列号转换为JS日期对象
function excelDateToJSDate(serial) {
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    
    const fractional_day = serial - Math.floor(serial) + 0.0000001;
    let total_seconds = Math.floor(86400 * fractional_day);
    
    const seconds = total_seconds % 60;
    total_seconds -= seconds;
    
    const hours = Math.floor(total_seconds / (60 * 60));
    const minutes = Math.floor(total_seconds / 60) % 60;
    
    return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
}

// 获取当前时间字符串（yyyy-mm-dd hh:mm:ss格式）
function getCurrentTimeString() {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// 计算时间差（小时数）
function calculateTimeDifference(startTimeStr, endTimeStr) {
    if (!startTimeStr || !endTimeStr) return 0;
    
    try {
        const startTime = new Date(startTimeStr);
        const endTime = new Date(endTimeStr);
        
        if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
            return 0;
        }
        
        const diffMs = endTime.getTime() - startTime.getTime();
        const diffHours = diffMs / (1000 * 60 * 60); // 转换为小时
        
        return Math.max(0, diffHours); // 确保不为负数
    } catch (error) {
        console.error('计算时间差错误:', error);
        return 0;
    }
}

// 更新未充电数据的动态时间
function updateUnchargedDynamicData() {
    const currentTime = getCurrentTimeString();
    
    unchargedData.forEach(item => {
        if (item.lastEndTime && item.stillUnchargedTime) {
            // item.stillUnchargedTime = currentTime; // 已删除动态时间赋值
            item.duration = calculateTimeDifference(item.lastEndTime, item.stillUnchargedTime);
        }
    });
    
    // 更新筛选后的数据
    if (filteredUnchargedData.length > 0) {
        filterUnchargedData();
    }
}

// 启动未充电数据的动态更新
function startUnchargedDynamicUpdate() {
    // 清除之前的定时器
    if (unchargedUpdateInterval) {
        clearInterval(unchargedUpdateInterval);
    }
    
    // 立即更新一次
    updateUnchargedDynamicData();
    
    // 每秒更新一次 - 已禁用：动态时间更新已删除
    // unchargedUpdateInterval = setInterval(() => {
    //     updateUnchargedDynamicData();
    //     updateUnchargedTable();
    // }, 1000);
}

// 停止未充电数据的动态更新
function stopUnchargedDynamicUpdate() {
    if (unchargedUpdateInterval) {
        clearInterval(unchargedUpdateInterval);
        unchargedUpdateInterval = null;
    }
}

// 初始化时长筛选器
function initDurationFilter() {
    const durationFilter = document.getElementById('uncharged-duration-filter');
    durationFilter.addEventListener('change', function() {
        currentDurationFilter = this.value;
        currentUnchargedPage = 1; // 重置到第一页
        filterUnchargedData();
        updateUnchargedTable();
    });
    
    // 初始化页面选择器
    document.getElementById('page-select').addEventListener('change', function() {
        currentUnchargedPage = parseInt(this.value);
        // 立即更新当前页码显示
        document.getElementById('current-page').textContent = currentUnchargedPage;
        updateUnchargedTable();
    });
}

// 根据时长筛选数据
function filterUnchargedData() {
    if (currentDurationFilter === 'all') {
        filteredUnchargedData = [...unchargedData];
    } else {
        filteredUnchargedData = unchargedData.filter(item => {
            const duration = parseFloat(item.duration);
            switch (currentDurationFilter) {
                case 'lt30':
                    return duration < 30;
                case 'ge30lt60':
                    return duration >= 30 && duration < 60;
                case 'ge60lt90':
                    return duration >= 60 && duration < 90;
                case 'ge90':
                    return duration >= 90;
                default:
                    return true;
            }
        });
    }
    
    // 更新分页信息
    updatePagination();
}

// 更新分页信息
function updatePagination() {
    const totalPages = Math.ceil(filteredUnchargedData.length / rowsPerPage) || 1;
    document.getElementById('total-pages').textContent = totalPages;
    document.getElementById('current-page').textContent = Math.min(currentUnchargedPage, totalPages);
    
    // 更新页面选择器
    const pageSelect = document.getElementById('page-select');
    pageSelect.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        if (i === currentUnchargedPage) {
            option.selected = true;
        }
        pageSelect.appendChild(option);
    }
    
    // 如果当前页超出范围，重置为最后一页
    if (currentUnchargedPage > totalPages) {
        currentUnchargedPage = totalPages;
    }
}
// 更新未充电时长统计表格
function updateUnchargedTable() {
    // 先筛选数据
    if (filteredUnchargedData.length === 0) {
        filterUnchargedData();
    }
    
    const tableBody = document.getElementById('uncharged-table-body');
    tableBody.innerHTML = '';
    
    // 计算当前页的数据范围
    const startIndex = (currentUnchargedPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, filteredUnchargedData.length);
    
    // 显示当前页的数据
    for (let i = startIndex; i < endIndex; i++) {
        const item = filteredUnchargedData[i];
        const row = document.createElement('tr');
        
        // 格式化时长数据，保留2位小数
        const formattedDuration = parseFloat(item.duration || 0).toFixed(2);
        
        row.innerHTML = `
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.stationName}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.terminalName}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.lastEndTime}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.stillUnchargedTime}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${formattedDuration}</td>
        `;
        
        tableBody.appendChild(row);
    }
    
    // 更新数据信息
    document.getElementById('uncharged-data-info').textContent = `共加载 ${filteredUnchargedData.length} 条数据`;
}
        function startClock() {
            const el = document.getElementById('time-display');
            if (!el) return;
            function pad(n){return n.toString().padStart(2,'0');}
            function format(dt){
                const y = dt.getFullYear();
                const m = pad(dt.getMonth()+1);
                const d = pad(dt.getDate());
                const week = ['日','一','二','三','四','五','六'][dt.getDay()];
                const hh = pad(dt.getHours());
                const mm = pad(dt.getMinutes());
                const ss = pad(dt.getSeconds());
                return `${y}年${m}月${d}日 星期${week} ${hh}:${mm}:${ss}`;
            }
            el.textContent = format(new Date());
            setInterval(()=>{ el.textContent = format(new Date()); }, 1000);
        }

        // 将数字单元格打上不换行标记，避免金额/数值换行
        function isNumericString(text) {
            const s = String(text).trim();
            // 支持：货币符号、千分位、小数、单位(kwh/元)、百分比
            return /^¥?-?\d{1,3}(,\d{3})*(\.\d+)?(\s*(kwh|元))?$/.test(s)
                || /^-?\d+(\.\d+)?%$/.test(s);
        }

        function markNumericCells(tableEl) {
            const cells = tableEl.querySelectorAll('td, th');
            cells.forEach(cell => {
                const txt = (cell.textContent || '').trim();
                if (isNumericString(txt)) {
                    cell.classList.add('num-cell');
                    // 以内联样式加一道保险，确保不换行
                    cell.style.whiteSpace = 'nowrap';
                    cell.style.wordBreak = 'normal';
                    cell.style.overflowWrap = 'normal';
                    cell.style.textAlign = 'center';
                }
            });
        }

        // 处理单位信息左对齐
        function handleUnitInfoAlignment(tableEl) {
            const cells = tableEl.querySelectorAll('td, th');
            cells.forEach(cell => {
                const txt = (cell.textContent || '').trim();
                if (txt.includes('单位：长沙飞狐电动汽车充电服务有限公司')) {
                    cell.classList.add('unit-info-cell');
                    cell.style.textAlign = 'left';
                }
            });
        }

        // 按列识别数字列并整体加不换行样式，适配多种格式
        function markNumericColumns(tableEl) {
          const rows = tableEl.rows;
          if (!rows.length) return;
          const cols = rows[0].cells.length;
          const headerTexts = Array.from(rows[0].cells).map(c => (c.textContent || '').trim());
          const numericHeaderKeywords = /(kwh|电费|服务费|收入|金额|元|订单|数量|合计|同比|环比|率|百分比|%|数|量|次|时长|小时|利用率|金额)/i;

          const isNumericCol = new Array(cols).fill(false);

          // 规则1：表头关键字判定
          for (let c = 0; c < cols; c++) {
            if (numericHeaderKeywords.test(headerTexts[c])) isNumericCol[c] = true;
          }

          // 规则2：采样内容判定（忽略表头，>=60% 数字即视为数字列）
          for (let c = 0; c < cols; c++) {
            let numericCount = 0, total = 0;
            for (let r = 1; r < rows.length; r++) {
              const cell = rows[r].cells[c];
              if (!cell) continue;
              const txt = (cell.textContent || '').trim();
              if (txt) {
                total++;
                if (isNumericString(txt)) numericCount++;
              }
            }
            if (total > 0 && numericCount / total >= 0.6) isNumericCol[c] = true;
          }

          // 应用列样式
          for (let c = 0; c < cols; c++) {
            if (isNumericCol[c]) {
              for (let r = 0; r < rows.length; r++) {
                const cell = rows[r].cells[c];
                if (cell) cell.classList.add('num-col');
              }
            }
          }
        }

        // 整体情况概要数据存储对象
        const overviewData = {
            summary: {},
            overallMetrics: {},
            sfpMetrics: {},
            glMetrics: {},
            deviceMetrics: [],
            annualMetrics: [],
            coreMetrics: [],
            timeDistribution: { sfp: [], gl: [] },
            revenueCost: [],
            annualTrend: []
        };

        // 从Excel文件加载整体情况概要数据
        async function loadOverviewData() {
            try {
                const response = await fetch('https://www.csfhcdz.cn/data/cddata.xlsx');
                if (!response.ok) {
                    throw new Error('无法加载Excel文件');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // 解析每个工作表的数据
                parseOverviewSheetData(workbook);
                
                // 更新整体情况概要
                updateOverviewData();
                
            } catch (error) {
                console.error('加载整体情况概要数据失败:', error);
            }
        }

        // 解析整体情况概要工作表数据
        function parseOverviewSheetData(workbook) {
            // 解析整体情况概要 (Sheet1)
            const summarySheet = workbook.Sheets[workbook.SheetNames[0]];
            const summaryData = XLSX.utils.sheet_to_json(summarySheet, { header: 1 });
            
            // 跳过标题行
            for (let i = 1; i < summaryData.length; i++) {
                if (summaryData[i][0]) {
                    overviewData.summary[summaryData[i][0]] = summaryData[i][1];
                }
            }
            
            // 解析总体运营指标 (Sheet2)
            const overallSheet = workbook.Sheets[workbook.SheetNames[1]];
            const overallData = XLSX.utils.sheet_to_json(overallSheet, { header: 1 });
            
            for (let i = 1; i < overallData.length; i++) {
                if (overallData[i][0]) {
                    overviewData.overallMetrics[overallData[i][0]] = overallData[i][1];
                }
            }
            
            // 解析四方坪站运营指标 (Sheet3)
            const sfpSheet = workbook.Sheets[workbook.SheetNames[2]];
            const sfpData = XLSX.utils.sheet_to_json(sfpSheet, { header: 1 });
            
            for (let i = 1; i < sfpData.length; i++) {
                if (sfpData[i][0]) {
                    overviewData.sfpMetrics[sfpData[i][0]] = sfpData[i][1];
                }
            }
            
            // 解析高岭站运营指标 (Sheet4)
            const glSheet = workbook.Sheets[workbook.SheetNames[3]];
            const glData = XLSX.utils.sheet_to_json(glSheet, { header: 1 });
            
            for (let i = 1; i < glData.length; i++) {
                if (glData[i][0]) {
                    overviewData.glMetrics[glData[i][0]] = glData[i][1];
                }
            }
            
            // 解析设备充电总数据 (Sheet5)
            const deviceSheet = workbook.Sheets[workbook.SheetNames[4]];
            const deviceData = XLSX.utils.sheet_to_json(deviceSheet, { header: 1 });
            
            for (let i = 1; i < deviceData.length; i++) {
                if (deviceData[i][0]) {
                    overviewData.deviceMetrics.push({
                        name: deviceData[i][0],
                        charge: deviceData[i][1],
                        revenue: deviceData[i][2]
                    });
                }
            }
            
            // 解析年度运营数据 (Sheet6)
            const annualSheet = workbook.Sheets[workbook.SheetNames[5]];
            const annualData = XLSX.utils.sheet_to_json(annualSheet, { header: 1 });
            
            for (let i = 1; i < annualData.length; i++) {
                if (annualData[i][0]) {
                    overviewData.annualMetrics.push({
                        year: annualData[i][0],
                        charge: annualData[i][1],
                        revenue: annualData[i][2]
                    });
                }
            }
            
            // 解析充电站核心指标对比 (Sheet7)
            const coreSheet = workbook.Sheets[workbook.SheetNames[6]];
            const coreData = XLSX.utils.sheet_to_json(coreSheet, { header: 1 });
            
            for (let i = 2; i < coreData.length; i++) {
                if (coreData[i][0]) {
                    overviewData.coreMetrics.push({
                        station: coreData[i][0],
                        charge: coreData[i][1],
                        revenue: coreData[i][2],
                        orders: coreData[i][3]
                    });
                }
            }
            
            // 解析充电时段分布 (Sheet8)
            const timeSheet = workbook.Sheets[workbook.SheetNames[7]];
            const timeData = XLSX.utils.sheet_to_json(timeSheet, { header: 1 });
            
            // 分组数据
            for (let i = 2; i < timeData.length; i += 2) {
                if (timeData[i][0] && timeData[i][0].includes('sfp')) {
                    overviewData.timeDistribution.sfp.push(timeData[i][2]);
                    if (timeData[i+1] && timeData[i+1][0].includes('gl')) {
                        overviewData.timeDistribution.gl.push(timeData[i+1][2]);
                    }
                }
            }
            
            // 解析收入与成本构成 (Sheet9)
            const revenueSheet = workbook.Sheets[workbook.SheetNames[8]];
            const revenueData = XLSX.utils.sheet_to_json(revenueSheet, { header: 1 });
            
            for (let i = 2; i < revenueData.length; i++) {
                if (revenueData[i][0]) {
                    overviewData.revenueCost.push({
                        station: revenueData[i][0],
                        income: revenueData[i][1],
                        cost: revenueData[i][2],
                        profit: revenueData[i][3]
                    });
                }
            }
            
            // 解析年度充电量趋势 (Sheet10)
            const trendSheet = workbook.Sheets[workbook.SheetNames[9]];
            const trendData = XLSX.utils.sheet_to_json(trendSheet, { header: 1 });
            
            // 修正：确保正确获取年度充电量数据
            overviewData.annualTrend = [];
            for (let i = 1; i < trendData.length; i++) {
                if (trendData[i][0]) {
                    // 确保只获取充电量数据（第二列）
                    overviewData.annualTrend.push(trendData[i][1]);
                }
            }
        }

        // 更新整体情况概要数据
        function updateOverviewData() {
            const overviewGrid = document.getElementById('overview-grid');
            if (overviewGrid) {
                overviewGrid.innerHTML = `
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.cdz || '2座'}</div>
                        <div class="overview-name-large">运营中充电站数量</div>
                        <div class="overview-subtext">四方坪站、高岭站</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.gl || '11150kw'}</div>
                        <div class="overview-name-large">设备总功率</div>
                        <div class="overview-subtext">四方坪站${overviewData.summary.sfpgl || '8990kw'}<br>高岭站${overviewData.summary.glgl || '2160kw'}</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.qs || '178支'}</div>
                        <div class="overview-name-large">总充电枪数量</div>
                        <div class="overview-subtext">四方坪站${overviewData.summary.sfpcdq || '142支'}<br>高岭站${overviewData.summary.glcdq || '36支'}</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.zy || '15支'}</div>
                        <div class="overview-name-large">占用充电枪数量</div>
                        <div class="overview-subtext">四方坪站${overviewData.summary.sfpz || '15支'}</div>
                    </div>
                `;
            }
        }

        // 页面加载完成后加载整体情况概要数据
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
            
            // 初始化星空背景
            initStarfield();
            
            // 初始化数据可视化分析
            initVisualizationAnalysis();
            
            // 初始化用户充电行为分析
            initUserBehaviorAnalysis();
            
            // 初始化经营效率分析
            initEfficiencyAnalysis();
        });

        // 数据可视化分析相关变量
        let visualizationData = {
            stationData: [], // sheet2数据
            terminalData: [], // sheet3数据
            vehicleData: [], // sheet4数据
            userData: [] // sheet5数据
        };
        let currentVisualizationDate = null;
        let visualizationCharts = {
            station: null,
            terminal: null,
            vehicle: null,
            user: null
        };

        // 用户充电行为分析相关变量
        let behaviorData = [];
        let currentDateIndex = 0;
        let behaviorChart = null;
        let refreshInterval = null; // 自动刷新定时器
        let currentDataMode = 'day'; // 'day' 或 'month'
        let currentDayIndex = 0; // 日数据模式下的当前日期索引
        let currentMonthIndex = 0; // 月数据模式下的当前月份索引
        let dayDataList = []; // 日数据列表
        let monthDataList = []; // 月数据列表

        // 初始化数据可视化分析
        async function initVisualizationAnalysis() {
            try {
                // 设置默认日期为2025-09
                currentVisualizationDate = '2025-09';
                
                // 更新日期显示
                document.getElementById('visualization-date-display').textContent = currentVisualizationDate;
                
                // 加载数据
                await loadVisualizationData();
                
                // 设置翻页按钮事件
                setupVisualizationControls();
                
                // 渲染所有图表
                renderAllVisualizationCharts();
                
                // 更新按钮状态
                updateVisualizationButtonStates();
                
            } catch (error) {
                console.error('初始化数据可视化分析失败:', error);
            }
        }

        // Excel日期转换函数
        function convertExcelDate(excelDate) {
            if (!excelDate) return null;
            
            // 如果是数字（Excel日期序列号）
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().slice(0, 7); // 返回yyyy-mm格式
            }
            
            // 如果已经是字符串格式
            if (typeof excelDate === 'string') {
                // 检查是否是yyyy-mm格式
                if (/^\d{4}-\d{2}$/.test(excelDate)) {
                    return excelDate;
                }
                // 尝试解析其他日期格式
                const date = new Date(excelDate);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().slice(0, 7);
                }
            }
            
            return null;
        }

        // 加载可视化数据
        async function loadVisualizationData() {
            try {
                const response = await fetch('https://www.csfhcdz.cn/data/hzsj.xlsx');
                if (!response.ok) {
                    throw new Error('数据加载失败');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // 加载sheet2数据（站点数据）
                if (workbook.Sheets['Sheet2']) {
                    const sheet2Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet2'], { header: 1 });
                    visualizationData.stationData = processSheet2Data(sheet2Data);
                }
                
                // 加载sheet3数据（电站终端数据）
                if (workbook.Sheets['Sheet3']) {
                    const sheet3Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet3'], { header: 1 });
                    visualizationData.terminalData = processSheet3Data(sheet3Data);
                }
                
                // 加载sheet4数据（车辆分类数据）
                if (workbook.Sheets['Sheet4']) {
                    const sheet4Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet4'], { header: 1 });
                    visualizationData.vehicleData = processSheet4Data(sheet4Data);
                }
                
                // 加载sheet5数据（用户分类数据）
                if (workbook.Sheets['Sheet5']) {
                    const sheet5Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet5'], { header: 1 });
                    visualizationData.userData = processSheet5Data(sheet5Data);
                }
                
            } catch (error) {
                console.error('加载可视化数据失败:', error);
            }
        }

        // 处理sheet2数据（站点数据）
        function processSheet2Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                station: row[1],
                chargingPower: parseFloat(row[2]) || 0,
                serviceFee: parseFloat(row[3]) || 0,
                chargingFee: parseFloat(row[4]) || 0,
                orderCount: parseInt(row[5]) || 0
            })).filter(item => item.time && item.station);
        }

        // 处理sheet3数据（电站终端数据）
        function processSheet3Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                stationName: row[1],
                terminalName: row[2],
                chargingPower: parseFloat(row[3]) || 0,
                orderCount: parseInt(row[4]) || 0,
                avgDailyPower: parseFloat(row[5]) || 0
            })).filter(item => item.time && item.stationName && item.terminalName);
        }

        // 处理sheet4数据（车辆分类数据）
        function processSheet4Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                vehicleType: row[1],
                chargingPower: parseFloat(row[2]) || 0
            })).filter(item => item.time && item.vehicleType);
        }

        // 处理sheet5数据（用户分类数据）
        function processSheet5Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                userType: row[1],
                chargingPower: parseFloat(row[2]) || 0,
                serviceFee: parseFloat(row[3]) || 0,
                chargingFee: parseFloat(row[4]) || 0,
                orderCount: parseInt(row[5]) || 0
            })).filter(item => item.time && item.userType);
        }
        // 设置可视化控制按钮
        function setupVisualizationControls() {
            document.getElementById('prev-visualization-btn').addEventListener('click', () => {
                if (!document.getElementById('prev-visualization-btn').disabled) {
                    changeVisualizationDate(-1);
                }
            });
            
            document.getElementById('next-visualization-btn').addEventListener('click', () => {
                if (!document.getElementById('next-visualization-btn').disabled) {
                    changeVisualizationDate(1);
                }
            });
        }

        // 更新可视化按钮状态
        function updateVisualizationButtonStates() {
            const prevBtn = document.getElementById('prev-visualization-btn');
            const nextBtn = document.getElementById('next-visualization-btn');
            
            // 获取所有可用日期
            const allDates = new Set();
            [...visualizationData.stationData, ...visualizationData.terminalData, 
             ...visualizationData.vehicleData, ...visualizationData.userData]
                .forEach(item => {
                    if (item.time) allDates.add(item.time);
                });
            
            const sortedDates = Array.from(allDates).sort();
            const currentIndex = sortedDates.indexOf(currentVisualizationDate);
            
            // 更新按钮状态
            if (currentIndex <= 0) {
                prevBtn.disabled = true;
                prevBtn.style.background = '#6c757d';
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.disabled = false;
                prevBtn.style.background = '#007bff';
                prevBtn.style.cursor = 'pointer';
            }
            
            if (currentIndex >= sortedDates.length - 1) {
                nextBtn.disabled = true;
                nextBtn.style.background = '#6c757d';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.disabled = false;
                nextBtn.style.background = '#007bff';
                nextBtn.style.cursor = 'pointer';
            }
        }

        // 改变可视化日期
        function changeVisualizationDate(direction) {
            // 获取所有可用日期
            const allDates = new Set();
            [...visualizationData.stationData, ...visualizationData.terminalData, 
             ...visualizationData.vehicleData, ...visualizationData.userData]
                .forEach(item => {
                    if (item.time) allDates.add(item.time);
                });
            
            const sortedDates = Array.from(allDates).sort();
            const currentIndex = sortedDates.indexOf(currentVisualizationDate);
            
            let newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < sortedDates.length) {
                currentVisualizationDate = sortedDates[newIndex];
                document.getElementById('visualization-date-display').textContent = currentVisualizationDate;
                renderAllVisualizationCharts();
                updateVisualizationButtonStates();
            }
        }

        // 渲染所有可视化图表
        function renderAllVisualizationCharts() {
            renderStationChart();
            renderTerminalChart();
            renderVehicleChart();
            renderUserChart();
        }
        // 渲染站点柱状图
        function renderStationChart() {
            const ctx = document.getElementById('station-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.stationData.filter(item => item.time === currentVisualizationDate);
            
            // 按站点分组数据
            const stationGroups = {};
            currentData.forEach(item => {
                if (!stationGroups[item.station]) {
                    stationGroups[item.station] = {
                        chargingPower: 0,
                        serviceFee: 0,
                        chargingFee: 0,
                        orderCount: 0
                    };
                }
                stationGroups[item.station].chargingPower += item.chargingPower;
                stationGroups[item.station].serviceFee += item.serviceFee;
                stationGroups[item.station].chargingFee += item.chargingFee;
                stationGroups[item.station].orderCount += item.orderCount;
            });
            
            const stations = Object.keys(stationGroups);
            const chargingPowerData = stations.map(station => stationGroups[station].chargingPower);
            const serviceFeeData = stations.map(station => stationGroups[station].serviceFee);
            const chargingFeeData = stations.map(station => stationGroups[station].chargingFee);
            const orderCountData = stations.map(station => stationGroups[station].orderCount);
            
            if (visualizationCharts.station) {
                visualizationCharts.station.destroy();
            }
            
            visualizationCharts.station = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stations,
                    datasets: [
                        {
                            label: '充电电量(kwh)',
                            data: chargingPowerData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '充电服务费(元)',
                            data: serviceFeeData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '充电费用(元)',
                            data: chargingFeeData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '订单数量',
                            data: orderCountData,
                            backgroundColor: 'rgba(255, 205, 86, 0.6)',
                            borderColor: 'rgba(255, 205, 86, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    devicePixelRatio: 1,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const station = context.label;
                                    const currentData = visualizationData.stationData.filter(item => 
                                        item.time === currentVisualizationDate && item.station === station
                                    );
                                    
                                    if (currentData.length === 0) return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                    
                                    const total = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const serviceFee = currentData.reduce((sum, item) => sum + item.serviceFee, 0);
                                    const chargingFee = currentData.reduce((sum, item) => sum + item.chargingFee, 0);
                                    const orderCount = currentData.reduce((sum, item) => sum + item.orderCount, 0);
                                    
                                    return [
                                        '充电电量(kwh): ' + total.toFixed(2),
                                        '充电服务费(元): ' + serviceFee.toFixed(2),
                                        '充电费用(元): ' + chargingFee.toFixed(2),
                                        '订单数量: ' + orderCount.toFixed(2)
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        // 渲染电站终端折线图
        function renderTerminalChart() {
            const ctx = document.getElementById('terminal-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.terminalData.filter(item => item.time === currentVisualizationDate);
            
            // 按电站和终端分组
            const terminalGroups = {};
            currentData.forEach(item => {
                const key = `${item.stationName}-${item.terminalName}`;
                if (!terminalGroups[key]) {
                    terminalGroups[key] = {
                        chargingPower: 0,
                        orderCount: 0,
                        avgDailyPower: 0
                    };
                }
                terminalGroups[key].chargingPower += item.chargingPower;
                terminalGroups[key].orderCount += item.orderCount;
                terminalGroups[key].avgDailyPower += item.avgDailyPower;
            });
            
            const terminals = Object.keys(terminalGroups);
            const chargingPowerData = terminals.map(terminal => terminalGroups[terminal].chargingPower);
            const orderCountData = terminals.map(terminal => terminalGroups[terminal].orderCount);
            const avgDailyPowerData = terminals.map(terminal => terminalGroups[terminal].avgDailyPower);
            
            if (visualizationCharts.terminal) {
                visualizationCharts.terminal.destroy();
            }
            
            visualizationCharts.terminal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: terminals,
                    datasets: [
                        {
                            label: '充电电量(kwh)',
                            data: chargingPowerData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '订单数量',
                            data: orderCountData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '平均日充电电量(kwh)',
                            data: avgDailyPowerData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    devicePixelRatio: 1,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const terminal = context.label;
                                    const currentData = visualizationData.terminalData.filter(item => 
                                        item.time === currentVisualizationDate && `${item.stationName}-${item.terminalName}` === terminal
                                    );
                                    
                                    if (currentData.length === 0) return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                    
                                    const chargingPower = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const orderCount = currentData.reduce((sum, item) => sum + item.orderCount, 0);
                                    const avgDailyPower = currentData.reduce((sum, item) => sum + item.avgDailyPower, 0);
                                    
                                    return [
                                        '充电电量(kwh): ' + chargingPower.toFixed(2),
                                        '订单数量: ' + orderCount.toFixed(2),
                                        '平均日充电电量(kwh): ' + avgDailyPower.toFixed(2)
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // 渲染车辆分类饼图
        function renderVehicleChart() {
            const ctx = document.getElementById('vehicle-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.vehicleData.filter(item => item.time === currentVisualizationDate);
            
            // 按车辆分类分组
            const vehicleGroups = {};
            currentData.forEach(item => {
                if (!vehicleGroups[item.vehicleType]) {
                    vehicleGroups[item.vehicleType] = 0;
                }
                vehicleGroups[item.vehicleType] += item.chargingPower;
            });
            
            const vehicleTypes = Object.keys(vehicleGroups);
            const chargingPowerData = Object.values(vehicleGroups);
            const total = chargingPowerData.reduce((sum, value) => sum + value, 0);
            
            // 计算百分比
            const percentages = chargingPowerData.map(value => ((value / total) * 100).toFixed(1));
            
            if (visualizationCharts.vehicle) {
                visualizationCharts.vehicle.destroy();
            }
            
            visualizationCharts.vehicle = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: vehicleTypes.map((type, index) => `${type} (${percentages[index]}%)`),
                    datasets: [{
                        data: chargingPowerData,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    devicePixelRatio: 1,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const vehicleType = vehicleTypes[context.dataIndex];
                                    const currentData = visualizationData.vehicleData.filter(item => 
                                        item.time === currentVisualizationDate && item.vehicleType === vehicleType
                                    );
                                    
                                    if (currentData.length === 0) return context.label + ': ' + context.parsed.toFixed(2);
                                    
                                    const chargingPower = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const total = chargingPowerData.reduce((sum, value) => sum + value, 0);
                                    const percentage = ((chargingPower / total) * 100).toFixed(2);
                                    
                                    return [
                                        '车辆分类: ' + vehicleType,
                                        '充电电量(kwh): ' + chargingPower.toFixed(2),
                                        '占比: ' + percentage + '%'
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        // 渲染用户分类散点图
        function renderUserChart() {
            const ctx = document.getElementById('user-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.userData.filter(item => item.time === currentVisualizationDate);
            
            // 按用户分类分组
            const userGroups = {};
            currentData.forEach(item => {
                if (!userGroups[item.userType]) {
                    userGroups[item.userType] = {
                        chargingPower: 0,
                        serviceFee: 0,
                        chargingFee: 0,
                        orderCount: 0
                    };
                }
                userGroups[item.userType].chargingPower += item.chargingPower;
                userGroups[item.userType].serviceFee += item.serviceFee;
                userGroups[item.userType].chargingFee += item.chargingFee;
                userGroups[item.userType].orderCount += item.orderCount;
            });
            
            const userTypes = Object.keys(userGroups);
            const totalChargingPower = Object.values(userGroups).reduce((sum, group) => sum + group.chargingPower, 0);
            const totalServiceFee = Object.values(userGroups).reduce((sum, group) => sum + group.serviceFee, 0);
            const totalChargingFee = Object.values(userGroups).reduce((sum, group) => sum + group.chargingFee, 0);
            const totalOrderCount = Object.values(userGroups).reduce((sum, group) => sum + group.orderCount, 0);
            
            const datasets = [
                {
                    label: '充电电量(kwh)',
                    data: userTypes.map(userType => ({
                        x: userGroups[userType].chargingPower,
                        y: userGroups[userType].orderCount
                    })),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)'
                },
                {
                    label: '充电服务费(元)',
                    data: userTypes.map(userType => ({
                        x: userGroups[userType].serviceFee,
                        y: userGroups[userType].orderCount
                    })),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)'
                },
                {
                    label: '充电费用(元)',
                    data: userTypes.map(userType => ({
                        x: userGroups[userType].chargingFee,
                        y: userGroups[userType].orderCount
                    })),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)'
                }
            ];
            
            if (visualizationCharts.user) {
                visualizationCharts.user.destroy();
            }
            
            visualizationCharts.user = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    devicePixelRatio: 1,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '数值'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '订单数量'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const userType = userTypes[context.dataIndex];
                                    const currentData = visualizationData.userData.filter(item => 
                                        item.time === currentVisualizationDate && item.userType === userType
                                    );
                                    
                                    if (currentData.length === 0) return context.dataset.label + ': ' + context.parsed.x.toFixed(2);
                                    
                                    const chargingPower = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const serviceFee = currentData.reduce((sum, item) => sum + item.serviceFee, 0);
                                    const chargingFee = currentData.reduce((sum, item) => sum + item.chargingFee, 0);
                                    const orderCount = currentData.reduce((sum, item) => sum + item.orderCount, 0);
                                    const totalChargingPower = Object.values(userGroups).reduce((sum, group) => sum + group.chargingPower, 0);
                                    const percentage = ((chargingPower / totalChargingPower) * 100).toFixed(2);
                                    
                                    return [
                                        '用户分类: ' + userType,
                                        '充电电量(kwh): ' + chargingPower.toFixed(2),
                                        '充电服务费(元): ' + serviceFee.toFixed(2),
                                        '充电费用(元): ' + chargingFee.toFixed(2),
                                        '订单数量: ' + orderCount.toFixed(2),
                                        '占比: ' + percentage + '%'
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // 初始化用户充电行为分析
        async function initUserBehaviorAnalysis() {
            try {
                await loadBehaviorData();
                setupBehaviorControls();
                // 更新图表和电费分析表格
                if (behaviorData.length > 0) {
                    const currentData = behaviorData[currentDateIndex];
                    updateBehaviorChart(currentData);
                    updateElectricityTable(currentData);
                }
                
                // 启动自动刷新功能（每5分钟检查一次数据更新）
                startAutoRefresh();
            } catch (error) {
                console.error('初始化用户充电行为分析失败:', error);
            }
        }

        // 启动自动刷新功能
        function startAutoRefresh() {
            // 清除之前的定时器
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // 每5分钟自动刷新数据
            refreshInterval = setInterval(async () => {
                try {
                    console.log('自动刷新数据...');
                    await loadBehaviorData();
                    
                    // 如果当前日期索引超出范围，重置为最大日期
                    if (currentDateIndex >= behaviorData.length) {
                        currentDateIndex = behaviorData.length - 1;
                    }
                    
                    // 更新图表和电费分析表格
                    if (behaviorData.length > 0) {
                        const currentData = behaviorData[currentDateIndex];
                        updateBehaviorChart(currentData);
                        updateElectricityTable(currentData);
                        
                        // 更新当前日期显示
                        const currentDateDisplay = document.getElementById('current-date-display');
                        if (currentDateDisplay) {
                            currentDateDisplay.textContent = `当前日期：${currentData.displayDate}`;
                        }
                    }
                } catch (error) {
                    console.error('自动刷新数据失败:', error);
                }
            }, 5 * 60 * 1000); // 5分钟
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // 加载行为数据
        async function loadBehaviorData() {
            try {
                const response = await fetch('https://www.csfhcdz.cn/data/yhxw.xlsx?t=' + new Date().getTime());
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                console.log('Excel数据:', jsonData); // 调试用

                // 处理数据 - 按照Excel文件的实际格式加载
                behaviorData = [];

                // 按照Excel文件格式：A列日期，B列站点，C-Z列24小时数据
                // 每天占两行：第一行四方坪站，第二行高岭站
                for (let i = 1; i < jsonData.length; i += 2) {
                    const dateRow = jsonData[i];      // 四方坪站行
                    const stationRow = jsonData[i + 1]; // 高岭站行
                    
                    if (dateRow && dateRow[0]) {
                        const dateStr = dateRow[0];
                        let date;
                        
                        // 处理不同的日期格式
                        if (typeof dateStr === 'number') {
                            // Excel日期数字格式
                            date = new Date((dateStr - 25569) * 86400 * 1000);
                        } else if (typeof dateStr === 'string') {
                            // 字符串格式
                            date = new Date(dateStr);
                        } else {
                            continue;
                        }

                        const dateKey = date.toISOString().split('T')[0];
                        
                        // 从C列开始获取24小时数据（索引2-25）
                        const sfpData = dateRow.slice(2, 26) || new Array(24).fill(0);
                        const glData = stationRow ? stationRow.slice(2, 26) : new Array(24).fill(0);
                        
                        // 添加到图表数据（用于翻页和图表显示）
                        if (!behaviorData.find(d => d.date === dateKey)) {
                            behaviorData.push({
                                date: dateKey,
                                displayDate: formatDate(date),
                                sfpData: sfpData,
                                glData: glData
                            });
                        }
                    }
                }

                // 按日期排序
                behaviorData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // 设置当前日期为最大日期
                if (behaviorData.length > 0) {
                    currentDateIndex = behaviorData.length - 1;
                }

                // 更新按钮状态
                updateBehaviorButtonStates();

            } catch (error) {
                console.error('加载行为数据失败:', error);
                // 数据加载失败时也要更新按钮状态
                updateBehaviorButtonStates();
            }
        }

        // 格式化日期为MM-DD格式
        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
        }
        // 设置行为分析控件
        function setupBehaviorControls() {
            const prevBtn = document.getElementById('prev-data-btn');
            const nextBtn = document.getElementById('next-data-btn');
            const currentDataDisplay = document.getElementById('current-data-display');
            const dayDataBtn = document.getElementById('day-data-btn');
            const monthDataBtn = document.getElementById('month-data-btn');

            // 初始化数据列表
            initializeDataLists();
            
            // 设置默认显示最新数据
            if (dayDataList.length > 0) {
                currentDayIndex = dayDataList.length - 1;
            }
            if (monthDataList.length > 0) {
                currentMonthIndex = monthDataList.length - 1;
            }

            // 数据模式切换事件
            dayDataBtn.addEventListener('click', function() {
                currentDataMode = 'day';
                updateDataModeButtons();
                updateDataDisplay();
                updateBehaviorButtonStates();
            });

            monthDataBtn.addEventListener('click', function() {
                currentDataMode = 'month';
                updateDataModeButtons();
                updateDataDisplay();
                updateBehaviorButtonStates();
            });

            // 翻页按钮事件
            prevBtn.addEventListener('click', function() {
                if (currentDataMode === 'day') {
                    if (currentDayIndex > 0) {
                        currentDayIndex--;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                } else {
                    if (currentMonthIndex > 0) {
                        currentMonthIndex--;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                }
                updateBehaviorButtonStates();
            });

            nextBtn.addEventListener('click', function() {
                if (currentDataMode === 'day') {
                    if (currentDayIndex < dayDataList.length - 1) {
                        currentDayIndex++;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                } else {
                    if (currentMonthIndex < monthDataList.length - 1) {
                        currentMonthIndex++;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                }
                updateBehaviorButtonStates();
            });

            // 初始化显示
            updateDataModeButtons();
            updateDataDisplay();
            updateBehaviorButtonStates();
        }

        // 初始化数据列表
        function initializeDataLists() {
            if (behaviorData.length === 0) return;

            // 初始化日数据列表
            dayDataList = behaviorData.map(item => {
                const date = new Date(item.date);
                return {
                    date: item.date,
                    displayDate: formatDate(date),
                    data: item
                };
            });

            // 初始化月数据列表
            const monthMap = new Map();
            behaviorData.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthMap.has(monthKey)) {
                    monthMap.set(monthKey, {
                        monthKey: monthKey,
                        displayMonth: monthKey,
                        data: []
                    });
                }
                monthMap.get(monthKey).data.push(item);
            });

            monthDataList = Array.from(monthMap.values()).sort((a, b) => a.monthKey.localeCompare(b.monthKey));
        }

        // 更新数据模式按钮状态
        function updateDataModeButtons() {
            const dayDataBtn = document.getElementById('day-data-btn');
            const monthDataBtn = document.getElementById('month-data-btn');

            if (currentDataMode === 'day') {
                dayDataBtn.style.background = '#007bff';
                monthDataBtn.style.background = '#6c757d';
            } else {
                dayDataBtn.style.background = '#6c757d';
                monthDataBtn.style.background = '#007bff';
            }
        }

        // 更新数据显示
        function updateDataDisplay() {
            const currentDataDisplay = document.getElementById('current-data-display');
            
            if (currentDataMode === 'day') {
                if (dayDataList.length > 0 && currentDayIndex < dayDataList.length) {
                    currentDataDisplay.textContent = dayDataList[currentDayIndex].displayDate;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            } else {
                if (monthDataList.length > 0 && currentMonthIndex < monthDataList.length) {
                    // 月数据模式下，直接显示YYYY-MM格式
                    currentDataDisplay.textContent = monthDataList[currentMonthIndex].displayMonth;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            }
        }

        // 更新行为分析按钮状态
        function updateBehaviorButtonStates() {
            const prevBtn = document.getElementById('prev-data-btn');
            const nextBtn = document.getElementById('next-data-btn');
            
            if (!prevBtn || !nextBtn) return;

            let canGoPrev = false;
            let canGoNext = false;

            if (currentDataMode === 'day') {
                canGoPrev = currentDayIndex > 0;
                canGoNext = currentDayIndex < dayDataList.length - 1;
            } else {
                canGoPrev = currentMonthIndex > 0;
                canGoNext = currentMonthIndex < monthDataList.length - 1;
            }

            // 更新上一页按钮状态
            if (canGoPrev) {
                prevBtn.style.background = '#007bff';
                prevBtn.style.cursor = 'pointer';
                prevBtn.disabled = false;
            } else {
                prevBtn.style.background = '#ccc';
                prevBtn.style.cursor = 'not-allowed';
                prevBtn.disabled = true;
            }
            
            // 更新下一页按钮状态
            if (canGoNext) {
                nextBtn.style.background = '#007bff';
                nextBtn.style.cursor = 'pointer';
                nextBtn.disabled = false;
            } else {
                nextBtn.style.background = '#ccc';
                nextBtn.style.cursor = 'not-allowed';
                nextBtn.disabled = true;
            }
        }

        // 更新行为分析显示
        function updateBehaviorDisplay() {
            if (behaviorData.length === 0) return;

            let currentData = null;

            if (currentDataMode === 'day') {
                if (dayDataList.length > 0 && currentDayIndex < dayDataList.length) {
                    currentData = dayDataList[currentDayIndex].data;
                }
            } else {
                if (monthDataList.length > 0 && currentMonthIndex < monthDataList.length) {
                    // 月数据模式：合并该月所有日期的数据
                    const monthData = monthDataList[currentMonthIndex];
                    currentData = aggregateMonthData(monthData.data);
                }
            }

            if (currentData) {
                // 更新图表和电费分析表格
                updateBehaviorChart(currentData);
                updateElectricityTable(currentData);
            }
        }
        // 聚合月数据
        function aggregateMonthData(monthDataArray) {
            if (monthDataArray.length === 0) return null;

            // 如果只有一天的数据，直接返回
            if (monthDataArray.length === 1) {
                return monthDataArray[0];
            }

            // 聚合多天数据
            const aggregatedData = {
                date: monthDataArray[0].date, // 使用第一天的日期作为代表
                displayDate: monthDataArray[0].displayDate,
                sfpData: new Array(24).fill(0),
                glData: new Array(24).fill(0)
            };

            // 累加24小时数据
            monthDataArray.forEach(dayData => {
                for (let i = 0; i < 24; i++) {
                    aggregatedData.sfpData[i] += (dayData.sfpData[i] || 0);
                    aggregatedData.glData[i] += (dayData.glData[i] || 0);
                }
            });

            return aggregatedData;
        }
        // 计算电费分析数据
        function calculateElectricityData(data) {
            const currentDate = new Date(data.date);
            const month = currentDate.getMonth() + 1; // 1-12
            
            let sfpJian = 0, sfpFeng = 0, sfpPing = 0, sfpGu = 0;
            let glJian = 0, glFeng = 0, glPing = 0, glGu = 0;
            
            // 根据月份确定时段划分
            if (month === 7 || month === 8) {
                // 夏季（7、8月）：尖20:00-23:59，峰16:00-19:59，平06:00-11:59+14:00-15:59，谷00:00-05:59+12:00-13:59
                for (let hour = 0; hour < 24; hour++) {
                    const sfpValue = parseFloat(data.sfpData[hour]) || 0;
                    const glValue = parseFloat(data.glData[hour]) || 0;
                    
                    if (hour >= 20 && hour <= 23) {
                        // 尖时段
                        sfpJian += sfpValue;
                        glJian += glValue;
                    } else if (hour >= 16 && hour <= 19) {
                        // 峰时段
                        sfpFeng += sfpValue;
                        glFeng += glValue;
                    } else if ((hour >= 6 && hour <= 11) || (hour >= 14 && hour <= 15)) {
                        // 平时段
                        sfpPing += sfpValue;
                        glPing += glValue;
                    } else {
                        // 谷时段
                        sfpGu += sfpValue;
                        glGu += glValue;
                    }
                }
            } else if (month === 1 || month === 12) {
                // 冬季（1、12月）：尖18:00-21:59，峰16:00-17:59+22:00-23:59，平06:00-11:59+14:00-15:59，谷00:00-05:59+12:00-13:59
                for (let hour = 0; hour < 24; hour++) {
                    const sfpValue = parseFloat(data.sfpData[hour]) || 0;
                    const glValue = parseFloat(data.glData[hour]) || 0;
                    
                    if (hour >= 18 && hour <= 21) {
                        // 尖时段
                        sfpJian += sfpValue;
                        glJian += glValue;
                    } else if ((hour >= 16 && hour <= 17) || (hour >= 22 && hour <= 23)) {
                        // 峰时段
                        sfpFeng += sfpValue;
                        glFeng += glValue;
                    } else if ((hour >= 6 && hour <= 11) || (hour >= 14 && hour <= 15)) {
                        // 平时段
                        sfpPing += sfpValue;
                        glPing += glValue;
                    } else {
                        // 谷时段
                        sfpGu += sfpValue;
                        glGu += glValue;
                    }
                }
            } else {
                // 其他月份（2、3、4、5、6、9、10、11）：无尖时段，峰16:00-23:59，平06:00-11:59+14:00-15:59，谷00:00-05:59+12:00-13:59
                for (let hour = 0; hour < 24; hour++) {
                    const sfpValue = parseFloat(data.sfpData[hour]) || 0;
                    const glValue = parseFloat(data.glData[hour]) || 0;
                    
                    if (hour >= 16 && hour <= 23) {
                        // 峰时段
                        sfpFeng += sfpValue;
                        glFeng += glValue;
                    } else if ((hour >= 6 && hour <= 11) || (hour >= 14 && hour <= 15)) {
                        // 平时段
                        sfpPing += sfpValue;
                        glPing += glValue;
                    } else {
                        // 谷时段
                        sfpGu += sfpValue;
                        glGu += glValue;
                    }
                }
            }
            
            return {
                sfp: {
                    jian: sfpJian,
                    feng: sfpFeng,
                    ping: sfpPing,
                    gu: sfpGu,
                    total: sfpJian + sfpFeng + sfpPing + sfpGu
                },
                gl: {
                    jian: glJian,
                    feng: glFeng,
                    ping: glPing,
                    gu: glGu,
                    total: glJian + glFeng + glPing + glGu
                }
            };
        }

        // 更新尖峰平谷充电记录表格
        function updateElectricityTable(data) {
            const tbody = document.getElementById('electricity-table-body');
            if (!tbody) return;
            
            const electricityData = calculateElectricityData(data);
            
            // 计算总计
            const totalJian = electricityData.sfp.jian + electricityData.gl.jian;
            const totalFeng = electricityData.sfp.feng + electricityData.gl.feng;
            const totalPing = electricityData.sfp.ping + electricityData.gl.ping;
            const totalGu = electricityData.sfp.gu + electricityData.gl.gu;
            const totalAll = totalJian + totalFeng + totalPing + totalGu;
            
            tbody.innerHTML = `
                <tr>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">四方坪站</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.jian.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.feng.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.ping.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.gu.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0; font-weight: bold;">${electricityData.sfp.total.toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">高岭站</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.jian.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.feng.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.ping.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.gu.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0; font-weight: bold;">${electricityData.gl.total.toFixed(2)}</td>
                </tr>
                <tr style="background-color: #f8f9fa; font-weight: bold;">
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">共计</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalJian.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalFeng.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalPing.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalGu.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalAll.toFixed(2)}</td>
                </tr>
            `;
            
            // 同时更新两个饼图
            updateElectricityPieChartSFP(electricityData);
            updateElectricityPieChartGL(electricityData);
            
            // 更新数字显示和箭头
            updateElectricityNumbers(electricityData, data);
        }

        // 更新数字显示和箭头
        function updateElectricityNumbers(electricityData, currentData) {
            // 获取上个月的数据进行比较
            const currentDate = new Date(currentData.date);
            const previousMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            const previousMonthKey = previousMonth.toISOString().split('T')[0];
            
            // 查找上个月的数据
            const previousData = behaviorData.find(d => d.date === previousMonthKey);
            
            // 更新四方坪站数字显示
            updateStationNumbers('sfp', electricityData.sfp, previousData);
            
            // 更新高岭站数字显示
            updateStationNumbers('gl', electricityData.gl, previousData);
        }
        
        // 更新单个站点的数字显示
        function updateStationNumbers(stationPrefix, currentData, previousData) {
            const fields = ['jian', 'feng', 'ping', 'gu'];
            
            // 计算总数用于百分比计算
            const total = currentData.jian + currentData.feng + currentData.ping + currentData.gu;
            
            fields.forEach(field => {
                const numberElement = document.getElementById(`${stationPrefix}-${field}-number`);
                const percentElement = document.getElementById(`${stationPrefix}-${field}-percent`);
                const numberItemElement = numberElement ? numberElement.closest('.number-item') : null;
                
                if (numberElement && percentElement && numberItemElement) {
                    const value = currentData[field];
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    
                    // 如果数据为0，隐藏整个数字项
                    if (value === 0) {
                        numberItemElement.style.display = 'none';
                    } else {
                        numberItemElement.style.display = 'flex';
                        numberElement.textContent = value.toFixed(2);
                        percentElement.textContent = `(${percentage}%)`;
                    }
                }
            });
        }

        // 更新四方坪站尖峰平谷饼图
        function updateElectricityPieChartSFP(electricityData) {
            const ctx = document.getElementById('electricity-pie-chart-sfp');
            if (!ctx) return;

            // 销毁现有图表
            if (electricityPieChartSFP) {
                electricityPieChartSFP.destroy();
            }

            // 准备四方坪站饼图数据
            const labels = ['尖', '峰', '平', '谷'];
            const data = [
                electricityData.sfp.jian,
                electricityData.sfp.feng,
                electricityData.sfp.ping,
                electricityData.sfp.gu
            ];

            const total = data.reduce((sum, value) => sum + value, 0);

            electricityPieChartSFP = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#ff6b6b', '#ffa726', '#66bb6a', '#42a5f5' // 四方坪站：尖峰平谷
                        ],
                        borderColor: [
                            '#d32f2f', '#f57c00', '#388e3c', '#1976d2' // 四方坪站：尖峰平谷
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '四方坪站 - 尖峰平谷分布图',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 10,
                                boxWidth: 6,
                                boxHeight: 6
                            }
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    cutout: '50%' // 空心饼图
                }
            });
        }

        // 更新高岭站尖峰平谷饼图
        function updateElectricityPieChartGL(electricityData) {
            const ctx = document.getElementById('electricity-pie-chart-gl');
            if (!ctx) return;

            // 销毁现有图表
            if (electricityPieChartGL) {
                electricityPieChartGL.destroy();
            }

            // 准备高岭站饼图数据
            const labels = ['尖', '峰', '平', '谷'];
            const data = [
                electricityData.gl.jian,
                electricityData.gl.feng,
                electricityData.gl.ping,
                electricityData.gl.gu
            ];

            const total = data.reduce((sum, value) => sum + value, 0);

            electricityPieChartGL = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#e57373', '#ffb74d', '#81c784', '#64b5f6' // 高岭站：尖峰平谷
                        ],
                        borderColor: [
                            '#c62828', '#ef6c00', '#2e7d32', '#1565c0' // 高岭站：尖峰平谷
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '高岭站 - 尖峰平谷分布图',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 10,
                                boxWidth: 6,
                                boxHeight: 6
                            }
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    cutout: '50%' // 空心饼图
                }
            });
        }


        // 更新行为分析图表
        function updateBehaviorChart(data) {
            const ctx = document.getElementById('behavior-chart');
            if (!ctx) return;

            // 销毁现有图表
            if (behaviorChart) {
                behaviorChart.destroy();
            }

            const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00-${i.toString().padStart(2, '0')}:59`);

            // 根据数据模式确定图表标题的日期格式
            let chartTitleDate;
            if (currentDataMode === 'day') {
                chartTitleDate = data.displayDate; // 日数据模式：MM-DD格式
            } else {
                // 月数据模式：从monthDataList获取YYYY-MM格式
                if (monthDataList.length > 0 && currentMonthIndex < monthDataList.length) {
                    chartTitleDate = monthDataList[currentMonthIndex].displayMonth;
                } else {
                    chartTitleDate = data.displayDate; // 备用显示
                }
            }

            behaviorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: '四方坪站充电量(kwh)',
                            data: data.sfpData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '高岭站充电量(kwh)',
                            data: data.glData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${chartTitleDate} 充电量趋势分析`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '充电量 (kwh)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        // 经营效率分析相关变量
        let efficiencyData = [];
        let currentEfficiencyDateIndex = 0;
        let efficiencyRefreshInterval = null; // 经营效率自动刷新定时器
        let efficiencyRadarChart = null; // 经营效率雷达图
        let currentEfficiencyDataMode = 'day'; // 'day' 或 'month'
        let currentEfficiencyDayIndex = 0; // 日数据模式下的当前日期索引
        let currentEfficiencyMonthIndex = 0; // 月数据模式下的当前月份索引
        let efficiencyDayDataList = []; // 日数据列表
        let efficiencyMonthDataList = []; // 月数据列表

        // 初始化经营效率分析
        async function initEfficiencyAnalysis() {
            try {
                await loadEfficiencyData();
                setupEfficiencyControls();
                // 更新表格数据和雷达图
                if (efficiencyData.length > 0) {
                    const currentData = efficiencyData[currentEfficiencyDateIndex];
                    updateEfficiencyTable(currentData);
                    updateEfficiencyRadarChart(currentData);
                }
                
                // 启动自动刷新功能（每5分钟检查一次数据更新）
                startEfficiencyAutoRefresh();
            } catch (error) {
                console.error('初始化经营效率分析失败:', error);
            }
        }
        // 加载经营效率数据
        async function loadEfficiencyData() {
            try {
                const response = await fetch('https://www.csfhcdz.cn/data/yyxl.xlsx?t=' + new Date().getTime());
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                console.log('经营效率Excel数据:', jsonData); // 调试用

                // 处理数据 - 按照Excel文件的实际格式加载
                efficiencyData = [];

                // 按照Excel文件格式：A列日期，B列站点，C-H列数据
                // 每天占两行：第一行四方坪站，第二行高岭站
                for (let i = 1; i < jsonData.length; i += 2) {
                    const dateRow = jsonData[i];      // 四方坪站行
                    const stationRow = jsonData[i + 1]; // 高岭站行
                    
                    if (dateRow && dateRow[0]) {
                        const dateStr = dateRow[0];
                        let date;
                        
                        // 处理不同的日期格式
                        if (typeof dateStr === 'number') {
                            // Excel日期数字格式
                            date = new Date((dateStr - 25569) * 86400 * 1000);
                        } else if (typeof dateStr === 'string') {
                            // 字符串格式
                            date = new Date(dateStr);
                        } else {
                            continue;
                        }

                        const dateKey = date.toISOString().split('T')[0];
                        
                        // 从C列开始获取数据（索引2-7对应C-H列）
                        const sfpData = {
                            duration: parseFloat(dateRow[2]) || 0,      // 终端日均充电时长(分钟)
                            utilization: parseFloat(dateRow[3]) || 0,    // 终端日均利用率
                            energy: parseFloat(dateRow[4]) || 0,        // 终端日均充电电量(kwh)
                            revenue: parseFloat(dateRow[5]) || 0,        // 终端日均充电收益(元)
                            power: parseFloat(dateRow[6]) || 0,         // 平均每小时充电功率(kw)
                            times: parseFloat(dateRow[7]) || 0          // 单枪日均充电次数
                        };
                        
                        const glData = {
                            duration: parseFloat(stationRow[2]) || 0,
                            utilization: parseFloat(stationRow[3]) || 0,
                            energy: parseFloat(stationRow[4]) || 0,
                            revenue: parseFloat(stationRow[5]) || 0,
                            power: parseFloat(stationRow[6]) || 0,
                            times: parseFloat(stationRow[7]) || 0
                        };
                        
                        // 添加到数据数组
                        if (!efficiencyData.find(d => d.date === dateKey)) {
                            efficiencyData.push({
                                date: dateKey,
                                displayDate: formatEfficiencyDate(date),
                                sfpData: sfpData,
                                glData: glData
                            });
                        }
                    }
                }

                // 按日期排序
                efficiencyData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // 设置当前日期为最大日期
                if (efficiencyData.length > 0) {
                    currentEfficiencyDateIndex = efficiencyData.length - 1;
                }

                // 更新按钮状态
                updateEfficiencyButtonStates();

            } catch (error) {
                console.error('加载经营效率数据失败:', error);
                // 数据加载失败时也要更新按钮状态
                updateEfficiencyButtonStates();
            }
        }

        // 格式化日期为YYYY-MM-DD格式
        function formatEfficiencyDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 设置经营效率分析控件
        function setupEfficiencyControls() {
            const prevBtn = document.getElementById('efficiency-prev-data-btn');
            const nextBtn = document.getElementById('efficiency-next-data-btn');
            const currentDataDisplay = document.getElementById('efficiency-current-data-display');
            const dayDataBtn = document.getElementById('efficiency-day-data-btn');
            const monthDataBtn = document.getElementById('efficiency-month-data-btn');

            // 初始化数据列表
            initializeEfficiencyDataLists();
            
            // 设置默认显示最新数据
            if (efficiencyDayDataList.length > 0) {
                currentEfficiencyDayIndex = efficiencyDayDataList.length - 1;
            }
            if (efficiencyMonthDataList.length > 0) {
                currentEfficiencyMonthIndex = efficiencyMonthDataList.length - 1;
            }

            // 数据模式切换事件
            dayDataBtn.addEventListener('click', function() {
                currentEfficiencyDataMode = 'day';
                updateEfficiencyDataModeButtons();
                updateEfficiencyDataDisplay();
                updateEfficiencyButtonStates();
            });

            monthDataBtn.addEventListener('click', function() {
                currentEfficiencyDataMode = 'month';
                updateEfficiencyDataModeButtons();
                updateEfficiencyDataDisplay();
                updateEfficiencyButtonStates();
            });

            // 翻页按钮事件
            prevBtn.addEventListener('click', function() {
                if (currentEfficiencyDataMode === 'day') {
                    if (currentEfficiencyDayIndex > 0) {
                        currentEfficiencyDayIndex--;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                } else {
                    if (currentEfficiencyMonthIndex > 0) {
                        currentEfficiencyMonthIndex--;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                }
                updateEfficiencyButtonStates();
            });

            nextBtn.addEventListener('click', function() {
                if (currentEfficiencyDataMode === 'day') {
                    if (currentEfficiencyDayIndex < efficiencyDayDataList.length - 1) {
                        currentEfficiencyDayIndex++;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                } else {
                    if (currentEfficiencyMonthIndex < efficiencyMonthDataList.length - 1) {
                        currentEfficiencyMonthIndex++;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                }
                updateEfficiencyButtonStates();
            });

            // 初始化显示
            updateEfficiencyDataModeButtons();
            updateEfficiencyDataDisplay();
            updateEfficiencyButtonStates();
        }

        // 初始化经营效率数据列表
        function initializeEfficiencyDataLists() {
            if (efficiencyData.length === 0) return;

            // 初始化日数据列表
            efficiencyDayDataList = efficiencyData.map(item => {
                const date = new Date(item.date);
                return {
                    date: item.date,
                    displayDate: formatEfficiencyDate(date).substring(5), // 只显示MM-DD
                    data: item
                };
            });

            // 初始化月数据列表
            const monthMap = new Map();
            efficiencyData.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthMap.has(monthKey)) {
                    monthMap.set(monthKey, {
                        monthKey: monthKey,
                        displayMonth: monthKey,
                        data: []
                    });
                }
                monthMap.get(monthKey).data.push(item);
            });

            efficiencyMonthDataList = Array.from(monthMap.values()).sort((a, b) => a.monthKey.localeCompare(b.monthKey));
        }

        // 更新经营效率数据模式按钮状态
        function updateEfficiencyDataModeButtons() {
            const dayDataBtn = document.getElementById('efficiency-day-data-btn');
            const monthDataBtn = document.getElementById('efficiency-month-data-btn');

            if (currentEfficiencyDataMode === 'day') {
                dayDataBtn.style.background = '#007bff';
                monthDataBtn.style.background = '#6c757d';
            } else {
                dayDataBtn.style.background = '#6c757d';
                monthDataBtn.style.background = '#007bff';
            }
        }

        // 更新经营效率数据显示
        function updateEfficiencyDataDisplay() {
            const currentDataDisplay = document.getElementById('efficiency-current-data-display');
            
            if (currentEfficiencyDataMode === 'day') {
                if (efficiencyDayDataList.length > 0 && currentEfficiencyDayIndex < efficiencyDayDataList.length) {
                    currentDataDisplay.textContent = efficiencyDayDataList[currentEfficiencyDayIndex].displayDate;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            } else {
                if (efficiencyMonthDataList.length > 0 && currentEfficiencyMonthIndex < efficiencyMonthDataList.length) {
                    // 月数据模式下，直接显示YYYY-MM格式
                    currentDataDisplay.textContent = efficiencyMonthDataList[currentEfficiencyMonthIndex].displayMonth;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            }
        }

        // 更新经营效率分析按钮状态
        function updateEfficiencyButtonStates() {
            const prevBtn = document.getElementById('efficiency-prev-data-btn');
            const nextBtn = document.getElementById('efficiency-next-data-btn');
            
            if (!prevBtn || !nextBtn) return;

            let canGoPrev = false;
            let canGoNext = false;

            if (currentEfficiencyDataMode === 'day') {
                canGoPrev = currentEfficiencyDayIndex > 0;
                canGoNext = currentEfficiencyDayIndex < efficiencyDayDataList.length - 1;
            } else {
                canGoPrev = currentEfficiencyMonthIndex > 0;
                canGoNext = currentEfficiencyMonthIndex < efficiencyMonthDataList.length - 1;
            }

            // 更新上一页按钮状态
            if (canGoPrev) {
                prevBtn.style.background = '#007bff';
                prevBtn.style.cursor = 'pointer';
                prevBtn.disabled = false;
            } else {
                prevBtn.style.background = '#ccc';
                prevBtn.style.cursor = 'not-allowed';
                prevBtn.disabled = true;
            }
            
            // 更新下一页按钮状态
            if (canGoNext) {
                nextBtn.style.background = '#007bff';
                nextBtn.style.cursor = 'pointer';
                nextBtn.disabled = false;
            } else {
                nextBtn.style.background = '#ccc';
                nextBtn.style.cursor = 'not-allowed';
                nextBtn.disabled = true;
            }
        }

        // 更新日期显示
        function updateEfficiencyDateDisplay(data) {
            const currentDateDisplay = document.getElementById('efficiency-date-display');
            if (currentDateDisplay && data) {
                currentDateDisplay.textContent = `当前日期：${data.displayDate}`;
            }
        }

        // 更新经营效率分析显示
        function updateEfficiencyDisplay() {
            if (efficiencyData.length === 0) return;

            let currentData = null;

            if (currentEfficiencyDataMode === 'day') {
                if (efficiencyDayDataList.length > 0 && currentEfficiencyDayIndex < efficiencyDayDataList.length) {
                    currentData = efficiencyDayDataList[currentEfficiencyDayIndex].data;
                }
            } else {
                if (efficiencyMonthDataList.length > 0 && currentEfficiencyMonthIndex < efficiencyMonthDataList.length) {
                    // 月数据模式：计算该月所有日期的平均值
                    const monthData = efficiencyMonthDataList[currentEfficiencyMonthIndex];
                    currentData = calculateEfficiencyMonthAverage(monthData.data);
                }
            }

            if (currentData) {
                // 更新表格数据和雷达图
                updateEfficiencyTable(currentData);
                updateEfficiencyRadarChart(currentData);
            }
        }
        // 计算经营效率月数据平均值
        function calculateEfficiencyMonthAverage(monthDataArray) {
            if (monthDataArray.length === 0) return null;

            // 如果只有一天的数据，直接返回
            if (monthDataArray.length === 1) {
                return monthDataArray[0];
            }

            // 计算平均值
            const averageData = {
                date: monthDataArray[0].date, // 使用第一天的日期作为代表
                displayDate: monthDataArray[0].displayDate,
                sfpData: {
                    duration: 0,
                    utilization: 0,
                    energy: 0,
                    revenue: 0,
                    power: 0,
                    times: 0
                },
                glData: {
                    duration: 0,
                    utilization: 0,
                    energy: 0,
                    revenue: 0,
                    power: 0,
                    times: 0
                }
            };

            // 累加所有数据
            monthDataArray.forEach(dayData => {
                // 四方坪站数据累加
                averageData.sfpData.duration += dayData.sfpData.duration || 0;
                averageData.sfpData.utilization += dayData.sfpData.utilization || 0;
                averageData.sfpData.energy += dayData.sfpData.energy || 0;
                averageData.sfpData.revenue += dayData.sfpData.revenue || 0;
                averageData.sfpData.power += dayData.sfpData.power || 0;
                averageData.sfpData.times += dayData.sfpData.times || 0;

                // 高岭站数据累加
                averageData.glData.duration += dayData.glData.duration || 0;
                averageData.glData.utilization += dayData.glData.utilization || 0;
                averageData.glData.energy += dayData.glData.energy || 0;
                averageData.glData.revenue += dayData.glData.revenue || 0;
                averageData.glData.power += dayData.glData.power || 0;
                averageData.glData.times += dayData.glData.times || 0;
            });

            // 计算平均值（除以天数）
            const dayCount = monthDataArray.length;
            averageData.sfpData.duration /= dayCount;
            averageData.sfpData.utilization /= dayCount;
            averageData.sfpData.energy /= dayCount;
            averageData.sfpData.revenue /= dayCount;
            averageData.sfpData.power /= dayCount;
            averageData.sfpData.times /= dayCount;

            averageData.glData.duration /= dayCount;
            averageData.glData.utilization /= dayCount;
            averageData.glData.energy /= dayCount;
            averageData.glData.revenue /= dayCount;
            averageData.glData.power /= dayCount;
            averageData.glData.times /= dayCount;

            return averageData;
        }

        // 更新经营效率分析表格
        function updateEfficiencyTable(data) {
            if (!data) return;

            // 更新四方坪站数据
            document.getElementById('sifang-duration').textContent = data.sfpData.duration.toFixed(2);
            document.getElementById('sifang-utilization').textContent = (data.sfpData.utilization * 100).toFixed(2) + '%';
            document.getElementById('sifang-energy').textContent = data.sfpData.energy.toFixed(2);
            document.getElementById('sifang-revenue').textContent = data.sfpData.revenue.toFixed(2);
            document.getElementById('sifang-power').textContent = data.sfpData.power.toFixed(2);
            document.getElementById('sifang-times').textContent = data.sfpData.times.toFixed(2);

            // 更新高岭站数据
            document.getElementById('gaoling-duration').textContent = data.glData.duration.toFixed(2);
            document.getElementById('gaoling-utilization').textContent = (data.glData.utilization * 100).toFixed(2) + '%';
            document.getElementById('gaoling-energy').textContent = data.glData.energy.toFixed(2);
            document.getElementById('gaoling-revenue').textContent = data.glData.revenue.toFixed(2);
            document.getElementById('gaoling-power').textContent = data.glData.power.toFixed(2);
            document.getElementById('gaoling-times').textContent = data.glData.times.toFixed(2);
        }
        // 更新经营效率雷达图
        function updateEfficiencyRadarChart(data) {
            const ctx = document.getElementById('efficiency-radar-chart');
            if (!ctx) return;

            // 销毁现有图表
            if (efficiencyRadarChart) {
                efficiencyRadarChart.destroy();
            }

            // 准备雷达图数据
            const labels = [
                '终端日均充电时长',
                '终端日均利用率',
                '终端日均充电电量',
                '终端日均充电收益',
                '平均每小时充电功率',
                '单枪日均充电次数'
            ];

            // 标准化数据用于雷达图显示
            const sfpData = [
                data.sfpData.duration,
                data.sfpData.utilization * 100,
                data.sfpData.energy,
                data.sfpData.revenue,
                data.sfpData.power,
                data.sfpData.times
            ];

            const glData = [
                data.glData.duration,
                data.glData.utilization * 100,
                data.glData.energy,
                data.glData.revenue,
                data.glData.power,
                data.glData.times
            ];

            efficiencyRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '四方坪站',
                            data: sfpData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            borderWidth: 2,
                            pointBackgroundColor: '#007bff',
                            pointBorderColor: '#007bff',
                            pointHoverBackgroundColor: '#007bff',
                            pointHoverBorderColor: '#007bff'
                        },
                        {
                            label: '高岭站',
                            data: glData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderWidth: 2,
                            pointBackgroundColor: '#28a745',
                            pointBorderColor: '#28a745',
                            pointHoverBackgroundColor: '#28a745',
                            pointHoverBorderColor: '#28a745'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${currentEfficiencyDataMode === 'day' ? data.displayDate : (efficiencyMonthDataList.length > 0 && currentEfficiencyMonthIndex < efficiencyMonthDataList.length ? efficiencyMonthDataList[currentEfficiencyMonthIndex].displayMonth : data.displayDate)} 经营效率对比分析`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    
                                    // 获取两个站点的原始数据
                                    let sfpValue, glValue;
                                    switch(index) {
                                        case 0: 
                                            sfpValue = data.sfpData.duration.toFixed(2);
                                            glValue = data.glData.duration.toFixed(2);
                                            break;
                                        case 1: 
                                            sfpValue = (data.sfpData.utilization * 100).toFixed(2) + '%';
                                            glValue = (data.glData.utilization * 100).toFixed(2) + '%';
                                            break;
                                        case 2: 
                                            sfpValue = data.sfpData.energy.toFixed(2);
                                            glValue = data.glData.energy.toFixed(2);
                                            break;
                                        case 3: 
                                            sfpValue = data.sfpData.revenue.toFixed(2);
                                            glValue = data.glData.revenue.toFixed(2);
                                            break;
                                        case 4: 
                                            sfpValue = data.sfpData.power.toFixed(2);
                                            glValue = data.glData.power.toFixed(2);
                                            break;
                                        case 5: 
                                            sfpValue = data.sfpData.times.toFixed(2);
                                            glValue = data.glData.times.toFixed(2);
                                            break;
                                    }
                                    
                                    return [
                                        `四方坪站: ${sfpValue}`,
                                        `高岭站: ${glValue}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.1
                        }
                    }
                }
            });
        }

        // 启动经营效率自动刷新功能
        function startEfficiencyAutoRefresh() {
            // 清除之前的定时器
            if (efficiencyRefreshInterval) {
                clearInterval(efficiencyRefreshInterval);
            }
            
            // 每5分钟自动刷新数据
            efficiencyRefreshInterval = setInterval(async () => {
                try {
                    console.log('自动刷新经营效率数据...');
                    await loadEfficiencyData();
                    
                    // 如果当前日期索引超出范围，重置为最大日期
                    if (currentEfficiencyDateIndex >= efficiencyData.length) {
                        currentEfficiencyDateIndex = efficiencyData.length - 1;
                    }
                    
                    // 更新表格数据和雷达图
                    if (efficiencyData.length > 0) {
                        const currentData = efficiencyData[currentEfficiencyDateIndex];
                        updateEfficiencyTable(currentData);
                        updateEfficiencyRadarChart(currentData);
                        updateEfficiencyDateDisplay(currentData);
                    }
                } catch (error) {
                    console.error('自动刷新经营效率数据失败:', error);
                }
            }, 5 * 60 * 1000); // 5分钟
        }

        // 停止经营效率自动刷新
        function stopEfficiencyAutoRefresh() {
            if (efficiencyRefreshInterval) {
                clearInterval(efficiencyRefreshInterval);
                efficiencyRefreshInterval = null;
            }
        }
        // 星空背景动画
        function initStarfield() {
            const canvas = document.getElementById('starfield');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let stars = [];
            let mouse = {x: null, y: null, radius: 50};

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            window.addEventListener('resize', resize);
            resize();

            class Star {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.baseSize = Math.random() * 1.5 + 0.3;
                    this.size = this.baseSize;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.flickerSpeed = Math.random() * 0.05 + 0.01;
                    this.angle = Math.random() * Math.PI * 2;
                    // 随机冷暖色调（微蓝/微黄）
                    const colors = ['rgba(200,220,255,', 'rgba(255,245,200,'];
                    this.baseColor = colors[Math.floor(Math.random() * colors.length)];
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = this.baseColor + (0.7 + 0.3 * Math.sin(this.angle)) + ')';
                    ctx.fill();
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;

                    const dx = mouse.x - this.x;
                    const dy = mouse.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < mouse.radius) {
                        this.x -= dx / 15;
                        this.y -= dy / 15;
                    }

                    // 星星闪烁效果
                    this.angle += this.flickerSpeed;
                    this.size = this.baseSize + Math.sin(this.angle) * 0.3;

                    this.draw();
                }
            }

            function init() {
                stars = [];
                var starCount = 200;
                if (window.innerWidth < 600) {
                    starCount = 50;
                }
                for (let i = 0; i < starCount; i++) {
                    stars.push(new Star());
                }
            }

            function connect() {
                for (let a = 0; a < stars.length; a++) {
                    for (let b = a + 1; b < stars.length; b++) {
                        const dx = stars[a].x - stars[b].x;
                        const dy = stars[a].y - stars[b].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 100) {
                            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                            ctx.lineWidth = 0.5;
                            ctx.beginPath();
                            ctx.moveTo(stars[a].x, stars[a].y);
                            ctx.lineTo(stars[b].x, stars[b].y);
                            ctx.stroke();
                        }
                    }
                }
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let star of stars) {
                    star.update();
                }
                connect();
                requestAnimationFrame(animate);
            }

            window.addEventListener('mousemove', (e) => {
                mouse.x = e.x;
                mouse.y = e.y;
            });
            // 移动端触控支持
            window.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                mouse.x = touch.clientX;
                mouse.y = touch.clientY;
            });
            init();
            animate();
        }

        // 左侧"数据查询"二级菜单与"平台首页"点击逻辑：显示/隐藏空白覆盖页
        (function() {
            function setupDataQueryPages() {
                var btnCd = document.getElementById('menu-cd-data');
                var btnZh = document.getElementById('menu-zh-data');
                var btnBill = document.getElementById('menu-bill-data');
                var btnHome = document.getElementById('menu-home');
                var pageCd = document.getElementById('page-cd-data');
                var pageZh = document.getElementById('page-zh-data');
                var pageBill = document.getElementById('page-bill-data');
                var breadcrumbLeaf = document.getElementById('breadcrumb-leaf');

                if (!btnCd || !btnZh || !btnHome || !pageCd || !pageZh) return;

                function showCd() {
                    pageCd.style.display = 'block';
                    pageZh.style.display = 'none';
                    if (pageBill) pageBill.style.display = 'none';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showZh() {
                    pageCd.style.display = 'none';
                    pageZh.style.display = 'block';
                    if (pageBill) pageBill.style.display = 'none';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                    // 初始化综合数据页面的日期选择器
                    if (typeof initZhDatetimePickers === 'function') {
                        initZhDatetimePickers();
                    }
                }

                function showBill() {
                    pageCd.style.display = 'none';
                    pageZh.style.display = 'none';
                    if (pageBill) pageBill.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showHome() {
                    pageCd.style.display = 'none';
                    pageZh.style.display = 'none';
                    if (pageBill) pageBill.style.display = 'none';
                }

                btnCd.addEventListener('click', function(e) { e.preventDefault(); if (breadcrumbLeaf) breadcrumbLeaf.textContent = '充电数据'; showCd(); });
                btnZh.addEventListener('click', function(e) { 
                    e.preventDefault(); 
                    const breadcrumbLeafZh = document.getElementById('breadcrumb-leaf-zh');
                    if (breadcrumbLeafZh) breadcrumbLeafZh.textContent = '综合数据';
                    showZh(); 
                });
                if (btnBill) {
                    btnBill.addEventListener('click', function(e) { e.preventDefault(); showBill(); });
                }
                btnHome.addEventListener('click', function() { showHome(); });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupDataQueryPages);
            } else {
                setupDataQueryPages();
            }
        })();

        // SQL Server数据库连接和查询功能
        // 数据库连接配置（从LeanCloud环境变量获取）
        const DB_CONFIG = {
            server: 'csfhcdz.f3322.net',
            port: 1433,
            user: 'csfh',
            password: 'fh123456',
            database: 'chargingdata',
            options: {
                encrypt: false, // 根据服务器配置调整
                trustServerCertificate: true // 仅用于开发环境
            }
        };

        // 更新连接状态显示
        function updateConnectionStatus(status, message) {
            const statusText = document.getElementById('status-text');
            if (status === 'connected') {
                statusText.textContent = '已连接 - ' + message;
                statusText.style.color = 'green';
            } else if (status === 'connecting') {
                statusText.textContent = '连接中...';
                statusText.style.color = 'orange';
            } else {
                statusText.textContent = '连接失败 - ' + message;
                statusText.style.color = 'red';
            }
        }
        // 执行SQL查询
        function executeSQLQuery() {
            const queryInput = document.getElementById('sql-query-input');
            const query = queryInput.value.trim();
            
            if (!query) {
                alert('请输入SQL查询语句');
                return;
            }
            
            console.log('=== 开始执行SQL查询 ===');
            console.log('查询语句:', query);
            console.log('时间:', new Date().toISOString());
            
            const resultContent = document.getElementById('query-result-content');
            resultContent.innerHTML = '<p>正在执行查询...</p>';
            
            // 使用fetch直接调用SQL Server应用的云函数
            const queryOptions = {
                method: 'POST',
                headers: {
                    'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                    'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            };
            console.log('查询请求配置:', queryOptions);
            
            fetch('https://0rrqt8vr.lc-cn-n1-shared.com/1.1/functions/executeSQLQuery', queryOptions)
                .then(response => {
                    console.log('=== SQL查询HTTP响应 ===');
                    console.log('状态码:', response.status);
                    console.log('状态文本:', response.statusText);
                    console.log('响应头:', response.headers);
                    console.log('响应类型:', response.type);
                    
                    if (!response.ok) {
                        console.error('SQL查询HTTP错误:', response.status, response.statusText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    console.log('SQL查询响应正常，开始解析JSON...');
                    return response.json();
                })
                .then(function(result) {
                    console.log('=== SQL查询JSON解析成功 ===');
                    console.log('完整结果:', result);
                    console.log('结果类型:', typeof result);
                    console.log('success字段:', result.success);
                    console.log('message字段:', result.message);
                    console.log('result.result字段:', result.result);
                    
                    // 优先检查result.result字段（LeanCloud云函数的标准返回格式）
                    if (result.result && typeof result.result === 'object' && result.result.success !== undefined) {
                        console.log('✅ 在SQL查询result.result中找到success字段:', result.result.success);
                        console.log('查询结果消息:', result.result.message);
                        
                        if (result.result.success) {
                            console.log('✅ SQL查询成功!');
                            displayQueryResult(result.result);
                        } else {
                            console.log('❌ SQL查询失败:', result.result.message);
                            resultContent.innerHTML = `
                                <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                    <h4>查询失败</h4>
                                    <p>${result.result.message || '未知错误'}</p>
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // 如果result.result是字符串，尝试解析
                    if (result.result && typeof result.result === 'string') {
                        try {
                            const parsedResult = JSON.parse(result.result);
                            console.log('解析后的SQL查询result.result:', parsedResult);
                            if (parsedResult.success !== undefined) {
                                console.log('✅ 在解析后的SQL查询result.result中找到success字段:', parsedResult.success);
                                if (parsedResult.success) {
                                    console.log('✅ SQL查询成功!');
                                    displayQueryResult(parsedResult);
                                } else {
                                    console.log('❌ SQL查询失败:', parsedResult.message);
                                    resultContent.innerHTML = `
                                        <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                            <h4>查询失败</h4>
                                            <p>${parsedResult.message || '未知错误'}</p>
                                        </div>
                                    `;
                                }
                                return;
                            }
                        } catch (e) {
                            console.log('无法解析SQL查询result.result:', e);
                        }
                    }
                    
                    // 检查直接返回的success字段
                    if (result.success !== undefined) {
                    if (result.success) {
                            console.log('✅ SQL查询成功!');
                        displayQueryResult(result);
                    } else {
                            console.log('❌ SQL查询失败，但收到了响应');
                        resultContent.innerHTML = `
                            <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                <h4>查询失败</h4>
                                <p>${result.message || '未知错误'}</p>
                            </div>
                        `;
                        }
                    } else {
                        console.log('❌ SQL查询失败，但收到了响应');
                        resultContent.innerHTML = `
                            <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                <h4>查询失败</h4>
                                <p>云函数没有返回success字段</p>
                            </div>
                        `;
                    }
                })
                .catch(function(error) {
                    console.error('=== SQL查询失败 ===');
                    console.error('错误对象:', error);
                    console.error('错误名称:', error.name);
                    console.error('错误消息:', error.message);
                    console.error('错误堆栈:', error.stack);
                    
                    resultContent.innerHTML = `
                        <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                            <h4>查询失败</h4>
                            <p>错误代码: ${error.code || 'N/A'}</p>
                            <p>错误信息: ${error.message || '未知错误'}</p>
                        </div>
                    `;
                });
        }

        // 更新当前条件显示
        function updateCurrentConditions() {
            const conditionsText = document.getElementById('current-conditions-text');
            if (!conditionsText) return;
            
            try {
                // 获取充电设备
                const device = (document.getElementById('device-select') || {}).value || '';
                if (!device) {
                    conditionsText.textContent = '请选择充电设备';
                    return;
                }
                
                // 获取站点信息
                const allBox = document.getElementById('station-all');
                const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
                const stationMapToLabel = { 
                    east: '长沙飞狐东区站', 
                    west: '长沙飞狐西区站', 
                    south: '长沙飞狐南区站', 
                    gaoling: '长沙飞狐高岭站' 
                };
                
                let stationText = '';
                if (allBox && allBox.checked) {
                    // 全选：显示所有站点名称
                    stationText = '长沙飞狐东区站、长沙飞狐西区站、长沙飞狐南区站、长沙飞狐高岭站';
                } else {
                    // 显示选中的站点
                    const checked = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
                    if (checked.length === 0) {
                        stationText = '未选择';
                    } else {
                        stationText = checked.map(k => stationMapToLabel[k] || k).join('、');
                    }
                }
                
                // 获取查询充电时间（充电开始时间或充电结束时间）
                const timeField = (document.getElementById('time-field-select') || {}).value || '充电结束时间';
                
                // 获取时间范围
                const startEl = document.getElementById('start-datetime');
                const endEl = document.getElementById('end-datetime');
                const startTime = (startEl && startEl.value) ? startEl.value.trim() : '';
                const endTime = (endEl && endEl.value) ? endEl.value.trim() : '';
                
                // 构建条件文本
                const conditions = [
                    `充电设备：${device}`,
                    `站点：${stationText}`,
                    `查询充电时间：${timeField}`,
                    startTime ? `充电开始时间：${startTime}` : '',
                    endTime ? `充电结束时间：${endTime}` : ''
                ].filter(c => c).join('；');
                
                conditionsText.textContent = conditions;
            } catch (err) {
                console.error('更新当前条件失败:', err);
                conditionsText.textContent = '获取查询条件失败';
            }
        }

        // 仅更新统计区域（不重新渲染表格数据）
        function updateStatsOnly() {
            const statsContainer = document.getElementById('stats-container');
            if (!statsContainer) return;
            
            const hasFullStats = (__statsTotals !== null && __statsTotals !== undefined);
            const isNK = (__currentDevice === '能科');
            
            let total, totalElectricityFee, totalServiceFee, totalChargingFee, totalElectricity, totalDuration;
            
            if (hasFullStats) {
                total = __statsTotals.total || 0;
                totalElectricityFee = __statsTotals.electricityFee || 0;
                totalServiceFee = __statsTotals.serviceFee || 0;
                totalChargingFee = __statsTotals.chargingFee || 0;
                totalElectricity = __statsTotals.electricity || 0;
                totalDuration = __statsTotals.duration || 0;
            } else {
                total = null;
                totalElectricityFee = null;
                totalServiceFee = null;
                totalChargingFee = null;
                totalElectricity = null;
                totalDuration = null;
            }
            
            const statsLoadingMsg = '<span style="color:#ff9800;"><i class="fas fa-spinner fa-spin"></i> 统计计算中...</span>';
            
            statsContainer.innerHTML = `
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 12px 0; color: #495057;">查询统计 ${!hasFullStats ? '<span style="font-size:14px; color:#ff9800; font-weight:normal;">(全量数据统计中，请稍候...)</span>' : '<span style="font-size:14px; color:#28a745; font-weight:normal;">✓</span>'}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">总计</div>
                            <div style="font-size: 18px; font-weight: 600; color: #495057;">${total !== null ? total + ' 条' : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '电费' : '充电电费'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #28a745;">${totalElectricityFee !== null ? '¥' + Number(totalElectricityFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '服务费' : '充电服务费'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #17a2b8;">${totalServiceFee !== null ? '¥' + Number(totalServiceFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '消费金额' : '充电收入'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #dc3545;">${totalChargingFee !== null ? '¥' + Number(totalChargingFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '充电量' : '充电电量'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #6f42c1;">${totalElectricity !== null ? Number(totalElectricity).toFixed(2) + (isNK ? '' : ' 度') : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '充电时长' : '充电时长'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #fd7e14;">${totalDuration !== null ? Number(totalDuration).toFixed(0) + ' 分钟' : statsLoadingMsg}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 显示查询结果（4.jpg样式 + 统计信息）
        function displayQueryResult(result) {
            const resultContent = document.getElementById('query-result-content');
            
            if (!result.results || result.results.length === 0) {
                resultContent.innerHTML = `
                    <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; color: #0c5460;">
                        <h4>查询成功</h4>
                        <p>查询语句: ${result.query}</p>
                        <p>结果: 无数据返回</p>
                    </div>
                `;
                return;
            }
            
            const data = result.results;
            
            // 判断是否有全量统计数据
            const hasFullStats = (__statsTotals !== null && __statsTotals !== undefined);
            const isNK = (__currentDevice === '能科');
            
            // 统计数据：优先使用全量统计，如果正在计算中则不显示fallback数据
            let total, totalElectricityFee, totalServiceFee, totalChargingFee, totalElectricity, totalDuration;
            
            if (hasFullStats) {
                // 使用全量统计数据
                total = __statsTotals.total || 0;
                totalElectricityFee = __statsTotals.electricityFee || 0;
                totalServiceFee = __statsTotals.serviceFee || 0;
                totalChargingFee = __statsTotals.chargingFee || 0;
                totalElectricity = __statsTotals.electricity || 0;
                totalDuration = __statsTotals.duration || 0;
                } else {
                // 统计数据正在计算中，设置为null表示"计算中"
                total = null;
                totalElectricityFee = null;
                totalServiceFee = null;
                totalChargingFee = null;
                totalElectricity = null;
                totalDuration = null;
            }
            
            // 构建统计信息显示（使用独立容器）
            const statsLoadingMsg = '<span style="color:#ff9800;"><i class="fas fa-spinner fa-spin"></i> 统计计算中...</span>';
            
            const statsHTML = `
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 12px 0; color: #495057;">查询统计 ${!hasFullStats ? '<span style="font-size:14px; color:#ff9800; font-weight:normal;">(全量数据统计中，请稍候...)</span>' : '<span style="font-size:14px; color:#28a745; font-weight:normal;">✓</span>'}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">总计</div>
                            <div style="font-size: 18px; font-weight: 600; color: #495057;">${total !== null ? total + ' 条' : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '电费' : '充电电费'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #28a745;">${totalElectricityFee !== null ? '¥' + Number(totalElectricityFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '服务费' : '充电服务费'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #17a2b8;">${totalServiceFee !== null ? '¥' + Number(totalServiceFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '消费金额' : '充电收入'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #dc3545;">${totalChargingFee !== null ? '¥' + Number(totalChargingFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '充电量' : '充电电量'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #6f42c1;">${totalElectricity !== null ? Number(totalElectricity).toFixed(2) + (isNK ? '' : ' 度') : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '充电时长' : '充电时长'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #fd7e14;">${totalDuration !== null ? Number(totalDuration).toFixed(0) + ' 分钟' : statsLoadingMsg}</div>
                        </div>
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <div id="stats-container">${statsHTML}</div>
                <div style="overflow-x: auto; height: 100%;">
                    <table style="width: 100%; border-collapse: collapse; margin: 0; min-width: 1200px;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
            `;
            
            // 仅显示固定的12列
            const __cols = (__currentDisplayColumns && __currentDisplayColumns.length) ? __currentDisplayColumns : DISPLAY_COLUMNS;
            __cols.forEach(col => {
                tableHTML += `<th style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; color: #495057; white-space: nowrap; min-width: 120px;">${col}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            // 数据行（只渲染12列，字段名容错映射）
            data.forEach((row, index) => {
                const rowClass = index % 2 === 0 ? 'background-color: #fff;' : 'background-color: #f8f9fa;';
                tableHTML += `<tr style="${rowClass}">`;
                __cols.forEach(col => {
                    let value = '';
                    if (__currentDevice === '能科') {
                        const map = {
                            '卡号': ['卡号','卡号：'],
                            '持卡人': ['持卡人'],
                            '充电桩名称': ['充电桩名称','终端名称'],
                            '开始日期时间': ['开始日期时间','充电开始时间'],
                            '结束日期时间': ['结束日期时间','充电结束时间'],
                            '充电时长': ['充电时长','充电时长(分钟)'],
                            '开始SOC': ['开始SOC','充电前soc','充电前SOC','起始SOC'],
                            '结束SOC': ['结束SOC','充电后soc','充电后SOC','终止SOC'],
                            '充电量': ['充电量','充电电量(度)'],
                            '消费金额': ['消费金额','充电费用(元)'],
                            '电费': ['电费','充电电费(元)'],
                            '服务费': ['服务费','充电服务费(元)']
                        };
                        const candidates = map[col] || [col];
                        value = getFirstDefined(row, candidates);
                        
                        // 如果是充电时长列，需要格式化显示
                        if (col === '充电时长' && value) {
                            value = formatDuration(value);
                        }
                    } else {
                    if (col === '充电前soc') {
                        value = getFirstDefined(row, ['充电前soc', '充电前SOC', '充电前Soc', '开始SOC', '起始SOC']);
                    } else if (col === '充电后soc') {
                        value = getFirstDefined(row, ['充电后soc', '充电后SOC', '充电后Soc', '结束SOC', '终止SOC']);
                    } else {
                        value = (row[col] !== null && row[col] !== undefined && row[col] !== 'NULL') ? row[col] : '';
                        }
                    }
                    tableHTML += `<td style="border: 1px solid #dee2e6; padding: 12px 8px; color: #495057; white-space: nowrap; min-width: 120px;">${value}</td>`;
                });
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            resultContent.innerHTML = tableHTML;
        }

        // 清空查询结果
        function clearQueryResult() {
            document.getElementById('sql-query-input').value = '';
            document.getElementById('query-result-content').innerHTML = '<p>执行查询后结果将显示在这里</p>';
        }

        // 简单的网络连接测试
        function testBasicConnection() {
            console.log('=== 测试基本网络连接 ===');
            return fetch('https://httpbin.org/get')
                .then(response => {
                    console.log('基本网络测试成功:', response.status);
                    return true;
                })
                .catch(error => {
                    console.error('基本网络测试失败:', error);
                    return false;
                });
        }
        // 测试LeanCloud服务器连接
        function testLeanCloudConnection() {
            console.log('=== 测试LeanCloud服务器连接 ===');
            console.log('AppID:', '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz');
            console.log('AppKey:', 'KAQ3Lzo5ZR44VPkqs7NGYLWB');
            console.log('MasterKey:', 'w5k7ze9JvM7JGUY7O5DVeLVA');
            console.log('直接测试云函数，跳过数据表测试...');
            
            // 直接测试云函数，跳过数据表测试
            return fetch('https://0rrqt8vr.lc-cn-n1-shared.com/1.1/functions/testDatabaseConnection', {
                method: 'POST',
                headers: {
                    'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                    'X-LC-Key': 'KAQ3Lzo5ZR44VPkqs7NGYLWB',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                console.log('云函数测试响应:', response.status, response.statusText);
                console.log('响应头:', response.headers);
                console.log('响应类型:', response.type);
                
                if (!response.ok) {
                    console.error('云函数调用失败:', response.status, response.statusText);
                    return false;
                }
                
                // 解析云函数响应
                return response.json().then(result => {
                    console.log('=== 云函数返回结果详情 ===');
                    console.log('原始响应文本:', JSON.stringify(result, null, 2));
                    console.log('完整结果对象:', result);
                    console.log('结果类型:', typeof result);
                    console.log('success字段:', result.success);
                    console.log('message字段:', result.message);
                    console.log('config字段:', result.config);
                    console.log('result.result字段:', result.result);
                    console.log('所有字段:', Object.keys(result));
                    
                    // 检查结果是否为空或异常
                    if (!result || typeof result !== 'object') {
                        console.error('❌ 云函数返回了无效的结果:', result);
                        return false;
                    }
                    
                    // 优先检查result.result字段（LeanCloud云函数的标准返回格式）
                    if (result.result && typeof result.result === 'object' && result.result.success !== undefined) {
                        console.log('✅ 在result.result中找到success字段:', result.result.success);
                        console.log('数据库连接消息:', result.result.message);
                        console.log('数据库配置:', result.result.config);
                        
                        if (result.result.success) {
                            console.log('✅ SQL Server数据库连接成功!');
                            return true;
                        } else {
                            console.log('❌ SQL Server数据库连接失败:', result.result.message);
                            return false;
                        }
                    }
                    
                    // 如果result.result是字符串，尝试解析
                    if (result.result && typeof result.result === 'string') {
                        try {
                            const parsedResult = JSON.parse(result.result);
                            console.log('解析后的result.result:', parsedResult);
                            if (parsedResult.success !== undefined) {
                                console.log('✅ 在解析后的result.result中找到success字段:', parsedResult.success);
                                if (parsedResult.success) {
                                    console.log('✅ SQL Server数据库连接成功!');
                                    return true;
                                } else {
                                    console.log('❌ SQL Server数据库连接失败:', parsedResult.message);
                                    return false;
                                }
                            }
                        } catch (e) {
                            console.log('无法解析result.result:', e);
                        }
                    }
                    
                    // 检查直接返回的success字段
                    if (result.success !== undefined) {
                        if (result.success) {
                            console.log('✅ SQL Server数据库连接成功!');
                            console.log('数据库信息:', result.config);
                            return true;
                        } else {
                            console.log('❌ SQL Server数据库连接失败');
                            console.log('错误消息:', result.message);
                            return false;
                        }
                    }
                    
                    // 如果都没有找到success字段
                    console.error('❌ 云函数没有返回success字段');
                    console.log('可能的原因:');
                    console.log('1. 云函数代码有错误');
                    console.log('2. 云函数没有正确返回结果');
                    console.log('3. 云函数权限不足');
                    console.log('4. 数据库连接配置错误');
                    return false;
                });
            })
            .catch(error => {
                console.error('=== AppKey云函数测试失败，尝试MasterKey ===');
                console.error('AppKey错误:', error);
                
                // 尝试使用MasterKey
                console.log('尝试使用MasterKey测试云函数...');
                return fetch('https://0rrqt8vr.lc-cn-n1-shared.com/1.1/functions/testDatabaseConnection', {
                    method: 'POST',
                    headers: {
                        'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                        'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    console.log('MasterKey云函数测试响应:', response.status, response.statusText);
                    console.log('响应头:', response.headers);
                    
                    if (!response.ok) {
                        console.error('MasterKey云函数调用失败:', response.status, response.statusText);
                        return false;
                    }
                    
                    // 解析MasterKey云函数响应
                    return response.json().then(result => {
                        console.log('=== MasterKey云函数返回结果详情 ===');
                        console.log('原始响应文本:', JSON.stringify(result, null, 2));
                        console.log('完整结果对象:', result);
                        console.log('结果类型:', typeof result);
                        console.log('success字段:', result.success);
                        console.log('message字段:', result.message);
                        console.log('config字段:', result.config);
                        console.log('result.result字段:', result.result);
                        console.log('所有字段:', Object.keys(result));
                        
                        // 检查结果是否为空或异常
                        if (!result || typeof result !== 'object') {
                            console.error('❌ MasterKey云函数返回了无效的结果:', result);
                            return false;
                        }
                        
                        // 优先检查result.result字段（LeanCloud云函数的标准返回格式）
                        if (result.result && typeof result.result === 'object' && result.result.success !== undefined) {
                            console.log('✅ 在MasterKey result.result中找到success字段:', result.result.success);
                            console.log('数据库连接消息:', result.result.message);
                            console.log('数据库配置:', result.result.config);
                            
                            if (result.result.success) {
                                console.log('✅ MasterKey SQL Server数据库连接成功!');
                                return true;
                            } else {
                                console.log('❌ MasterKey SQL Server数据库连接失败:', result.result.message);
                                return false;
                            }
                        }
                        
                        // 如果result.result是字符串，尝试解析
                        if (result.result && typeof result.result === 'string') {
                            try {
                                const parsedResult = JSON.parse(result.result);
                                console.log('解析后的result.result:', parsedResult);
                                if (parsedResult.success !== undefined) {
                                    console.log('✅ 在解析后的MasterKey result.result中找到success字段:', parsedResult.success);
                                    if (parsedResult.success) {
                                        console.log('✅ MasterKey SQL Server数据库连接成功!');
                                        return true;
                                    } else {
                                        console.log('❌ MasterKey SQL Server数据库连接失败:', parsedResult.message);
                                        return false;
                                    }
                                }
                            } catch (e) {
                                console.log('无法解析MasterKey result.result:', e);
                            }
                        }
                        
                        // 检查直接返回的success字段
                        if (result.success !== undefined) {
                            if (result.success) {
                                console.log('✅ MasterKey SQL Server数据库连接成功!');
                                console.log('数据库信息:', result.config);
                                return true;
                            } else {
                                console.log('❌ MasterKey SQL Server数据库连接失败');
                                console.log('错误消息:', result.message);
                                return false;
                            }
                        }
                        
                        // 如果都没有找到success字段
                        console.error('❌ MasterKey云函数没有返回success字段');
                        return false;
                    });
                })
                .catch(error2 => {
                    console.error('=== MasterKey云函数测试也失败 ===');
                    console.error('MasterKey错误对象:', error2);
                    console.error('MasterKey错误名称:', error2.name);
                    console.error('MasterKey错误消息:', error2.message);
                    console.error('MasterKey错误堆栈:', error2.stack);
                    return false;
                });
            });
        }
        // 显示列（仅用于页面展示用的12列，不影响导出）
        const DISPLAY_COLUMNS = [
            '电站名称', '终端名称', '充电开始时间', '充电结束时间',
            '充电电费(元)', '充电服务费(元)', '充电费用(元)', '充电时长(分钟)',
            '充电前soc', '充电后soc', '判定车牌号', '车辆所属客户'
        ];
        let __currentDisplayColumns = DISPLAY_COLUMNS.slice();
        // 统计总计（跨全量数据，而非当前页）
        let __statsTotals = {
            total: 0,
            electricityFee: 0,
            serviceFee: 0,
            chargingFee: 0,
            electricity: 0,
            duration: 0
        };
        let __currentDevice = '特来电';

        function getFirstDefined(row, keys) {
            for (let i = 0; i < keys.length; i++) {
                const k = keys[i];
                if (row.hasOwnProperty(k) && row[k] !== null && row[k] !== undefined && row[k] !== 'NULL') {
                    return row[k];
                }
            }
            return '';
        }

        // 格式化充电时长（能科数据需要从ISO格式或hh;mm;ss转为hh:mm:ss）
        function formatDuration(t) {
            if (!t) return '';
            const str = String(t).trim();
            
            // 如果是ISO日期格式（如 1970-01-01T00:11:16.000Z），提取时间部分并格式化为hh:mm:ss
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(str)) {
                const timeMatch = str.match(/T(\d{2}):(\d{2}):(\d{2})/);
                if (timeMatch) {
                    return `${timeMatch[1]}:${timeMatch[2]}:${timeMatch[3]}`;
                }
            }
            
            // 如果已经是hh:mm:ss或hh;mm;ss格式，统一转为hh:mm:ss
            const parts = str.split(/[:;]/);
            if (parts.length === 3) {
                return `${parts[0]}:${parts[1]}:${parts[2]}`;
            }
            
            // 如果都不匹配，返回原值
            return str;
        }

        // 特来电全选 + 时间跨度大：使用时间段分段 + 逐个站点查询统计
        async function aggregateTeldByStationsWithTimeSegments() {
            try {
                const tableName = __pagination.tableName || '[特来电]';
                const timeField = __pagination.timeField || '充电结束时间';
                const startEl = document.getElementById('start-datetime');
                const endEl = document.getElementById('end-datetime');
                
                if (!startEl || !endEl || !startEl.value || !endEl.value) {
                    throw new Error('时间范围未设置');
                }
                
                const startDate = new Date(startEl.value);
                const endDate = new Date(endEl.value);
                
                // 每30天为一个时间段
                const segmentDays = 30;
                const segments = [];
                let currentStart = new Date(startDate);
                
                while (currentStart <= endDate) {
                    let currentEnd = new Date(currentStart);
                    currentEnd.setDate(currentEnd.getDate() + segmentDays - 1);
                    if (currentEnd > endDate) {
                        currentEnd = new Date(endDate);
                    }
                    segments.push({
                        start: new Date(currentStart),
                        end: new Date(currentEnd)
                    });
                    currentStart.setDate(currentStart.getDate() + segmentDays);
                }
                
                console.log(`统计查询：时间范围分为 ${segments.length} 个时间段，每段约 ${segmentDays} 天`);
                
                // 获取需要查询的站点组（全选：所有4个站点组）
                const stationGroups = ['east', 'west', 'south', 'gaoling'];
                
                let totalCount = 0;
                let sumFeeElec = 0, sumServiceFee = 0, sumTotalFee = 0, sumKwh = 0, sumMinutes = 0;
                
                // 按时间段串行查询，每个时间段内按站点串行查询
                for (let segIdx = 0; segIdx < segments.length; segIdx++) {
                    const seg = segments[segIdx];
                    const segStart = toSqlDateTime(seg.start.toISOString().slice(0, 19).replace('T', ' '), false);
                    const segEnd = toSqlDateTime(seg.end.toISOString().slice(0, 19).replace('T', ' '), true);
                    
                    console.log(`统计查询时间段 ${segIdx + 1}/${segments.length}: ${segStart} 至 ${segEnd}`);
                    
                    // 在该时间段内，逐个站点组查询
                    for (const group of stationGroups) {
                        const stationNames = STATION_GROUP_TO_NAMES[group] || [];
                        if (stationNames.length === 0) continue;
                        
                        // 构建该站点组在该时间段的WHERE条件
                        const esc = stationNames.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                        const whereClause = `WHERE [${timeField}] BETWEEN '${segStart}' AND '${segEnd}' AND [电站名称] IN (${esc})`;
                        
                        // 查询该站点组在该时间段的统计数据
                        const statsSql = `SELECT 
                            COUNT(1) AS total,
                            SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                            SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                            SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                            SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                            SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                            FROM ${tableName} ${whereClause}`;
                        
                        try {
                            const res = await callSqlWithRetry(statsSql, 3, 800);
                            const row = (res && res.results && res.results[0]) || {};
                            
                            // 累加统计结果
                            totalCount += Number(row.total) || 0;
                            sumFeeElec += Number(row.fee_elec) || 0;
                            sumServiceFee += Number(row.fee_service) || 0;
                            sumTotalFee += Number(row.fee_total) || 0;
                            sumKwh += Number(row.kwh_total) || 0;
                            sumMinutes += Number(row.minutes_total) || 0;
                            
                            console.log(`时间段 ${segIdx + 1} 站点组 ${group} 统计成功:`, {
                                total: row.total,
                                fee_elec: row.fee_elec
                            });
                        } catch (err) {
                            console.warn(`时间段 ${segIdx + 1} 站点组 ${group} 统计失败:`, err);
                            // 某个站点查询失败时继续查询其他站点
                        }
                    }
                }
                
                // 更新分页总数
                if (__pagination.total === 0 && totalCount > 0) {
                    __pagination.total = totalCount;
                    renderPagination();
                }
                
                // 更新统计汇总
                __statsTotals = {
                    total: totalCount || __pagination.total || 0,
                    electricityFee: sumFeeElec,
                    serviceFee: sumServiceFee,
                    chargingFee: sumTotalFee,
                    electricity: sumKwh,
                    duration: sumMinutes
                };
                
                // 只更新统计区域，不重新渲染整个表格
                updateStatsOnly();
                console.log('特来电时间段分段统计完成:', __statsTotals);
            } catch (e) {
                console.warn('特来电时间段分段统计失败:', e);
            }
        }

        // 特来电多选/全选：逐个站点查询统计，然后汇总（避免大数据量查询超时）
        async function aggregateTeldByStations() {
            try {
                const tableName = __pagination.tableName || '[特来电]';
                const timeField = __pagination.timeField || '充电结束时间';
                const start = toSqlDateTime((document.getElementById('start-datetime') || {}).value, false);
                const end = toSqlDateTime((document.getElementById('end-datetime') || {}).value, true);
                
                // 获取需要查询的站点组
                const allBox = document.getElementById('station-all');
                const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
                let stationGroups = [];
                
                if (allBox && allBox.checked) {
                    // 全选：查询所有4个站点组
                    stationGroups = ['east', 'west', 'south', 'gaoling'];
                } else {
                    // 多选：查询选中的站点组
                    stationGroups = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
                }
                
                if (stationGroups.length === 0) {
                    console.warn('没有选择站点');
                    return;
                }

                let totalCount = 0;
                let sumFeeElec = 0, sumServiceFee = 0, sumTotalFee = 0, sumKwh = 0, sumMinutes = 0;

                // 逐个站点组查询统计
                for (const group of stationGroups) {
                    const stationNames = STATION_GROUP_TO_NAMES[group] || [];
                    if (stationNames.length === 0) continue;
                    
                    // 构建该站点组的WHERE条件
                    const esc = stationNames.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                    const whereClause = `WHERE [${timeField}] BETWEEN '${start}' AND '${end}' AND [电站名称] IN (${esc})`;
                    
                    // 查询该站点组的统计数据
                    const statsSql = `SELECT 
                        COUNT(1) AS total,
                        SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                        SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                        SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                        SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                        SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                        FROM ${tableName} ${whereClause}`;
                    
                    try {
                        const res = await callSqlWithRetry(statsSql, 3, 800);
                        const row = (res && res.results && res.results[0]) || {};
                        
                        // 累加统计结果
                        totalCount += Number(row.total) || 0;
                        sumFeeElec += Number(row.fee_elec) || 0;
                        sumServiceFee += Number(row.fee_service) || 0;
                        sumTotalFee += Number(row.fee_total) || 0;
                        sumKwh += Number(row.kwh_total) || 0;
                        sumMinutes += Number(row.minutes_total) || 0;
                        
                        console.log(`站点组 ${group} 查询成功:`, {
                            total: row.total,
                            fee_elec: row.fee_elec,
                            fee_service: row.fee_service
                        });
                    } catch (err) {
                        console.warn(`站点组 ${group} 查询失败:`, err);
                        // 某个站点查询失败时继续查询其他站点
                    }
                }

                // 更新分页总数（如果还没有设置）
                if (__pagination.total === 0 && totalCount > 0) {
                    __pagination.total = totalCount;
                    renderPagination();
                }

                // 更新统计汇总
                __statsTotals = {
                    total: totalCount || __pagination.total || 0,
                    electricityFee: sumFeeElec,
                    serviceFee: sumServiceFee,
                    chargingFee: sumTotalFee,
                    electricity: sumKwh,
                    duration: sumMinutes
                };
                
                // 只更新统计区域，不重新渲染整个表格
                updateStatsOnly();
                console.log('特来电站点汇总统计完成:', __statsTotals);
            } catch (e) {
                console.warn('特来电站点汇总统计失败:', e);
                // 统计失败时保持__statsTotals为null，不做任何操作
            }
        }

        // 能科：计算充电时长（分批查询，因为充电时长可能是ISO格式）
        async function calculateNkDuration(whereClause, tableName, timeField) {
            try {
                const total = Number(__pagination.total) || 0;
                if (!total) return;
                
                const batchSize = 5000;
                let offset = 0;
                let sumMinutes = 0;
                
                // 格式化充电时长：支持ISO日期格式和hh:mm:ss格式
                const parseDuration = (t) => {
                    if (!t) return 0;
                    const str = String(t).trim();
                    
                    // 如果是ISO日期格式（如 1970-01-01T00:11:16.000Z），提取时间部分
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(str)) {
                        const timeMatch = str.match(/T(\d{2}):(\d{2}):(\d{2})/);
                        if (timeMatch) {
                            const h = parseFloat(timeMatch[1]) || 0;
                            const m = parseFloat(timeMatch[2]) || 0;
                            const s = parseFloat(timeMatch[3]) || 0;
                            return h * 60 + m + s / 60;
                        }
                    }
                    
                    // 如果是hh:mm:ss或hh;mm;ss格式
                    const parts = str.split(/[:;]/);
                    if (parts.length === 3) {
                        const h = parseFloat(parts[0]) || 0;
                        const m = parseFloat(parts[1]) || 0;
                        const s = parseFloat(parts[2]) || 0;
                        return h * 60 + m + s / 60;
                    }
                    
                    // 如果都不是，尝试直接解析为数字（假设是分钟数）
                    const num = parseFloat(str);
                    return isNaN(num) ? 0 : num;
                };
                
                const loops = Math.ceil(total / batchSize);
                for (let i = 0; i < loops; i++) {
                    const startRn = offset + 1;
                    const endRn = Math.min(total, offset + batchSize);
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    const overOrder = `ORDER BY [${timeField}] ASC`;
                    const sql = `SELECT [充电时长] FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                    
                    const res = await callSqlWithRetry(sql, 3, 600).catch(() => null);
                    const rows = (res && res.results) ? res.results : [];
                    for (const r of rows) {
                        sumMinutes += parseDuration(r['充电时长']);
                    }
                    offset += batchSize;
                }
                
                // 更新充电时长
                if (__statsTotals) {
                    __statsTotals.duration = sumMinutes;
                    updateStatsOnly();
                }
            } catch (e) {
                console.warn('能科充电时长计算失败:', e);
            }
        }

        // 能科：客户端分批聚合全量统计（后备方案，当服务器端聚合失败时使用）
        async function aggregateNkTotalsInBatches() {
            try {
                const tableName = __pagination.tableName || '[能科]';
                const whereClause = __pagination.whereClause || '';
                const timeField = __pagination.timeField || '结束日期时间';
                const total = Number(__pagination.total) || 0;
                if (!total) return;

                // 每批次抓取行数（仅取5列）
                const batchSize = 5000;
                let offset = 0;
                let sumFee = 0, sumService = 0, sumAmount = 0, sumKwh = 0, sumMinutes = 0;

                // 复用前端清洗方法
                const clean = (v, kind) => {
                    if (v === null || v === undefined) return 0;
                    let s = String(v).trim();
                    let neg = false;
                    if (/^\(.*\)$/.test(s)) { neg = true; s = s.slice(1, -1); }
                    s = s.replace(/[¥￥,，\s]/g, '');
                    if (kind === 'kwh') {
                        s = s.replace(/(度|kWh|KWh|kW·h|kW·H)/gi, '');
                    }
                    s = s.replace(/元/g, '').replace(/．/g, '.');
                    const num = parseFloat(s);
                    const val = isNaN(num) ? 0 : num;
                    return neg ? -val : val;
                };

                const buildPageSql = (startRn, endRn) => {
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    const overOrder = `ORDER BY [${timeField}] ASC`;
                    // 仅选择聚合需要的5列，减少传输量
                    return `SELECT [电费],[服务费],[消费金额],[充电量],[充电时长] FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, [电费],[服务费],[消费金额],[充电量],[充电时长] ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                };

                // 格式化充电时长：支持ISO日期格式和hh:mm:ss格式
                const parseDuration = (t) => {
                    if (!t) return 0;
                    const str = String(t).trim();
                    
                    // 如果是ISO日期格式（如 1970-01-01T00:11:16.000Z），提取时间部分
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(str)) {
                        // 提取时间部分：从T后面到.或Z之前
                        const timeMatch = str.match(/T(\d{2}):(\d{2}):(\d{2})/);
                        if (timeMatch) {
                            const h = parseFloat(timeMatch[1]) || 0;
                            const m = parseFloat(timeMatch[2]) || 0;
                            const s = parseFloat(timeMatch[3]) || 0;
                            return h * 60 + m + s / 60;
                        }
                    }
                    
                    // 如果是hh:mm:ss或hh;mm;ss格式
                    const parts = str.split(/[:;]/);
                    if (parts.length === 3) {
                        const h = parseFloat(parts[0]) || 0;
                        const m = parseFloat(parts[1]) || 0;
                        const s = parseFloat(parts[2]) || 0;
                        return h * 60 + m + s / 60;
                    }
                    
                    // 如果都不是，尝试直接解析为数字（假设是分钟数）
                    const num = parseFloat(str);
                    return isNaN(num) ? 0 : num;
                };

                const loops = Math.ceil(total / batchSize);
                for (let i = 0; i < loops; i++) {
                    const startRn = offset + 1;
                    const endRn = Math.min(total, offset + batchSize);
                    const sql = buildPageSql(startRn, endRn);
                    const res = await callSqlWithRetry(sql, 3, 600).catch(() => null);
                    const rows = (res && res.results) ? res.results : [];
                    for (const r of rows) {
                        sumFee += clean(r['电费'], 'money');
                        sumService += clean(r['服务费'], 'money');
                        sumAmount += clean(r['消费金额'], 'money');
                        sumKwh += clean(r['充电量'], 'kwh');
                        sumMinutes += parseDuration(r['充电时长']);
                    }
                    offset += batchSize;
                }

                __statsTotals = {
                    total: __pagination.total,
                    electricityFee: sumFee,
                    serviceFee: sumService,
                    chargingFee: sumAmount,
                    electricity: sumKwh,
                    duration: sumMinutes
                };
                // 只更新统计区域，不重新渲染整个表格
                updateStatsOnly();
            } catch (e) {
                console.warn('能科分批聚合失败:', e);
                // 统计失败时保持__statsTotals为null，不做任何操作
            }
        }

        // 设备切换：当选择“能科”时，仅保留“长沙飞狐东区站”可选，其余置灰不可选
        function onDeviceChange() {
            const device = (document.getElementById('device-select') || {}).value || '';
            const deviceSelect = document.getElementById('device-select');
            if (deviceSelect) deviceSelect.style.color = device ? '#333' : '#999';
            const all = document.getElementById('station-all');
            const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
            if (device === '能科') {
                // 只允许 east（长沙飞狐东区站）
                items.forEach(i => {
                    const isEast = i.getAttribute('data-group') === 'east';
                    i.disabled = !isEast;
                    i.checked = !!isEast;
                    const label = i.closest('label');
                    if (label) label.style.color = isEast ? '#333' : '#bbb';
                });
                if (all) { all.checked = false; all.disabled = true; }
            } else {
                // 还原可选状态
                items.forEach(i => {
                    i.disabled = false;
                    const label = i.closest('label');
                    if (label) label.style.color = '#333';
                });
                if (all) { all.disabled = false; }
            }
            // 刷新展示文本
            applyStationSelection();
        }

        // 分页状态（页面展示每页20条）
        let __pagination = {
            enabled: false,
            sqlNoOrder: '',
            orderByFinal: '',
            pageSize: 20,
            total: 0,
            currentPage: 1,
            // 新增：用于OFFSET/FETCH的参数
            whereClause: '',
            timeField: '充电结束时间',
            selectCols: '[电站名称], [终端名称], [充电开始时间], [充电结束时间], [充电电费(元)], [充电服务费(元)], [充电费用(元)], [充电时长(分钟)], [充电前soc], [充电后soc], [判定车牌号], [车辆所属客户]',
            tableName: '[特来电]'
        };
        function ensureTopPaginationBar() {
            const container = document.getElementById('query-result');
            if (!container) return null;
            let bar = document.getElementById('query-pagination-top');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'query-pagination-top';
                bar.style.margin = '8px 0';
                container.insertBefore(bar, document.getElementById('query-result-content'));
            }
            return bar;
        }

        function renderPagination() {
            const bar = ensureTopPaginationBar();
            if (!bar) return;
            if (!__pagination.enabled || __pagination.total === 0) {
                bar.innerHTML = '';
                return;
            }
            const totalPages = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
            bar.innerHTML = `
                <div style="padding:6px 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px; display:flex; align-items:center; gap:8px;">
                    <button id="pg-first" style="padding:4px 8px;">首页</button>
                    <button id="pg-prev" style="padding:4px 8px;">上一页</button>
                    <span>第 <strong>${__pagination.currentPage}</strong> / ${totalPages} 页</span>
                    <span>共 <strong>${__pagination.total}</strong> 条</span>
                    <button id="pg-next" style="padding:4px 8px;">下一页</button>
                    <button id="pg-last" style="padding:4px 8px;">末页</button>
                </div>`;
            document.getElementById('pg-first').onclick = () => goToPage(1);
            document.getElementById('pg-prev').onclick = () => goToPage(Math.max(1, __pagination.currentPage - 1));
            document.getElementById('pg-next').onclick = () => {
                const tp = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
                goToPage(Math.min(tp, __pagination.currentPage + 1));
            };
            document.getElementById('pg-last').onclick = () => {
                const tp = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
                goToPage(tp);
            };
        }

        function callSqlGeneric(sql) {
            return fetch('https://0rrqt8vr.lc-cn-n1-shared.com/1.1/functions/executeSQLQuery', {
                method: 'POST',
                headers: {
                    'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                    'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ query: sql })
            }).then(r => { if (!r.ok) throw new Error('HTTP ' + r.status + ': ' + r.statusText); return r.json(); })
              .then(j => (j && j.result) ? j.result : j);
        }

        // 带重试的 SQL 调用，缓解偶发 5xx/网络错误
        function callSqlWithRetry(sql, attempts = 3, delayMs = 600) {
            let tries = 0;
            function run() {
                tries++;
                return fetch('https://0rrqt8vr.lc-cn-n1-shared.com/1.1/functions/executeSQLQuery', {
                    method: 'POST',
                    headers: {
                        'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                        'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ query: sql })
                }).then(async r => {
                    if (!r.ok) {
                        let errorMsg = 'HTTP ' + r.status + ': ' + r.statusText;
                        try {
                            const errorBody = await r.text();
                            if (errorBody) {
                                errorMsg += ' - ' + errorBody;
                            }
                        } catch (e) {
                            // 忽略解析错误体的错误
                        }
                        const error = new Error(errorMsg);
                        error.httpStatus = r.status;
                        throw error;
                    }
                    return r.json();
                }).then(j => (j && j.result) ? j.result : j).catch(err => {
                    if (tries < attempts) {
                        const wait = delayMs * Math.pow(2, tries - 1);
                        return new Promise(res => setTimeout(res, wait)).then(run);
                    }
                    throw err;
                });
            }
            return run();
        }

        // 特来电全选时，使用时间段分段查询（避免大数据量查询超时）
        async function goToPageWithTimeSegments(targetPage) {
            if (!__pagination.enabled) return;
            
            const resultContent = document.getElementById('query-result-content');
            const statsContainer = document.getElementById('stats-container');
            const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
            
            const totalPages = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
            const page = Math.min(totalPages, Math.max(1, targetPage));
            __pagination.currentPage = page;
            const offset = (page - 1) * __pagination.pageSize;
            const needCount = __pagination.pageSize;
            
            // 显示加载提示
            if (tableContainer) {
                tableContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> 正在分段查询数据... 第 ' + page + ' 页（大数据量优化查询）</div>';
            } else {
                resultContent.innerHTML = `<p>正在分段查询数据... 第 ${page} 页（大数据量优化查询）</p>`;
            }
            
            try {
                const startEl = document.getElementById('start-datetime');
                const endEl = document.getElementById('end-datetime');
                if (!startEl || !endEl || !startEl.value || !endEl.value) {
                    throw new Error('时间范围未设置');
                }
                
                const startDate = new Date(startEl.value);
                const endDate = new Date(endEl.value);
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                // 每30天为一个时间段
                const segmentDays = 30;
                const segments = [];
                let currentStart = new Date(startDate);
                
                while (currentStart <= endDate) {
                    let currentEnd = new Date(currentStart);
                    currentEnd.setDate(currentEnd.getDate() + segmentDays - 1);
                    if (currentEnd > endDate) {
                        currentEnd = new Date(endDate);
                    }
                    segments.push({
                        start: new Date(currentStart),
                        end: new Date(currentEnd)
                    });
                    currentStart.setDate(currentStart.getDate() + segmentDays);
                }
                
                console.log(`时间范围分为 ${segments.length} 个时间段，每段约 ${segmentDays} 天`);
                
                const selectCols = __pagination.selectCols || '*';
                const timeField = __pagination.timeField || '充电结束时间';
                const tableName = __pagination.tableName || '[特来电]';
                const overOrder = `ORDER BY [${timeField}] ASC`;
                
                // 存储所有时间段查询的结果
                let allRows = [];
                let collectedCount = 0;
                let targetStartIndex = offset;
                let targetEndIndex = offset + needCount;
                
                // 按时间段串行查询（避免并发过多）
                for (let i = 0; i < segments.length; i++) {
                    const seg = segments[i];
                    const segStart = toSqlDateTime(seg.start.toISOString().slice(0, 19).replace('T', ' '), false);
                    const segEnd = toSqlDateTime(seg.end.toISOString().slice(0, 19).replace('T', ' '), true);
                    
                    // 更新加载提示
                    if (tableContainer) {
                        tableContainer.innerHTML = `<div style="padding:20px; text-align:center;">
                            <i class="fas fa-spinner fa-spin"></i> 正在查询时间段 ${i + 1}/${segments.length}...<br>
                            <small style="color:#666;">${segStart} 至 ${segEnd}</small>
                        </div>`;
                    }
                    
                    const whereClause = `WHERE [${timeField}] BETWEEN '${segStart}' AND '${segEnd}'`;
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    
                    // 查询该时间段的所有数据（按时间段分段后，每个时间段的数据量应该较小）
                    const segSql = `SELECT ${selectCols} FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t`;
                    
                    try {
                        const segRes = await callSqlWithRetry(segSql, 3, 800);
                        const segRows = (segRes && segRes.results) ? segRes.results : [];
                        
                        // 移除rn列
                        const cleanedRows = segRows.map(row => {
                            const cleaned = { ...row };
                            delete cleaned.rn;
                            return cleaned;
                        });
                        
                        // 检查是否需要这个时间段的数据
                        const segRowCount = cleanedRows.length;
                        if (collectedCount + segRowCount < targetStartIndex) {
                            // 这个时间段的数据都在目标范围之前，跳过
                            collectedCount += segRowCount;
                            continue;
                        }
                        
                        if (collectedCount >= targetEndIndex) {
                            // 已经收集够了，可以停止
                            break;
                        }
                        
                        // 添加需要的数据行
                        const segStartIndex = Math.max(0, targetStartIndex - collectedCount);
                        const segEndIndex = Math.min(segRowCount, targetEndIndex - collectedCount);
                        allRows = allRows.concat(cleanedRows.slice(segStartIndex, segEndIndex));
                        collectedCount += segRowCount;
                        
                        // 如果已经收集够了，可以提前停止
                        if (allRows.length >= needCount) {
                            break;
                        }
                    } catch (err) {
                        console.warn(`时间段 ${i + 1} 查询失败:`, err);
                        // 某个时间段查询失败时继续查询其他时间段
                        continue;
                    }
                }
                
                // 只取需要的数量
                const finalRows = allRows.slice(0, needCount);
                const payload = { success: true, results: finalRows, rowCount: finalRows.length };
                __lastQueryResults = payload;
                
                // 只更新表格部分
                updateTableOnly(payload);
                setExportEnabled(finalRows.length > 0);
                renderPagination();
                
                console.log(`分段查询完成，共查询 ${segments.length} 个时间段，获取 ${finalRows.length} 行数据`);
            } catch (err) {
                console.error('分段查询失败:', err);
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                            <h4 style="margin:0 0 6px 0;">查询失败</h4>
                            <div>${err.message || '未知错误'}</div>
                        </div>`;
                } else {
                    resultContent.innerHTML = `
                        <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                            <h4 style="margin:0 0 6px 0;">查询失败</h4>
                            <div>${err.message || '未知错误'}</div>
                        </div>`;
                }
                setExportEnabled(false);
            }
        }

        function goToPage(targetPage) {
            if (!__pagination.enabled) return;
            
            // 全选时也使用IN条件查询，查询逻辑与多选一致，不需要特殊处理
            const resultContent = document.getElementById('query-result-content');
            const totalPages = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
            const page = Math.min(totalPages, Math.max(1, targetPage));
            __pagination.currentPage = page;
            const offset = (page - 1) * __pagination.pageSize;
            
            // 翻页时只显示加载提示，不影响统计区域
            const statsContainer = document.getElementById('stats-container');
            const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
            if (tableContainer) {
                tableContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> 正在加载数据... 第 ' + page + ' 页</div>';
            } else {
            resultContent.innerHTML = `<p>正在加载数据... 第 ${page} 页</p>`;
            }
            
            // 使用 ROW_NUMBER 分页（兼容后端），并精确列清单
            const selectCols = __pagination.selectCols || '*';
            const whereClause = __pagination.whereClause || '';
            const timeField = __pagination.timeField || '充电结束时间';
            const startRn = offset + 1;
            const endRn = offset + __pagination.pageSize;
            const tableName = __pagination.tableName || '[特来电]';
            const innerFrom = `FROM ${tableName} ${whereClause}`;
            const overOrder = `ORDER BY [${timeField}] ASC`;
            const pageSql = `SELECT ${selectCols} FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
            callSqlWithRetry(pageSql, 3, 600).then(pageRes => {
                const rows = (pageRes && pageRes.results) ? pageRes.results : [];
                const payload = { success: true, results: rows, rowCount: rows.length, query: pageSql };
                __lastQueryResults = payload; // 保留当前页的完整列数据用于导出当前页
                
                // 翻页时只更新表格部分，不更新统计区域（统计只在第一次查询时计算）
                updateTableOnly(payload);
                
                setExportEnabled(rows.length > 0);
                renderPagination();
            }).catch(err => {
                console.error('分页加载失败:', err);
                const statsContainer = document.getElementById('stats-container');
                const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                            <h4 style="margin:0 0 6px 0;">查询失败</h4>
                            <div>${err.message || '未知错误'}</div>
                        </div>`;
                } else {
                resultContent.innerHTML = `
                    <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                        <h4 style="margin:0 0 6px 0;">查询失败</h4>
                        <div>${err.message || '未知错误'}</div>
                    </div>`;
                }
                setExportEnabled(false);
            });
        }
        
        // 仅更新表格部分（翻页时使用，不更新统计区域）
        function updateTableOnly(result) {
            if (!result.results || result.results.length === 0) {
                const statsContainer = document.getElementById('stats-container');
                const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; color: #0c5460;">
                            <h4>查询成功</h4>
                            <p>结果: 无数据返回</p>
                        </div>`;
                }
                return;
            }
            
            const data = result.results;
            const isNK = (__currentDevice === '能科');
            
            let tableHTML = `
                <div style="overflow-x: auto; height: 100%;">
                    <table style="width: 100%; border-collapse: collapse; margin: 0; min-width: 1200px;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
            `;
            
            // 仅显示固定的12列
            const __cols = (__currentDisplayColumns && __currentDisplayColumns.length) ? __currentDisplayColumns : DISPLAY_COLUMNS;
            __cols.forEach(col => {
                tableHTML += `<th style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; color: #495057; white-space: nowrap; min-width: 120px;">${col}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            // 数据行（只渲染12列，字段名容错映射）
            data.forEach((row, index) => {
                const rowClass = index % 2 === 0 ? 'background-color: #fff;' : 'background-color: #f8f9fa;';
                tableHTML += `<tr style="${rowClass}">`;
                __cols.forEach(col => {
                    let value = '';
                    if (__currentDevice === '能科') {
                        const map = {
                            '卡号': row['卡号'] || row['卡号'] || '',
                            '持卡人': row['持卡人'] || row['持卡人'] || '',
                            '充电桩名称': row['充电桩名称'] || row['充电桩名称'] || '',
                            '开始日期时间': row['开始日期时间'] || row['开始日期时间'] || '',
                            '结束日期时间': row['结束日期时间'] || row['结束日期时间'] || '',
                            '充电时长': formatDuration(row['充电时长'] || row['充电时长'] || ''),
                            '开始SOC': row['开始SOC'] || row['开始SOC'] || '',
                            '结束SOC': row['结束SOC'] || row['结束SOC'] || '',
                            '充电量': row['充电量'] || row['充电量'] || '',
                            '消费金额': row['消费金额'] || row['消费金额'] || '',
                            '电费': row['电费'] || row['电费'] || '',
                            '服务费': row['服务费'] || row['服务费'] || ''
                        };
                        value = map[col] !== undefined ? map[col] : '';
                    } else {
                        const map = {
                            '电站名称': row['电站名称'] || '',
                            '终端名称': row['终端名称'] || '',
                            '充电开始时间': row['充电开始时间'] || '',
                            '充电结束时间': row['充电结束时间'] || '',
                            '充电电费(元)': row['充电电费(元)'] || '',
                            '充电服务费(元)': row['充电服务费(元)'] || '',
                            '充电费用(元)': row['充电费用(元)'] || '',
                            '充电时长(分钟)': row['充电时长(分钟)'] || '',
                            '充电前soc': row['充电前soc'] || '',
                            '充电后soc': row['充电后soc'] || '',
                            '判定车牌号': row['判定车牌号'] || '',
                            '车辆所属客户': row['车辆所属客户'] || ''
                        };
                        value = map[col] !== undefined ? map[col] : '';
                    }
                    tableHTML += `<td style="border: 1px solid #dee2e6; padding: 10px 8px; text-align: left; color: #495057;">${value}</td>`;
                });
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            // 只更新表格容器，保持统计区域不变
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer && statsContainer.nextElementSibling) {
                statsContainer.nextElementSibling.outerHTML = tableHTML;
            } else if (statsContainer) {
                statsContainer.insertAdjacentHTML('afterend', tableHTML);
            } else {
                // 如果没有统计容器，说明是第一次加载或统计区域未渲染，使用完整渲染
                displayQueryResult(result);
            }
        }

        // 设置时间框体默认值：当天日期带时分秒（显示在文本框内），选择时用原生日历不带时分秒
        (function setDefaultDateTimes() {
            try {
                const pad = n => (n < 10 ? '0' + n : '' + n);
                const now = new Date();
                const y = now.getFullYear();
                const m = pad(now.getMonth() + 1);
                const d = pad(now.getDate());
                const startTime = `${y}-${m}-${d} 00:00:00`;
                const endTime = `${y}-${m}-${d} 23:59:59`;
                const startEl = document.getElementById('start-datetime');
                const endEl = document.getElementById('end-datetime');
                if (startEl) startEl.value = startTime;
                if (endEl) endEl.value = endTime;

                function attachDateBehavior(input, isEnd) {
                    if (!input) return;
                    // 保持文本输入框始终显示 yyyy-mm-dd hh:mm:ss
                    // 使用隐藏的原生日期选择器进行选择
                    const hiddenPicker = document.createElement('input');
                    hiddenPicker.type = 'date';
                    hiddenPicker.style.position = 'fixed';
                    hiddenPicker.style.opacity = '0';
                    hiddenPicker.style.pointerEvents = 'none';
                    hiddenPicker.style.width = '0';
                    hiddenPicker.style.height = '0';
                    document.body.appendChild(hiddenPicker);

                    function openPicker() {
                        const rect = input.getBoundingClientRect();
                        hiddenPicker.style.left = `${Math.max(0, rect.left)}px`;
                        hiddenPicker.style.top = `${Math.max(0, rect.bottom)}px`;
                        const current = input.value && input.value.slice(0, 10);
                        if (/^\d{4}-\d{2}-\d{2}$/.test(current)) {
                            hiddenPicker.value = current;
                        }
                        // 先聚焦再打开，确保首次定位正确
                        hiddenPicker.focus();
                        try { hiddenPicker.showPicker && hiddenPicker.showPicker(); } catch (e) { /* ignore */ }
                        hiddenPicker.click();
                    }

                    // 允许手动输入；点击旁边📅按钮时弹出日期选择器
                    const triggerBtn = document.getElementById(isEnd ? 'end-date-btn' : 'start-date-btn');
                    if (triggerBtn) {
                        triggerBtn.addEventListener('click', function(ev){ ev.preventDefault(); openPicker(); });
                    }

                    hiddenPicker.addEventListener('change', function() {
                        const v = hiddenPicker.value;
                        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                            input.value = isEnd ? `${v} 23:59:59` : `${v} 00:00:00`;
                        }
                        // 选择后把焦点回到可见输入
                        input.focus();
                    });
                }

                attachDateBehavior(startEl, false);
                attachDateBehavior(endEl, true);
            } catch (e) { console.warn('默认时间设置失败:', e); }
        })();

        // ========= 充电数据 正式查询：交互与查询逻辑 =========
        function setExportEnabled(enabled) {
            const btn = document.getElementById('export-btn');
            if (!btn) return;
            btn.disabled = !enabled;
            if (enabled) {
                btn.style.background = '#28a745';
                btn.style.cursor = 'pointer';
            } else {
                btn.style.background = '#adb5bd';
                btn.style.cursor = 'not-allowed';
            }
        }

        // 初始化导出按钮禁用，并初始化设备框体为灰色占位
        setTimeout(() => {
            setExportEnabled(false);
            const deviceSelect = document.getElementById('device-select');
            if (deviceSelect) deviceSelect.style.color = deviceSelect.value ? '#333' : '#999';
        }, 0);

        const STATION_GROUP_TO_NAMES = {
            east: [
                '长沙飞狐充电站',
                '长沙特来电飞狐四方坪东区充电站',
                '长沙特来电飞狐东区充电站',
                '长沙飞狐四方坪桥下充电站',
                '长沙飞狐四方坪桥下二期充电站'
            ],
            west: [
                '长沙特来电飞狐四方坪西区充电站',
                '长沙特来电飞狐西区充电站',
                '长沙飞狐四方坪桥下三期充电站'
            ],
            south: [
                '长沙特来电飞狐四方坪南区充电站',
                '长沙特来电飞狐南区充电站'
            ],
            gaoling: [
                '长沙市开福区高岭香江国际城充电站建设项目',
                '华为飞狐特来电高岭超充站'
            ]
        };

        function navigateHome() {
            // 简单处理：关闭覆盖页，回到首页内容
            const overlay = document.getElementById('page-cd-data');
            if (overlay) overlay.style.display = 'none';
            const overlayBill = document.getElementById('page-bill-data');
            if (overlayBill) overlayBill.style.display = 'none';
            const overlayZh = document.getElementById('page-zh-data');
            if (overlayZh) overlayZh.style.display = 'none';
            window.scrollTo(0, 0);
        }

        function toggleStationMenu() {
            const menu = document.getElementById('station-menu');
            if (!menu) return;
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        }

        // 点击页面空白处隐藏电站下拉
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('station-menu');
            const box = document.getElementById('station-box');
            if (!menu || !box) return;
            if (menu.style.display === 'none' || menu.style.display === '') return;
            const target = e.target;
            if (!box.contains(target) && !menu.contains(target)) {
                menu.style.display = 'none';
            }
        });
        // 鼠标离开菜单区域后隐藏（稍作延迟避免抖动）
        (function() {
            const menu = document.getElementById('station-menu');
            if (!menu) return;
            let hideTimer = null;
            function scheduleHide() {
                clearTimeout(hideTimer);
                hideTimer = setTimeout(() => { menu.style.display = 'none'; }, 200);
            }
            function cancelHide() { clearTimeout(hideTimer); }
            menu.addEventListener('mouseleave', scheduleHide);
            menu.addEventListener('mouseenter', cancelHide);
            const box = document.getElementById('station-box');
            if (box) {
                box.addEventListener('mouseleave', scheduleHide);
                box.addEventListener('mouseenter', cancelHide);
            }
        })();

        function onToggleAllStations() {
            const all = document.getElementById('station-all');
            const items = document.querySelectorAll('#station-menu .station-group');
            items.forEach(i => { i.checked = all.checked; });
        }

        function applyStationSelection() {
            const all = document.getElementById('station-all');
            const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
            const checked = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
            if (checked.length === items.length) {
                all.checked = true;
            } else {
                all.checked = false;
            }
            // 显示已选择的电站名称
            const display = document.getElementById('station-display');
            const mapToLabel = { east: '长沙飞狐东区站', west: '长沙飞狐西区站', south: '长沙飞狐南区站', gaoling: '长沙飞狐高岭充电站' };
            if (display) {
                if (all.checked) {
                    display.textContent = '电站：全选';
                } else if (checked.length > 0) {
                    display.textContent = '电站：' + checked.map(k => mapToLabel[k]).join('、');
                } else {
                    display.textContent = '电站：未选择';
                }
            }
            toggleStationMenu();
        }

        function getSelectedStationNames() {
            const all = document.getElementById('station-all');
            const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
            if (all && all.checked) {
                // 全选：返回所有分组名称合并
                return Object.values(STATION_GROUP_TO_NAMES).flat();
            }
            const groups = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
            if (groups.length === 0) return [];
            let list = [];
            groups.forEach(g => { list = list.concat(STATION_GROUP_TO_NAMES[g] || []); });
            return Array.from(new Set(list));
        }

        function toSqlDateTime(value, isEnd = false) {
            if (!value) return '';
            // value could be 'YYYY-MM-DD hh:mm:ss' or 'YYYY-MM-DD'
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return isEnd ? `${value} 23:59:59` : `${value} 00:00:00`;
            }
            return value.replace('T', ' ');
        }
        function buildStationQuery() {
            const device = (document.getElementById('device-select') || {}).value || '';
            const timeUi = (document.getElementById('time-field-select') || {}).value || '充电结束时间';
            const start = toSqlDateTime((document.getElementById('start-datetime') || {}).value, false);
            const end = toSqlDateTime((document.getElementById('end-datetime') || {}).value, true);
            const stations = getSelectedStationNames();
            const allBox = document.getElementById('station-all');
            const isAllStations = !!(allBox && allBox.checked);

            if (!device) {
                return { ok: false, error: '请选择充电设备' };
            }
            if (!start || !end) {
                return { ok: false, error: '请选择开始与结束时间' };
            }
            // 只有在非全选且没有选择任何电站时才报错
            if (!isAllStations && stations.length === 0) {
                return { ok: false, error: '请选择电站' };
            }

            let tableName = '[特来电]';
            let timeField = timeUi; // 默认与UI一致
            let whereParts = [];

            if (device === '能科') {
                tableName = '[能科]';
                // 时间字段映射
                timeField = (timeUi === '充电开始时间') ? '开始日期时间' : '结束日期时间';
                // 能科：仅按时间过滤（电站UI受限为"东区站"，但表内无电站字段要求）
            whereParts.push(`[${timeField}] BETWEEN '${start}' AND '${end}'`);
            } else {
                // 特来电：使用与单选查询完全相同的逻辑
                // 1. 添加时间过滤条件（所有查询都有）
            whereParts.push(`[${timeField}] BETWEEN '${start}' AND '${end}'`);
                
                // 2. 添加电站名称过滤条件（全选时也使用IN条件，包含所有站点）
                if (isAllStations) {
                    // 全选时：获取所有站点名称，使用IN条件（与多选逻辑一致）
                    const allStations = getSelectedStationNames();
                    if (allStations.length > 0) {
                        const esc = allStations.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                        whereParts.push(`[电站名称] IN (${esc})`);
                    }
                } else if (stations.length > 0) {
                    // 单选/多选：使用选中的站点名称
                const esc = stations.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                whereParts.push(`[电站名称] IN (${esc})`);
            }
            }

            const whereClause = whereParts.length ? ('WHERE ' + whereParts.join(' AND ')) : '';
            const sql = `SELECT * FROM ${tableName} ${whereClause} ORDER BY [${timeField}] ASC`;
            
            // 调试：输出SQL以便检查（开发时启用以排查问题）
            if (device === '特来电' && isAllStations) {
                console.log('特来电全选查询SQL:', sql);
                console.log('WHERE条件:', whereParts);
                console.log('是否全选:', isAllStations);
            }
            
            return { ok: true, sql, device, tableName, timeField, isAllStations };
        }
        let __lastQueryResults = null;

        function runStationQuery() {
            // 清空上一次查询的统计数据，避免显示旧数据
            __statsTotals = null;
            
            // 验证时间：结束时间不能小于开始时间
            const startEl = document.getElementById('start-datetime');
            const endEl = document.getElementById('end-datetime');
            if (startEl && endEl && startEl.value && endEl.value) {
                const startStr = startEl.value.trim();
                const endStr = endEl.value.trim();
                if (startStr && endStr) {
                    const startDate = new Date(startStr);
                    const endDate = new Date(endStr);
                    if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime()) && endDate < startDate) {
                        const resultContent = document.getElementById('query-result-content');
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px; background:#f8d7da; border:1px solid #f5c6cb; border-radius:6px;">充电结束时间不能小于充电开始时间</div>';
                        setExportEnabled(false);
                        __pagination.enabled = false;
                        renderPagination();
                        return;
                    }
                }
            }
            
            const build = buildStationQuery();
            const resultContent = document.getElementById('query-result-content');
            if (!build.ok) {
                resultContent.innerHTML = '<div style="color:#c00;">' + build.error + '</div>';
                setExportEnabled(false);
                __pagination.enabled = false;
                renderPagination();
                return;
            }
            
            // 更新当前条件显示
            updateCurrentConditions();

            function singleQueryFallback() {
                console.warn('分页失败，回退到单次查询');
                resultContent.innerHTML = '<p>正在执行查询...</p>';
                setExportEnabled(false);
                return fetch('https://0rrqt8vr.lc-cn-n1-shared.com/1.1/functions/executeSQLQuery', {
                    method: 'POST',
                    headers: {
                        'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                        'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ query: build.sql })
                })
                .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status + ': ' + r.statusText); return r.json(); })
                .then(result => {
                    const payload = (result && result.result) ? result.result : result;
                    if (payload && payload.success) {
                        __lastQueryResults = payload;
                        displayQueryResult(payload);
                        setExportEnabled(!!(payload && payload.results && payload.results.length));
                        __pagination.enabled = false;
                        renderPagination();
                    } else {
                        resultContent.innerHTML = `
                            <div style=\"background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;\">\n                                <h4 style=\"margin:0 0 6px 0;\">查询失败</h4>\n                                <div>${(payload && payload.message) || '未知错误'}</div>\n                            </div>`;
                        setExportEnabled(false);
                        __pagination.enabled = false;
                        renderPagination();
                    }
                })
                .catch(err => {
                    console.error('单次查询也失败:', err);
                    resultContent.innerHTML = `
                        <div style=\"background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;\">\n                            <h4 style=\"margin:0 0 6px 0;\">查询失败</h4>\n                            <div>${err.message || '未知错误'}</div>\n                        </div>`;
                    setExportEnabled(false);
                    __pagination.enabled = false;
                    renderPagination();
                });
            }

            // 分页查询优化：先加载第一页，再异步统计全量 COUNT/SUM
            setExportEnabled(false);
            resultContent.innerHTML = '<p>准备加载第 1 页...</p>';

            const timeFieldSel = build.timeField || ((document.getElementById('time-field-select') || {}).value || '充电结束时间');
            const sqlNoOrder = build.sql.replace(/ORDER\s+BY[\s\S]*$/i, '').trim();
            const orderByFinal = `ORDER BY [${timeFieldSel}] ASC`;

                    __pagination.enabled = true;
                    __pagination.sqlNoOrder = sqlNoOrder;
                    __pagination.orderByFinal = orderByFinal;
                    __pagination.pageSize = 20;
            __pagination.total = 0;
                    __pagination.currentPage = 1;
            (function assignWhereAndColumns(){
                const start = toSqlDateTime((document.getElementById('start-datetime') || {}).value, false);
                const end = toSqlDateTime((document.getElementById('end-datetime') || {}).value, true);
                const stations = getSelectedStationNames();
                const allBox = document.getElementById('station-all');
                const isAllStations = !!(allBox && allBox.checked);
                const whereParts = [];
                if (start && end) {
                    whereParts.push(`[${timeFieldSel}] BETWEEN '${start}' AND '${end}'`);
                }
                // 特来电：使用与单选查询完全相同的逻辑
                // 1. 添加时间过滤条件（所有查询都有）
                // 2. 添加电站名称过滤条件（全选时也使用IN条件，包含所有站点）
                if (build.device !== '能科') {
                    if (isAllStations) {
                        // 全选时：获取所有站点名称，使用IN条件（与多选逻辑一致）
                        const allStations = getSelectedStationNames();
                        if (allStations.length > 0) {
                            const esc = allStations.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                            whereParts.push(`[电站名称] IN (${esc})`);
                        }
                    } else if (stations && stations.length > 0) {
                        // 单选/多选：使用选中的站点名称
                    const esc = stations.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                    whereParts.push(`[电站名称] IN (${esc})`);
                    }
                }
                __pagination.whereClause = whereParts.length ? ('WHERE ' + whereParts.join(' AND ')) : '';
                
                // 调试：输出分页查询WHERE条件（特来电全选时）
                if (build.device === '特来电' && isAllStations) {
                    console.log('分页查询WHERE条件:', __pagination.whereClause);
                    console.log('WHERE条件数组:', whereParts);
                }
                
                __pagination.timeField = timeFieldSel;
                __pagination.tableName = build.tableName || '[特来电]';
                __currentDevice = build.device || '特来电';
                if (build.device === '能科') {
                    // 为兼容列名差异，能科分页查询改为 SELECT *，前端按映射展示
                    __pagination.selectCols = '*';
                    __currentDisplayColumns = ['卡号','持卡人','充电桩名称','开始日期时间','结束日期时间','充电时长','开始SOC','结束SOC','充电量','消费金额','电费','服务费'];
                } else {
                    __pagination.selectCols = '[电站名称], [终端名称], [充电开始时间], [充电结束时间], [充电电费(元)], [充电服务费(元)], [充电费用(元)], [充电时长(分钟)], [充电前soc], [充电后soc], [判定车牌号], [车辆所属客户]';
                    __currentDisplayColumns = DISPLAY_COLUMNS.slice();
                }
            })();

            // 先渲染第一页（只查询20行数据，不涉及统计）
            renderPagination();
            
            // 直接使用普通分页查询（全选时也使用IN条件，查询逻辑与多选一致）
            goToPage(1);

            // 异步统计查询：能科和特来电都使用服务器端聚合（统一逻辑）
            const whereClause = __pagination.whereClause || '';
            const tableName = __pagination.tableName || '[特来电]';
            
            if (build.device === '能科') {
                // 能科：使用服务器端聚合（与特来电逻辑一致）
                console.log('能科查询：使用服务器端聚合统计方式');
                
                // 能科的字段名：电费、服务费、消费金额、充电量、充电时长
                // 注意：能科的充电时长可能是ISO格式或hh:mm:ss格式，需要在客户端处理
                const statsSql = `SELECT 
                    COUNT(1) AS total,
                    SUM(CAST([电费] AS DECIMAL(18,4))) AS fee_elec,
                    SUM(CAST([服务费] AS DECIMAL(18,4))) AS fee_service,
                    SUM(CAST([消费金额] AS DECIMAL(18,4))) AS fee_total,
                    SUM(CAST([充电量] AS DECIMAL(18,4))) AS kwh_total
                    FROM ${tableName} ${whereClause}`;
                
                // 统计查询：返回汇总数据（充电时长单独计算）
                callSqlWithRetry(statsSql, 3, 800).then(statsRes => {
                    const row = (statsRes && statsRes.results && statsRes.results[0]) || {};
                    const total = Number(row.total) || 0;
                    const sumFee = Number(row.fee_elec) || 0;
                    const sumService = Number(row.fee_service) || 0;
                    const sumAmount = Number(row.fee_total) || 0;
                    const sumKwh = Number(row.kwh_total) || 0;
                    
                    // 更新分页总数
                    __pagination.total = total;
                    renderPagination();
                    
                    // 先使用服务器端SUM的结果，充电时长稍后通过分批计算补充
                    __statsTotals = {
                        total: total,
                        electricityFee: sumFee,
                        serviceFee: sumService,
                        chargingFee: sumAmount,
                        electricity: sumKwh,
                        duration: 0 // 暂设为0，稍后补充
                    };
                    updateStatsOnly();
                    
                    // 异步计算充电时长（分批查询，因为可能是ISO格式）
                    if (total > 0) {
                        calculateNkDuration(whereClause, tableName, timeFieldSel);
                    }
                }).catch(err => {
                    console.warn('能科统计查询失败，使用分批聚合作为后备:', err);
                    // 如果服务器端聚合失败，回退到分批聚合
                    const countSql = `SELECT COUNT(1) AS total FROM ${tableName} ${whereClause}`;
                    callSqlWithRetry(countSql, 3, 800).then(countRes => {
                const total = (countRes && countRes.results && countRes.results[0] && (countRes.results[0].total || countRes.results[0][''])) || 0;
                __pagination.total = Number(total) || 0;
                renderPagination();
                    aggregateNkTotalsInBatches();
                    }).catch(err2 => {
                        console.warn('统计总数失败（不影响数据查看）:', err2);
            });
                });
            } else {
                // 特来电：使用服务器端聚合
                console.log('特来电查询：使用服务器端聚合统计方式');

                const statsSql = `SELECT 
                        COUNT(1) AS total,
                        SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                        SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                        SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                        SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                        SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                    FROM ${tableName} ${whereClause}`;
                
                // 统计查询：只返回一行汇总数据
                callSqlWithRetry(statsSql, 3, 800).then(statsRes => {
                    const row = (statsRes && statsRes.results && statsRes.results[0]) || {};
                    const total = Number(row.total) || 0;
                    
                    // 更新分页总数
                    __pagination.total = total;
                    renderPagination();
                    
                    // 更新统计汇总
                        __statsTotals = {
                        total: total,
                            electricityFee: Number(row.fee_elec) || 0,
                            serviceFee: Number(row.fee_service) || 0,
                            chargingFee: Number(row.fee_total) || 0,
                            electricity: Number(row.kwh_total) || 0,
                            duration: Number(row.minutes_total) || 0
                        };
                    // 只更新统计区域，不重新渲染整个表格
                    updateStatsOnly();
                }).catch(err => {
                    console.warn('统计查询失败（不影响分页数据查看）:', err);
                    // 统计失败时保持__statsTotals为null，统计区域继续显示"计算中"
                });
            }
        }

        function exportQueryToExcel() {
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn && exportBtn.disabled) {
                // 禁用状态下静默返回，不提示
                return;
            }
            // 仅导出当前页的数据（与页面展示一致，默认每页20行）
            try {
                    const rows = (__lastQueryResults && __lastQueryResults.results) ? __lastQueryResults.results : [];
                if (!rows || rows.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }
                const ws = XLSX.utils.json_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '充电数据查询');
                // 文件名包含当前页码
                const pageNo = (__pagination && __pagination.enabled) ? __pagination.currentPage : 1;
                XLSX.writeFile(wb, `充电数据查询_第${pageNo}页.xlsx`);
            } catch (e) {
                console.error('导出失败:', e);
                alert('导出失败：' + (e.message || '未知错误'));
            }
        }

        // ========= 电费账单页面相关函数 =========
        
        // 客户号选择相关函数
        function toggleCustomerMenu() {
            const menu = document.getElementById('customer-menu');
            if (!menu) return;
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        }

        function onToggleAllCustomers() {
            const allBox = document.getElementById('customer-all');
            const items = document.querySelectorAll('#customer-menu .customer-group');
            const checked = allBox ? allBox.checked : false;
            items.forEach(item => { item.checked = checked; });
            updateCustomerDisplay();
        }

        function updateCustomerDisplay() {
            const allBox = document.getElementById('customer-all');
            const items = Array.from(document.querySelectorAll('#customer-menu .customer-group'));
            const checked = items.filter(i => i.checked);
            
            // 更新全选状态
            if (allBox) {
                allBox.checked = (checked.length === items.length);
            }

            // 更新显示文字
            const display = document.getElementById('customer-display');
            if (!display) return;
            
            if (checked.length === 0) {
                display.textContent = '客户号';
                display.style.color = '#999';
            } else if (checked.length === items.length) {
                display.textContent = '全部客户号';
                display.style.color = '#333';
            } else if (checked.length === 1) {
                display.textContent = checked[0].getAttribute('data-customer');
                display.style.color = '#333';
            } else {
                display.textContent = `已选${checked.length}个客户号`;
                display.style.color = '#333';
            }
        }

        function applyCustomerSelection() {
            updateCustomerDisplay();
            toggleCustomerMenu();
        }

        function getSelectedCustomers() {
            const items = Array.from(document.querySelectorAll('#customer-menu .customer-group'));
            return items.filter(i => i.checked).map(i => i.getAttribute('data-customer'));
        }

        // 初始化客户号选择功能
        (function initCustomerSelection() {
            try {
                const items = document.querySelectorAll('#customer-menu .customer-group');
                items.forEach(item => {
                    item.addEventListener('change', updateCustomerDisplay);
                });
                
                // 点击页面其他地方时关闭菜单
                document.addEventListener('click', function(e) {
                    const menu = document.getElementById('customer-menu');
                    const btn = document.getElementById('customer-menu-btn');
                    const box = document.getElementById('customer-box');
                    if (menu && btn && box && !box.contains(e.target)) {
                        menu.style.display = 'none';
                    }
                });
            } catch(e) {
                console.warn('客户号选择初始化失败:', e);
            }
        })();

        // 年月格式的日期选择器
        (function initMonthPickers() {
            try {
                const pad = n => (n < 10 ? '0' + n : '' + n);
                const now = new Date();
                const y = now.getFullYear();
                const m = pad(now.getMonth() + 1);
                const defaultMonth = `${y}-${m}`;
                
                const startEl = document.getElementById('bill-start-month');
                const endEl = document.getElementById('bill-end-month');
                if (startEl) startEl.value = defaultMonth;
                if (endEl) endEl.value = defaultMonth;

                function attachMonthBehavior(input, isEnd) {
                    if (!input) return;
                    
                    const hiddenPicker = document.createElement('input');
                    hiddenPicker.type = 'month';
                    hiddenPicker.style.position = 'fixed';
                    hiddenPicker.style.opacity = '0';
                    hiddenPicker.style.pointerEvents = 'none';
                    hiddenPicker.style.width = '0';
                    hiddenPicker.style.height = '0';
                    document.body.appendChild(hiddenPicker);

                    function openPicker() {
                        const rect = input.getBoundingClientRect();
                        hiddenPicker.style.left = `${Math.max(0, rect.left)}px`;
                        hiddenPicker.style.top = `${Math.max(0, rect.bottom)}px`;
                        const current = input.value;
                        if (/^\d{4}-\d{2}$/.test(current)) {
                            hiddenPicker.value = current;
                        }
                        hiddenPicker.focus();
                        try { hiddenPicker.showPicker && hiddenPicker.showPicker(); } catch (e) { /* ignore */ }
                        hiddenPicker.click();
                    }

                    const triggerBtn = document.getElementById(isEnd ? 'bill-end-month-btn' : 'bill-start-month-btn');
                    if (triggerBtn) {
                        triggerBtn.addEventListener('click', function(ev){ ev.preventDefault(); openPicker(); });
                    }

                    hiddenPicker.addEventListener('change', function() {
                        const v = hiddenPicker.value;
                        if (/^\d{4}-\d{2}$/.test(v)) {
                            input.value = v;
                        }
                        input.focus();
                    });
                }

                attachMonthBehavior(startEl, false);
                attachMonthBehavior(endEl, true);
            } catch (e) { 
                console.warn('月份选择器初始化失败:', e); 
            }
        })();

        // 电费账单查询相关变量
        let __lastBillQueryResults = null;

        function setBillExportEnabled(enabled) {
            const btn = document.getElementById('bill-export-btn');
            if (!btn) return;
            btn.disabled = !enabled;
            if (enabled) {
                btn.style.background = '#28a745';
                btn.style.cursor = 'pointer';
            } else {
                btn.style.background = '#adb5bd';
                btn.style.cursor = 'not-allowed';
            }
        }

        // 构建电费账单查询SQL
        function buildBillQuery() {
            const startMonth = (document.getElementById('bill-start-month') || {}).value || '';
            const endMonth = (document.getElementById('bill-end-month') || {}).value || '';
            const customers = getSelectedCustomers();
            const allBox = document.getElementById('customer-all');
            const isAllCustomers = !!(allBox && allBox.checked);

            if (!startMonth || !endMonth) {
                return { ok: false, error: '请选择开始与结束年月' };
            }

            // 验证年月格式
            if (!/^\d{4}-\d{2}$/.test(startMonth) || !/^\d{4}-\d{2}$/.test(endMonth)) {
                return { ok: false, error: '年月格式错误，请使用YYYY-MM格式' };
            }

            // 解析年月
            const [startYear, startMonthNum] = startMonth.split('-').map(Number);
            const [endYear, endMonthNum] = endMonth.split('-').map(Number);

            if (customers.length === 0) {
                return { ok: false, error: '请选择客户号' };
            }

            // 验证结束时间不能小于开始时间
            if (endYear < startYear || (endYear === startYear && endMonthNum < startMonthNum)) {
                return { ok: false, error: '结束年月不能小于开始年月' };
            }

            const tableName = '[电力局]';
            let whereParts = [];

            // 构建年月条件
            // 如果是同一年，则使用月份范围
            if (startYear === endYear) {
                whereParts.push(`[年] = ${startYear}`);
                whereParts.push(`[月] BETWEEN ${startMonthNum} AND ${endMonthNum}`);
            } else {
                // 跨年查询：年份在范围内，或者是开始年且月份>=开始月，或者是结束年且月份<=结束月
                whereParts.push(`(
                    ([年] > ${startYear} AND [年] < ${endYear})
                    OR ([年] = ${startYear} AND [月] >= ${startMonthNum})
                    OR ([年] = ${endYear} AND [月] <= ${endMonthNum})
                )`);
            }

            // 添加客户号条件
            if (!isAllCustomers && customers.length > 0) {
                const esc = customers.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                whereParts.push(`[变压器编号] IN (${esc})`);
            }

            const whereClause = whereParts.length ? ('WHERE ' + whereParts.join(' AND ')) : '';
            const sql = `SELECT * FROM ${tableName} ${whereClause} ORDER BY [年] ASC, [月] ASC`;
            return { ok: true, sql, tableName };
        }

        // 更新电费账单当前条件显示
        function updateBillCurrentConditions() {
            const conditionsText = document.getElementById('bill-current-conditions-text');
            if (!conditionsText) return;
            
            try {
                // 获取客户号信息
                const allBox = document.getElementById('customer-all');
                const items = Array.from(document.querySelectorAll('#customer-menu .customer-group'));
                let customerText = '';
                
                if (allBox && allBox.checked) {
                    // 全选：显示所有客户号
                    customerText = '3111439077、3118481453、4350001671599';
                } else {
                    // 显示选中的客户号
                    const checked = items.filter(i => i.checked).map(i => i.getAttribute('data-customer'));
                    if (checked.length === 0) {
                        customerText = '未选择';
                    } else {
                        customerText = checked.join('、');
                    }
                }
                
                // 获取年月范围
                const startMonth = (document.getElementById('bill-start-month') || {}).value || '';
                const endMonth = (document.getElementById('bill-end-month') || {}).value || '';
                
                // 构建条件文本
                const conditions = [
                    `客户号：${customerText}`,
                    startMonth ? `开始年月：${startMonth}` : '',
                    endMonth ? `结束年月：${endMonth}` : ''
                ].filter(c => c).join('；');
                
                conditionsText.textContent = conditions || '请选择查询条件后点击查询';
            } catch (err) {
                console.error('更新电费账单当前条件失败:', err);
                conditionsText.textContent = '获取查询条件失败';
            }
        }

        // 执行电费账单查询
        function runBillQuery() {
            const build = buildBillQuery();
            const resultContent = document.getElementById('bill-query-result-content');
            if (!build.ok) {
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">' + build.error + '</div>';
                setBillExportEnabled(false);
                return;
            }
            
            // 更新当前条件显示
            updateBillCurrentConditions();

            resultContent.innerHTML = '<p style="padding:12px;">正在执行查询...</p>';
            setBillExportEnabled(false);

            return fetch('https://0rrqt8vr.lc-cn-n1-shared.com/1.1/functions/executeSQLQuery', {
                method: 'POST',
                headers: {
                    'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                    'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ query: build.sql })
            })
            .then(r => { 
                if (!r.ok) throw new Error('HTTP ' + r.status + ': ' + r.statusText); 
                return r.json(); 
            })
            .then(result => {
                const payload = (result && result.result) ? result.result : result;
                if (payload && payload.success) {
                    __lastBillQueryResults = payload;
                    displayBillQueryResult(payload);
                    setBillExportEnabled(true);
                } else {
                    const msg = payload.message || payload.error || '未知错误';
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">查询失败: ' + msg + '</div>';
                    setBillExportEnabled(false);
                }
            })
            .catch(err => {
                console.error('查询失败:', err);
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">网络错误或查询失败: ' + err.message + '</div>';
                setBillExportEnabled(false);
            });
        }

        // 显示电费账单查询结果
        function displayBillQueryResult(payload) {
            const resultContent = document.getElementById('bill-query-result-content');
            if (!resultContent) return;

            const rows = payload.results || [];
            if (rows.length === 0) {
                resultContent.innerHTML = '<div style="padding:12px; color:#666;">未查询到数据</div>';
                return;
            }

            // 计算统计数据
            let totalPurchaseFee = 0;  // 购电费
            let totalTransmissionFee = 0;  // 输配电量电费
            let totalPowerAdjustmentFee = 0;  // 力调电费
            let totalFundFee = 0;  // 基金及附加
            let totalLineLossFee = 0;  // 上网线损费用
            let totalSystemFee = 0;  // 系统运行费用
            let totalEnvironmentFee = 0;  // 环境价值费用
            let totalElectricity = 0;  // 电量

            rows.forEach(row => {
                totalPurchaseFee += parseFloat(row['购电费'] || 0);
                totalTransmissionFee += parseFloat(row['输配电量电费'] || 0);
                totalPowerAdjustmentFee += parseFloat(row['力调电费'] || 0);
                totalFundFee += parseFloat(row['基金及附加'] || 0);
                totalLineLossFee += parseFloat(row['上网线损费用'] || 0);
                totalSystemFee += parseFloat(row['系统运行费用'] || 0);
                totalEnvironmentFee += parseFloat(row['环境价值费用'] || 0);
                totalElectricity += parseFloat(row['电量'] || 0);
            });

            const totalFee = totalPurchaseFee + totalTransmissionFee + totalPowerAdjustmentFee + 
                           totalFundFee + totalLineLossFee + totalSystemFee + totalEnvironmentFee;

            // 构建汇总信息HTML
            let summaryHtml = `
                <div style="padding:16px; background:#f8f9fa; border-bottom:2px solid #007bff; margin-bottom:16px;">
                    <h5 style="margin:0 0 12px 0; color:#333;">费用汇总统计</h5>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; font-size:14px;">
                        <div><strong>购电费：</strong>¥${totalPurchaseFee.toFixed(2)}</div>
                        <div><strong>输配电量电费：</strong>¥${totalTransmissionFee.toFixed(2)}</div>
                        <div><strong>力调电费：</strong>¥${totalPowerAdjustmentFee.toFixed(2)}</div>
                        <div><strong>基金及附加：</strong>¥${totalFundFee.toFixed(2)}</div>
                        <div><strong>上网线损费用：</strong>¥${totalLineLossFee.toFixed(2)}</div>
                        <div><strong>系统运行费用：</strong>¥${totalSystemFee.toFixed(2)}</div>
                        <div><strong>环境价值费用：</strong>¥${totalEnvironmentFee.toFixed(2)}</div>
                        <div style="color:#007bff; font-weight:bold; font-size:16px;"><strong>总费用：</strong>¥${totalFee.toFixed(2)}</div>
                    </div>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-size:14px;">
                        <strong>电量：</strong><span style="color:#28a745; font-weight:bold;">${totalElectricity.toFixed(2)} 度</span>
                    </div>
                </div>
            `;

            // 构建表格HTML
            const cols = Object.keys(rows[0]);
            let tableHtml = '<table style="width:100%; border-collapse:collapse; font-size:14px;">';
            tableHtml += '<thead><tr>';
            cols.forEach(col => {
                tableHtml += `<th style="padding:10px; background:#007bff; color:#fff; border:1px solid #ddd; text-align:center; white-space:nowrap;">${col}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            // 需要格式化为两位小数的费用字段
            const feeFields = [
                '购电费',
                '输配电量电费',
                '力调电费',
                '基金及附加',
                '上网线损费用',
                '系统运行费用',
                '环境价值费用'
            ];

            // 格式化数字为两位小数的辅助函数（仅对指定字段）
            const formatFeeNumber = (val) => {
                if (val === null || val === undefined || val === '') return '';
                // 尝试转换为数字
                const num = parseFloat(val);
                // 如果是有效数字，格式化为两位小数
                if (!isNaN(num)) {
                    return num.toFixed(2);
                }
                // 如果不是数字，返回原值
                return val;
            };

            rows.forEach((row, idx) => {
                const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                tableHtml += '<tr>';
                cols.forEach(col => {
                    let val = row[col] !== null && row[col] !== undefined ? row[col] : '';
                    // 只对指定的费用字段格式化为两位小数，其他字段保持原格式
                    if (feeFields.includes(col)) {
                        val = formatFeeNumber(val);
                    }
                    tableHtml += `<td style="padding:8px; border:1px solid #ddd; text-align:center; background:${bg};">${val}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            tableHtml += `<div style="padding:12px; color:#666; font-size:13px;">共查询到 ${rows.length} 条数据</div>`;

            resultContent.innerHTML = summaryHtml + tableHtml;
        }

        // 导出电费账单到Excel
        function exportBillToExcel() {
            const exportBtn = document.getElementById('bill-export-btn');
            if (exportBtn && exportBtn.disabled) {
                return;
            }

            try {
                const rows = (__lastBillQueryResults && __lastBillQueryResults.results) ? __lastBillQueryResults.results : [];
                if (!rows || rows.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }
                
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '电费账单');
                XLSX.writeFile(wb, `电费账单查询.xlsx`);
            } catch (e) {
                console.error('导出失败:', e);
                alert('导出失败：' + (e.message || '未知错误'));
            }
        }

        // 初始化电费账单导出按钮为禁用状态
        setTimeout(() => {
            setBillExportEnabled(false);
        }, 0);

        // ==================== 综合数据查询相关函数 ====================
        
        // 综合数据分页和查询状态
        let __zhPagination = {
            currentPage: 1,
            pageSize: 20,
            total: 0,
            tableName: '',
            timeField: '',
            whereClause: '',
            orderByFinal: '',
            results: []
        };
        let __zhStatsTotals = null;
        let __lastZhQueryResults = null;

        // 项目类别变化处理
        function onZhProjectChange() {
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            if (!project) return;
            
            // 根据项目类别设置时间字段
            let timeField = '';
            if (project === '红门缴费') {
                timeField = '缴费时间';
            } else if (project === '月租车充值') {
                timeField = '交款时间';
            } else if (project === '兴元售货机') {
                timeField = '支付时间';
            } else if (project === '赛菲姆道闸') {
                timeField = '支付时间';
            } else if (project === '快易洁洗车') {
                timeField = '日期';
            } else if (project === '收钱吧') {
                timeField = '交易日期';
            } else if (project === '智小盟') {
                timeField = '支付时间';
            } else if (project === '车颜知己洗车') {
                timeField = '启动时间';
            } else if (project === '车海洋洗车') {
                timeField = '时间';
            } else if (project === '微信') {
                timeField = '交易时间';
            }
            
            // 根据项目类别设置表名
            if (project === '车海洋洗车') {
                __zhPagination.tableName = '[车海洋洗车消费]';
            } else if (project === '微信') {
                __zhPagination.tableName = '[微信收款商业版]';
            } else {
                __zhPagination.tableName = `[${project}]`;
            }
            __zhPagination.timeField = timeField;
            
            // 初始化日期选择器
            initZhDatetimePickers();
        }

        // 初始化综合数据页面日期选择器（与充电数据页面保持一致）
        function initZhDatetimePickers() {
            try {
                const pad = n => (n < 10 ? '0' + n : '' + n);
                const now = new Date();
                const y = now.getFullYear();
                const m = pad(now.getMonth() + 1);
                const d = pad(now.getDate());
                const startTime = `${y}-${m}-${d} 00:00:00`;
                const endTime = `${y}-${m}-${d} 23:59:59`;
                const startInput = document.getElementById('zh-start-datetime');
                const endInput = document.getElementById('zh-end-datetime');
                if (!startInput || !endInput) return;
                
                if (startInput.value === '') startInput.value = startTime;
                if (endInput.value === '') endInput.value = endTime;

                function attachZhDateBehavior(input, isEnd) {
                    if (!input) return;
                    // 保持文本输入框始终显示 yyyy-mm-dd hh:mm:ss
                    // 使用隐藏的原生日期选择器进行选择
                    const hiddenPicker = document.createElement('input');
                    hiddenPicker.type = 'date';
                    hiddenPicker.style.position = 'fixed';
                    hiddenPicker.style.opacity = '0';
                    hiddenPicker.style.pointerEvents = 'none';
                    hiddenPicker.style.width = '0';
                    hiddenPicker.style.height = '0';
                    document.body.appendChild(hiddenPicker);

                    function openPicker() {
                        const rect = input.getBoundingClientRect();
                        hiddenPicker.style.left = `${Math.max(0, rect.left)}px`;
                        hiddenPicker.style.top = `${Math.max(0, rect.bottom)}px`;
                        const current = input.value && input.value.slice(0, 10);
                        if (/^\d{4}-\d{2}-\d{2}$/.test(current)) {
                            hiddenPicker.value = current;
                        }
                        // 先聚焦再打开，确保首次定位正确
                        hiddenPicker.focus();
                        try { hiddenPicker.showPicker && hiddenPicker.showPicker(); } catch (e) { /* ignore */ }
                        hiddenPicker.click();
                    }

                    // 允许手动输入；点击旁边📅按钮时弹出日期选择器
                    const triggerBtn = document.getElementById(isEnd ? 'zh-end-date-btn' : 'zh-start-date-btn');
                    if (triggerBtn) {
                        triggerBtn.addEventListener('click', function(ev){ ev.preventDefault(); openPicker(); });
                    }

                    hiddenPicker.addEventListener('change', function() {
                        const v = hiddenPicker.value;
                        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                            input.value = isEnd ? `${v} 23:59:59` : `${v} 00:00:00`;
                        }
                        // 选择后把焦点回到可见输入
                        input.focus();
                    });
                }

                attachZhDateBehavior(startInput, false);
                attachZhDateBehavior(endInput, true);
            } catch (e) { 
                console.warn('综合数据默认时间设置失败:', e); 
            }
        }

        // 构建综合数据查询SQL
        function buildZhQuery() {
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            if (!project) {
                throw new Error('请选择项目类别');
            }

            const start = toSqlDateTime((document.getElementById('zh-start-datetime') || {}).value, false);
            const end = toSqlDateTime((document.getElementById('zh-end-datetime') || {}).value, true);
            const timeField = __zhPagination.timeField || '缴费时间';

            if (!start || !end) {
                throw new Error('请选择开始时间和结束时间');
            }

            // 根据项目类别设置表名
            let tableName = `[${project}]`;
            if (project === '车海洋洗车') {
                tableName = '[车海洋洗车消费]';
            } else if (project === '微信') {
                tableName = '[微信收款商业版]';
            }
            
            // 对于日期字段（如"交易日期"、"日期"），只使用日期部分进行比较
            // 对于日期时间字段（如"支付时间"、"交易时间"、"时间"），使用完整日期时间进行比较
            let whereClause = '';
            if (timeField === '交易日期' || timeField === '日期') {
                // 日期字段：只提取日期部分（YYYY-MM-DD）
                const startDate = start.split(' ')[0];
                const endDate = end.split(' ')[0];
                // 尝试使用更简单的日期比较方式
                // 如果字段是DATE类型，直接比较字符串；如果是DATETIME类型，使用CONVERT提取日期部分
                // 先尝试简单的字符串比较（适用于DATE类型字段）
                whereClause = `WHERE [${timeField}] >= '${startDate}' AND [${timeField}] <= '${endDate}'`;
            } else if (project === '智小盟') {
                // 智小盟的时间字段前面可能有制表符或空格，清理后使用字符串比较（因为字段可能是nvarchar类型）
                // 清理后的格式应该是 "YYYY-MM-DD HH:MM:SS"，可以直接进行字符串比较
                whereClause = `WHERE LTRIM(RTRIM([${timeField}])) >= '${start}' AND LTRIM(RTRIM([${timeField}])) <= '${end}'`;
            } else {
                // 日期时间字段：使用完整日期时间
                whereClause = `WHERE [${timeField}] >= '${start}' AND [${timeField}] <= '${end}'`;
            }
            
            // 根据项目类别设置查询列
            let selectColumns = '*';
            if (project === '兴元售货机') {
                selectColumns = '[商户名称], [销售额], [货道编号], [商品名称], [支付账号], [支付方式], [支付金额], [出货状态], [退款金额], [支付时间]';
            } else if (project === '赛菲姆道闸') {
                selectColumns = '[车牌号码], [订单类型], [支付金额], [支付时间], [支付方式], [开始时间], [结束时间]';
            } else if (project === '收钱吧') {
                selectColumns = '[交易日期], [收款通道/支付方式], [交易状态], [收款金额]';
            } else if (project === '智小盟') {
                selectColumns = '[设备名称], [实收金额 ], [支付方式], [支付时间]';
            } else if (project === '车海洋洗车') {
                selectColumns = '*'; // 车海洋洗车消费表的所有列
            } else if (project === '微信') {
                selectColumns = '[交易时间], [商户号], [微信订单号], [订单金额], [退款金额]';
            } else if (project === '车颜知己洗车') {
                selectColumns = '[场所], [启动时间], [停止时间], [订单金额], [使用会员卡], [订单状态]';
            }
            // 快易洁洗车：查询所有列
            
            return {
                tableName: tableName,
                whereClause: whereClause,
                timeField: timeField,
                project: project,
                selectColumns: selectColumns
            };
        }

        // 更新综合数据当前条件显示
        function updateZhCurrentConditions() {
            const conditionsText = document.getElementById('zh-current-conditions-text');
            if (!conditionsText) return;
            
            try {
                // 获取项目类别
                const project = (document.getElementById('zh-project-select') || {}).value || '';
                if (!project) {
                    conditionsText.textContent = '请选择项目类别';
                    return;
                }
                
                // 获取时间范围
                const startEl = document.getElementById('zh-start-datetime');
                const endEl = document.getElementById('zh-end-datetime');
                const startTime = (startEl && startEl.value) ? startEl.value.trim() : '';
                const endTime = (endEl && endEl.value) ? endEl.value.trim() : '';
                
                // 构建条件文本
                const conditions = [
                    `项目类别：${project}`,
                    startTime ? `开始时间：${startTime}` : '',
                    endTime ? `结束时间：${endTime}` : ''
                ].filter(c => c).join('；');
                
                conditionsText.textContent = conditions || '请选择查询条件后点击查询';
            } catch (err) {
                console.error('更新综合数据当前条件失败:', err);
                conditionsText.textContent = '获取查询条件失败';
            }
        }

        // 执行综合数据查询
        function runZhQuery() {
            __zhStatsTotals = null;

            try {
                const query = buildZhQuery();
                __zhPagination.tableName = query.tableName;
                __zhPagination.timeField = query.timeField;
                __zhPagination.whereClause = query.whereClause;

                const resultContent = document.getElementById('zh-query-result-content');
                if (!resultContent) return;

                resultContent.innerHTML = '<div style="padding:12px;"><i class="fas fa-spinner fa-spin"></i> 查询中...</div>';
                setZhExportEnabled(false);
                
                // 更新当前条件显示
                updateZhCurrentConditions();

                // 先获取总数
                const countSql = `SELECT COUNT(*) as total FROM ${query.tableName} ${query.whereClause}`;
                console.log('综合数据查询 - 项目:', query.project, '表名:', query.tableName, '时间字段:', query.timeField);
                console.log('COUNT SQL:', countSql);
                console.log('WHERE子句:', query.whereClause);
                
                // 对于"智小盟"，先检查表中是否有任何数据，以及时间字段的格式
                if (query.project === '智小盟') {
                    const testSql = `SELECT TOP 5 [支付时间] FROM ${query.tableName} ORDER BY [支付时间] DESC`;
                    console.log('智小盟测试查询 - 检查表中最近5条数据的时间字段:', testSql);
                    callSqlWithRetry(testSql).then(testResult => {
                        console.log('智小盟测试查询结果:', testResult);
                        if (testResult && testResult.results && testResult.results.length > 0) {
                            console.log('智小盟表中存在数据，最近5条记录的时间字段值:');
                            testResult.results.forEach((row, idx) => {
                                console.log(`  第${idx + 1}条: [支付时间] = "${row['支付时间']}" (类型: ${typeof row['支付时间']})`);
                            });
                        } else {
                            console.warn('智小盟测试查询：表中没有任何数据');
                        }
                    }).catch(err => {
                        console.error('智小盟测试查询失败:', err);
                    });
                    
                    // 检查表中的总记录数
                    const totalCountSql = `SELECT COUNT(*) as total FROM ${query.tableName}`;
                    callSqlWithRetry(totalCountSql).then(totalResult => {
                        if (totalResult && totalResult.results && totalResult.results[0]) {
                            const totalInTable = totalResult.results[0].total || totalResult.results[0].TOTAL || 0;
                            console.log(`智小盟表中总记录数: ${totalInTable}`);
                        }
                    }).catch(err => {
                        console.error('智小盟总记录数查询失败:', err);
                    });
                }
                
                callSqlWithRetry(countSql)
                    .then(countResult => {
                        console.log('COUNT查询结果:', countResult);
                        console.log('COUNT查询结果类型:', typeof countResult);
                        console.log('COUNT查询结果keys:', Object.keys(countResult));
                        if (countResult && countResult.results) {
                            console.log('COUNT查询results:', countResult.results);
                            console.log('COUNT查询results长度:', countResult.results.length);
                            if (countResult.results.length > 0) {
                                console.log('COUNT查询results[0]:', countResult.results[0]);
                            }
                        }
                        const total = countResult.results && countResult.results[0] ? (countResult.results[0].total || countResult.results[0].TOTAL || 0) : 0;
                        console.log('提取的total值:', total);
                        __zhPagination.total = total;
                        __zhPagination.currentPage = 1;

                        // 获取第一页数据
                        // 对于"智小盟"，ORDER BY需要使用清理后的字段
                        let orderByFinal;
                        if (query.project === '智小盟') {
                            orderByFinal = `ORDER BY LTRIM(RTRIM([${query.timeField}])) DESC`;
                        } else {
                            orderByFinal = `ORDER BY [${query.timeField}] DESC`;
                        }
                        __zhPagination.orderByFinal = orderByFinal;
                        // 兴元售货机使用指定的列，其他使用*
                        const selectCols = query.selectColumns || '*';
                        const dataSql = `SELECT TOP 20 ${selectCols} FROM ${query.tableName} ${query.whereClause} ${orderByFinal}`;
                        console.log('数据查询SQL:', dataSql);

                        return callSqlWithRetry(dataSql);
                    })
                    .then(dataResult => {
                        console.log('数据查询结果:', dataResult);
                        console.log('数据查询结果类型:', typeof dataResult);
                        console.log('数据查询结果keys:', dataResult ? Object.keys(dataResult) : []);
                        console.log('结果数量:', dataResult && dataResult.results ? dataResult.results.length : 0);
                        if (dataResult && dataResult.results && dataResult.results.length > 0) {
                            console.log('第一条数据的字段:', Object.keys(dataResult.results[0]));
                            console.log('第一条数据的完整内容:', dataResult.results[0]);
                        } else {
                            console.warn('数据查询结果为空或格式错误！');
                            console.warn('dataResult:', dataResult);
                            console.warn('dataResult.results:', dataResult ? dataResult.results : 'undefined');
                        }
                        if (dataResult && dataResult.results) {
                            // 根据项目类别过滤列
                            let cleanedResults = dataResult.results;
                            if (query.project === '兴元售货机') {
                                const allowedCols = ['商户名称', '销售额', '货道编号', '商品名称', '支付账号', '支付方式', '支付金额', '出货状态', '退款金额', '支付时间'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '赛菲姆道闸') {
                                const allowedCols = ['车牌号码', '订单类型', '支付金额', '支付时间', '支付方式', '开始时间', '结束时间'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '收钱吧') {
                                const allowedCols = ['交易日期', '收款通道/支付方式', '交易状态', '收款金额'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '智小盟') {
                                console.log('智小盟：原始结果数量:', dataResult.results.length);
                                if (dataResult.results.length > 0) {
                                    console.log('智小盟：第一条数据的字段:', Object.keys(dataResult.results[0]));
                                    console.log('智小盟：第一条数据内容:', dataResult.results[0]);
                                }
                                const allowedCols = ['设备名称', '实收金额 ', '支付方式', '支付时间'];
                                console.log('智小盟：允许的字段:', allowedCols);
                                cleanedResults = dataResult.results.map((row, idx) => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        } else if (idx === 0) {
                                            console.warn(`智小盟：第一条数据缺少字段 "${col}"，可用字段:`, Object.keys(row));
                                        }
                                    });
                                    if (idx === 0 && Object.keys(filtered).length === 0) {
                                        console.error('智小盟：过滤后的第一条数据为空，原始数据:', row);
                                    }
                                    return filtered;
                                });
                                console.log('智小盟：过滤后结果数量:', cleanedResults.length);
                                if (cleanedResults.length > 0) {
                                    console.log('智小盟：过滤后第一条数据:', cleanedResults[0]);
                                }
                            } else if (query.project === '车海洋洗车') {
                                // 车海洋洗车：输出车海洋洗车消费表的所有列，不需要过滤
                                cleanedResults = dataResult.results;
                            } else if (query.project === '微信') {
                                const allowedCols = ['交易时间', '商户号', '微信订单号', '订单金额', '退款金额'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '车颜知己洗车') {
                                const allowedCols = ['场所', '启动时间', '停止时间', '订单金额', '使用会员卡', '订单状态'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            }
                            
                            __lastZhQueryResults = { ...dataResult, results: cleanedResults };
                            __zhPagination.results = cleanedResults;
                            
                            // 根据项目类别计算统计
                            calculateZhStats(query.project, cleanedResults);
                            
                            displayZhQueryResult({ ...dataResult, results: cleanedResults });
                            setZhExportEnabled(true);
                        } else {
                            throw new Error('查询结果格式错误');
                        }
                    })
                    .catch(err => {
                        console.error('查询失败:', err);
                        console.error('查询项目:', query.project);
                        console.error('表名:', query.tableName);
                        console.error('时间字段:', query.timeField);
                        console.error('WHERE条件:', query.whereClause);
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">查询失败: ' + (err.message || '未知错误') + '<br>表名: ' + query.tableName + '<br>时间字段: ' + query.timeField + '<br>请检查表名和字段名是否正确</div>';
                        setZhExportEnabled(false);
                    });
            } catch (err) {
                alert(err.message || '查询参数错误');
            }
        }

        // 计算综合数据统计（根据项目类别）
        async function calculateZhStats(project, rows) {
            __zhStatsTotals = null;
            
            try {
                if (project === '红门缴费') {
                    await calculateHongmenStats();
                } else if (project === '月租车充值') {
                    await calculateYuezucheStats();
                } else if (project === '兴元售货机') {
                    await calculateXingyuanStats();
                } else if (project === '赛菲姆道闸') {
                    await calculateSaifeimuStats();
                } else if (project === '收钱吧') {
                    await calculateShouqianbaStats();
                } else if (project === '智小盟') {
                    await calculateZhixiaomengStats();
                } else if (project === '快易洁洗车') {
                    await calculateKuaijijieStats();
                } else if (project === '车海洋洗车') {
                    await calculateChehaiyangStats();
                } else if (project === '微信') {
                    await calculateWeixinStats();
                } else if (project === '车颜知己洗车') {
                    await calculateCheyanzhijiStats();
                }
            } catch (err) {
                console.error('统计计算失败:', err);
            }
        }

        // 红门缴费统计：按收费场区+支付方式统计交易金额
        async function calculateHongmenStats() {
            const query = buildZhQuery();
            const sql = `SELECT [收费场区], [支付方式], SUM([交易金额]) as 交易金额合计 
                        FROM ${query.tableName} ${query.whereClause} 
                        GROUP BY [收费场区], [支付方式] 
                        ORDER BY [收费场区], [支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {};
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const field = row['收费场区'] || '未知';
                        const payMethod = row['支付方式'] || '未知';
                        const amount = parseFloat(row['交易金额合计'] || 0);
                        
                        if (!stats[field]) {
                            stats[field] = {};
                        }
                        stats[field][payMethod] = amount;
                        totalAmount += amount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                console.error('红门缴费统计失败:', err);
            }
        }

        // 月租车充值统计：按车牌类型（东区、西区、南区）+支付方式统计交款金额
        async function calculateYuezucheStats() {
            const query = buildZhQuery();
            // 先获取所有数据，然后在客户端分组
            const sql = `SELECT [车牌类型], [支付方式], [交款金额] 
                        FROM ${query.tableName} ${query.whereClause}`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {
                        '东区': {},
                        '西区': {},
                        '南区': {}
                    };
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const plateType = row['车牌类型'] || '';
                        const payMethod = row['支付方式'] || '未知';
                        const amount = parseFloat(row['交款金额'] || 0);
                        
                        // 根据车牌类型分类
                        let category = '';
                        if (plateType.includes('东区')) {
                            category = '东区';
                        } else if (plateType.includes('西区')) {
                            category = '西区';
                        } else if (plateType.includes('南区')) {
                            category = '南区';
                        }
                        
                        if (category) {
                            if (!stats[category][payMethod]) {
                                stats[category][payMethod] = 0;
                            }
                            stats[category][payMethod] += amount;
                            totalAmount += amount;
                        }
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                console.error('月租车充值统计失败:', err);
            }
        }

        // 兴元售货机：机器名称自定义分组函数
        function getMachineCategory(machineName) {
            if (!machineName) return machineName || '未知';
            const name = String(machineName);
            // 将"东区"、"东区刷脸机"、"四方坪桥下东区"等包含"东区"的合并为"东区"
            if (name.includes('东区')) {
                return '东区';
            } else if (name.includes('西区')) {
                return '西区';
            } else if (name.includes('南区')) {
                return '南区';
            }
            return name; // 其他保持原名称
        }

        // 兴元售货机统计：按机器名称自定义分组+支付方式统计支付金额和退款金额
        async function calculateXingyuanStats() {
            const query = buildZhQuery();
            const sql = `SELECT [机器名称], [支付方式], 
                        SUM([支付金额]) as 支付金额合计, 
                        SUM([退款金额]) as 退款金额合计
                        FROM ${query.tableName} ${query.whereClause} 
                        GROUP BY [机器名称], [支付方式] 
                        ORDER BY [机器名称], [支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    // 使用自定义分组后的结构：category -> machine -> payMethod -> data
                    const stats = {};
                    let totalPayAmount = 0;
                    let totalRefundAmount = 0;
                    let totalActualAmount = 0;
                    
                    result.results.forEach(row => {
                        const machineName = row['机器名称'] || '未知';
                        const category = getMachineCategory(machineName); // 自定义分组（包含"东区"的都归为"东区"）
                        const payMethod = row['支付方式'] || '未知';
                        const payAmount = parseFloat(row['支付金额合计'] || 0);
                        const refundAmount = parseFloat(row['退款金额合计'] || 0);
                        const actualAmount = payAmount - refundAmount;
                        
                        // 结构：stats[category][payMethod] - 同一category下的所有机器数据合并
                        if (!stats[category]) {
                            stats[category] = {};
                        }
                        if (!stats[category][payMethod]) {
                            stats[category][payMethod] = {
                                payAmount: 0,
                                refundAmount: 0,
                                actualAmount: 0
                            };
                        }
                        // 合并同一category下所有机器的数据
                        stats[category][payMethod].payAmount += payAmount;
                        stats[category][payMethod].refundAmount += refundAmount;
                        stats[category][payMethod].actualAmount += actualAmount;
                        
                        totalPayAmount += payAmount;
                        totalRefundAmount += refundAmount;
                        totalActualAmount += actualAmount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalPayAmount: totalPayAmount,
                        totalRefundAmount: totalRefundAmount,
                        totalActualAmount: totalActualAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                console.error('兴元售货机统计失败:', err);
            }
        }

        // 赛菲姆道闸统计：按支付方式统计支付金额
        async function calculateSaifeimuStats() {
            const query = buildZhQuery();
            const sql = `SELECT [支付方式], SUM([支付金额]) as 支付金额合计 
                        FROM ${query.tableName} ${query.whereClause} 
                        GROUP BY [支付方式] 
                        ORDER BY [支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {};
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const payMethod = row['支付方式'] || '未知';
                        const amount = parseFloat(row['支付金额合计'] || 0);
                        stats[payMethod] = amount;
                        totalAmount += amount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                console.error('赛菲姆道闸统计失败:', err);
            }
        }

        // 收钱吧统计：按收款通道/支付方式统计收款金额
        async function calculateShouqianbaStats() {
            const query = buildZhQuery();
            const sql = `SELECT [收款通道/支付方式], SUM([收款金额]) as 收款金额合计 
                        FROM ${query.tableName} ${query.whereClause} 
                        GROUP BY [收款通道/支付方式] 
                        ORDER BY [收款通道/支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {};
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const channel = row['收款通道/支付方式'] || '未知';
                        const amount = parseFloat(row['收款金额合计'] || 0);
                        stats[channel] = amount;
                        totalAmount += amount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                console.error('收钱吧统计失败:', err);
            }
        }

        // 智小盟统计：统计实收金额汇总
        async function calculateZhixiaomengStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = toSqlDateTime(startInput ? startInput.value : '', false);
            const end = toSqlDateTime(endInput ? endInput.value : '', true);
            
            if (!start || !end) {
                console.error('智小盟统计：缺少时间参数');
                __zhStatsTotals = null;
                updateZhStatsDisplay();
                return;
            }
            
            // 智小盟的时间字段前面可能有制表符，清理后使用字符串比较
            const sql = `SELECT ISNULL(SUM([实收金额 ]), 0) as 实收金额合计 
                        FROM [智小盟] WHERE LTRIM(RTRIM([支付时间])) >= '${start}' AND LTRIM(RTRIM([支付时间])) <= '${end}'`;
            
            try {
                console.log('智小盟统计SQL:', sql);
                const result = await callSqlWithRetry(sql);
                console.log('智小盟统计查询结果:', result);
                
                if (result && result.results && result.results.length > 0) {
                    const totalAmount = parseFloat(result.results[0]['实收金额合计'] || 0);
                    console.log('智小盟统计金额:', totalAmount);
                    
                    __zhStatsTotals = {
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                } else {
                    console.warn('智小盟统计：查询结果为空或格式错误');
                    __zhStatsTotals = {
                        totalAmount: 0
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                console.error('智小盟统计失败:', err);
                console.error('错误详情:', err.message, err.stack);
                __zhStatsTotals = null;
                updateZhStatsDisplay();
            }
        }

        // 车海洋洗车统计：统计消费金额、返还金额、充值金额
        async function calculateChehaiyangStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = startInput.value || startInput.getAttribute('data-value') || '';
            const end = endInput.value || endInput.getAttribute('data-value') || '';
            
            if (!start || !end) {
                console.error('车海洋洗车统计：缺少时间参数');
                return;
            }
            
            // 从"车海洋洗车消费"表统计
            const consumeSql = `SELECT SUM([消费金额]) as 消费金额合计, SUM([返还金额]) as 消费返还金额合计 
                               FROM [车海洋洗车消费] WHERE [时间] >= '${start}' AND [时间] <= '${end}'`;
            
            // 从"车海洋洗车充值"表统计
            const rechargeSql = `SELECT SUM([充值金额]) as 充值金额合计, SUM([返还金额]) as 充值返还金额合计 
                                FROM [车海洋洗车充值] WHERE [时间] >= '${start}' AND [时间] <= '${end}'`;
            
            try {
                const [consumeResult, rechargeResult] = await Promise.all([
                    callSqlWithRetry(consumeSql),
                    callSqlWithRetry(rechargeSql)
                ]);
                
                const consumeAmount = parseFloat(consumeResult.results && consumeResult.results[0] ? (consumeResult.results[0]['消费金额合计'] || 0) : 0);
                const consumeRefund = parseFloat(consumeResult.results && consumeResult.results[0] ? (consumeResult.results[0]['消费返还金额合计'] || 0) : 0);
                const rechargeAmount = parseFloat(rechargeResult.results && rechargeResult.results[0] ? (rechargeResult.results[0]['充值金额合计'] || 0) : 0);
                const rechargeRefund = parseFloat(rechargeResult.results && rechargeResult.results[0] ? (rechargeResult.results[0]['充值返还金额合计'] || 0) : 0);
                const totalRefund = consumeRefund + rechargeRefund;
                
                __zhStatsTotals = {
                    consumeAmount: consumeAmount,
                    consumeRefund: consumeRefund,
                    rechargeAmount: rechargeAmount,
                    rechargeRefund: rechargeRefund,
                    totalRefund: totalRefund
                };
                
                updateZhStatsDisplay();
            } catch (err) {
                console.error('车海洋洗车统计失败:', err);
            }
        }

        // 微信统计：统计微信扫码收入和微信商户下单收入
        async function calculateWeixinStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = toSqlDateTime(startInput ? startInput.value : '', false);
            const end = toSqlDateTime(endInput ? endInput.value : '', true);
            
            if (!start || !end) {
                console.error('微信统计：缺少时间参数');
                __zhStatsTotals = null;
                updateZhStatsDisplay();
                return;
            }
            
            // 从"微信收款商业版"表统计
            // 检查时间参数是否有效
            if (!start || !end || start === 'Invalid Date' || end === 'Invalid Date') {
                console.error('微信统计：时间参数无效', { start, end });
                throw new Error('时间参数无效');
            }
            
            const shangyebanSql = `SELECT ISNULL(SUM(CAST([订单金额] AS FLOAT)), 0) as 订单金额合计, ISNULL(SUM(CAST([退款金额] AS FLOAT)), 0) as 退款金额合计 
                                  FROM [微信收款商业版] WHERE [交易时间] >= '${start}' AND [交易时间] <= '${end}'`;
            
            // 从"微信商户下单"表统计
            const xiadanSql = `SELECT ISNULL(SUM(CAST([订单金额] AS FLOAT)), 0) as 订单金额合计, ISNULL(SUM(CAST([退款金额] AS FLOAT)), 0) as 退款金额合计 
                              FROM [微信商户下单] WHERE [交易时间] >= '${start}' AND [交易时间] <= '${end}'`;
            
            try {
                console.log('微信统计：开始查询，时间范围:', start, '至', end);
                console.log('微信收款商业版SQL:', shangyebanSql);
                console.log('微信商户下单SQL:', xiadanSql);
                
                // 分别执行查询以便单独处理错误
                let shangyebanResult, xiadanResult;
                let shangyebanError = null;
                let xiadanError = null;
                
                try {
                    shangyebanResult = await callSqlWithRetry(shangyebanSql);
                    console.log('微信收款商业版查询结果:', shangyebanResult);
                } catch (err) {
                    console.error('微信收款商业版查询失败:', err);
                    shangyebanError = err;
                    // 设置为空结果
                    shangyebanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                try {
                    xiadanResult = await callSqlWithRetry(xiadanSql);
                    console.log('微信商户下单查询结果:', xiadanResult);
                } catch (err) {
                    console.error('微信商户下单查询失败:', err);
                    xiadanError = err;
                    // 设置为空结果
                    xiadanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                // 如果有错误，记录警告但继续处理
                if (shangyebanError) {
                    console.warn('微信收款商业版查询失败，使用默认值0:', shangyebanError);
                }
                if (xiadanError) {
                    console.warn('微信商户下单查询失败，使用默认值0:', xiadanError);
                }
                
                if (!shangyebanResult || !shangyebanResult.results) {
                    console.error('微信收款商业版查询结果格式错误:', shangyebanResult);
                    shangyebanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                if (!xiadanResult || !xiadanResult.results) {
                    console.error('微信商户下单查询结果格式错误:', xiadanResult);
                    xiadanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                const shangyebanRow = shangyebanResult.results[0] || {};
                const shangyebanOrderAmount = parseFloat(shangyebanRow['订单金额合计'] || 0);
                const shangyebanRefundAmount = parseFloat(shangyebanRow['退款金额合计'] || 0);
                const shangyebanIncome = shangyebanOrderAmount - shangyebanRefundAmount;
                
                const xiadanRow = xiadanResult.results[0] || {};
                const xiadanOrderAmount = parseFloat(xiadanRow['订单金额合计'] || 0);
                const xiadanRefundAmount = parseFloat(xiadanRow['退款金额合计'] || 0);
                const xiadanIncome = xiadanOrderAmount - xiadanRefundAmount;
                
                // 计算微信总收入
                const totalIncome = shangyebanIncome + xiadanIncome;
                
                console.log('微信统计计算结果:', {
                    shangyebanOrderAmount,
                    shangyebanRefundAmount,
                    shangyebanIncome,
                    xiadanOrderAmount,
                    xiadanRefundAmount,
                    xiadanIncome,
                    totalIncome
                });
                
                __zhStatsTotals = {
                    shangyebanOrderAmount: shangyebanOrderAmount,
                    shangyebanRefundAmount: shangyebanRefundAmount,
                    shangyebanIncome: shangyebanIncome,
                    xiadanOrderAmount: xiadanOrderAmount,
                    xiadanRefundAmount: xiadanRefundAmount,
                    xiadanIncome: xiadanIncome,
                    totalIncome: totalIncome
                };
                
                updateZhStatsDisplay();
            } catch (err) {
                console.error('微信统计失败:', err);
                console.error('错误详情:', err.message, err.stack);
                __zhStatsTotals = null;
                updateZhStatsDisplay();
            }
        }

        // 车颜知己洗车统计：按场所统计会员和非会员订单金额
        async function calculateCheyanzhijiStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = toSqlDateTime(startInput ? startInput.value : '', false);
            const end = toSqlDateTime(endInput ? endInput.value : '', true);
            
            if (!start || !end) {
                console.error('车颜知己洗车统计：缺少时间参数');
                __zhStatsTotals = null;
                updateZhStatsDisplay();
                return;
            }
            
            // 查询所有已完成订单的数据
            const sql = `SELECT [场所], [订单金额], [使用会员卡], [订单状态] 
                        FROM [车颜知己洗车] 
                        WHERE [启动时间] >= '${start}' AND [启动时间] <= '${end}' AND [订单状态] = '已完成'`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (!result || !result.results) {
                    console.error('车颜知己洗车统计：查询结果格式错误');
                    __zhStatsTotals = null;
                    updateZhStatsDisplay();
                    return;
                }
                
                // 按场所统计
                const statsByPlace = {};
                let totalMemberAmount = 0;
                let totalNonMemberAmount = 0;
                
                result.results.forEach(row => {
                    const place = row['场所'] || '未知';
                    const useMemberCard = String(row['使用会员卡'] || '').trim();
                    const orderStatus = String(row['订单状态'] || '').trim();
                    const orderAmount = parseFloat(row['订单金额'] || 0);
                    
                    if (orderStatus !== '已完成') {
                        return; // 只统计已完成的订单
                    }
                    
                    if (!statsByPlace[place]) {
                        statsByPlace[place] = {
                            memberCount: 0,      // 会员订单数
                            nonMemberAmount: 0   // 非会员订单金额总和
                        };
                    }
                    
                    if (useMemberCard === '是') {
                        // 会员：统计订单数，每个订单按7元计算
                        statsByPlace[place].memberCount += 1;
                    } else if (useMemberCard === '否') {
                        // 非会员：直接累加订单金额
                        statsByPlace[place].nonMemberAmount += orderAmount;
                    }
                });
                
                // 计算每个场所的会员订单金额（订单数 × 7）
                const stats = {};
                Object.keys(statsByPlace).forEach(place => {
                    const memberAmount = statsByPlace[place].memberCount * 7;
                    const nonMemberAmount = statsByPlace[place].nonMemberAmount;
                    stats[place] = {
                        memberAmount: memberAmount,
                        nonMemberAmount: nonMemberAmount
                    };
                    totalMemberAmount += memberAmount;
                    totalNonMemberAmount += nonMemberAmount;
                });
                
                __zhStatsTotals = {
                    stats: stats,
                    totalMemberAmount: totalMemberAmount,
                    totalNonMemberAmount: totalNonMemberAmount
                };
                
                updateZhStatsDisplay();
            } catch (err) {
                console.error('车颜知己洗车统计失败:', err);
                __zhStatsTotals = null;
                updateZhStatsDisplay();
            }
        }

        // 快易洁洗车统计：按日期统计所有字段汇总
        async function calculateKuaijijieStats() {
            const query = buildZhQuery();
            // 获取所有数值列并统计
            const sql = `SELECT * FROM ${query.tableName} ${query.whereClause}`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    // 统计所有数值字段的总和
                    const stats = {};
                    let totalAmount = 0;
                    
                    // 获取第一行来确定字段
                    if (result.results.length > 0) {
                        const firstRow = result.results[0];
                        const numericFields = Object.keys(firstRow).filter(key => {
                            // 排除"日期"列
                            if (key === '日期') return false;
                            const val = firstRow[key];
                            return val !== null && val !== undefined && !isNaN(parseFloat(val));
                        });
                        
                        // 初始化统计
                        numericFields.forEach(field => {
                            stats[field] = 0;
                        });
                        
                        // 累加所有行
                        result.results.forEach(row => {
                            numericFields.forEach(field => {
                                const val = parseFloat(row[field] || 0);
                                stats[field] += val;
                                if (field.includes('金额') || field.includes('金额') || field.includes('费用') || field.includes('收入')) {
                                    totalAmount += val;
                                }
                            });
                        });
                    }
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                console.error('快易洁洗车统计失败:', err);
            }
        }

        // 更新统计显示
        function updateZhStatsDisplay() {
            const resultContent = document.getElementById('zh-query-result-content');
            if (!resultContent) return;
            
            // 重新显示结果（包含统计）
            if (__lastZhQueryResults) {
                displayZhQueryResult(__lastZhQueryResults);
            }
        }

        // 显示综合数据查询结果
        function displayZhQueryResult(dataResult) {
            const resultContent = document.getElementById('zh-query-result-content');
            if (!resultContent) return;

            const rows = dataResult.results || [];
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            
            let html = '';
            
            // 统计区域
            html += '<div id="zh-stats-container" style="margin-bottom:16px; padding:12px; background:#f8f9fa; border-radius:6px;">';
            if (__zhStatsTotals === null) {
                html += '<div style="color:#666;"><i class="fas fa-spinner fa-spin"></i> 统计计算中...</div>';
            } else {
                html += renderZhStats(project);
            }
            html += '</div>';

            // 数据表格
            if (rows.length === 0) {
                html += '<div style="padding:12px; color:#666;">未查询到数据</div>';
                resultContent.innerHTML = html;
                return;
            }

            // 分页信息
            const currentPage = __zhPagination.currentPage;
            const pageSize = __zhPagination.pageSize;
            const total = __zhPagination.total;
            const totalPages = Math.ceil(total / pageSize);
            
            html += `<div style="margin-bottom:12px; padding:8px; background:#e9ecef; border-radius:4px;">
                <span>共 ${total} 条记录，第 ${currentPage}/${totalPages} 页</span>
                <div style="display:inline-block; margin-left:16px;">
                    <button onclick="zhGoToPage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''} 
                            style="padding:4px 8px; margin:0 4px; border:1px solid #ddd; border-radius:4px; background:#fff; cursor:pointer;">上一页</button>
                    <button onclick="zhGoToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''} 
                            style="padding:4px 8px; margin:0 4px; border:1px solid #ddd; border-radius:4px; background:#fff; cursor:pointer;">下一页</button>
                </div>
            </div>`;

            // 表格
            if (rows.length > 0) {
                const cols = Object.keys(rows[0]);
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px;">';
                html += '<thead><tr style="background:#e9ecef;">';
                cols.forEach(col => {
                    html += `<th style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:600;">${col}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                rows.forEach((row, idx) => {
                    const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                    html += '<tr>';
                    cols.forEach(col => {
                        let val = row[col] !== null && row[col] !== undefined ? row[col] : '';
                        html += `<td style="padding:8px; border:1px solid #ddd; text-align:center; background:${bg};">${val}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }

            resultContent.innerHTML = html;
        }

        // 渲染统计信息
        function renderZhStats(project) {
            if (!__zhStatsTotals) return '<div style="color:#666;">统计计算中...</div>';
            
            let html = '<div style="font-weight:600; margin-bottom:8px; color:#333;">统计汇总</div>';
            
            if (project === '红门缴费') {
                const stats = __zhStatsTotals.stats;
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">收费场区</th><th style="padding:6px; border:1px solid #ddd;">支付方式</th><th style="padding:6px; border:1px solid #ddd;">交易金额</th></tr></thead><tbody>';
                
                // 计算所有支付方式的总金额（用于占比计算）
                const payMethodTotals = {};
                let grandTotal = 0;
                
                // 先遍历一次，计算每个支付方式的总金额
                Object.keys(stats).forEach(field => {
                    const payMethods = stats[field];
                    Object.keys(payMethods).forEach(payMethod => {
                        const amount = payMethods[payMethod];
                        if (!payMethodTotals[payMethod]) {
                            payMethodTotals[payMethod] = 0;
                        }
                        payMethodTotals[payMethod] += amount;
                        grandTotal += amount;
                    });
                });
                
                // 按指定顺序显示车场
                const fieldOrder = ['东区车场', '南区车场', '西区车场'];
                const otherFields = Object.keys(stats).filter(f => !fieldOrder.includes(f)).sort();
                const allFields = fieldOrder.concat(otherFields);
                
                allFields.forEach(field => {
                    if (!stats[field]) return;
                    
                    const payMethods = stats[field];
                    const payMethodKeys = Object.keys(payMethods).sort();
                    const rowCount = payMethodKeys.length;
                    let fieldSubtotal = 0;
                    
                    // 计算该车场的小计
                    payMethodKeys.forEach(payMethod => {
                        fieldSubtotal += payMethods[payMethod];
                    });
                    
                    // 显示该车场的所有支付方式
                    payMethodKeys.forEach((payMethod, idx) => {
                        const amount = payMethods[payMethod];
                        const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                        html += `<tr style="background:${bg};">
                            ${idx === 0 ? `<td rowspan="${rowCount}" style="padding:6px; border:1px solid #ddd; text-align:center; vertical-align:middle; font-weight:600;">${field}</td>` : ''}
                            <td style="padding:6px; border:1px solid #ddd; text-align:center;">${payMethod}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                        </tr>`;
                    });
                    
                    // 显示该车场的小计
                    if (rowCount > 0) {
                        html += `<tr style="background:#fff3cd;">
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;"></td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;">${field}小计</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600;">${fieldSubtotal.toFixed(2)}</td>
                        </tr>`;
                    }
                });
                
                html += '</tbody></table>';
                
                // 显示合计和支付方式汇总及占比（文本格式）
                html += `<div style="margin-top:12px;">`;
                
                // 构建支付方式汇总文本
                const payMethodSummary = Object.keys(payMethodTotals).sort().map(payMethod => {
                    const amount = payMethodTotals[payMethod];
                    const percentage = grandTotal > 0 ? ((amount / grandTotal) * 100).toFixed(2) : '0.00';
                    return `${payMethod} ${amount.toFixed(2)}(${percentage}%)`;
                }).join('   |   ');
                
                html += `<div style="display:flex; justify-content:space-between; align-items:center; font-weight:600;">
                    <span style="color:#007bff; font-size:50%;">${payMethodSummary}</span>
                    <span style="margin-left:auto; padding-left:20px; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</span>
                </div>`;
                html += `</div>`;
                
            } else if (project === '月租车充值') {
                const stats = __zhStatsTotals.stats;
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">车牌类型</th><th style="padding:6px; border:1px solid #ddd;">支付方式</th><th style="padding:6px; border:1px solid #ddd;">交款金额</th></tr></thead><tbody>';
                
                // 计算所有支付方式的总金额（用于占比计算）
                const payMethodTotals = {};
                let grandTotal = 0;
                
                // 先遍历一次，计算每个支付方式的总金额
                Object.keys(stats).forEach(category => {
                    const payMethods = stats[category] || {};
                    Object.keys(payMethods).forEach(payMethod => {
                        const amount = payMethods[payMethod];
                        if (!payMethodTotals[payMethod]) {
                            payMethodTotals[payMethod] = 0;
                        }
                        payMethodTotals[payMethod] += amount;
                        grandTotal += amount;
                    });
                });
                
                // 按指定顺序显示车牌类型
                const categoryOrder = ['东区', '西区', '南区'];
                
                categoryOrder.forEach(category => {
                    if (!stats[category]) return;
                    
                    const payMethods = stats[category] || {};
                    const payMethodKeys = Object.keys(payMethods).filter(pm => payMethods[pm] > 0).sort();
                    const rowCount = payMethodKeys.length;
                    let categorySubtotal = 0;
                    
                    // 计算该车牌类型的小计
                    payMethodKeys.forEach(payMethod => {
                        categorySubtotal += payMethods[payMethod];
                    });
                    
                    // 显示该车牌类型的所有支付方式
                    payMethodKeys.forEach((payMethod, idx) => {
                        const amount = payMethods[payMethod];
                        const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                        html += `<tr style="background:${bg};">
                            ${idx === 0 ? `<td rowspan="${rowCount}" style="padding:6px; border:1px solid #ddd; text-align:center; vertical-align:middle; font-weight:600;">${category}</td>` : ''}
                            <td style="padding:6px; border:1px solid #ddd; text-align:center;">${payMethod}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                        </tr>`;
                    });
                    
                    // 显示该车牌类型的小计
                    if (rowCount > 0) {
                        html += `<tr style="background:#fff3cd;">
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;"></td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;">${category}小计</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600;">${categorySubtotal.toFixed(2)}</td>
                        </tr>`;
                    }
                });
                
                html += '</tbody></table>';
                
                // 显示合计和支付方式汇总及占比（文本格式）
                const payMethodSummary = Object.keys(payMethodTotals).sort().map(payMethod => {
                    const amount = payMethodTotals[payMethod];
                    const percentage = grandTotal > 0 ? ((amount / grandTotal) * 100).toFixed(2) : '0.00';
                    return `${payMethod} ${amount.toFixed(2)}(${percentage}%)`;
                }).join('   |   ');
                
                html += `<div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center; font-weight:600;">
                    <span style="color:#007bff; font-size:50%;">${payMethodSummary}</span>
                    <span style="margin-left:auto; padding-left:20px; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</span>
                </div>`;
                
            } else if (project === '兴元售货机') {
                const stats = __zhStatsTotals.stats;
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px; table-layout:fixed;">';
                html += '<thead><tr style="background:#dee2e6;">';
                html += '<th style="padding:6px; border:1px solid #ddd; width:25%;">机器名称</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:18%;">支付方式</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:19%;">支付金额</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:19%;">退款金额</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:19%;">实际金额</th>';
                html += '</tr></thead><tbody>';
                
                // 先处理自定义分组（东区、西区、南区），然后处理其他
                const categories = ['东区', '西区', '南区'];
                const otherCategories = Object.keys(stats).filter(cat => !categories.includes(cat)).sort();
                const allCategories = categories.concat(otherCategories);
                
                allCategories.forEach(category => {
                    if (!stats[category]) return;
                    
                    const payMethods = stats[category];
                    const payMethodKeys = Object.keys(payMethods).sort();
                    const rowCount = payMethodKeys.length;
                    let categoryPayAmount = 0;
                    let categoryRefundAmount = 0;
                    let categoryActualAmount = 0;
                    
                    // 计算该分组的小计
                    payMethodKeys.forEach(payMethod => {
                        const data = payMethods[payMethod];
                        categoryPayAmount += data.payAmount;
                        categoryRefundAmount += data.refundAmount;
                        categoryActualAmount += data.actualAmount;
                    });
                    
                    // 显示该分组的所有支付方式（只显示category名称，不显示具体机器名称）
                    payMethodKeys.forEach((payMethod, idx) => {
                        const data = payMethods[payMethod];
                        const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                        html += `<tr style="background:${bg};">
                            ${idx === 0 ? `<td rowspan="${rowCount}" style="padding:6px; border:1px solid #ddd; text-align:center; vertical-align:middle; font-weight:600; width:25%;">${category}</td>` : ''}
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; width:18%;">${payMethod}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; width:19%;">${data.payAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; width:19%;">${data.refundAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; width:19%;">${data.actualAmount.toFixed(2)}</td>
                        </tr>`;
                    });
                    
                    // 显示该分组的小计
                    if (rowCount > 0) {
                        html += `<tr style="background:#fff3cd;">
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600; width:25%;"></td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600; width:18%;">${category}小计</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600; width:19%;">${categoryPayAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600; width:19%;">${categoryRefundAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600; width:19%;">${categoryActualAmount.toFixed(2)}</td>
                        </tr>`;
                    }
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:8px; font-weight:600;">
                    <span style="color:#007bff;">支付金额合计: ${__zhStatsTotals.totalPayAmount.toFixed(2)}</span> | 
                    <span style="color:#dc3545;">退款金额合计: ${__zhStatsTotals.totalRefundAmount.toFixed(2)}</span> | 
                    <span style="color:#28a745;">实际金额合计: ${__zhStatsTotals.totalActualAmount.toFixed(2)}</span>
                </div>`;
            } else if (project === '赛菲姆道闸') {
                // 赛菲姆道闸：按支付方式统计
                const stats = __zhStatsTotals.stats || {};
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">支付方式</th><th style="padding:6px; border:1px solid #ddd;">支付金额</th></tr></thead><tbody>';
                
                Object.keys(stats).sort().forEach(payMethod => {
                    const amount = stats[payMethod];
                    html += `<tr style="background:#fff;">
                        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${payMethod}</td>
                        <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</div>`;
            } else if (project === '收钱吧') {
                // 收钱吧：按收款通道/支付方式统计
                const stats = __zhStatsTotals.stats || {};
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">收款通道/支付方式</th><th style="padding:6px; border:1px solid #ddd;">收款金额</th></tr></thead><tbody>';
                
                Object.keys(stats).sort().forEach(channel => {
                    const amount = stats[channel];
                    html += `<tr style="background:#fff;">
                        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${channel}</td>
                        <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</div>`;
            } else if (project === '智小盟') {
                // 智小盟：显示实收金额合计
                html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">实收金额合计: ${(__zhStatsTotals.totalAmount || 0).toFixed(2)}</div>`;
            } else if (project === '快易洁洗车') {
                // 快易洁洗车：显示所有字段汇总
                const stats = __zhStatsTotals.stats || {};
                if (Object.keys(stats).length > 0) {
                    html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                    html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">字段</th><th style="padding:6px; border:1px solid #ddd;">汇总</th></tr></thead><tbody>';
                    
                    Object.keys(stats).sort().forEach(field => {
                        const value = stats[field];
                        // 如果是"返还总额"字段，使用特殊样式
                        if (field === '返还总额') {
                            html += `<tr style="background:#fff;">
                                <td style="padding:6px; border:1px solid #ddd; text-align:center; color:#dc3545; font-size:16px; font-weight:bold;">${field}</td>
                                <td style="padding:6px; border:1px solid #ddd; text-align:right; color:#dc3545; font-size:16px; font-weight:bold;">${parseFloat(value).toFixed(2)}</td>
                            </tr>`;
                        } else {
                        html += `<tr style="background:#fff;">
                            <td style="padding:6px; border:1px solid #ddd; text-align:center;">${field}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${parseFloat(value).toFixed(2)}</td>
                        </tr>`;
                    }
                    });
                    
                    html += '</tbody></table>';
                    if (__zhStatsTotals.totalAmount > 0) {
                        html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">金额合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</div>`;
                    }
                }
            } else if (project === '车海洋洗车') {
                // 车海洋洗车：显示消费金额、消费返还金额、充值金额、充值返还金额、返还总额
                const stats = __zhStatsTotals || {};
                html += `<div style="margin-top:8px; font-size:14px; line-height:1.8;">
                    <div>消费金额：<span style="color:#28a745; font-weight:bold;">${(stats.consumeAmount || 0).toFixed(2)}</span>元</div>
                    <div>消费返还金额：<span style="color:#28a745; font-weight:bold;">${(stats.consumeRefund || 0).toFixed(2)}</span>元</div>
                    <div>充值金额：<span style="color:#28a745; font-weight:bold;">${(stats.rechargeAmount || 0).toFixed(2)}</span>元</div>
                    <div>充值返还金额：<span style="color:#28a745; font-weight:bold;">${(stats.rechargeRefund || 0).toFixed(2)}</span>元</div>
                    <div style="margin-top:6px; padding-top:6px; border-top:1px solid #dee2e6; font-weight:600;">返还总额：<span style="color:#dc3545; font-weight:bold;">${(stats.totalRefund || 0).toFixed(2)}</span>元</div>
                </div>`;
            } else if (project === '微信') {
                // 微信：显示微信扫码收入和微信商户下单收入
                const stats = __zhStatsTotals || {};
                html += `<div style="margin-top:8px; font-size:14px; line-height:1.8;">
                    <div>微信扫码收入：<span style="color:#28a745; font-weight:bold;">${(stats.shangyebanIncome || 0).toFixed(2)}</span>元：订单金额<span style="color:#28a745;">${(stats.shangyebanOrderAmount || 0).toFixed(2)}</span>元   退款金额<span style="color:#dc3545;">${(stats.shangyebanRefundAmount || 0).toFixed(2)}</span>元</div>
                    <div style="margin-top:8px;">微信商户下单收入：<span style="color:#28a745; font-weight:bold;">${(stats.xiadanIncome || 0).toFixed(2)}</span>元：订单金额<span style="color:#28a745;">${(stats.xiadanOrderAmount || 0).toFixed(2)}</span>元   退款金额<span style="color:#dc3545;">${(stats.xiadanRefundAmount || 0).toFixed(2)}</span>元</div>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-weight:600;">微信总收入：<span style="color:#007bff; font-weight:bold;">${(stats.totalIncome || 0).toFixed(2)}</span>元</div>
                </div>`;
            } else if (project === '车颜知己洗车') {
                // 车颜知己洗车：按场所显示会员和非会员订单金额
                const stats = __zhStatsTotals.stats || {};
                html += '<div style="margin-top:8px; font-size:14px; line-height:1.8;">';
                
                // 按场所显示
                Object.keys(stats).sort().forEach(place => {
                    const memberAmount = stats[place].memberAmount || 0;
                    const nonMemberAmount = stats[place].nonMemberAmount || 0;
                    html += `<div>${place}   会员订单金额 <span style="color:#28a745; font-weight:bold;">${memberAmount.toFixed(2)}</span>元   非会员订单金额 <span style="color:#28a745; font-weight:bold;">${nonMemberAmount.toFixed(2)}</span>元</div>`;
                });
                
                // 汇总
                const totalMemberAmount = __zhStatsTotals.totalMemberAmount || 0;
                const totalNonMemberAmount = __zhStatsTotals.totalNonMemberAmount || 0;
                const totalOrderAmount = totalMemberAmount + totalNonMemberAmount;
                html += `<div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-weight:600; display:flex; justify-content:space-between; align-items:center;">
                    <span>会员订单金额小计 <span style="color:#007bff; font-weight:bold;">${totalMemberAmount.toFixed(2)}</span>元    非会员订单金额小计 <span style="color:#007bff; font-weight:bold;">${totalNonMemberAmount.toFixed(2)}</span>元</span>
                    <span style="margin-left:auto; padding-left:20px;">订单金额总计：<span style="color:#28a745; font-weight:bold;">${totalOrderAmount.toFixed(2)}</span>元</span>
                </div>`;
                html += '</div>';
            } else if (!__zhStatsTotals) {
                // 其他项目：暂无统计
                html += '<div style="color:#666;">暂无统计数据</div>';
            }
            
            return html;
        }

        // 综合数据分页
        function zhGoToPage(page) {
            const totalPages = Math.max(1, Math.ceil(__zhPagination.total / __zhPagination.pageSize));
            if (page < 1 || page > totalPages) return;
            
            __zhPagination.currentPage = page;
            const offset = (page - 1) * __zhPagination.pageSize;
            const startRn = offset + 1;
            const endRn = offset + __zhPagination.pageSize;
            
            const tableName = __zhPagination.tableName || '';
            const whereClause = __zhPagination.whereClause || '';
            const timeField = __zhPagination.timeField || '缴费时间';
            
            if (!tableName) {
                console.error('分页失败：表名未设置');
                return;
            }
            
            // 使用 ROW_NUMBER 分页（兼容后端）
            // 根据项目类别设置查询列
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            let selectCols = '*';
            if (project === '兴元售货机') {
                selectCols = '[商户名称], [销售额], [货道编号], [商品名称], [支付账号], [支付方式], [支付金额], [出货状态], [退款金额], [支付时间]';
            } else if (project === '赛菲姆道闸') {
                selectCols = '[车牌号码], [订单类型], [支付金额], [支付时间], [支付方式], [开始时间], [结束时间]';
            } else if (project === '收钱吧') {
                selectCols = '[交易日期], [收款通道/支付方式], [交易状态], [收款金额]';
            } else if (project === '智小盟') {
                selectCols = '[设备名称], [实收金额 ], [支付方式], [支付时间]';
            } else if (project === '车海洋洗车') {
                selectCols = '*'; // 车海洋洗车消费表的所有列
            } else if (project === '微信') {
                selectCols = '[交易时间], [商户号], [微信订单号], [订单金额], [退款金额]';
            } else if (project === '车颜知己洗车') {
                selectCols = '[场所], [启动时间], [停止时间], [订单金额], [使用会员卡], [订单状态]';
            }
            // 快易洁洗车：查询所有列
            
            const innerFrom = `FROM ${tableName} ${whereClause}`;
            // 对于"智小盟"，ORDER BY也需要使用清理后的字段
            let overOrder;
            if (project === '智小盟') {
                overOrder = `ORDER BY LTRIM(RTRIM([${timeField}])) DESC`;
            } else {
                overOrder = `ORDER BY [${timeField}] DESC`;
            }
            // 构建分页SQL：外层选择指定列（排除rn），内层选择所有列包括rn
            let pageSql;
            if (project === '兴元售货机' || project === '赛菲姆道闸' || project === '收钱吧' || project === '智小盟' || project === '车海洋洗车' || project === '微信' || project === '车颜知己洗车') {
                // 指定列的项目：外层选择指定列
                pageSql = `SELECT ${selectCols} FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
            } else {
                // 其他：外层选择所有列（排除rn）
                pageSql = `SELECT * FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
            }
            
            const resultContent = document.getElementById('zh-query-result-content');
            if (resultContent) {
                resultContent.innerHTML = '<div style="padding:12px;"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
            }
            
            callSqlWithRetry(pageSql)
                .then(dataResult => {
                    if (dataResult && dataResult.results) {
                        // 移除ROW_NUMBER列（如果存在）
                        const cleanedResults = dataResult.results.map(row => {
                            const cleaned = { ...row };
                            delete cleaned.rn;
                            // 根据项目类别过滤列
                            if (project === '兴元售货机') {
                                const allowedCols = ['商户名称', '销售额', '货道编号', '商品名称', '支付账号', '支付方式', '支付金额', '出货状态', '退款金额', '支付时间'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '赛菲姆道闸') {
                                const allowedCols = ['车牌号码', '订单类型', '支付金额', '支付时间', '支付方式', '开始时间', '结束时间'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '收钱吧') {
                                const allowedCols = ['交易日期', '收款通道/支付方式', '交易状态', '收款金额'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '智小盟') {
                                const allowedCols = ['设备名称', '实收金额 ', '支付方式', '支付时间'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '车海洋洗车') {
                                // 车海洋洗车：输出所有列，不需要过滤
                                return cleaned;
                            } else if (project === '微信') {
                                const allowedCols = ['交易时间', '商户号', '微信订单号', '订单金额', '退款金额'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '车颜知己洗车') {
                                const allowedCols = ['场所', '启动时间', '停止时间', '订单金额', '使用会员卡', '订单状态'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            }
                            return cleaned;
                        });
                        __zhPagination.results = cleanedResults;
                        const payload = { success: true, results: cleanedResults, rowCount: cleanedResults.length };
                        displayZhQueryResult(payload);
                    } else {
                        throw new Error('查询结果格式错误');
                    }
                })
                .catch(err => {
                    console.error('分页查询失败:', err);
                    if (resultContent) {
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">加载失败: ' + (err.message || '未知错误') + '</div>';
                    }
                });
        }

        // 综合数据导出Excel
        function exportZhToExcel() {
            if (!__lastZhQueryResults || !__lastZhQueryResults.results) {
                alert('没有可导出的数据');
                return;
            }
            
            try {
                const project = (document.getElementById('zh-project-select') || {}).value || '综合数据';
                const rows = __lastZhQueryResults.results;
                const cols = Object.keys(rows[0]);
                
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, project);
                XLSX.writeFile(wb, `${project}查询.xlsx`);
            } catch (e) {
                console.error('导出失败:', e);
                alert('导出失败：' + (e.message || '未知错误'));
            }
        }

        // 设置综合数据导出按钮状态
        function setZhExportEnabled(enabled) {
            const btn = document.getElementById('zh-export-btn');
            if (!btn) return;
            if (enabled) {
                btn.disabled = false;
                btn.style.background = '#007bff';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.background = '#adb5bd';
                btn.style.cursor = 'not-allowed';
            }
        }

        // 初始化综合数据页面
        setTimeout(() => {
            initZhDatetimePickers();
            setZhExportEnabled(false);
            
            // 更新导航函数，确保综合数据页面显示时更新面包屑
            const originalShowZh = window.showZh;
            if (typeof originalShowZh !== 'function') {
                // 如果setupDataQueryPages还没执行，稍后再设置
                setTimeout(() => {
                    const btnZh = document.getElementById('menu-zh-data');
                    if (btnZh) {
                        btnZh.addEventListener('click', function(e) {
                            const breadcrumbLeaf = document.getElementById('breadcrumb-leaf-zh');
                            if (breadcrumbLeaf) breadcrumbLeaf.textContent = '综合数据';
                        });
                    }
                }, 100);
            }
        }, 0);
    </script>
    
    <!-- 版权信息已移除 -->
</body>
</html>