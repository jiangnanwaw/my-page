<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>长沙飞狐智能数据平台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary: #1a73e8;
            --secondary: #0d47a1;
            --accent: #00c853;
            --dark: #0a1929;
            --light: #f5f9ff;
            --gray: #e0e0e0;
            --card-bg: rgba(255, 255, 255, 0.85);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark), #102a43);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://images.unsplash.com/photo-1518770660439-4636190af475?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80') no-repeat center center/cover;
            opacity: 0.05;
            z-index: -1;
        }
        
        /* 登录框样式 */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 41, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .login-box {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 380px;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .login-box h2 {
            margin-bottom: 30px;
            color: var(--dark);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-box h2 i {
            color: var(--primary);
        }
        
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .input-group input {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        
        .login-btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover {
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.4);
        }
        
        .login-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .error-msg {
            color: var(--danger);
            margin-top: 10px;
            min-height: 24px;
            font-size: 14px;
        }
        
        /* 切换链接样式 */
        .toggle-link {
            margin-top: 15px;
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .toggle-link:hover {
            text-decoration: underline;
        }
        
        /* 重置密码模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        .modal-title {
            margin-bottom: 20px;
            text-align: center;
            color: var(--dark);
            font-size: 22px;
        }
        
        /* 主页面布局 */
        #main-container {
            display: none;
            min-height: 100vh;
            flex: 1;
            flex-direction: column;
        }
        
        header {
            position: sticky; /* 添加这行 */
            top: 0; /* 添加这行 */
            z-index: 1000; /* 添加这行 */
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            height: 70px;
            box-sizing: border-box;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo img {
            height: 40px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .time-display {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            background: var(--glass-bg);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        /* 用户信息区域 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--glass-bg);
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .username {
            font-size: 14px;
            font-weight: 500;
        }
        
        .layout {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 70px);
        }
        
        /* 左侧菜单 */
        .sidebar {
             position: sticky; /* 修改这行 */
    top: 70px; /* 添加这行 */
    height: calc(100vh - 70px); /* 添加这行 */
    background: linear-gradient(180deg, var(--dark), #0c1e32);
    padding: 25px 0;
    box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
    overflow-y: auto; /* 确保菜单内容可滚动 */
    width: 250px;
    /* 其他样式保持不变 */
}
        
        .menu-item {
            padding: 15px 30px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            font-size: 16px;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background: rgba(26, 115, 232, 0.2);
            color: white;
            border-left: 4px solid var(--primary);
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
        }
        
        /* 子菜单样式 */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .submenu.expanded {
            max-height: 500px;
        }
        
        .submenu-item {
            padding: 12px 20px 12px 60px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 14px;
            text-decoration: none; /* 添加这行移除下划线 */
        }
        
        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            text-decoration: none; /* 添加这行确保hover时也没有下划线 */
        }
        
        .submenu-item i {
            font-size: 12px;
        }
        
        .submenu .submenu {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .submenu .submenu .submenu-item {
            padding-left: 80px;
        }
        
        .menu-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
        }
        
        .menu-item.expanded .menu-toggle {
            transform: translateY(-50%) rotate(90deg);
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 30px;
            background: #f0f5ff;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 22px;
            margin-bottom: 25px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* 数据查询区域 - 修改部分 */
        .query-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 10px 15px; /* 减少内边距 */
            margin-bottom: 20px; /* 减少下边距 */
            box-shadow: var(--shadow);
            width: 100%; /* 宽度铺满 */
            height: auto; /* 高度自适应 */
        }
        
        .query-form {
            display: flex;
    flex-wrap: nowrap;
    gap: 8px; /* 减少间距 */
    align-items: flex-end; /* 改为底部对齐，确保按钮与输入框底部对齐 */
}
        
        .form-group {
             display: flex;
    flex-direction: column;
    gap: 6px;
    width: 240px; /* 固定宽度，大幅缩短 */
    min-width: 240px; /* 设置最小宽度 */
}
        
        .form-group label {
            font-weight: 500;
            color: #555;
            font-size: 14px; /* 减小字体 */
        }
        
        .form-group input, .form-group select {
            padding: 8px 10px; /* 减小内边距 */
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 14px; /* 减小字体 */
            background: white;
            transition: all 0.3s;
            height: 36px; /* 固定高度 */
            width: 100%; /* 宽度100% */
                    }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            outline: none;
        }
        
        .btn-group {
            display: flex;
    gap: 8px;
    margin-left: auto; /* 推到右侧 */
    padding-bottom: 2px; /* 向下微调 */
}
        
        .query-btn, .export-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px; /* 减小内边距 */
            border-radius: 8px;
            font-size: 14px; /* 减小字体 */
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px; /* 减小间距 */
            height: 36px; /* 固定高度 */
            white-space: nowrap; /* 防止文本换行 */
        }
        
        .export-btn {
            background: var(--success);
        }
        
        .query-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .query-btn:disabled, .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .query-btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .query-btn.loading .spinner {
            display: inline-block;
        }
        
        .query-btn.loading span {
            vertical-align: middle;
        }
        
        .query-info {
            margin-top: 10px; /* 减小上边距 */
            color: #666;
            font-size: 13px; /* 减小字体 */
            padding: 6px; /* 减小内边距 */
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.03);
            border-left: 4px solid var(--accent);
        }
        
        .query-info.error {
            background-color: rgba(220, 53, 69, 0.1);
            border-left-color: var(--danger);
            color: var(--danger);
        }
        
        .query-info.error i {
            color: var(--danger);
        }
        
        .query-info.success {
            background-color: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success);
            color: var(--success);
        }
        
        .query-info.success i {
            color: var(--success);
        }
        
        /* Excel 表格区域 */
        .excel-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .excel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-container {
            /* 确保表格有横向滚动条 */
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px; /* 确保表格不会过窄 */
            /* 移除固定布局，让列宽自适应 */
            table-layout: auto; 
        }
        
        .table-container th {
            background-color: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            padding: 12px 15px;
        }
        
        .table-container th, .table-container td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
            /* 移除最小宽度限制 */
            min-width: 0;
            /* 确保内容完整显示 */
            white-space: normal;
            word-break: break-word;
            line-height: 1.5;
            vertical-align: middle;
            /* 添加最大宽度限制防止内容过长 */
            max-width: 300px;
        }
        
        .table-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .table-container tr:hover {
            background-color: #f1f7ff;
        }
        
        .table-container td:first-child {
            font-weight: bold;
            background-color: #f0f5ff;
        }
        
        .data-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* 综合数据报表样式 */
        .comprehensive-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .comprehensive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* 页脚 */
        footer {
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            margin-top: auto;
            width: 100%;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 900px) {
            .form-group {
        min-width: 120px !important; /* 覆盖媒体查询中的设置 */
        width: 120px !important;
    }
    .btn-group {
        width: auto !important;
        justify-content: flex-start !important;
    }
}
        
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .menu-item span, .submenu-item span {
                display: none;
            }
            .menu-item {
                justify-content: center;
                padding: 20px 0;
            }
            .user-info .username {
                display: none;
            }
            .time-display {
                font-size: 14px;
                padding: 6px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .login-box {
                width: 90%;
                padding: 30px 20px;
            }
            .modal-content {
                width: 90%;
                padding: 20px;
            }
            header {
                padding: 15px 10px;
            }
            .main-content {
                padding: 15px;
            }
        }
        
        /* 图表加载指示器 */
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        .chart-loading i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.5; transform: scale(0.9); }
        }
        
        /* 数据加载指示器 */
        .data-loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary);
            font-size: 16px;
        }
        
        .data-loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .data-type-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* 日期选择器改进 */
        .form-group input[type="month"] {
            cursor: pointer;
            position: relative;
        }
        
        .form-group input[type="month"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
        }
        
        /* 自定义日期选择器容器 */
        .custom-date-picker {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .year-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .year-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 0 8px;
            color: #555;
        }
        
        .year-btn:hover {
            color: var(--primary);
        }
        
        .year-display {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .month-btn {
            padding: 8px 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .month-btn:hover {
            background: #f0f5ff;
            border-color: var(--primary);
        }
        
        .month-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 日期选择器容器 */
        .date-picker-container {
            position: relative;
        }
        
        .custom-picker {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            min-width: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }
        
        /* 功能提示弹窗 */
        .feature-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            text-align: center;
            max-width: 90%;
            width: 400px;
            display: none;
        }
        
        .feature-popup h3 {
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .feature-popup .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #777;
            background: none;
            border: none;
        }
        
        .feature-popup .popup-content {
            margin-bottom: 20px;
            font-size: 18px;
            color: #555;
        }
        
        .feature-popup .confirm-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .feature-popup .confirm-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }

        /* 新增样式 */
        #metrics-container {
            padding: 30px;
            background: #f0f5ff;
        }

        .metrics-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .metrics-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            flex: 1;
            min-width: 300px;
        }

        .metric-card-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            /* 移除了下面的横线 */
    /* border-bottom: 2px solid var(--primary); */
        }

        .metric-card-title i {
            color: var(--primary);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        /* 综合收入数据显示在一行 */
        .income-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .metric-item {
            padding: 15px;
            border-radius: 8px;
            background: rgba(26, 115, 232, 0.05);
            text-align: center;
            transition: all 0.3s;
        }

        .metric-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
            white-space: nowrap;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }

        .chart-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--primary);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        .chart-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .chart-action-btn {
            padding: 8px 15px;
            background: #f0f5ff;
            border: 1px solid var(--primary);
            border-radius: 6px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .chart-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        #report-section {
            padding-top: 50px;
        }
        
        /* 数据加载动画 */
        .data-loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: var(--primary);
        }
        
        .data-loading-indicator i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- 登录容器 -->
    <div id="login-container">
        <div class="login-box">
            <!-- 登录表单 -->
            <div id="login-form">
                <h2><i class="fas fa-charging-station"></i> 飞狐数据平台登录</h2>
                <div class="input-group">
                    <i class="fas fa-mobile-alt"></i>
                    <input type="tel" id="login-phone" placeholder="请输入手机号" autocomplete="off">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-password" placeholder="请输入密码">
                </div>
                <button class="login-btn" id="login-btn">登录系统</button>
                <div class="toggle-link" id="show-reset">忘记密码？</div>
                <div class="toggle-link" id="show-register">注册新账号</div>
                <div class="error-msg" id="login-error-msg"></div>
            </div>
            
            <!-- 注册表单 -->
            <div id="register-form" style="display: none;">
                <h2><i class="fas fa-user-plus"></i> 用户注册</h2>
                <div class="input-group">
                    <i class="fas fa-mobile-alt"></i>
                    <input type="tel" id="register-phone" placeholder="请输入手机号" autocomplete="off">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="register-password" placeholder="设置密码">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="register-confirm" placeholder="确认密码">
                </div>
                <button class="login-btn" id="register-btn">注册账号</button>
                <div class="toggle-link" id="back-to-login">返回登录</div>
                <div class="error-msg" id="register-error-msg"></div>
            </div>
        </div>
    </div>
    
    <!-- 重置密码模态框 -->
    <div class="modal" id="reset-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h3 class="modal-title"><i class="fas fa-key"></i> 重置密码</h3>
            <div class="input-group">
                <i class="fas fa-mobile-alt"></i>
                <input type="tel" id="reset-phone" placeholder="请输入手机号" autocomplete="off">
            </div>
            <div class="input-group">
                <i class="fas fa-shield-alt"></i>
                <input type="text" id="last-four" placeholder="手机号后四位" maxlength="4">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="reset-password" placeholder="设置新密码">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="reset-confirm" placeholder="确认新密码">
            </div>
            <button class="login-btn" id="reset-btn">重置密码</button>
            <div class="error-msg" id="reset-error-msg"></div>
        </div>
    </div>
    
    <!-- 功能提示弹窗 -->
    <div class="feature-popup" id="feature-popup">
        <button class="close-btn" id="close-popup"><i class="fas fa-times"></i></button>
        <h3><i class="fas fa-exclamation-triangle"></i> 功能提示</h3>
        <div class="popup-content" id="popup-content">
            此功能暂未开放
        </div>
        <button class="confirm-btn" id="confirm-popup">确定</button>
    </div>

    <!-- 主页面容器 -->
    <div id="main-container">
        <header>
            <div class="logo">
                <i class="fas fa-bolt"></i>
                <h1>长沙飞狐智能数据平台</h1>
            </div>
            <div class="user-info">
                <img src="https://jiangnanwaw.github.io/my-page/photo/fhlogo.png" alt="用户头像" class="user-avatar">
                <span class="username" id="user-display">admin</span>
            </div>
            <div class="time-display" id="time-display">
                2025年08月05日 星期二 10:30:45
            </div>
        </header>
        
        <div class="layout">
            <!-- 左侧菜单 -->
            <div class="sidebar">
                <div class="menu-item active">
                    <i class="fas fa-home"></i>
                    <span>平台首页</span>
                </div>
                
                <!-- BI数据分析（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>BI数据分析</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://www.csfhcdz.cn/bi/cdbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-bolt"></i>
                        <span>充电数据可视化</span>
                    </a>
                    <a href="https://www.csfhcdz.cn/bi/zhbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>综合数据可视化</span>
                    </a>
                </div>
                
                <!-- 场站基本情况（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>场站基本情况</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <!-- 四方坪站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>四方坪站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <!-- 监控（带子菜单） -->
                        <div class="menu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                            <i class="fas fa-chevron-right menu-toggle"></i>
                        </div>
                        <div class="submenu">
                            <a href="http://wawtf.eicp.net:50000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>东区</span>
                            </a>
                            <a href="http://wawtf.eicp.net:7000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>南区</span>
                            </a>
                            <a href="http://wawtf.eicp.net:9000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>西区</span>
                            </a>
                        </div>
                        <a href="https://cloud.wlyk.com/" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                    
                    <!-- 高岭站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>高岭站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <a href="http://wawwt.eicp.net:1428" target="_blank" class="submenu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                        </a>
                        <a href="https://psp.hikparking.com/#/login" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                </div>
                
                <!-- 充电桩管理（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-car-battery"></i>
                    <span>充电桩管理</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://cloud.teld.cn/web/login?locale=zh-CN" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>特来电</span>
                    </a>
                    <a href="https://auth.digipowercloud.huawei.com/dpcloud/index.html#/login" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>华为</span>
                    </a>
                </div>
                
                <!--  资料文件（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-building"></i>
                    <span>资料文件</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="ftp://wawtf.eicp.net/" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>相关合同</span>
                    </a>
                   <a href="https://www.csfhcdz.cn/bi/qt.html" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>其它资料</span>
                    </a>
                </div>

                <!-- 其他菜单项 -->
                
                <div class="menu-item" id="finance-management">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>财务管理</span>
                </div>
                <div class="menu-item" id="system-settings">
                    <i class="fas fa-cogs"></i>
                    <span>系统设置</span>
                </div>
                <div class="menu-item" id="history-menu">
                    <i class="fas fa-history"></i>
                    <span>历史记录</span>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="main-content">
                <!-- 查询板块 -->
                <div class="query-section">
                    <h2 class="section-title"><i class="fas fa-search"></i> 数据查询</h2>
                    <div class="query-form">
                        <div class="form-group date-picker-container">
                           <label for="start-date">开始日期</label>
        <input type="text" id="start-date" placeholder="选择开始日期" readonly>
        <div class="custom-picker" id="start-date-picker">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button class="year-btn prev-year"><i class="fas fa-chevron-left"></i></button>
                                            <div class="year-display" id="start-year-display">2025</div>
                                            <button class="year-btn next-year"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="start-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group date-picker-container">
                             <label for="end-date">结束日期</label>
        <input type="text" id="end-date" placeholder="选择结束日期" readonly>
        <div class="custom-picker" id="end-date-picker">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button class="year-btn prev-year"><i class="fas fa-chevron-left"></i></button>
                                            <div class="year-display" id="end-year-display">2025</div>
                                            <button class="year-btn next-year"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="end-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group data-type-select">
                            <label for="data-type">数据类型</label>
        <select id="data-type">
            <option value="charging">充电数据</option>
            <option value="comprehensive">综合数据</option>
        </select>
    </div>
                        
                        <div class="btn-group">
                           <button class="query-btn" id="query-btn">
            <span class="spinner"></span>
            <i class="fas fa-search"></i>
            <span>查询数据</span>
        </button>
        <button class="export-btn" id="export-btn" disabled>
            <i class="fas fa-file-excel"></i>
            <span>导出Excel</span>
        </button>
    </div>
</div>
                    <div class="query-info" id="query-info">
                        <i class="fas fa-info-circle"></i> 
                        请选择日期和数据类型来查询数据
                    </div>
                </div>
                <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-charging-station"></i> 充电数据</h2>
                <!-- 充电数据指标板块 -->
                <div class="metrics-section">
                    <div class="metrics-row">
                        <div class="metric-card">
                            <div class="metric-card-title">
                                <i class="fas fa-calendar-check"></i>
                                本月充电数据
                            </div>
                            <div class="metric-grid">
                                <div class="metric-item">
                                    <div class="metric-value" id="month-charge">205,673.95  kwh</div>
                                    <div class="metric-label">总充电量</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="month-electricity">¥177,408.03</div>
                                    <div class="metric-label">总充电收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="month-service">¥64,784.97</div>
                                    <div class="metric-label">总服务费收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="month-orders">8,222</div>
                                    <div class="metric-label">总订单数量</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-card-title">
                                <i class="fas fa-calendar-alt"></i>
                                本年度充电数据
                            </div>
                            <div class="metric-grid">
                                <div class="metric-item">
                                    <div class="metric-value" id="year-charge">3,395,628.58 kwh</div>
                                    <div class="metric-label">总充电量</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="year-electricity">¥2,878,714.66</div>
                                    <div class="metric-label">总充电收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="year-service">¥963,642.56</div>
                                    <div class="metric-label">总服务费收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="year-orders">130,688</div>
                                    <div class="metric-label">总订单数量</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-card-title">
                                <i class="fas fa-chart-line"></i>
                                累计充电数据
                            </div>
                            <div class="metric-grid">
                                <div class="metric-item">
                                    <div class="metric-value" id="total-charge">32,051,447.86 kwh</div>
                                    <div class="metric-label">总充电量</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="total-electricity">¥30,318,139.69</div>
                                    <div class="metric-label">总充电收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="total-service">¥11,305,282.54</div>
                                    <div class="metric-label">总服务费收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="total-orders">1,235,906</div>
                                    <div class="metric-label">总订单数量</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 充电数据图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            充电数据趋势 (2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="charging-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                    
                    <!-- 充电数据总趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            充电数据总趋势 (2018-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="charging-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-chart-line"></i> 综合业务数据</h2>
                <!-- 综合数据板块 -->
                <div class="metrics-section">
                    <div class="metrics-row">
                        <div class="metric-card">
                            <div class="metric-card-title">
                                <i class="fas fa-money-bill-wave"></i>
                                综合收入数据
                            </div>
                            <!-- 修改为三列布局 -->
                            <div class="income-grid">
                                <div class="metric-item">
                                    <div class="metric-value" id="month-income">¥43,435.85</div>
                                    <div class="metric-label">本月总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="year-income">¥375,153.84</div>
                                    <div class="metric-label">本年度总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="total-income">¥2,564,822.21</div>
                                    <div class="metric-label">累计总收入</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 综合数据图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            综合收入趋势 (2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="income-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                    
                    <!-- 各版块收入汇总图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            各版块收入汇总 (2023-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenue-by-sector-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                    
                    <!-- 年度总收入趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            年度总收入趋势 (2018-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="annual-revenue-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-table"></i> 数据报表</h2>
                <!-- Excel 表格区域 -->
                <div class="excel-section" id="report-section">
                    <div class="excel-header">
                        <h3 class="metric-section-title"><i class="fas fa-table"></i> 充电数据报表</h3>
                        <div id="file-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="data-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="table-container">
                        <!-- Excel表格将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>场站名称</th>
                                    <th>充电量(kwh)</th>
                                    <th>服务车辆(辆)</th>
                                    <th>收入(元)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-07-01</td>
                                    <td>四方坪站</td>
                                    <td>1,250</td>
                                    <td>85</td>
                                    <td>2,345.50</td>
                                </tr>
                                <tr>
                                    <td>2025-07-01</td>
                                    <td>高岭站</td>
                                    <td>980</td>
                                    <td>62</td>
                                    <td>1,845.20</td>
                                </tr>
                                <tr>
                                    <td>2025-07-02</td>
                                    <td>四方坪站</td>
                                    <td>1,340</td>
                                    <td>92</td>
                                    <td>2,520.80</td>
                                </tr>
                                <tr>
                                    <td>2025-07-02</td>
                                    <td>高岭站</td>
                                    <td>1,120</td>
                                    <td>75</td>
                                    <td>2,112.40</td>
                                </tr>
                                <tr>
                                    <td>2025-07-03</td>
                                    <td>四方坪站</td>
                                    <td>1,450</td>
                                    <td>98</td>
                                    <td>2,730.60</td>
                                </tr>
                                <tr>
                                    <td>2025-07-03</td>
                                    <td>高岭站</td>
                                    <td>1,050</td>
                                    <td>70</td>
                                    <td>1,980.20</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="row-count">共加载 6 行数据</div>
                        <div id="last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>
                
                <!-- 综合数据报表 -->
                <div class="comprehensive-section">
                    <div class="comprehensive-header">
                        <h3 class="metric-section-title"><i class="fas fa-chart-pie"></i> 综合数据报表</h3>
                        <div id="comprehensive-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="comprehensive-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载综合数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="comprehensive-table-container">
                        <!-- 综合数据报表将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th>四方坪站</th>
                                    <th>高岭站</th>
                                    <th>合计</th>
                                    <th>同比增长</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>充电量(kwh)</td>
                                    <td>42,580</td>
                                    <td>32,150</td>
                                    <td>74,730</td>
                                    <td>+12.5%</td>
                                </tr>
                                <tr>
                                    <td>服务车辆(辆)</td>
                                    <td>2,850</td>
                                    <td>2,150</td>
                                    <td>5,000</td>
                                    <td>+8.3%</td>
                                </tr>
                                <tr>
                                    <td>总收入(元)</td>
                                    <td>80,240.50</td>
                                    <td>60,520.80</td>
                                    <td>140,761.30</td>
                                    <td>+15.2%</td>
                                </tr>
                                <tr>
                                    <td>设备利用率</td>
                                    <td>78.4%</td>
                                    <td>65.2%</td>
                                    <td>71.8%</td>
                                    <td>+5.3%</td>
                                </tr>
                                <tr>
                                    <td>平均充电时长</td>
                                    <td>45分钟</td>
                                    <td>52分钟</td>
                                    <td>48.5分钟</td>
                                    <td>-2.1%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="comprehensive-row-count">共加载 5 行数据</div>
                        <div id="comprehensive-last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer>
            © 2025 长沙飞狐电动汽车充电服务有限公司 | 新能源充电站数据管理平台
        </footer>
    </div>

    <script>
        // 允许登录的手机号列表
        const allowedPhones = ['15616000858', '18773731318'];
        
        // 登录验证逻辑
        const loginContainer = document.getElementById('login-container');
        const mainContainer = document.getElementById('main-container');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const resetBtn = document.getElementById('reset-btn');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const resetModal = document.getElementById('reset-modal');
        const loginErrorMsg = document.getElementById('login-error-msg');
        const registerErrorMsg = document.getElementById('register-error-msg');
        const resetErrorMsg = document.getElementById('reset-error-msg');
        const userDisplay = document.getElementById('user-display');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dataTypeSelect = document.getElementById('data-type');
        const queryBtn = document.getElementById('query-btn');
        const exportBtn = document.getElementById('export-btn');
        const queryInfo = document.getElementById('query-info');
        const tableContainer = document.getElementById('table-container');
        const dataLoading = document.getElementById('data-loading');
        const fileInfo = document.getElementById('file-info');
        const rowCount = document.getElementById('row-count');
        const lastUpdate = document.getElementById('last-update');
        
        // 综合数据报表元素
        const comprehensiveTableContainer = document.getElementById('comprehensive-table-container');
        const comprehensiveLoading = document.getElementById('comprehensive-loading');
        const comprehensiveInfo = document.getElementById('comprehensive-info');
        const comprehensiveRowCount = document.getElementById('comprehensive-row-count');
        const comprehensiveLastUpdate = document.getElementById('comprehensive-last-update');
        
        // 功能提示弹窗元素
        const featurePopup = document.getElementById('feature-popup');
        const closePopup = document.getElementById('close-popup');
        const confirmPopup = document.getElementById('confirm-popup');
        const popupContent = document.getElementById('popup-content');
        
        // 当前加载的Excel数据
        let currentExcelData = null;
        let currentFileName = '';
        let currentDataType = 'charging';
        let defaultChargingData = null;
        let defaultComprehensiveData = null;
        let defaultChargingFileName = '';
        let defaultComprehensiveFileName = '';
        
        // 导出相关变量
        let currentExportData = null;
        let currentExportFileName = '';
        let currentExportDataType = '';
        
        // 自定义日期选择器变量
        let startYear = 2025;
        let startMonth = null;
        let endYear = 2025;
        let endMonth = null;
        
        // 用户账户存储
        let userAccounts = JSON.parse(localStorage.getItem('userAccounts')) || {};
        
        // 图表实例
        let chargingChart = null;
        let incomeChart = null;
        let chargingTrendChart = null;
        let revenueBySectorChart = null;
        let annualRevenueTrendChart = null;
        
        // GitHub数据文件URL
        const metricsDataUrl = 'https://www.csfhcdz.cn/data/homepage.xlsx';
        
        // 显示功能提示弹窗
        function showFeaturePopup(message) {
            popupContent.textContent = message;
            featurePopup.style.display = 'block';
        }
        
        // 关闭功能提示弹窗
        function closeFeaturePopup() {
            featurePopup.style.display = 'none';
        }
        
        // 调整工作表范围以仅包含有数据的部分
        function adjustSheetRange(worksheet) {
            if (!worksheet['!ref']) return;
            
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            let minRow = range.s.r;
            let maxRow = range.e.r;
            let minCol = range.s.c;
            let maxCol = range.e.c;
            
            let firstRow = maxRow;
            let lastRow = minRow;
            let firstCol = maxCol;
            let lastCol = minCol;
            
            // 遍历工作表中所有的单元格地址
            Object.keys(worksheet).forEach(address => {
                if (address[0] !== '!') { // 跳过特殊属性
                    const cellAddress = XLSX.utils.decode_cell(address);
                    // 更新实际有数据的行和列范围
                    if (cellAddress.r < firstRow) firstRow = cellAddress.r;
                    if (cellAddress.r > lastRow) lastRow = cellAddress.r;
                    if (cellAddress.c < firstCol) firstCol = cellAddress.c;
                    if (cellAddress.c > lastCol) lastCol = cellAddress.c;
                }
            });
            
            // 如果找到了有效的数据范围，则更新worksheet的!ref
            if (firstRow <= lastRow && firstCol <= lastCol) {
                const newRange = { s: { r: firstRow, c: firstCol }, e: { r: lastRow, c: lastCol } };
                worksheet['!ref'] = XLSX.utils.encode_range(newRange);
            }
        }
        
        // 初始化自定义日期选择器
        function initCustomDatePickers() {
            const now = new Date();
            startYear = now.getFullYear();
            endYear = now.getFullYear();
            
            // 生成月份网格
            const months = ['一月', '二月', '三月', '四月', '五月', '六月', 
                            '七月', '八月', '九月', '十月', '十一月', '十二月'];
            
            const startMonthGrid = document.getElementById('start-month-grid');
            const endMonthGrid = document.getElementById('end-month-grid');
            
            months.forEach((month, index) => {
                const startBtn = document.createElement('button');
                startBtn.className = 'month-btn';
                startBtn.textContent = month;
                startBtn.dataset.month = index + 1;
                startBtn.addEventListener('click', function() {
                    selectMonth('start', index + 1);
                });
                startMonthGrid.appendChild(startBtn);
                
                const endBtn = document.createElement('button');
                endBtn.className = 'month-btn';
                endBtn.textContent = month;
                endBtn.dataset.month = index + 1;
                endBtn.addEventListener('click', function() {
                    selectMonth('end', index + 1);
                });
                endMonthGrid.appendChild(endBtn);
            });
            
            // 设置年份显示
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            // 年份控制按钮事件
            document.querySelectorAll('#start-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear--;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#start-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear++;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear--;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear++;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            // 点击外部关闭日期选择器
            document.addEventListener('click', function(e) {
                const startPicker = document.getElementById('start-date-picker');
                const endPicker = document.getElementById('end-date-picker');
                
                if (!e.target.closest('.date-picker-container')) {
                    startPicker.style.display = 'none';
                    endPicker.style.display = 'none';
                }
            });
            
            // 日期输入框点击事件
            startDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('start-date-picker');
                picker.style.display = 'block';
                document.getElementById('end-date-picker').style.display = 'none';
            });
            
            endDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('end-date-picker');
                picker.style.display = 'block';
                document.getElementById('start-date-picker').style.display = 'none';
            });
        }
        
        // 选择月份
        function selectMonth(type, month) {
            const year = type === 'start' ? startYear : endYear;
            const formattedMonth = month.toString().padStart(2, '0');
            const dateString = `${year}-${formattedMonth}`;
            
            if (type === 'start') {
                startMonth = month;
                startDateInput.value = dateString;
                document.getElementById('start-date-picker').style.display = 'none';
                
                // 清除结束日期选择状态
                document.querySelectorAll('#end-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            } else {
                endMonth = month;
                endDateInput.value = dateString;
                document.getElementById('end-date-picker').style.display = 'none';
                
                // 清除开始日期选择状态
                document.querySelectorAll('#start-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }
            
            // 设置选中状态
            document.querySelectorAll(`#${type}-month-grid .month-btn`).forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.month) === month) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // 初始化日期选择器
        function initDatePickers() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            
            // 设置默认值为上个月
            if (month === 0) {
                year--;
                month = 11;
            } else {
                month--;
            }
            
            const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            
            startDateInput.value = defaultDate;
            endDateInput.value = defaultDate;
            
            // 设置自定义选择器状态
            startYear = year;
            endYear = year;
            startMonth = month + 1;
            endMonth = month + 1;
            
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            document.querySelectorAll(`#start-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === startMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            document.querySelectorAll(`#end-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === endMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            defaultChargingFileName = generateFileName(defaultDate, defaultDate);
            defaultComprehensiveFileName = generateFileName(defaultDate, defaultDate);
        }
        
        // 格式化月份显示
        function formatMonthDisplay(dateStr) {
            const [year, month] = dateStr.split('-');
            return `${year}年${parseInt(month)}月`;
        }
        
        // 生成文件名
        function generateFileName(startDate, endDate) {
            const start = startDate.replace('-', '');
            const end = endDate.replace('-', '');
            return `${start}-${end}.xlsx`;
        }
        
        // 生成文件路径
        function generateFilePath(fileName, dataType) {
            const basePath = dataType === 'charging' 
                ? 'https://www.csfhcdz.cn/chargingdata/' 
                : 'https://www.csfhcdz.cn/comprehensivedata/';
            return `${basePath}${fileName}`;
        }
        
        // 加载并显示Excel数据
        function loadExcelData(filePath, fileName, dataType, isUserQuery = false) {
            const isCharging = dataType === 'charging';
            const loadingElement = isCharging ? dataLoading : comprehensiveLoading;
            const tableElement = isCharging ? tableContainer : comprehensiveTableContainer;
            const infoElement = isCharging ? fileInfo : comprehensiveInfo;
            const rowCountElement = isCharging ? rowCount : comprehensiveRowCount;
            const lastUpdateElement = isCharging ? lastUpdate : comprehensiveLastUpdate;
            
            loadingElement.style.display = 'block';
            
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('文件未找到');
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 调整工作表范围以仅包含有数据的部分
                    adjustSheetRange(worksheet);
                    
                    // 转换为HTML表格
                    const html = XLSX.utils.sheet_to_html(worksheet, {
                        id: 'excel-table',
                        header: '',
                        footer: ''
                    });
                    
                    tableElement.innerHTML = html;
                    
                    // 添加表格样式
                    const tableEl = tableElement.querySelector('table');
                    if (tableEl) {
                        tableEl.classList.add('excel-table');
                        // 确保表格宽度适应内容
                        tableEl.style.width = 'auto';
                        // 修复列宽问题
                        tableEl.style.tableLayout = 'auto';
                        
                        // 确保单元格内容正确显示
                        const cells = tableEl.querySelectorAll('td, th');
                        cells.forEach(cell => {
                            cell.style.whiteSpace = 'normal';
                            cell.style.wordBreak = 'break-word';
                            cell.style.lineHeight = '1.5';
                            cell.style.verticalAlign = 'middle';
                        });
                    }
                    
                    // 如果是用户查询，设置导出数据
                    if (isUserQuery) {
                        currentExportData = data;
                        currentExportFileName = fileName;
                        currentExportDataType = dataType;
                        exportBtn.disabled = false;
                    }
                    
                    // 更新文件信息
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    infoElement.textContent = `当前显示: ${formatMonthDisplay(startDate)}至${formatMonthDisplay(endDate)}数据`;
                    
                    // 更新行数
                    const table = tableElement.querySelector('table');
                    const rowCountValue = table.rows.length - 1; // 减去表头
                    rowCountElement.textContent = `共加载 ${rowCountValue} 行数据`;
                    
                    // 更新最后更新时间
                    const now = new Date();
                    lastUpdateElement.textContent = `最后更新时间: ${now.toLocaleString()}`;
                    
                    // 显示成功信息
                    queryInfo.innerHTML = `<i class="fas fa-check-circle"></i> 成功加载 ${fileName} 数据`;
                    queryInfo.className = 'query-info success';
                    
                    // 保存为默认数据
                    if (isCharging) {
                        defaultChargingData = data;
                    } else {
                        defaultComprehensiveData = data;
                    }

                    // 只有在用户查询时才滚动到报表区域
                    if (isUserQuery) {
                        document.getElementById('report-section').scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                })
                .catch(error => {
                    console.error('加载Excel文件失败:', error);
                    
                    // 显示具体日期范围的错误信息
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 没有找到${startDate}至${endDate}之间的数据`;
                    queryInfo.className = 'query-info error';
                    
                    // 15秒后恢复默认提示
                    setTimeout(() => {
                        queryInfo.innerHTML = '<i class="fas fa-info-circle"></i> 请选择日期和数据类型来查询数据';
                        queryInfo.className = 'query-info';
                    }, 15000);
                    
                    // 如果是用户查询，重置导出数据
                    if (isUserQuery) {
                        currentExportData = null;
                        exportBtn.disabled = true;
                    }
                    
                    // 恢复默认数据
                    if (isCharging && defaultChargingData) {
                        renderExcelFromData(defaultChargingData, tableContainer);
                        fileInfo.textContent = `当前显示: ${defaultChargingFileName.replace('.xlsx', '')}数据`;
                        const table = tableContainer.querySelector('table');
                        const rowCountValue = table.rows.length - 1;
                        rowCount.textContent = `共加载 ${rowCountValue} 行数据`;
                        lastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                    } else if (!isCharging && defaultComprehensiveData) {
                        renderExcelFromData(defaultComprehensiveData, comprehensiveTableContainer);
                        comprehensiveInfo.textContent = `当前显示: ${defaultComprehensiveFileName.replace('.xlsx', '')}数据`;
                        const table = comprehensiveTableContainer.querySelector('table');
                        const rowCountValue = table.rows.length - 1;
                        comprehensiveRowCount.textContent = `共加载 ${rowCountValue} 行数据`;
                        comprehensiveLastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                    }
                })
                .finally(() => {
                    loadingElement.style.display = 'none';
                    queryBtn.classList.remove('loading');
                });
        }
        
        // 从数据渲染Excel表格
        function renderExcelFromData(data, container) {
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 调整工作表范围以仅包含有数据的部分
            adjustSheetRange(worksheet);
            
            const html = XLSX.utils.sheet_to_html(worksheet, {
                id: 'excel-table',
                header: '',
                footer: ''
            });
            
            container.innerHTML = html;
            
            const tableEl = container.querySelector('table');
            if (tableEl) {
                tableEl.classList.add('excel-table');
                tableEl.style.width = 'auto';
                tableEl.style.tableLayout = 'auto';
                
                // 确保单元格内容正确显示
                const cells = tableEl.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.whiteSpace = 'normal';
                    cell.style.wordBreak = 'break-word';
                    cell.style.lineHeight = '1.5';
                    cell.style.verticalAlign = 'middle';
                });
            }
        }
        
        // 加载默认数据
        function loadDefaultData() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            
            // 设置默认值为上个月
            if (month === 0) {
                year--;
                month = 11;
            } else {
                month--;
            }
            
            const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            const chargingFileName = generateFileName(defaultDate, defaultDate);
            const chargingFilePath = generateFilePath(chargingFileName, 'charging');
            
            // 加载默认充电数据
            loadExcelData(chargingFilePath, chargingFileName, 'charging');
            
            // 加载默认综合数据
            const comprehensiveFileName = generateFileName(defaultDate, defaultDate);
            const comprehensiveFilePath = generateFilePath(comprehensiveFileName, 'comprehensive');
            loadExcelData(comprehensiveFilePath, comprehensiveFileName, 'comprehensive');
        }
        
        // 导出Excel文件
        function exportExcel() {
            if (!currentExportData) {
                alert('没有查询数据导出');
                return;
            }
            
            const blob = new Blob([currentExportData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = currentExportFileName;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // 查询按钮点击事件
        queryBtn.addEventListener('click', function() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const dataType = dataTypeSelect.value;
            
            if (!startDate || !endDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 请选择开始日期和结束日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 检查结束日期是否小于开始日期
            if (endDate < startDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 结束日期不能早于开始日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 显示加载状态
            this.classList.add('loading');
            
            const fileName = generateFileName(startDate, endDate);
            const filePath = generateFilePath(fileName, dataType);
            
            // 设置当前数据类型
            currentDataType = dataType;
            
            // 加载Excel数据 (标记为用户查询)
            loadExcelData(filePath, fileName, dataType, true);
        });
        
        // 导出按钮点击事件
        exportBtn.addEventListener('click', exportExcel);
        
        // 菜单项点击事件
        document.querySelectorAll('.menu-item').forEach(item => {
            const submenu = item.nextElementSibling;
            if (!submenu || !submenu.classList.contains('submenu')) {
                item.addEventListener('click', function() {
                    if (this !== document.querySelector('.menu-item.active')) {
                        document.querySelector('.menu-item.active').classList.remove('active');
                        this.classList.add('active');
                    }
                });
            }
            
            const toggle = item.querySelector('.menu-toggle');
            if (toggle) {
                item.addEventListener('click', function(e) {
                    if (e.target !== toggle && !toggle.contains(e.target)) {
                        const submenu = this.nextElementSibling;
                        if (submenu && submenu.classList.contains('submenu')) {
                            this.classList.toggle('expanded');
                            submenu.classList.toggle('expanded');
                        }
                    }
                });
            }
        });
        
        // 为特定菜单项添加点击事件
       
        document.getElementById('finance-management').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('财务管理功能暂未开放');
        });
        
        document.getElementById('system-settings').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('系统设置功能暂未开放');
        });
        
        document.getElementById('history-menu').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('历史记录功能暂未开放');
        });
        
        // 关闭弹窗事件
        closePopup.addEventListener('click', closeFeaturePopup);
        confirmPopup.addEventListener('click', closeFeaturePopup);
        
        let loginAttempts = 0;
        const MAX_ATTEMPTS = 3;
        const LOCK_TIME = 5 * 60 * 1000; // 5分钟锁定时间
        
        // 添加30分钟无操作自动登出功能
        let lastActivityTime = Date.now();
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30分钟
        
        // 重置活动时间的函数
        function resetActivityTimer() {
            lastActivityTime = Date.now();
        }
        
        // 检查是否超时的函数
        function checkInactivity() {
            const currentTime = Date.now();
            if (currentTime - lastActivityTime > INACTIVITY_TIMEOUT) {
                // 超时处理
                if (mainContainer.style.display !== 'none') {
                    alert('登录超时，请重新登录');
                    loginContainer.style.display = 'flex';
                    mainContainer.style.display = 'none';
                }
            }
        }
        
        // 添加事件监听器来跟踪用户活动
        document.addEventListener('mousemove', resetActivityTimer);
        document.addEventListener('keydown', resetActivityTimer);
        document.addEventListener('click', resetActivityTimer);
        document.addEventListener('scroll', resetActivityTimer);
        
        // 定期检查是否超时
        setInterval(checkInactivity, 1000);
        
        // 手机号脱敏处理
        function maskPhone(phone) {
            if (phone.length !== 11) return phone;
            return phone.substring(0, 3) + '****' + phone.substring(7);
        }
        
        // 注册按钮点击事件
        registerBtn.addEventListener('click', function() {
            const phone = document.getElementById('register-phone').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            
            // 检查手机号是否在允许列表中
            if (!allowedPhones.includes(phone)) {
                registerErrorMsg.textContent = '无登录权限，请联系管理员';
                return;
            }
            
            // 检查密码是否一致
            if (password !== confirmPassword) {
                registerErrorMsg.textContent = '两次输入的密码不一致';
                return;
            }
            
            // 检查密码长度
            if (password.length < 6) {
                registerErrorMsg.textContent = '密码长度至少为6位';
                return;
            }
            
            // 保存用户信息
            userAccounts[phone] = password;
            localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
            
            // 提示注册成功
            alert('用户注册成功');
            
            // 切换到登录表单
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            document.getElementById('login-phone').value = phone;
            loginErrorMsg.textContent = '';
        });
        
        // 登录按钮点击事件
        loginBtn.addEventListener('click', function() {
            const phone = document.getElementById('login-phone').value.trim();
            const password = document.getElementById('login-password').value;
            
            // 检查是否在锁定状态
            const lockUntil = localStorage.getItem('lockUntil');
            if (lockUntil && Date.now() < parseInt(lockUntil)) {
                const remaining = Math.ceil((parseInt(lockUntil) - Date.now()) / 1000 / 60);
                loginErrorMsg.textContent = `您已连续多次输入错误，系统被锁定${remaining}分钟`;
                document.getElementById('login-password').disabled = true;
                loginBtn.disabled = true;
                return;
            }
            
            // 检查用户是否存在
            if (!userAccounts[phone]) {
                loginErrorMsg.textContent = '该手机号未注册，请先注册';
                return;
            }
            
            // 验证密码
            if (userAccounts[phone] === password) {
                // 登录成功
                loginContainer.style.display = 'none';
                mainContainer.style.display = 'block';
                loginAttempts = 0;
                localStorage.removeItem('lockUntil');
                
                // 重置活动时间
                resetActivityTimer();
                
                // 初始化日期选择器
                initDatePickers();
                
                // 初始化自定义日期选择器
                initCustomDatePickers();
                
                // 加载默认数据
                loadDefaultData();
                
                // 显示用户手机号（脱敏）
                userDisplay.textContent = maskPhone(phone);

                // 初始化图表
                initCharts();
                
                // 加载指标数据
                loadMetricsData();
            } else {
                // 登录失败
                loginAttempts++;
                
                if (loginAttempts >= MAX_ATTEMPTS) {
                    // 锁定系统
                    const lockTime = Date.now() + LOCK_TIME;
                    localStorage.setItem('lockUntil', lockTime.toString());
                    const remaining = Math.ceil(LOCK_TIME / 1000 / 60);
                    loginErrorMsg.textContent = `您已连续多次输入错误，系统被锁定${remaining}分钟`;
                    document.getElementById('login-password').disabled = true;
                    loginBtn.disabled = true;
                    
                    // 5分钟后解锁
                    setTimeout(() => {
                        document.getElementById('login-password').disabled = false;
                        loginBtn.disabled = false;
                        loginErrorMsg.textContent = '';
                        loginAttempts = 0;
                        localStorage.removeItem('lockUntil');
                    }, LOCK_TIME);
                } else {
                    loginErrorMsg.textContent = '密码输入错误';
                }
            }
        });
        
        // 重置密码按钮点击事件
        resetBtn.addEventListener('click', function() {
            const phone = document.getElementById('reset-phone').value.trim();
            const lastFour = document.getElementById('last-four').value;
            const password = document.getElementById('reset-password').value;
            const confirmPassword = document.getElementById('reset-confirm').value;
            
            // 检查手机号是否在允许列表中
            if (!allowedPhones.includes(phone)) {
                resetErrorMsg.textContent = '无登录权限，请联系管理员';
                return;
            }
            
            // 检查手机号后四位
            if (phone.substring(7) !== lastFour) {
                resetErrorMsg.textContent = '手机号后四位不正确';
                return;
            }
            
            // 检查密码是否一致
            if (password !== confirmPassword) {
                resetErrorMsg.textContent = '两次输入的密码不一致';
                return;
            }
            
            // 检查密码长度
            if (password.length < 6) {
                resetErrorMsg.textContent = '密码长度至少为6位';
                return;
            }
            
            // 更新用户密码
            userAccounts[phone] = password;
            localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
            
            // 提示重置成功
            alert('密码重置成功');
            
            // 关闭模态框
            resetModal.style.display = 'none';
            
            // 清空表单
            document.getElementById('reset-phone').value = '';
            document.getElementById('last-four').value = '';
            document.getElementById('reset-password').value = '';
            document.getElementById('reset-confirm').value = '';
            resetErrorMsg.textContent = '';
        });
        
        // 检查是否有锁定状态
        window.addEventListener('DOMContentLoaded', function() {
            const lockUntil = localStorage.getItem('lockUntil');
            if (lockUntil && Date.now() < parseInt(lockUntil)) {
                const remaining = Math.ceil((parseInt(lockUntil) - Date.now()) / 1000 / 60);
                loginErrorMsg.textContent = `您已连续多次输入错误，系统被锁定${remaining}分钟`;
                document.getElementById('login-password').disabled = true;
                loginBtn.disabled = true;
            }
            
            // 新增事件绑定：忘记密码、注册、返回登录、关闭模态框
            const showReset = document.getElementById('show-reset');
            const showRegister = document.getElementById('show-register');
            const backToLogin = document.getElementById('back-to-login');
            const closeModal = document.getElementById('close-modal');
            const resetModal = document.getElementById('reset-modal');

            showReset.addEventListener('click', function() {
                resetModal.style.display = 'flex';
            });

            showRegister.addEventListener('click', function() {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            });

            backToLogin.addEventListener('click', function() {
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
            });

            closeModal.addEventListener('click', function() {
                resetModal.style.display = 'none';
            });

            resetModal.addEventListener('click', function(e) {
                if (e.target === resetModal) {
                    resetModal.style.display = 'none';
                }
            });
        });
        
        // 时间显示更新
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[now.getDay()];
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            document.getElementById('time-display').textContent = 
                `${year}年${month}月${day}日 ${weekday} ${hours}:${minutes}:${seconds}`;
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // 格式化数字显示（解决科学计数法问题）
        // 修改后的格式化函数
function formatNumber(value) {
    // 检查是否为整数（包括浮点数表示的整数）
    if (Number.isInteger(value) || Math.abs(value - Math.round(value)) < 1e-6) {
        // 整数：直接格式化为整数
        return Math.round(value).toLocaleString();
    } else {
        // 非整数：使用原来的处理方式
        if (typeof value === 'number' && (Math.abs(value) > 1e6 || Math.abs(value) < 1e-6)) {
            return value.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return value.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

        // 初始化图表
        function initCharts() {
            // 充电数据图表
            const chargingCtx = document.getElementById('charging-chart').getContext('2d');
            chargingChart = new Chart(chargingCtx, {
                type: 'bar',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                    datasets: [
                        {
                            label: '充电量 (kwh)',
                            data: [479733.16, 464263.68, 512991.91, 457884.94, 470890.75, 461424.8, 548439.35],
                            backgroundColor: 'rgba(26, 115, 232, 0.7)',
                            borderColor: 'rgba(26, 115, 232, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '服务费收入 (元)',
                            data: [135946.9, 129429.97, 142060.47, 125140.44, 134990.15, 136456.45, 159618.18],
                            type: 'line',
                            borderColor: 'rgba(0, 200, 83, 1)',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '充电量 (kwh)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '服务费收入 (元)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            // 收入数据图表
            const incomeCtx = document.getElementById('income-chart').getContext('2d');
            incomeChart = new Chart(incomeCtx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                    datasets: [
                        {
                            label: '综合收入 (元)',
                            data: [45013.18, 39691.03, 39095.14, 52606.46, 44061.75, 38928.35, 43435.85],
                            borderColor: 'rgba(220, 53, 69, 1)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '综合收入 (元)'
                            }
                        }
                    }
                }
            });

            // 充电数据总趋势图表
            const chargingTrendCtx = document.getElementById('charging-trend-chart').getContext('2d');
            chargingTrendChart = new Chart(chargingTrendCtx, {
                type: 'line',
                data: {
                    labels: ['2018', '2019', '2020', '2021', '2022', '2023', '2024', '2025'],
                    datasets: [
                        {
                            label: '充电量 (kwh)',
                            data: [626624.99, 2487651.48, 3580420.54, 4883217.95, 5136589.43, 5076097.29, 6674722.08, 3395628.58],
                            borderColor: 'rgba(26, 115, 232, 1)',
                            backgroundColor: 'rgba(26, 115, 232, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: '充电服务费收入 (元)',
                            data: [419522.88, 1298604.49, 1340324.34, 1541061.48, 2141138.69, 1765909.85, 1775147.16, 963642.56],
                            borderColor: 'rgba(0, 200, 83, 1)',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '充电量 (kwh)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '服务费收入 (元)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            // 各版块收入汇总图表
            const revenueBySectorCtx = document.getElementById('revenue-by-sector-chart').getContext('2d');
            revenueBySectorChart = new Chart(revenueBySectorCtx, {
                type: 'bar',
                data: {
                    labels: ['车海洋', '快易洁', '微信', '车颜知己', '兴元售货机', '收钱吧', '赛菲姆道闸',  '红门道闸',  '月租车'],
                    datasets: [
                        {
                            label: '2023年收入 (元)',
                            data: [80754.88, 17379.48, 42490.2, 68818, 35487.9, 91060.2, 134950, 0, 0],
                            backgroundColor: 'rgba(26, 115, 232, 0.7)',
                            borderColor: 'rgba(26, 115, 232, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '2024年收入 (元)',
                            data: [84064.39, 25829.64, 3535.03, 168284.5, 61996.3, 126047.14, 135730, 0, 0],
                            backgroundColor: 'rgba(0, 200, 83, 0.7)',
                            borderColor: 'rgba(0, 200, 83, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '2025年收入 (元)',
                            data: [43964.18, 12708.99, 18846, 100167.8, 36451.7, 30170.17, 107170, 58010, 49160],
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '收入 (元)'
                            }
                        }
                    }
                }
            });

            // 年度总收入趋势图表
            const annualRevenueTrendCtx = document.getElementById('annual-revenue-trend-chart').getContext('2d');
            annualRevenueTrendChart = new Chart(annualRevenueTrendCtx, {
                type: 'line',
                data: {
                    labels: ['2018', '2019', '2020', '2021', '2022', '2023', '2024', '2025'],
                    datasets: [
                        {
                            label: '年度总收入 (元)',
                            data: [37577.76, 231494.31, 329854.87, 492025.50, 474854.70, 470940.67, 605487.01, 375153.84],
                            borderColor: 'rgba(156, 39, 176, 1)',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '总收入 (元)'
                            }
                        }
                    }
                }
            });

               
            // 图表按钮事件
            document.querySelectorAll('.chart-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.textContent.includes('导出')) {
                        const canvas = this.closest('.chart-container').querySelector('canvas');
                        const link = document.createElement('a');
                        link.download = '图表导出.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } else {
                        // 刷新数据
                        loadMetricsData();
                        alert('数据已刷新！');
                    }
                });
            });
        }
        
        // 从GitHub加载指标数据
        function loadMetricsData() {
            // 显示加载状态
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'data-loading-indicator';
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载指标数据...';
            document.querySelector('.metrics-section').prepend(loadingIndicator);
            
            fetch(metricsDataUrl)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 处理指标数据（Metrics工作表）
                    const metricsSheet = workbook.Sheets['Metrics'];
                    const metricsJson = XLSX.utils.sheet_to_json(metricsSheet, { header: 1 });
                    
                    // 更新指标数据 - 修正索引位置
                    document.getElementById('month-charge').textContent = formatNumber(metricsJson[1][1]) + ' kwh';
                    document.getElementById('month-electricity').textContent = '¥' + formatNumber(metricsJson[2][1]);
                    document.getElementById('month-service').textContent = '¥' + formatNumber(metricsJson[3][1]);
                    document.getElementById('month-orders').textContent = formatNumber(metricsJson[4][1]);
                    
                    document.getElementById('year-charge').textContent = formatNumber(metricsJson[5][1]) + ' kwh';
                    document.getElementById('year-electricity').textContent = '¥' + formatNumber(metricsJson[6][1]);
                    document.getElementById('year-service').textContent = '¥' + formatNumber(metricsJson[7][1]);
                    document.getElementById('year-orders').textContent = formatNumber(metricsJson[8][1]);
                    
                    document.getElementById('total-charge').textContent = formatNumber(metricsJson[9][1]) + ' kwh';
                    document.getElementById('total-electricity').textContent = '¥' + formatNumber(metricsJson[10][1]);
                    document.getElementById('total-service').textContent = '¥' + formatNumber(metricsJson[11][1]);
                    document.getElementById('total-orders').textContent = formatNumber(metricsJson[12][1]);
                    
                    document.getElementById('month-income').textContent = '¥' + formatNumber(metricsJson[13][1]);
                    document.getElementById('year-income').textContent = '¥' + formatNumber(metricsJson[14][1]);
                    document.getElementById('total-income').textContent = '¥' + formatNumber(metricsJson[15][1]);
                    
                    // 处理充电图表数据（ChargingChart工作表）
                    const chargingChartSheet = workbook.Sheets['ChargingChart'];
                    const chargingChartJson = XLSX.utils.sheet_to_json(chargingChartSheet, { header: 1 });
                    
                    // 提取数据
                    const labels = [];
                    const chargingData = [];
                    const serviceIncomeData = [];
                    
                    for (let i = 1; i < chargingChartJson.length; i++) {
                        const row = chargingChartJson[i];
                        if (row && row.length >= 3) {
                            labels.push(row[0]);
                            chargingData.push(row[1]);
                            serviceIncomeData.push(row[2]);
                        }
                    }
                    
                    // 更新充电图表
                    if (chargingChart) {
                        chargingChart.data.labels = labels;
                        chargingChart.data.datasets[0].data = chargingData;
                        chargingChart.data.datasets[1].data = serviceIncomeData;
                        chargingChart.update();
                    }
                    
                    // 处理综合收入图表数据（IncomeChart工作表）
                    const incomeChartSheet = workbook.Sheets['IncomeChart'];
                    const incomeChartJson = XLSX.utils.sheet_to_json(incomeChartSheet, { header: 1 });
                    
                    // 提取数据
                    const incomeLabels = [];
                    const incomeDataArray = [];
                    
                    for (let i = 1; i < incomeChartJson.length; i++) {
                        const row = incomeChartJson[i];
                        if (row && row.length >= 2) {
                            incomeLabels.push(row[0]);
                            incomeDataArray.push(row[1]);
                        }
                    }
                    
                    // 更新收入图表
                    if (incomeChart) {
                        incomeChart.data.labels = incomeLabels;
                        incomeChart.data.datasets[0].data = incomeDataArray;
                        incomeChart.update();
                    }
                    
                    // 移除加载状态
                    loadingIndicator.remove();
                })
                .catch(error => {
                    console.error('加载指标数据失败:', error);
                    loadingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 加载指标数据失败';
                    
                    // 5秒后移除提示
                    setTimeout(() => {
                        loadingIndicator.remove();
                    }, 5000);
                });
        }
    </script>
</body>
</html>