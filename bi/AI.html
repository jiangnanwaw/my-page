<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="storage-access=self">
    <title>AIæ™ºèƒ½åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            height: 100vh;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            margin-bottom: 20px;
            direction: ltr;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
            position: relative;
        }

        .message.assistant::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-right: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* AIå›¾æ ‡ - ä½¿ç”¨CSSç»˜åˆ¶ç¥ç»ç½‘ç»œèŠ‚ç‚¹æ ·å¼ */
        .message.assistant::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 6px;
            width: 20px;
            height: 20px;
            background: 
                /* ä¸­å¿ƒå¤§èŠ‚ç‚¹ */
                radial-gradient(circle at 50% 50%, #ffffff 3px, transparent 3px),
                /* å››ä¸ªè§’çš„è¿æ¥èŠ‚ç‚¹ */
                radial-gradient(circle at 0% 0%, #ffffff 1.5px, transparent 1.5px),
                radial-gradient(circle at 100% 0%, #ffffff 1.5px, transparent 1.5px),
                radial-gradient(circle at 0% 100%, #ffffff 1.5px, transparent 1.5px),
                radial-gradient(circle at 100% 100%, #ffffff 1.5px, transparent 1.5px),
                /* è¿æ¥çº¿ */
                linear-gradient(to right, rgba(255,255,255,0.4) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.4) 1px, transparent 1px);
            background-size: 
                20px 20px,
                20px 20px,
                20px 20px,
                20px 20px,
                20px 20px,
                5px 5px,
                5px 5px;
            background-position:
                center,
                0 0,
                100% 0,
                0 100%,
                100% 100%,
                0 0,
                0 0;
            opacity: 0.95;
        }

        .message.assistant .message-content {
            margin-left: 40px;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: #007AFF;
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .input-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 20px 40px;
        }

        .input-label {
            color: #333333;
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
            max-width: 700px;
        }

        .input-box {
            width: 100%;
            padding: 20px 60px 20px 20px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: box-shadow 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 200px;
            overflow-y: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.5;
        }

        .input-box:focus {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .input-box::placeholder {
            color: #999;
            font-size: 14px;
        }

        .send-button {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #007AFF;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            z-index: 10;
        }

        .send-button:hover {
            background: #0051D5;
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            pointer-events: none;
        }

        .loading {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #007AFF;
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes loading {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .loading-container {
            display: flex;
            gap: 6px;
            padding: 12px 18px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* æ€è€ƒå’Œå›ç­”éƒ¨åˆ†çš„æ ·å¼ */
        .thinking-section {
            color: #666;
            font-style: italic;
            margin: 10px 0 5px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-left: 3px solid #6c757d;
            border-radius: 4px;
        }

        .answer-section {
            color: #333;
            margin: 10px 0 5px 0;
            padding: 8px 12px;
            background: #e7f3ff;
            border-left: 3px solid #007AFF;
            border-radius: 4px;
        }

        .message-content strong {
            color: #007AFF;
            font-weight: 600;
        }

        .download-prompt {
            margin-top: 15px;
            padding: 12px 16px;
            background: #f0f7ff;
            border: 1px solid #007AFF;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
        }

        .download-prompt-text {
            margin-bottom: 10px;
            color: #666;
        }

        .download-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .download-button:hover {
            background: #0051D5;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .download-button:active {
            transform: translateY(0);
        }

        .download-button svg {
            width: 16px;
            height: 16px;
        }

        .truncated-content {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="messages-container" id="messagesContainer"></div>

        <div class="input-section">
            <div class="input-label">æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ ï¼Ÿ</div>
            <div class="input-wrapper">
                <textarea
                    class="input-box"
                    id="messageInput"
                    placeholder="ç»™æˆ‘å‘é€æ¶ˆæ¯(æˆ‘å¯ä»¥æŸ¥ä»»æ„æ—¶é—´å†…å››æ–¹åªæˆ–é«˜å²­æˆ–é£ç‹å…¬å¸çš„å……ç”µç”µé‡ã€å……ç”µæœåŠ¡è´¹ã€å……ç”µæ¯›åˆ©ä»¥åŠç»¼åˆä¸šåŠ¡æ”¶å…¥å’Œæ¯é¡¹ç»¼åˆä¸šåŠ¡æ˜ç»†çš„æ”¶å…¥ç­‰ä¿¡æ¯æ•°æ®)"
                    autocomplete="off"
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="19" x2="12" y2="5"></line>
                        <polyline points="5 12 12 5 19 12"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨å¤šä¸ªCDNæºï¼Œæé«˜åŠ è½½æˆåŠŸç‡ -->
    <script>
        // æŠ‘åˆ¶Tracking Preventionè­¦å‘Šï¼ˆè¿™äº›è­¦å‘Šä¸å½±å“åŠŸèƒ½ï¼‰
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('Tracking Prevention')) {
                // é™é»˜å¤„ç†Tracking Preventionè­¦å‘Š
                return;
            }
            originalWarn.apply(console, args);
        };

        // æ•è·å¹¶å¤„ç†å¯èƒ½çš„æ‰©å±•è„šæœ¬é”™è¯¯
        window.addEventListener('error', function(e) {
            if (e.filename && e.filename.includes('color-scheme-watcher')) {
                // é™é»˜å¤„ç†æµè§ˆå™¨æ‰©å±•ç›¸å…³çš„é”™è¯¯
                e.preventDefault();
                return false;
            }
        }, true);

        // CDNåŠ è½½çŠ¶æ€è·Ÿè¸ª
        window.LeanCloudLoader = {
            loaded: false,
            sources: [
                'https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js',
                'https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js',
                'https://lf1-cdn-tos.bytecdntp.com/cdn/expire-1-M/leancloud-storage/4.15.0/av-min.js'
            ],
            currentIndex: 0
        };

        window.XLSXLoader = {
            loaded: false,
            sources: [
                'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
                'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
            ],
            currentIndex: 0
        };
    </script>

    <!-- é¦–å…ˆåŠ è½½XLSXï¼ˆå¯é€‰ï¼Œå¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
            onerror="loadXLSXFallback()"
            onload="window.XLSXLoader.loaded=true"></script>

    <!-- LeanCloudè„šæœ¬åŠ è½½é€»è¾‘ -->
    <script>
        function loadLeanCloudScript() {
            const loader = window.LeanCloudLoader;
            const src = loader.sources[loader.currentIndex];
            console.log(`å°è¯•åŠ è½½LeanCloud CDN (${loader.currentIndex + 1}/${loader.sources.length}):`, src);

            const script = document.createElement('script');
            script.src = src;
            script.async = true;

            script.onload = function() {
                console.log('LeanCloudè„šæœ¬åŠ è½½æˆåŠŸï¼');
                loader.loaded = true;
            };

            script.onerror = function() {
                console.warn(`CDNæº ${loader.currentIndex + 1} åŠ è½½å¤±è´¥:`, src);
                loader.currentIndex++;

                if (loader.currentIndex < loader.sources.length) {
                    // å°è¯•ä¸‹ä¸€ä¸ªCDN
                    setTimeout(loadLeanCloudScript, 500);
                } else {
                    console.error('æ‰€æœ‰LeanCloud CDNæºåŠ è½½å¤±è´¥ï¼');
                    showErrorDialog('æ— æ³•åŠ è½½LeanCloudåº“ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. CDNè¢«é˜²ç«å¢™é˜»æ­¢\n3. ä»£ç†è®¾ç½®é—®é¢˜\n\nå»ºè®®ï¼š\n- æ£€æŸ¥ç½‘ç»œè¿æ¥\n- å°è¯•ä½¿ç”¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒ\n- æˆ–ä½¿ç”¨ä»£ç†è®¿é—®');
                }
            };

            document.head.appendChild(script);
        }

        function loadXLSXFallback() {
            const loader = window.XLSXLoader;
            console.log('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
            loader.currentIndex++;

            if (loader.currentIndex < loader.sources.length) {
                const script = document.createElement('script');
                script.src = loader.sources[loader.currentIndex];
                script.onload = function() {
                    console.log('XLSXå¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
                    loader.loaded = true;
                };
                script.onerror = function() {
                    console.warn('XLSXå¤‡ç”¨CDNä¹ŸåŠ è½½å¤±è´¥');
                };
                document.head.appendChild(script);
            } else {
                console.warn('æ‰€æœ‰XLSX CDNæºåŠ è½½å¤±è´¥ï¼ŒExcelå¯¼å‡ºåŠŸèƒ½å°†ä¸å¯ç”¨');
            }
        }

        function showErrorDialog(message) {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                text-align: center;
                font-family: -apple-system, sans-serif;
            `;

            dialog.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 15px;">âš ï¸</div>
                <h3 style="margin: 0 0 15px 0; color: #333;">åŠ è½½å¤±è´¥</h3>
                <p style="margin: 0 0 20px 0; color: #666; white-space: pre-line;">${message}</p>
                <button onclick="location.reload()" style="
                    padding: 10px 25px;
                    background: #007AFF;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                ">åˆ·æ–°é¡µé¢</button>
            `;

            document.body.appendChild(dialog);
        }

        // å¼€å§‹åŠ è½½LeanCloud
        loadLeanCloudScript();

        // ç­‰å¾…DOMå’ŒLeanCloudè„šæœ¬éƒ½åŠ è½½å®Œæˆ
        let initAttempts = 0;
        const MAX_INIT_ATTEMPTS = 600; // æœ€å¤šç­‰å¾…60ç§’ï¼ˆ600 * 100msï¼‰

        function initApp() {
            initAttempts++;

            // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            if (initAttempts > MAX_INIT_ATTEMPTS) {
                console.error('åˆå§‹åŒ–è¶…æ—¶ï¼šLeanCloudè„šæœ¬åŠ è½½å¤±è´¥');
                showErrorDialog('åº”ç”¨åˆå§‹åŒ–è¶…æ—¶ï¼šæ— æ³•åŠ è½½å¿…è¦çš„åº“æ–‡ä»¶ã€‚\n\nè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. æ˜¯å¦è¢«é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢\n3. å°è¯•åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // æ£€æŸ¥AVæ˜¯å¦å·²åŠ è½½ï¼ˆä¼˜å…ˆæ£€æŸ¥åŠ è½½å™¨çŠ¶æ€ï¼‰
            if (typeof AV === 'undefined') {
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰CDNæºéƒ½å¤±è´¥äº†
                if (window.LeanCloudLoader && window.LeanCloudLoader.currentIndex >= window.LeanCloudLoader.sources.length) {
                    console.error('æ‰€æœ‰CDNæºåŠ è½½å¤±è´¥ï¼Œåœæ­¢åˆå§‹åŒ–');
                    return;
                }
                if (initAttempts % 10 === 0) { // æ¯1ç§’è¾“å‡ºä¸€æ¬¡æ—¥å¿—
                    console.log('ç­‰å¾…LeanCloudè„šæœ¬åŠ è½½... (' + initAttempts + '/' + MAX_INIT_ATTEMPTS + ')');
                }
                setTimeout(initApp, 100);
                return;
            }

            // æ£€æŸ¥XLSXæ˜¯å¦å·²åŠ è½½ï¼ˆå¯é€‰ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼‰
            if (typeof XLSX === 'undefined') {
                console.warn('XLSXåº“æœªåŠ è½½ï¼ŒExcelå¯¼å‡ºåŠŸèƒ½å°†ä¸å¯ç”¨');
            }

            // åˆå§‹åŒ– LeanCloud
            AV.init({
                appId: '8luz5IULzHMzsGz2hG2a4scI-gzGzoHsz',
                appKey: 'CMGwM4hzM3C2TXTfIYQVS6TM',
                serverURL: 'https://8luz5iul.lc-cn-n1-shared.com'
            });

            const messagesContainer = document.getElementById('messagesContainer');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!sendButton) {
                console.error('å‘é€æŒ‰é’®æœªæ‰¾åˆ°ï¼');
                return;
            }
            if (!messageInput) {
                console.error('è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼');
                return;
            }

            // çŠ¶æ€ç®¡ç†ï¼šæ˜¯å¦æ­£åœ¨å‘é€æ¶ˆæ¯
            let isSending = false;
            let currentAbortController = null;

            // æ›´æ–°å‘é€æŒ‰é’®å›¾æ ‡
            function updateSendButtonIcon(isPause = false) {
                const svg = sendButton.querySelector('svg');
                if (isPause) {
                    // æ˜¾ç¤ºæš‚åœå›¾æ ‡
                    svg.innerHTML = `
                        <rect x="6" y="4" width="4" height="16" rx="1"></rect>
                        <rect x="14" y="4" width="4" height="16" rx="1"></rect>
                    `;
                } else {
                    // æ˜¾ç¤ºå‘é€ç®­å¤´
                    svg.innerHTML = `
                        <line x1="12" y1="19" x2="12" y2="5"></line>
                        <polyline points="5 12 12 5 19 12"></polyline>
                    `;
                }
            }

            // å–æ¶ˆå¯¹è¯
            function cancelConversation() {
                if (isSending && currentAbortController) {
                    console.log('å–æ¶ˆå¯¹è¯è¯·æ±‚');
                    currentAbortController.abort();
                    currentAbortController = null;
                }
                
                // é‡ç½®çŠ¶æ€
                isSending = false;
                currentAbortController = null;
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                removeLoading();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                updateSendButtonIcon(false);
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
                
                // æ˜¾ç¤ºå–æ¶ˆæ¶ˆæ¯
                addMessage('å¯¹è¯å·²å–æ¶ˆ', false);
            }

            // ç®€å•çš„Markdownæ¸²æŸ“å‡½æ•°
            function renderMarkdown(text) {
            if (!text) return '';

            // å¤„ç†åŠ ç²—æ–‡æœ¬ **text**
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // å¤„ç†ã€æ€è€ƒã€‘å’Œã€å›ç­”ã€‘æ ‡ç­¾
            text = text.replace(/ã€æ€è€ƒã€‘/g, '<div class="thinking-section"><strong>ã€æ€è€ƒã€‘</strong></div>');
            text = text.replace(/ã€å›ç­”ã€‘/g, '<div class="answer-section"><strong>ã€å›ç­”ã€‘</strong></div>');

            // ä¿ç•™æ¢è¡Œ
            text = text.replace(/\n/g, '<br>');

            return text;
        }

            // å°†æ•°æ®è½¬æ¢ä¸ºExcelå¹¶ä¸‹è½½
            function downloadAsExcel(data, filename = 'æŸ¥è¯¢ç»“æœ') {
                // æ£€æŸ¥XLSXæ˜¯å¦å¯ç”¨
                if (typeof XLSX === 'undefined') {
                    alert('Excelå¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨ï¼šXLSXåº“æœªåŠ è½½å¤±è´¥ã€‚\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                    return;
                }

                try {
                    // å¦‚æœæ²¡æœ‰æ•°æ®æˆ–æ•°æ®ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·
                    if (!data || data.length === 0) {
                        alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                        return;
                    }

                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();

                // è·å–è¡¨å¤´
                const headers = Object.keys(data[0]);
                
                // å‡†å¤‡æ•°æ®ï¼šè¡¨å¤´ + æ•°æ®è¡Œ
                const excelData = [
                    headers, // ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´
                    ...data.map(row => headers.map(header => {
                        const value = row[header];
                        // å¤„ç†æ—¥æœŸå¯¹è±¡
                        if (value instanceof Date) {
                            return value;
                        }
                        // å¤„ç†æ•°å­—
                        if (typeof value === 'number') {
                            return value;
                        }
                        // å¤„ç†nullå’Œundefined
                        if (value === null || value === undefined) {
                            return '';
                        }
                        return String(value);
                    }))
                ];

                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // è®¾ç½®åˆ—å®½
                const colWidths = headers.map(header => {
                    const maxLength = Math.max(
                        header.length,
                        ...data.map(row => {
                            const val = row[header];
                            return val ? String(val).length : 0;
                        })
                    );
                    return { wch: Math.min(Math.max(maxLength + 2, 10), 50) };
                });
                ws['!cols'] = colWidths;

                // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, 'æŸ¥è¯¢ç»“æœ');

                // ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                const finalFilename = `${filename}_${timestamp}.xlsx`;

                // ä¸‹è½½æ–‡ä»¶
                XLSX.writeFile(wb, finalFilename);
            } catch (error) {
                console.error('ç”ŸæˆExcelæ–‡ä»¶æ—¶å‡ºé”™:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

            // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
            function addMessage(content, isUser = false, metadata = null, rawData = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜¾ç¤ºä¸‹è½½æç¤ºï¼ˆæ•°æ®é‡è¶…è¿‡10æ¡è®°å½•æ—¶æ˜¾ç¤ºï¼‰
            const shouldShowDownload = !isUser && rawData && rawData.hasData && rawData.rawData && rawData.rawData.length > 10;
            const MAX_DISPLAY_LINES = 20; // æœ€å¤šæ˜¾ç¤º20è¡Œ
            let displayContent = content;
            let isTruncated = false;

            // å¦‚æœæ˜¯AIå›å¤ä¸”æœ‰æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æˆªæ–­æ˜¾ç¤º
            if (shouldShowDownload) {
                const lines = content.split('\n');
                // æ£€æŸ¥å†…å®¹æ˜¯å¦è¿‡é•¿ï¼ˆè¶…è¿‡æœ€å¤§æ˜¾ç¤ºè¡Œæ•°ï¼‰
                if (lines.length > MAX_DISPLAY_LINES) {
                    // æ‰¾åˆ°è¡¨æ ¼å¼€å§‹çš„ä½ç½®
                    const tableStartIndex = lines.findIndex(line => line.includes('|') && !line.includes('---'));
                    if (tableStartIndex !== -1) {
                        // æˆªæ–­åˆ°æŒ‡å®šè¡Œæ•°ï¼ˆä¿ç•™è¡¨å¤´åˆ†éš”çº¿å’Œå‰å‡ è¡Œæ•°æ®ï¼‰
                        const truncatedLines = lines.slice(0, tableStartIndex + MAX_DISPLAY_LINES);
                        displayContent = truncatedLines.join('\n') + '\n\n... æ•°æ®è¾ƒå¤šï¼Œå»ºè®®ä¸‹è½½å®Œæ•´æ•°æ®æŸ¥çœ‹';
                        isTruncated = true;
                    }
                }
            }

            // å¦‚æœæ˜¯AIå›å¤ï¼Œä½¿ç”¨Markdownæ¸²æŸ“
            if (!isUser) {
                if (isTruncated) {
                    // å¦‚æœå†…å®¹è¢«æˆªæ–­ï¼Œæ·»åŠ æ»šåŠ¨å®¹å™¨
                    const truncatedDiv = document.createElement('div');
                    truncatedDiv.className = 'truncated-content';
                    truncatedDiv.innerHTML = renderMarkdown(displayContent);
                    contentDiv.appendChild(truncatedDiv);
                } else {
                    contentDiv.innerHTML = renderMarkdown(displayContent);
                }
            } else {
                contentDiv.textContent = displayContent;
            }

            // å¦‚æœéœ€è¦æ˜¾ç¤ºä¸‹è½½æç¤º
            if (shouldShowDownload) {
                const downloadPrompt = document.createElement('div');
                downloadPrompt.className = 'download-prompt';
                
                const promptText = document.createElement('div');
                promptText.className = 'download-prompt-text';
                const recordCount = rawData.rawData.length;
                if (isTruncated) {
                    promptText.textContent = `ğŸ“Š æŸ¥è¯¢ç»“æœåŒ…å« ${recordCount} æ¡è®°å½•ï¼Œå½“å‰ä»…æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®ã€‚æ˜¯å¦éœ€è¦ä¸‹è½½å®Œæ•´çš„Excelè¡¨æ ¼ï¼Ÿ`;
                } else {
                    promptText.textContent = `ğŸ“Š æŸ¥è¯¢ç»“æœåŒ…å« ${recordCount} æ¡è®°å½•ã€‚æ˜¯å¦éœ€è¦ä¸‹è½½Excelè¡¨æ ¼ä»¥ä¾¿æ›´å¥½åœ°æŸ¥çœ‹å’Œåˆ†ææ•°æ®ï¼Ÿ`;
                }
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-button';
                downloadBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    ä¸‹è½½Excelè¡¨æ ¼
                `;
                
                downloadBtn.addEventListener('click', () => {
                    downloadAsExcel(rawData.rawData, 'æŸ¥è¯¢ç»“æœ');
                });
                
                downloadPrompt.appendChild(promptText);
                downloadPrompt.appendChild(downloadBtn);
                contentDiv.appendChild(downloadPrompt);
            }

            messageDiv.appendChild(contentDiv);

            // å¦‚æœæœ‰å…ƒæ•°æ®ï¼Œæ˜¾ç¤ºé¢å¤–ä¿¡æ¯
            if (metadata && metadata.processingTime) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-metadata';
                metaDiv.style.fontSize = '11px';
                metaDiv.style.color = '#999';
                metaDiv.style.marginTop = '5px';
                metaDiv.textContent = `å¤„ç†æ—¶é—´: ${metadata.processingTime}ms`;

                contentDiv.appendChild(metaDiv);
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            function showLoading() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'loading-message';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content loading-container';
            contentDiv.innerHTML = '<span class="loading"></span><span class="loading"></span><span class="loading"></span>';

            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

            // ç§»é™¤åŠ è½½åŠ¨ç”»
            function removeLoading() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

            // è·å–æˆ–åˆ›å»ºsessionId
            function getSessionId() {
            let sessionId = null;
            try {
                sessionId = sessionStorage.getItem('chatSessionId');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('chatSessionId', sessionId);
                }
            } catch (e) {
                // å¦‚æœå­˜å‚¨è®¿é—®è¢«é˜»æ­¢ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨
                console.warn('sessionStorageè®¿é—®è¢«é˜»æ­¢ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨:', e);
                if (!window._tempSessionId) {
                    window._tempSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                sessionId = window._tempSessionId;
            }
            return sessionId;
        }

            // å‘é€æ¶ˆæ¯
            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                // å¦‚æœæ­£åœ¨å‘é€ï¼Œåˆ™ç›´æ¥è¿”å›ï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰
                if (isSending) {
                    return;
                }

                // è®¾ç½®å‘é€çŠ¶æ€
                isSending = true;
                currentAbortController = new AbortController();

                // ç¦ç”¨è¾“å…¥ï¼Œä½†ä¿æŒæŒ‰é’®å¯ç”¨ï¼ˆç”¨äºå–æ¶ˆï¼‰
                messageInput.disabled = true;
                sendButton.disabled = false;

                // æ›´æ–°æŒ‰é’®å›¾æ ‡ä¸ºæš‚åœé”®
                updateSendButtonIcon(true);

                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                addMessage(message, true);
                messageInput.value = '';
                messageInput.style.height = 'auto';

                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                showLoading();

                try {
                    console.log('å‘é€æ¶ˆæ¯:', message);

                    // è·å–sessionId
                    const sessionId = getSessionId();

                    // è°ƒç”¨äº‘å‡½æ•°
                    // æ³¨æ„ï¼šLeanCloudçš„Cloud.runå¯èƒ½ä¸æ”¯æŒAbortControllerï¼Œä½†æˆ‘ä»¬å¯ä»¥è®¾ç½®æ ‡å¿—
                    const result = await AV.Cloud.run('chatWithAI', { 
                        message: message,
                        sessionId: sessionId
                    });

                    // æ£€æŸ¥æ˜¯å¦å·²è¢«å–æ¶ˆ
                    if (!isSending) {
                        console.log('è¯·æ±‚å·²è¢«å–æ¶ˆï¼Œå¿½ç•¥å“åº”');
                        return;
                    }

                    console.log('æ”¶åˆ°å“åº”:', result);

                    // ç§»é™¤åŠ è½½åŠ¨ç”»
                    removeLoading();

                    // æ˜¾ç¤ºAIå›å¤
                    const metadata = {
                        processingTime: result.processingTime,
                        sqlQuery: result.sqlQuery
                    };

                    // ä¼ é€’åŸå§‹æ•°æ®ç”¨äºExcelå¯¼å‡º
                    const rawData = {
                        rawData: result.rawData,
                        hasData: result.hasData
                    };

                    addMessage(result.reply, false, metadata, rawData);

                } catch (error) {
                    // å¦‚æœå·²è¢«å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    if (!isSending) {
                        console.log('è¯·æ±‚å·²è¢«å–æ¶ˆ');
                        return;
                    }

                    console.error('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', {
                        name: error.name,
                        message: error.message,
                        code: error.code,
                        rawMessage: error.rawMessage
                    });

                    removeLoading();

                    let errorMsg = 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ã€‚\n';

                    if (error.code === 141) {
                        errorMsg += 'äº‘å‡½æ•°æ‰§è¡Œé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ã€‚';
                    } else if (error.code === 1) {
                        errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚';
                    } else {
                        errorMsg += `é”™è¯¯ä¿¡æ¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                    }

                    addMessage(errorMsg);
                } finally {
                    // é‡ç½®çŠ¶æ€
                    isSending = false;
                    currentAbortController = null;
                    
                    // æ¢å¤è¾“å…¥å’ŒæŒ‰é’®
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    updateSendButtonIcon(false);
                    messageInput.focus();
                }
            }

            // æµ‹è¯•DeepSeek APIè¿æ¥
            async function testDeepSeekAPI() {
                console.log('æµ‹è¯•DeepSeek APIè¿æ¥...');
                try {
                    const result = await AV.Cloud.run('testDeepSeekAPI', {});
                    console.log('DeepSeek APIæµ‹è¯•ç»“æœ:', result);

                    if (result.success) {
                        addMessage(`âœ… DeepSeek APIè¿æ¥æ­£å¸¸\nå¯ç”¨æ¨¡å‹: ${result.models.data ? result.models.data.length : 0}ä¸ª`);
                    } else {
                        addMessage(`âŒ DeepSeek APIè¿æ¥å¤±è´¥\né”™è¯¯: ${result.error}\nçŠ¶æ€ç : ${result.status}`);
                    }
                } catch (error) {
                    console.error('æµ‹è¯•DeepSeek APIæ—¶å‡ºé”™:', error);
                    addMessage(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            }

            // æµ‹è¯•æ•°æ®åº“è¿æ¥
            async function testDatabaseConnection() {
                console.log('æµ‹è¯•æ•°æ®åº“è¿æ¥...');
                try {
                    const result = await AV.Cloud.run('testDatabaseConnection', {});
                    console.log('æ•°æ®åº“æµ‹è¯•ç»“æœ:', result);

                    if (result.success) {
                        addMessage(`âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸\nç‰ˆæœ¬: ${result.version.substring(0, 50)}...`);
                    } else {
                        addMessage(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥\né”™è¯¯: ${result.error}`);
                    }
                } catch (error) {
                    console.error('æµ‹è¯•æ•°æ®åº“æ—¶å‡ºé”™:', error);
                    addMessage(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            }

            // æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨å
            async function listDatabaseTables() {
                console.log('æŸ¥è¯¢æ•°æ®åº“è¡¨å...');
                try {
                    const result = await AV.Cloud.run('listDatabaseTables', {});
                    console.log('æ•°æ®åº“è¡¨åç»“æœ:', result);

                    if (result.success) {
                        const tableList = result.tables.join('\nâ€¢ ');
                        addMessage(`âœ… ${result.message}\n\nè¡¨ååˆ—è¡¨ï¼š\nâ€¢ ${tableList}`);
                    } else {
                        addMessage(`âŒ æŸ¥è¯¢è¡¨åå¤±è´¥\né”™è¯¯: ${result.error}`);
                    }
                } catch (error) {
                    console.error('æŸ¥è¯¢è¡¨åæ—¶å‡ºé”™:', error);
                    addMessage(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                }
            }

            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('å‘é€æŒ‰é’®å…ƒç´ :', sendButton);
            console.log('è¾“å…¥æ¡†å…ƒç´ :', messageInput);
            console.log('sendMessageå‡½æ•°:', typeof sendMessage);
            
            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('å‘é€æŒ‰é’®è¢«ç‚¹å‡», isSending:', isSending);
                
                if (isSending) {
                    // å¦‚æœæ­£åœ¨å‘é€ï¼Œåˆ™å–æ¶ˆå¯¹è¯
                    cancelConversation();
                } else {
                    // å¦åˆ™å‘é€æ¶ˆæ¯
                    if (typeof sendMessage === 'function') {
                        sendMessage();
                    } else {
                        console.error('sendMessageä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼');
                    }
                }
            });

            // å›è½¦å‘é€ï¼ŒShift+Enteræ¢è¡Œ
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
            messageInput.addEventListener('input', (e) => {
                const textarea = e.target;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            });

            // ç›‘å¬ç‰¹æ®Šå‘½ä»¤
            messageInput.addEventListener('input', (e) => {
                const value = e.target.value.trim();

                // å¦‚æœè¾“å…¥ /test-api åˆ™æµ‹è¯•DeepSeek API
                if (value === '/test-api') {
                    e.target.value = '';
                    testDeepSeekAPI();
                }

                // å¦‚æœè¾“å…¥ /test-db åˆ™æµ‹è¯•æ•°æ®åº“
                if (value === '/test-db') {
                    e.target.value = '';
                    testDatabaseConnection();
                }

                // å¦‚æœè¾“å…¥ /list-tables åˆ™æŸ¥è¯¢æ‰€æœ‰è¡¨å
                if (value === '/list-tables') {
                    e.target.value = '';
                    listDatabaseTables();
                }

                // å¦‚æœè¾“å…¥ /help æ˜¾ç¤ºå¸®åŠ©
                if (value === '/help') {
                    e.target.value = '';
                    addMessage(`å¯ç”¨å‘½ä»¤ï¼š
/test-api - æµ‹è¯•DeepSeek APIè¿æ¥
/test-db - æµ‹è¯•æ•°æ®åº“è¿æ¥
/list-tables - æŸ¥è¯¢æ•°æ®åº“æ‰€æœ‰è¡¨å
/help - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

æ•°æ®åº“æŸ¥è¯¢ç¤ºä¾‹ï¼š
â€¢ ä»Šå¹´ç‰¹æ¥ç”µçš„å¹³å‡å……ç”µæœåŠ¡è´¹æ˜¯å¤šå°‘ï¼Ÿ
â€¢ 2020å¹´8æœˆå…´å…ƒæ”¶å…¥å¤šå°‘ï¼Ÿ
â€¢ ä»Šå¤©å……ç”µçš„æ€»ç”µé‡æ˜¯å¤šå°‘ï¼Ÿ

é€šç”¨é—®ç­”ç¤ºä¾‹ï¼š
â€¢ ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ
â€¢ å¦‚ä½•å­¦ä¹ ç¼–ç¨‹ï¼Ÿ`);
                }
            });

            // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
            messageInput.focus();
        } // ç»“æŸ initApp å‡½æ•°

        // ç­‰å¾…DOMå’Œè„šæœ¬éƒ½åŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
            initApp();
        }
    </script>
</body>
</html>
